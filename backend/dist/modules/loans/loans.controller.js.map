{"version":3,"sources":["../../../src/modules/loans/loans.controller.ts"],"sourcesContent":["import {\r\n  Controller,\r\n  Post,\r\n  Get,\r\n  Param,\r\n  Body,\r\n  UseGuards,\r\n  Request,\r\n  Query,\r\n  Delete,\r\n} from '@nestjs/common';\r\nimport { JwtAuthGuard } from '@/common/guards/jwt-auth.guard';\r\nimport { LoansService } from './loans.service';\r\nimport { CreateLoanApplicationDto, CreateGrantDto, ApproveLoanDto, RejectLoanDto } from './dto/create-loan-application.dto';\r\nimport { ApiOperation, ApiTags, ApiBearerAuth } from '@nestjs/swagger';\r\nimport { RolesGuard } from '@/common/guards/roles.guard';\r\nimport { Roles } from '@/common/decorators/roles.decorator';\r\n\r\n@ApiTags('loans')\r\n@ApiBearerAuth()\r\n@Controller()\r\n@UseGuards(JwtAuthGuard)\r\nexport class LoansController {\r\n  constructor(private loansService: LoansService) {}\r\n\r\n  /**\r\n   * Apply for a loan\r\n   */\r\n  @Post('loans/apply')\r\n  @ApiOperation({ summary: 'Apply for a loan' })\r\n  async applyForLoan(\r\n    @Request() req,\r\n    @Body() data: CreateLoanApplicationDto,\r\n  ) {\r\n    return this.loansService.applyForLoan(req.user.id, data);\r\n  }\r\n\r\n  /**\r\n   * Get all loan applications (user)\r\n   */\r\n  @Get('loans/applications')\r\n  @ApiOperation({ summary: 'Get all loan applications' })\r\n  async getLoanApplications(@Request() req) {\r\n    return this.loansService.getLoanApplications(req.user.id);\r\n  }\r\n\r\n  /**\r\n   * Get a specific loan application\r\n   */\r\n  @Get('loans/applications/:id')\r\n  @ApiOperation({ summary: 'Get loan application details' })\r\n  async getLoanApplication(\r\n    @Request() req,\r\n    @Param('id') loanId: string,\r\n  ) {\r\n    return this.loansService.getLoanApplication(req.user.id, loanId);\r\n  }\r\n\r\n  /** User responds to proposed offer */\r\n  @Post('loans/applications/:id/respond')\r\n  @ApiOperation({ summary: 'Respond to proposed loan offer' })\r\n  async respondToOffer(\r\n    @Request() req,\r\n    @Param('id') loanId: string,\r\n    @Body() body: { action: 'ACCEPT' | 'DECLINE' },\r\n  ) {\r\n    return this.loansService.userRespondToOffer(loanId, req.user.id, body.action);\r\n  }\r\n\r\n  /** User: delete own application if not ACTIVE */\r\n  @Delete('loans/applications/:id')\r\n  @ApiOperation({ summary: 'Delete a non-active loan application' })\r\n  async deleteOwn(\r\n    @Request() req,\r\n    @Param('id') loanId: string,\r\n  ) {\r\n    return this.loansService.deleteLoanApplication(req.user.id, loanId);\r\n  }\r\n\r\n  /** Admin: list applications */\r\n  @Get('loans/admin/applications')\r\n  @UseGuards(RolesGuard)\r\n  @Roles('BANK_ADMIN', 'SUPER_ADMIN')\r\n  @ApiOperation({ summary: 'List loan applications (Admin only)' })\r\n  async adminList(@Query('status') status?: string) {\r\n    return this.loansService.adminListApplications(status);\r\n  }\r\n\r\n  /** Admin: propose revised offer */\r\n  @Post('loans/admin/applications/:id/propose')\r\n  @UseGuards(RolesGuard)\r\n  @Roles('BANK_ADMIN', 'SUPER_ADMIN')\r\n  @ApiOperation({ summary: 'Propose a revised offer (Admin only)' })\r\n  async propose(\r\n    @Request() req,\r\n    @Param('id') loanId: string,\r\n    @Body() body: { amount: number; note?: string },\r\n  ) {\r\n    return this.loansService.proposeOffer(loanId, req.user.id, Number(body.amount || 0), body.note);\r\n  }\r\n\r\n  /** Admin: approve */\r\n  @Post('loans/admin/applications/:id/approve')\r\n  @UseGuards(RolesGuard)\r\n  @Roles('BANK_ADMIN', 'SUPER_ADMIN')\r\n  @ApiOperation({ summary: 'Approve loan (Admin only)' })\r\n  async approve(\r\n    @Request() req,\r\n    @Param('id') loanId: string,\r\n    @Body() body: ApproveLoanDto,\r\n  ) {\r\n    return this.loansService.approveLoan(loanId, req.user.id, body);\r\n  }\r\n\r\n  /** Admin: reject */\r\n  @Post('loans/admin/applications/:id/reject')\r\n  @UseGuards(RolesGuard)\r\n  @Roles('BANK_ADMIN', 'SUPER_ADMIN')\r\n  @ApiOperation({ summary: 'Reject loan (Admin only)' })\r\n  async reject(\r\n    @Request() req,\r\n    @Param('id') loanId: string,\r\n    @Body() body: RejectLoanDto,\r\n  ) {\r\n    return this.loansService.rejectLoan(loanId, req.user.id, body);\r\n  }\r\n\r\n  /** Admin: request processing fee */\r\n  @Post('loans/admin/applications/:id/request-fee')\r\n  @UseGuards(RolesGuard)\r\n  @Roles('BANK_ADMIN', 'SUPER_ADMIN')\r\n  @ApiOperation({ summary: 'Request processing fee from user (Admin only)' })\r\n  async requestFee(\r\n    @Request() req,\r\n    @Param('id') loanId: string,\r\n    @Body() body: {\r\n      processingFee: number;\r\n      feeDescription: string;\r\n      cryptoWalletAddress: string;\r\n      cryptoType: string;\r\n      approvalNote?: string;\r\n    },\r\n  ) {\r\n    return this.loansService.requestProcessingFee(loanId, req.user.id, body);\r\n  }\r\n\r\n  /** User: submit fee payment proof */\r\n  @Post('loans/applications/:id/submit-fee-proof')\r\n  @ApiOperation({ summary: 'Submit processing fee payment proof' })\r\n  async submitFeeProof(\r\n    @Request() req,\r\n    @Param('id') loanId: string,\r\n    @Body() body: { proofUrl: string },\r\n  ) {\r\n    return this.loansService.submitFeePaymentProof(req.user.id, loanId, body.proofUrl);\r\n  }\r\n\r\n  /** Admin: verify payment and approve loan */\r\n  @Post('loans/admin/applications/:id/verify-fee')\r\n  @UseGuards(RolesGuard)\r\n  @Roles('BANK_ADMIN', 'SUPER_ADMIN')\r\n  @ApiOperation({ summary: 'Verify fee payment and approve loan (Admin only)' })\r\n  async verifyFee(\r\n    @Request() req,\r\n    @Param('id') loanId: string,\r\n  ) {\r\n    return this.loansService.verifyFeeAndApproveLoan(loanId, req.user.id);\r\n  }\r\n\r\n  /** Admin: disburse */\r\n  @Post('loans/admin/applications/:id/disburse')\r\n  @UseGuards(RolesGuard)\r\n  @Roles('BANK_ADMIN', 'SUPER_ADMIN')\r\n  @ApiOperation({ summary: 'Disburse approved loan (Admin only)' })\r\n  async disburse(\r\n    @Request() req,\r\n    @Param('id') loanId: string,\r\n  ) {\r\n    return this.loansService.disburseLoan(loanId, req.user.id);\r\n  }\r\n\r\n  /** Admin: update loan currency */\r\n  @Post('loans/admin/applications/:id/update-currency')\r\n  @UseGuards(RolesGuard)\r\n  @Roles('BANK_ADMIN', 'SUPER_ADMIN')\r\n  @ApiOperation({ summary: 'Update loan currency (Admin only)' })\r\n  async updateCurrency(\r\n    @Request() req,\r\n    @Param('id') loanId: string,\r\n    @Body() body: { currency: string },\r\n  ) {\r\n    return this.loansService.updateLoanCurrency(loanId, req.user.id, body.currency);\r\n  }\r\n\r\n  /** User: repay loan */\r\n  @Post('loans/applications/:id/repay')\r\n  @ApiOperation({ summary: 'Repay loan from wallet' })\r\n  async repay(\r\n    @Request() req,\r\n    @Param('id') loanId: string,\r\n    @Body() body: { amount: number },\r\n  ) {\r\n    return this.loansService.userRepayLoan(req.user.id, loanId, Number(body.amount || 0));\r\n  }\r\n\r\n  /** User: view loan repayment history */\r\n  @Get('loans/applications/:id/repayments')\r\n  @ApiOperation({ summary: 'Get loan repayment history' })\r\n  async getRepayments(\r\n    @Request() req,\r\n    @Param('id') loanId: string,\r\n  ) {\r\n    return this.loansService.getRepayments(req.user.id, loanId);\r\n  }\r\n\r\n  /**\r\n   * Request a grant\r\n   */\r\n  @Post('grants/apply')\r\n  @ApiOperation({ summary: 'Apply for a grant' })\r\n  async requestGrant(\r\n    @Request() req,\r\n    @Body() data: CreateGrantDto,\r\n  ) {\r\n    return this.loansService.requestGrant(req.user.id, data);\r\n  }\r\n\r\n  /**\r\n   * Get all grants\r\n   */\r\n  @Get('grants/requests')\r\n  @ApiOperation({ summary: 'Get all grant requests' })\r\n  async getGrants(@Request() req) {\r\n    return this.loansService.getGrants(req.user.id);\r\n  }\r\n\r\n  /**\r\n   * Get a specific grant\r\n   */\r\n  @Get('grants/requests/:id')\r\n  @ApiOperation({ summary: 'Get grant details' })\r\n  async getGrant(\r\n    @Request() req,\r\n    @Param('id') grantId: string,\r\n  ) {\r\n    return this.loansService.getGrant(req.user.id, grantId);\r\n  }\r\n}\r\n"],"names":["LoansController","applyForLoan","req","data","loansService","user","id","getLoanApplications","getLoanApplication","loanId","respondToOffer","body","userRespondToOffer","action","deleteOwn","deleteLoanApplication","adminList","status","adminListApplications","propose","proposeOffer","Number","amount","note","approve","approveLoan","reject","rejectLoan","requestFee","requestProcessingFee","submitFeeProof","submitFeePaymentProof","proofUrl","verifyFee","verifyFeeAndApproveLoan","disburse","disburseLoan","updateCurrency","updateLoanCurrency","currency","repay","userRepayLoan","getRepayments","requestGrant","getGrants","getGrant","grantId","summary"],"mappings":"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"}