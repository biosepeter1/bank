{"version":3,"sources":["../../../src/modules/kyc/kyc.service.ts"],"sourcesContent":["import { Injectable, NotFoundException, BadRequestException } from '@nestjs/common';\r\nimport { PrismaService } from '../../prisma/prisma.service';\r\nimport { SubmitKycDto, ReviewKycDto } from './dto/kyc.dto';\r\nimport { EmailService } from '../../common/services/email.service';\r\nimport {\r\n  getKycRequirements,\r\n  validateIdNumber,\r\n  calculateAge,\r\n  KycCountryRequirement,\r\n} from './config/kyc-country.config';\r\n\r\n@Injectable()\r\nexport class KycService {\r\n  constructor(\r\n    private prisma: PrismaService,\r\n    private emailService: EmailService,\r\n  ) {}\r\n\r\n  async getKycRequirementsForCountry(countryCode: string): Promise<KycCountryRequirement> {\r\n    return getKycRequirements(countryCode);\r\n  }\r\n\r\n  async submitKyc(userId: string, submitKycDto: SubmitKycDto) {\r\n    // Get user to check their country\r\n    const user = await this.prisma.user.findUnique({\r\n      where: { id: userId },\r\n    });\r\n\r\n    if (!user) {\r\n      throw new NotFoundException('User not found');\r\n    }\r\n\r\n    // Get country requirements\r\n    const requirements = getKycRequirements(submitKycDto.country || user.country);\r\n\r\n    // Validate age\r\n    const dob = new Date(submitKycDto.dateOfBirth);\r\n    const age = calculateAge(dob);\r\n    if (age < requirements.minAge) {\r\n      throw new BadRequestException(\r\n        `You must be at least ${requirements.minAge} years old to register`,\r\n      );\r\n    }\r\n\r\n    // Validate ID number format (if applicable)\r\n    const idValidation = validateIdNumber(\r\n      submitKycDto.country || user.country,\r\n      submitKycDto.idType,\r\n      submitKycDto.idNumber,\r\n    );\r\n\r\n    if (!idValidation.valid) {\r\n      throw new BadRequestException(idValidation.error);\r\n    }\r\n\r\n    // Validate required fields based on country\r\n    if (requirements.addressFields.state && !submitKycDto.state) {\r\n      throw new BadRequestException('State is required for your country');\r\n    }\r\n\r\n    if (requirements.addressFields.postalCode && !submitKycDto.postalCode) {\r\n      throw new BadRequestException('Postal code is required for your country');\r\n    }\r\n\r\n    // Validate required documents\r\n    if (requirements.requiredDocuments.idDocument && !submitKycDto.idDocumentUrl) {\r\n      throw new BadRequestException('ID document is required');\r\n    }\r\n\r\n    if (requirements.requiredDocuments.proofOfAddress && !submitKycDto.proofOfAddressUrl) {\r\n      throw new BadRequestException('Proof of address is required');\r\n    }\r\n\r\n    if (requirements.requiredDocuments.selfie && !submitKycDto.selfieUrl) {\r\n      throw new BadRequestException('Selfie is required');\r\n    }\r\n\r\n    // Check if ID type is valid for the country\r\n    const validIdTypes = requirements.idTypes.map((t) => t.value);\r\n    if (!validIdTypes.includes(submitKycDto.idType)) {\r\n      throw new BadRequestException(\r\n        `Invalid ID type for ${requirements.country}. Valid types: ${validIdTypes.join(', ')}`,\r\n      );\r\n    }\r\n\r\n    // Check if KYC already exists\r\n    const existing = await this.prisma.kYC.findUnique({\r\n      where: { userId },\r\n    });\r\n\r\n    if (existing) {\r\n      // Only allow updates if status is PENDING or RESUBMIT_REQUIRED\r\n      if (!['PENDING', 'RESUBMIT_REQUIRED', 'REJECTED'].includes(existing.status)) {\r\n        throw new BadRequestException(\r\n          'KYC already submitted and is under review or approved',\r\n        );\r\n      }\r\n\r\n      // Update existing KYC\r\n      return this.prisma.kYC.update({\r\n        where: { userId },\r\n        data: {\r\n          ...submitKycDto,\r\n          dateOfBirth: dob,\r\n          status: 'PENDING',\r\n          submittedAt: new Date(),\r\n          rejectionReason: null, // Clear previous rejection reason\r\n        },\r\n      });\r\n    }\r\n\r\n    // Create new KYC\r\n    return this.prisma.kYC.create({\r\n      data: {\r\n        userId,\r\n        ...submitKycDto,\r\n        dateOfBirth: dob,\r\n        status: 'PENDING',\r\n        submittedAt: new Date(),\r\n      },\r\n    });\r\n  }\r\n\r\n  async getKycStatus(userId: string) {\r\n    const kyc = await this.prisma.kYC.findUnique({\r\n      where: { userId },\r\n    });\r\n\r\n    if (!kyc) {\r\n      return { status: 'NOT_SUBMITTED', message: 'KYC not submitted yet' };\r\n    }\r\n\r\n    return kyc;\r\n  }\r\n\r\n  async getAllKyc() {\r\n    return this.prisma.kYC.findMany({\r\n      include: {\r\n        user: {\r\n          select: {\r\n            id: true,\r\n            email: true,\r\n            firstName: true,\r\n            lastName: true,\r\n            phone: true,\r\n          },\r\n        },\r\n      },\r\n      orderBy: { submittedAt: 'desc' },\r\n    });\r\n  }\r\n\r\n  async getAllPendingKyc() {\r\n    return this.prisma.kYC.findMany({\r\n      where: {\r\n        status: 'PENDING',\r\n      },\r\n      include: {\r\n        user: {\r\n          select: {\r\n            id: true,\r\n            email: true,\r\n            firstName: true,\r\n            lastName: true,\r\n            phone: true,\r\n          },\r\n        },\r\n      },\r\n      orderBy: { submittedAt: 'desc' },\r\n    });\r\n  }\r\n\r\n  async reviewKyc(kycId: string, reviewerId: string, reviewKycDto: ReviewKycDto) {\r\n    const kyc = await this.prisma.kYC.findUnique({\r\n      where: { id: kycId },\r\n    });\r\n\r\n    if (!kyc) {\r\n      throw new NotFoundException('KYC not found');\r\n    }\r\n\r\n    // Update KYC status\r\n    const updated = await this.prisma.kYC.update({\r\n      where: { id: kycId },\r\n      data: {\r\n        status: reviewKycDto.status,\r\n        reviewedBy: reviewerId,\r\n        reviewedAt: new Date(),\r\n        rejectionReason: reviewKycDto.rejectionReason,\r\n      },\r\n    });\r\n\r\n    // Fetch user details for email\r\n    const user = await this.prisma.user.findUnique({\r\n      where: { id: kyc.userId },\r\n      select: { email: true, firstName: true, accountStatus: true },\r\n    });\r\n\r\n    if (!user) {\r\n      throw new NotFoundException('User not found');\r\n    }\r\n\r\n    // Update user account status and send notifications based on KYC review\r\n    if (reviewKycDto.status === 'APPROVED') {\r\n      // Activate user account when KYC is approved\r\n      await this.prisma.user.update({\r\n        where: { id: kyc.userId },\r\n        data: { accountStatus: 'ACTIVE' },\r\n      });\r\n\r\n      // Create in-app notification\r\n      await this.prisma.notification.create({\r\n        data: {\r\n          userId: kyc.userId,\r\n          title: 'KYC Approved',\r\n          message: 'Your KYC verification has been approved. Your account is now active!',\r\n          type: 'SUCCESS',\r\n        },\r\n      });\r\n\r\n      // Send email notification (non-blocking)\r\n      try {\r\n        await this.emailService.sendKycStatusEmail({\r\n          email: user.email,\r\n          firstName: user.firstName,\r\n          status: 'APPROVED',\r\n        });\r\n      } catch (error) {\r\n        console.error('Failed to send KYC approval email:', error);\r\n      }\r\n    } else if (reviewKycDto.status === 'REJECTED') {\r\n      // Suspend user account when KYC is rejected\r\n      await this.prisma.user.update({\r\n        where: { id: kyc.userId },\r\n        data: { accountStatus: 'SUSPENDED' },\r\n      });\r\n\r\n      // Create in-app notification\r\n      await this.prisma.notification.create({\r\n        data: {\r\n          userId: kyc.userId,\r\n          title: 'KYC Rejected',\r\n          message: `Your KYC verification has been rejected. Reason: ${reviewKycDto.rejectionReason || 'Please contact support for more information.'}`,\r\n          type: 'ERROR',\r\n        },\r\n      });\r\n\r\n      // Send email notification (non-blocking)\r\n      try {\r\n        await this.emailService.sendKycStatusEmail({\r\n          email: user.email,\r\n          firstName: user.firstName,\r\n          status: 'REJECTED',\r\n          reason: reviewKycDto.rejectionReason,\r\n        });\r\n      } catch (error) {\r\n        console.error('Failed to send KYC rejection email:', error);\r\n      }\r\n    } else if (reviewKycDto.status === 'RESUBMIT_REQUIRED') {\r\n      // Keep account as PENDING when resubmission is required\r\n      await this.prisma.user.update({\r\n        where: { id: kyc.userId },\r\n        data: { accountStatus: 'PENDING' },\r\n      });\r\n\r\n      // Create in-app notification\r\n      await this.prisma.notification.create({\r\n        data: {\r\n          userId: kyc.userId,\r\n          title: 'KYC Resubmission Required',\r\n          message: `Please resubmit your KYC documents. ${reviewKycDto.rejectionReason || ''}`,\r\n          type: 'WARNING',\r\n        },\r\n      });\r\n\r\n      // Send email notification (non-blocking)\r\n      try {\r\n        await this.emailService.sendKycStatusEmail({\r\n          email: user.email,\r\n          firstName: user.firstName,\r\n          status: 'RESUBMIT_REQUIRED',\r\n          reason: reviewKycDto.rejectionReason,\r\n        });\r\n      } catch (error) {\r\n        console.error('Failed to send KYC resubmission email:', error);\r\n      }\r\n    }\r\n\r\n    // Create audit log\r\n    const reviewer = await this.prisma.user.findUnique({ where: { id: reviewerId } });\r\n    if (!reviewer) {\r\n      throw new NotFoundException('Reviewer user not found');\r\n    }\r\n    await this.prisma.auditLog.create({\r\n      data: {\r\n        userId: reviewerId,\r\n        actorEmail: reviewer.email,\r\n        actorRole: reviewer.role,\r\n        action: reviewKycDto.status === 'APPROVED' ? 'KYC_APPROVED' : 'KYC_REJECTED',\r\n        entity: 'KYC',\r\n        entityId: kycId,\r\n        description: `Admin ${reviewKycDto.status.toLowerCase()} KYC for user ${kyc.userId}`,\r\n        metadata: reviewKycDto.rejectionReason ? { rejectionReason: reviewKycDto.rejectionReason } : undefined,\r\n      },\r\n    });\r\n\r\n    return updated;\r\n  }\r\n}\r\n"],"names":["KycService","getKycRequirementsForCountry","countryCode","getKycRequirements","submitKyc","userId","submitKycDto","user","prisma","findUnique","where","id","NotFoundException","requirements","country","dob","Date","dateOfBirth","age","calculateAge","minAge","BadRequestException","idValidation","validateIdNumber","idType","idNumber","valid","error","addressFields","state","postalCode","requiredDocuments","idDocument","idDocumentUrl","proofOfAddress","proofOfAddressUrl","selfie","selfieUrl","validIdTypes","idTypes","map","t","value","includes","join","existing","kYC","status","update","data","submittedAt","rejectionReason","create","getKycStatus","kyc","message","getAllKyc","findMany","include","select","email","firstName","lastName","phone","orderBy","getAllPendingKyc","reviewKyc","kycId","reviewerId","reviewKycDto","updated","reviewedBy","reviewedAt","accountStatus","notification","title","type","emailService","sendKycStatusEmail","console","reason","reviewer","auditLog","actorEmail","actorRole","role","action","entity","entityId","description","toLowerCase","metadata","undefined"],"mappings":";;;;+BAYaA;;;eAAAA;;;wBAZsD;+BACrC;8BAED;kCAMtB;;;;;;;;;;AAGA,IAAA,AAAMA,aAAN,MAAMA;IAMX,MAAMC,6BAA6BC,WAAmB,EAAkC;QACtF,OAAOC,IAAAA,oCAAkB,EAACD;IAC5B;IAEA,MAAME,UAAUC,MAAc,EAAEC,YAA0B,EAAE;QAC1D,kCAAkC;QAClC,MAAMC,OAAO,MAAM,IAAI,CAACC,MAAM,CAACD,IAAI,CAACE,UAAU,CAAC;YAC7CC,OAAO;gBAAEC,IAAIN;YAAO;QACtB;QAEA,IAAI,CAACE,MAAM;YACT,MAAM,IAAIK,yBAAiB,CAAC;QAC9B;QAEA,2BAA2B;QAC3B,MAAMC,eAAeV,IAAAA,oCAAkB,EAACG,aAAaQ,OAAO,IAAIP,KAAKO,OAAO;QAE5E,eAAe;QACf,MAAMC,MAAM,IAAIC,KAAKV,aAAaW,WAAW;QAC7C,MAAMC,MAAMC,IAAAA,8BAAY,EAACJ;QACzB,IAAIG,MAAML,aAAaO,MAAM,EAAE;YAC7B,MAAM,IAAIC,2BAAmB,CAC3B,CAAC,qBAAqB,EAAER,aAAaO,MAAM,CAAC,sBAAsB,CAAC;QAEvE;QAEA,4CAA4C;QAC5C,MAAME,eAAeC,IAAAA,kCAAgB,EACnCjB,aAAaQ,OAAO,IAAIP,KAAKO,OAAO,EACpCR,aAAakB,MAAM,EACnBlB,aAAamB,QAAQ;QAGvB,IAAI,CAACH,aAAaI,KAAK,EAAE;YACvB,MAAM,IAAIL,2BAAmB,CAACC,aAAaK,KAAK;QAClD;QAEA,4CAA4C;QAC5C,IAAId,aAAae,aAAa,CAACC,KAAK,IAAI,CAACvB,aAAauB,KAAK,EAAE;YAC3D,MAAM,IAAIR,2BAAmB,CAAC;QAChC;QAEA,IAAIR,aAAae,aAAa,CAACE,UAAU,IAAI,CAACxB,aAAawB,UAAU,EAAE;YACrE,MAAM,IAAIT,2BAAmB,CAAC;QAChC;QAEA,8BAA8B;QAC9B,IAAIR,aAAakB,iBAAiB,CAACC,UAAU,IAAI,CAAC1B,aAAa2B,aAAa,EAAE;YAC5E,MAAM,IAAIZ,2BAAmB,CAAC;QAChC;QAEA,IAAIR,aAAakB,iBAAiB,CAACG,cAAc,IAAI,CAAC5B,aAAa6B,iBAAiB,EAAE;YACpF,MAAM,IAAId,2BAAmB,CAAC;QAChC;QAEA,IAAIR,aAAakB,iBAAiB,CAACK,MAAM,IAAI,CAAC9B,aAAa+B,SAAS,EAAE;YACpE,MAAM,IAAIhB,2BAAmB,CAAC;QAChC;QAEA,4CAA4C;QAC5C,MAAMiB,eAAezB,aAAa0B,OAAO,CAACC,GAAG,CAAC,CAACC,IAAMA,EAAEC,KAAK;QAC5D,IAAI,CAACJ,aAAaK,QAAQ,CAACrC,aAAakB,MAAM,GAAG;YAC/C,MAAM,IAAIH,2BAAmB,CAC3B,CAAC,oBAAoB,EAAER,aAAaC,OAAO,CAAC,eAAe,EAAEwB,aAAaM,IAAI,CAAC,OAAO;QAE1F;QAEA,8BAA8B;QAC9B,MAAMC,WAAW,MAAM,IAAI,CAACrC,MAAM,CAACsC,GAAG,CAACrC,UAAU,CAAC;YAChDC,OAAO;gBAAEL;YAAO;QAClB;QAEA,IAAIwC,UAAU;YACZ,+DAA+D;YAC/D,IAAI,CAAC;gBAAC;gBAAW;gBAAqB;aAAW,CAACF,QAAQ,CAACE,SAASE,MAAM,GAAG;gBAC3E,MAAM,IAAI1B,2BAAmB,CAC3B;YAEJ;YAEA,sBAAsB;YACtB,OAAO,IAAI,CAACb,MAAM,CAACsC,GAAG,CAACE,MAAM,CAAC;gBAC5BtC,OAAO;oBAAEL;gBAAO;gBAChB4C,MAAM;oBACJ,GAAG3C,YAAY;oBACfW,aAAaF;oBACbgC,QAAQ;oBACRG,aAAa,IAAIlC;oBACjBmC,iBAAiB;gBACnB;YACF;QACF;QAEA,iBAAiB;QACjB,OAAO,IAAI,CAAC3C,MAAM,CAACsC,GAAG,CAACM,MAAM,CAAC;YAC5BH,MAAM;gBACJ5C;gBACA,GAAGC,YAAY;gBACfW,aAAaF;gBACbgC,QAAQ;gBACRG,aAAa,IAAIlC;YACnB;QACF;IACF;IAEA,MAAMqC,aAAahD,MAAc,EAAE;QACjC,MAAMiD,MAAM,MAAM,IAAI,CAAC9C,MAAM,CAACsC,GAAG,CAACrC,UAAU,CAAC;YAC3CC,OAAO;gBAAEL;YAAO;QAClB;QAEA,IAAI,CAACiD,KAAK;YACR,OAAO;gBAAEP,QAAQ;gBAAiBQ,SAAS;YAAwB;QACrE;QAEA,OAAOD;IACT;IAEA,MAAME,YAAY;QAChB,OAAO,IAAI,CAAChD,MAAM,CAACsC,GAAG,CAACW,QAAQ,CAAC;YAC9BC,SAAS;gBACPnD,MAAM;oBACJoD,QAAQ;wBACNhD,IAAI;wBACJiD,OAAO;wBACPC,WAAW;wBACXC,UAAU;wBACVC,OAAO;oBACT;gBACF;YACF;YACAC,SAAS;gBAAEd,aAAa;YAAO;QACjC;IACF;IAEA,MAAMe,mBAAmB;QACvB,OAAO,IAAI,CAACzD,MAAM,CAACsC,GAAG,CAACW,QAAQ,CAAC;YAC9B/C,OAAO;gBACLqC,QAAQ;YACV;YACAW,SAAS;gBACPnD,MAAM;oBACJoD,QAAQ;wBACNhD,IAAI;wBACJiD,OAAO;wBACPC,WAAW;wBACXC,UAAU;wBACVC,OAAO;oBACT;gBACF;YACF;YACAC,SAAS;gBAAEd,aAAa;YAAO;QACjC;IACF;IAEA,MAAMgB,UAAUC,KAAa,EAAEC,UAAkB,EAAEC,YAA0B,EAAE;QAC7E,MAAMf,MAAM,MAAM,IAAI,CAAC9C,MAAM,CAACsC,GAAG,CAACrC,UAAU,CAAC;YAC3CC,OAAO;gBAAEC,IAAIwD;YAAM;QACrB;QAEA,IAAI,CAACb,KAAK;YACR,MAAM,IAAI1C,yBAAiB,CAAC;QAC9B;QAEA,oBAAoB;QACpB,MAAM0D,UAAU,MAAM,IAAI,CAAC9D,MAAM,CAACsC,GAAG,CAACE,MAAM,CAAC;YAC3CtC,OAAO;gBAAEC,IAAIwD;YAAM;YACnBlB,MAAM;gBACJF,QAAQsB,aAAatB,MAAM;gBAC3BwB,YAAYH;gBACZI,YAAY,IAAIxD;gBAChBmC,iBAAiBkB,aAAalB,eAAe;YAC/C;QACF;QAEA,+BAA+B;QAC/B,MAAM5C,OAAO,MAAM,IAAI,CAACC,MAAM,CAACD,IAAI,CAACE,UAAU,CAAC;YAC7CC,OAAO;gBAAEC,IAAI2C,IAAIjD,MAAM;YAAC;YACxBsD,QAAQ;gBAAEC,OAAO;gBAAMC,WAAW;gBAAMY,eAAe;YAAK;QAC9D;QAEA,IAAI,CAAClE,MAAM;YACT,MAAM,IAAIK,yBAAiB,CAAC;QAC9B;QAEA,wEAAwE;QACxE,IAAIyD,aAAatB,MAAM,KAAK,YAAY;YACtC,6CAA6C;YAC7C,MAAM,IAAI,CAACvC,MAAM,CAACD,IAAI,CAACyC,MAAM,CAAC;gBAC5BtC,OAAO;oBAAEC,IAAI2C,IAAIjD,MAAM;gBAAC;gBACxB4C,MAAM;oBAAEwB,eAAe;gBAAS;YAClC;YAEA,6BAA6B;YAC7B,MAAM,IAAI,CAACjE,MAAM,CAACkE,YAAY,CAACtB,MAAM,CAAC;gBACpCH,MAAM;oBACJ5C,QAAQiD,IAAIjD,MAAM;oBAClBsE,OAAO;oBACPpB,SAAS;oBACTqB,MAAM;gBACR;YACF;YAEA,yCAAyC;YACzC,IAAI;gBACF,MAAM,IAAI,CAACC,YAAY,CAACC,kBAAkB,CAAC;oBACzClB,OAAOrD,KAAKqD,KAAK;oBACjBC,WAAWtD,KAAKsD,SAAS;oBACzBd,QAAQ;gBACV;YACF,EAAE,OAAOpB,OAAO;gBACdoD,QAAQpD,KAAK,CAAC,sCAAsCA;YACtD;QACF,OAAO,IAAI0C,aAAatB,MAAM,KAAK,YAAY;YAC7C,4CAA4C;YAC5C,MAAM,IAAI,CAACvC,MAAM,CAACD,IAAI,CAACyC,MAAM,CAAC;gBAC5BtC,OAAO;oBAAEC,IAAI2C,IAAIjD,MAAM;gBAAC;gBACxB4C,MAAM;oBAAEwB,eAAe;gBAAY;YACrC;YAEA,6BAA6B;YAC7B,MAAM,IAAI,CAACjE,MAAM,CAACkE,YAAY,CAACtB,MAAM,CAAC;gBACpCH,MAAM;oBACJ5C,QAAQiD,IAAIjD,MAAM;oBAClBsE,OAAO;oBACPpB,SAAS,CAAC,iDAAiD,EAAEc,aAAalB,eAAe,IAAI,gDAAgD;oBAC7IyB,MAAM;gBACR;YACF;YAEA,yCAAyC;YACzC,IAAI;gBACF,MAAM,IAAI,CAACC,YAAY,CAACC,kBAAkB,CAAC;oBACzClB,OAAOrD,KAAKqD,KAAK;oBACjBC,WAAWtD,KAAKsD,SAAS;oBACzBd,QAAQ;oBACRiC,QAAQX,aAAalB,eAAe;gBACtC;YACF,EAAE,OAAOxB,OAAO;gBACdoD,QAAQpD,KAAK,CAAC,uCAAuCA;YACvD;QACF,OAAO,IAAI0C,aAAatB,MAAM,KAAK,qBAAqB;YACtD,wDAAwD;YACxD,MAAM,IAAI,CAACvC,MAAM,CAACD,IAAI,CAACyC,MAAM,CAAC;gBAC5BtC,OAAO;oBAAEC,IAAI2C,IAAIjD,MAAM;gBAAC;gBACxB4C,MAAM;oBAAEwB,eAAe;gBAAU;YACnC;YAEA,6BAA6B;YAC7B,MAAM,IAAI,CAACjE,MAAM,CAACkE,YAAY,CAACtB,MAAM,CAAC;gBACpCH,MAAM;oBACJ5C,QAAQiD,IAAIjD,MAAM;oBAClBsE,OAAO;oBACPpB,SAAS,CAAC,oCAAoC,EAAEc,aAAalB,eAAe,IAAI,IAAI;oBACpFyB,MAAM;gBACR;YACF;YAEA,yCAAyC;YACzC,IAAI;gBACF,MAAM,IAAI,CAACC,YAAY,CAACC,kBAAkB,CAAC;oBACzClB,OAAOrD,KAAKqD,KAAK;oBACjBC,WAAWtD,KAAKsD,SAAS;oBACzBd,QAAQ;oBACRiC,QAAQX,aAAalB,eAAe;gBACtC;YACF,EAAE,OAAOxB,OAAO;gBACdoD,QAAQpD,KAAK,CAAC,0CAA0CA;YAC1D;QACF;QAEA,mBAAmB;QACnB,MAAMsD,WAAW,MAAM,IAAI,CAACzE,MAAM,CAACD,IAAI,CAACE,UAAU,CAAC;YAAEC,OAAO;gBAAEC,IAAIyD;YAAW;QAAE;QAC/E,IAAI,CAACa,UAAU;YACb,MAAM,IAAIrE,yBAAiB,CAAC;QAC9B;QACA,MAAM,IAAI,CAACJ,MAAM,CAAC0E,QAAQ,CAAC9B,MAAM,CAAC;YAChCH,MAAM;gBACJ5C,QAAQ+D;gBACRe,YAAYF,SAASrB,KAAK;gBAC1BwB,WAAWH,SAASI,IAAI;gBACxBC,QAAQjB,aAAatB,MAAM,KAAK,aAAa,iBAAiB;gBAC9DwC,QAAQ;gBACRC,UAAUrB;gBACVsB,aAAa,CAAC,MAAM,EAAEpB,aAAatB,MAAM,CAAC2C,WAAW,GAAG,cAAc,EAAEpC,IAAIjD,MAAM,EAAE;gBACpFsF,UAAUtB,aAAalB,eAAe,GAAG;oBAAEA,iBAAiBkB,aAAalB,eAAe;gBAAC,IAAIyC;YAC/F;QACF;QAEA,OAAOtB;IACT;IAtSA,YACE,AAAQ9D,MAAqB,EAC7B,AAAQqE,YAA0B,CAClC;aAFQrE,SAAAA;aACAqE,eAAAA;IACP;AAoSL"}