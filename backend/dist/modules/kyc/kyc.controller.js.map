{"version":3,"sources":["../../../src/modules/kyc/kyc.controller.ts"],"sourcesContent":["import { \r\n  Controller, \r\n  Get, \r\n  Post, \r\n  Body, \r\n  Param, \r\n  UseGuards,\r\n  UseInterceptors,\r\n  UploadedFiles,\r\n  BadRequestException,\r\n  Query,\r\n} from '@nestjs/common';\r\nimport { FileFieldsInterceptor } from '@nestjs/platform-express';\r\nimport { ApiTags, ApiOperation, ApiBearerAuth, ApiConsumes, ApiQuery } from '@nestjs/swagger';\r\nimport { KycService } from './kyc.service';\r\nimport { SubmitKycDto, ReviewKycDto, GetKycRequirementsDto } from './dto/kyc.dto';\r\nimport { JwtAuthGuard } from '../../common/guards/jwt-auth.guard';\r\nimport { RolesGuard } from '../../common/guards/roles.guard';\r\nimport { Roles } from '../../common/decorators/roles.decorator';\r\nimport { CurrentUser } from '../../common/decorators/current-user.decorator';\r\nimport { AllowSuspended } from '../../common/decorators/allow-suspended.decorator';\r\nimport { UploadService } from '../../common/upload/upload.service';\r\n\r\n@ApiTags('kyc')\r\n@Controller('kyc')\r\n@UseGuards(JwtAuthGuard)\r\n@ApiBearerAuth()\r\nexport class KycController {\r\n  constructor(\r\n    private readonly kycService: KycService,\r\n    private readonly uploadService: UploadService,\r\n  ) {}\r\n\r\n  @Get('requirements')\r\n  @AllowSuspended() // Suspended users can view KYC requirements\r\n  @ApiOperation({ summary: 'Get KYC requirements for a country' })\r\n  @ApiQuery({ name: 'countryCode', required: false, example: 'NG' })\r\n  async getRequirements(@Query('countryCode') countryCode?: string, @CurrentUser() user?: any) {\r\n    // Use country code from query, or fall back to user's country\r\n    const code = countryCode || user?.country || 'DEFAULT';\r\n    return this.kycService.getKycRequirementsForCountry(code);\r\n  }\r\n\r\n  @Post('upload/id-document')\r\n  @AllowSuspended() // Suspended users can upload KYC documents\r\n  @ApiOperation({ summary: 'Upload ID document' })\r\n  @ApiConsumes('multipart/form-data')\r\n  @UseInterceptors(\r\n    FileFieldsInterceptor([{ name: 'file', maxCount: 1 }], {\r\n      storage: require('multer').diskStorage({\r\n        destination: (req, file, cb) => {\r\n          const path = require('path');\r\n          const uploadPath = path.join(process.cwd(), 'uploads', 'kyc', 'id-documents');\r\n          cb(null, uploadPath);\r\n        },\r\n        filename: (req, file, cb) => {\r\n          const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1e9);\r\n          const ext = require('path').extname(file.originalname);\r\n          cb(null, `id-doc-${uniqueSuffix}${ext}`);\r\n        },\r\n      }),\r\n      fileFilter: (req, file, callback) => {\r\n        const allowedMimeTypes = [\r\n          'image/jpeg',\r\n          'image/jpg',\r\n          'image/png',\r\n          'image/webp',\r\n          'application/pdf',\r\n        ];\r\n        if (allowedMimeTypes.includes(file.mimetype)) {\r\n          callback(null, true);\r\n        } else {\r\n          callback(\r\n            new BadRequestException(\r\n              'Invalid file type. Only JPEG, PNG, WEBP, and PDF files are allowed.',\r\n            ),\r\n            false,\r\n          );\r\n        }\r\n      },\r\n      limits: { fileSize: 5 * 1024 * 1024 },\r\n    }),\r\n  )\r\n  async uploadIdDocument(\r\n    @UploadedFiles() files: { file?: Express.Multer.File[] },\r\n  ) {\r\n    if (!files?.file?.[0]) {\r\n      throw new BadRequestException('No file uploaded');\r\n    }\r\n    return {\r\n      url: this.uploadService.getFileUrl(`kyc/id-documents/${files.file[0].filename}`),\r\n      filename: files.file[0].filename,\r\n    };\r\n  }\r\n\r\n  @Post('upload/proof-of-address')\r\n  @AllowSuspended() // Suspended users can upload KYC documents\r\n  @ApiOperation({ summary: 'Upload proof of address' })\r\n  @ApiConsumes('multipart/form-data')\r\n  @UseInterceptors(\r\n    FileFieldsInterceptor([{ name: 'file', maxCount: 1 }], {\r\n      storage: require('multer').diskStorage({\r\n        destination: (req, file, cb) => {\r\n          const path = require('path');\r\n          const uploadPath = path.join(process.cwd(), 'uploads', 'kyc', 'proof-of-address');\r\n          cb(null, uploadPath);\r\n        },\r\n        filename: (req, file, cb) => {\r\n          const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1e9);\r\n          const ext = require('path').extname(file.originalname);\r\n          cb(null, `proof-${uniqueSuffix}${ext}`);\r\n        },\r\n      }),\r\n      fileFilter: (req, file, callback) => {\r\n        const allowedMimeTypes = [\r\n          'image/jpeg',\r\n          'image/jpg',\r\n          'image/png',\r\n          'image/webp',\r\n          'application/pdf',\r\n        ];\r\n        if (allowedMimeTypes.includes(file.mimetype)) {\r\n          callback(null, true);\r\n        } else {\r\n          callback(\r\n            new BadRequestException(\r\n              'Invalid file type. Only JPEG, PNG, WEBP, and PDF files are allowed.',\r\n            ),\r\n            false,\r\n          );\r\n        }\r\n      },\r\n      limits: { fileSize: 5 * 1024 * 1024 },\r\n    }),\r\n  )\r\n  async uploadProofOfAddress(\r\n    @UploadedFiles() files: { file?: Express.Multer.File[] },\r\n  ) {\r\n    if (!files?.file?.[0]) {\r\n      throw new BadRequestException('No file uploaded');\r\n    }\r\n    return {\r\n      url: this.uploadService.getFileUrl(`kyc/proof-of-address/${files.file[0].filename}`),\r\n      filename: files.file[0].filename,\r\n    };\r\n  }\r\n\r\n  @Post('upload/selfie')\r\n  @AllowSuspended() // Suspended users can upload KYC documents\r\n  @ApiOperation({ summary: 'Upload selfie' })\r\n  @ApiConsumes('multipart/form-data')\r\n  @UseInterceptors(\r\n    FileFieldsInterceptor([{ name: 'file', maxCount: 1 }], {\r\n      storage: require('multer').diskStorage({\r\n        destination: (req, file, cb) => {\r\n          const path = require('path');\r\n          const uploadPath = path.join(process.cwd(), 'uploads', 'kyc', 'selfies');\r\n          cb(null, uploadPath);\r\n        },\r\n        filename: (req, file, cb) => {\r\n          const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1e9);\r\n          const ext = require('path').extname(file.originalname);\r\n          cb(null, `selfie-${uniqueSuffix}${ext}`);\r\n        },\r\n      }),\r\n      fileFilter: (req, file, callback) => {\r\n        const allowedMimeTypes = [\r\n          'image/jpeg',\r\n          'image/jpg',\r\n          'image/png',\r\n          'image/webp',\r\n        ];\r\n        if (allowedMimeTypes.includes(file.mimetype)) {\r\n          callback(null, true);\r\n        } else {\r\n          callback(\r\n            new BadRequestException(\r\n              'Invalid file type. Only JPEG, PNG, and WEBP images are allowed.',\r\n            ),\r\n            false,\r\n          );\r\n        }\r\n      },\r\n      limits: { fileSize: 5 * 1024 * 1024 },\r\n    }),\r\n  )\r\n  async uploadSelfie(\r\n    @UploadedFiles() files: { file?: Express.Multer.File[] },\r\n  ) {\r\n    if (!files?.file?.[0]) {\r\n      throw new BadRequestException('No file uploaded');\r\n    }\r\n    return {\r\n      url: this.uploadService.getFileUrl(`kyc/selfies/${files.file[0].filename}`),\r\n      filename: files.file[0].filename,\r\n    };\r\n  }\r\n\r\n  @Post('submit')\r\n  @AllowSuspended() // Suspended users can submit KYC to get their account unsuspended\r\n  @ApiOperation({ summary: 'Submit KYC documents' })\r\n  async submitKyc(@CurrentUser() user: any, @Body() submitKycDto: SubmitKycDto) {\r\n    return this.kycService.submitKyc(user.id, submitKycDto);\r\n  }\r\n\r\n  @Get('status')\r\n  @AllowSuspended() // Suspended users can view their KYC status\r\n  @ApiOperation({ summary: 'Get KYC status' })\r\n  getStatus(@CurrentUser() user: any) {\r\n    return this.kycService.getKycStatus(user.id);\r\n  }\r\n\r\n  @Get('all')\r\n  @UseGuards(RolesGuard)\r\n  @Roles('SUPER_ADMIN', 'BANK_ADMIN')\r\n  @ApiOperation({ summary: 'Get all KYC documents (Admin only)' })\r\n  getAll() {\r\n    return this.kycService.getAllKyc();\r\n  }\r\n\r\n  @Get('pending')\r\n  @UseGuards(RolesGuard)\r\n  @Roles('SUPER_ADMIN', 'BANK_ADMIN')\r\n  @ApiOperation({ summary: 'Get all pending KYC (Admin only)' })\r\n  getPending() {\r\n    return this.kycService.getAllPendingKyc();\r\n  }\r\n\r\n  @Post('review/:id')\r\n  @UseGuards(RolesGuard)\r\n  @Roles('SUPER_ADMIN', 'BANK_ADMIN')\r\n  @ApiOperation({ summary: 'Review KYC (Admin only)' })\r\n  reviewKyc(\r\n    @Param('id') id: string,\r\n    @CurrentUser() user: any,\r\n    @Body() reviewKycDto: ReviewKycDto,\r\n  ) {\r\n    return this.kycService.reviewKyc(id, user.id, reviewKycDto);\r\n  }\r\n}\r\n"],"names":["KycController","getRequirements","countryCode","user","code","country","kycService","getKycRequirementsForCountry","uploadIdDocument","files","file","BadRequestException","url","uploadService","getFileUrl","filename","uploadProofOfAddress","uploadSelfie","submitKyc","submitKycDto","id","getStatus","getKycStatus","getAll","getAllKyc","getPending","getAllPendingKyc","reviewKyc","reviewKycDto","summary","name","required","example","maxCount","storage","require","diskStorage","destination","req","cb","path","uploadPath","join","process","cwd","uniqueSuffix","Date","now","Math","round","random","ext","extname","originalname","fileFilter","callback","allowedMimeTypes","includes","mimetype","limits","fileSize"],"mappings":"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"}