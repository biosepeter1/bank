{"version":3,"sources":["../../../src/modules/transactions/transactions.service.ts"],"sourcesContent":["import { Injectable } from '@nestjs/common';\r\nimport { PrismaService } from '../../prisma/prisma.service';\r\n\r\n@Injectable()\r\nexport class TransactionsService {\r\n  constructor(private prisma: PrismaService) { }\r\n\r\n  async getUserTransactions(userId: string, limit = 50) {\r\n    const list = await this.prisma.transaction.findMany({\r\n      where: { userId },\r\n      orderBy: { createdAt: 'desc' },\r\n      take: limit,\r\n      include: {\r\n        transfer: {\r\n          include: {\r\n            sender: {\r\n              select: { id: true, firstName: true, lastName: true, email: true },\r\n            },\r\n            receiver: {\r\n              select: { id: true, firstName: true, lastName: true, email: true },\r\n            },\r\n          },\r\n        },\r\n      },\r\n    });\r\n\r\n    // Compute signedAmount per transaction on the server to avoid brittle UI heuristics\r\n    const withSigned = list.map((tx) => {\r\n      const amount = Number(tx.amount);\r\n      const before = tx.balanceBefore == null ? null : Number(tx.balanceBefore as any);\r\n      const after = tx.balanceAfter == null ? null : Number(tx.balanceAfter as any);\r\n\r\n      const deltaKnown = before !== null && after !== null;\r\n      const balanceIncreased = deltaKnown ? after! > before! : undefined;\r\n\r\n      const lowerDesc = (tx as any).description?.toLowerCase?.() || '';\r\n\r\n      let signedAmount = amount; // default positive\r\n      switch (tx.type) {\r\n        case 'DEPOSIT':\r\n        case 'PAYMENT_GATEWAY_DEPOSIT':\r\n        case 'REFUND':\r\n        case 'INVESTMENT_MATURITY':\r\n          signedAmount = amount; // credit\r\n          break;\r\n        case 'WITHDRAWAL':\r\n        case 'PAYMENT_GATEWAY_WITHDRAWAL':\r\n        case 'FEE':\r\n        case 'CARD_PAYMENT':\r\n        case 'INVESTMENT':\r\n        case 'INVESTMENT_LIQUIDATION':\r\n          signedAmount = -amount; // debit\r\n          break;\r\n        case 'TRANSFER':\r\n          if (tx.transfer) {\r\n            if (tx.transfer.receiver?.id === userId) signedAmount = amount; // received\r\n            else if (tx.transfer.sender?.id === userId) signedAmount = -amount; // sent\r\n            else signedAmount = amount; // default to credit if unsure\r\n          } else if (deltaKnown) {\r\n            signedAmount = balanceIncreased ? amount : -amount;\r\n          }\r\n          break;\r\n        case 'ADJUSTMENT':\r\n        default:\r\n          if (deltaKnown) {\r\n            signedAmount = balanceIncreased ? amount : -amount;\r\n          } else if (lowerDesc.includes('debit')) {\r\n            signedAmount = -amount;\r\n          } else if (lowerDesc.includes('credit')) {\r\n            signedAmount = amount;\r\n          } else {\r\n            signedAmount = amount; // default to credit\r\n          }\r\n      }\r\n\r\n      return { ...tx, signedAmount } as any;\r\n    });\r\n\r\n    return withSigned;\r\n  }\r\n\r\n  async getTransactionById(id: string, userId: string) {\r\n    return this.prisma.transaction.findFirst({\r\n      where: {\r\n        id,\r\n        userId,\r\n      },\r\n      include: {\r\n        transfer: {\r\n          include: {\r\n            sender: {\r\n              select: {\r\n                id: true,\r\n                firstName: true,\r\n                lastName: true,\r\n                email: true,\r\n              },\r\n            },\r\n            receiver: {\r\n              select: {\r\n                id: true,\r\n                firstName: true,\r\n                lastName: true,\r\n                email: true,\r\n              },\r\n            },\r\n          },\r\n        },\r\n        card: true,\r\n      },\r\n    });\r\n  }\r\n\r\n  async getAllTransactions(limit = 100) {\r\n    const list = await this.prisma.transaction.findMany({\r\n      orderBy: { createdAt: 'desc' },\r\n      take: limit,\r\n      select: {\r\n        id: true,\r\n        userId: true,\r\n        type: true,\r\n        amount: true,\r\n        currency: true,\r\n        status: true,\r\n        description: true,\r\n        createdAt: true,\r\n        balanceBefore: true,\r\n        balanceAfter: true,\r\n        user: {\r\n          select: {\r\n            id: true,\r\n            firstName: true,\r\n            lastName: true,\r\n            email: true,\r\n          },\r\n        },\r\n        transfer: {\r\n          select: {\r\n            sender: { select: { id: true } },\r\n            receiver: { select: { id: true } },\r\n          },\r\n        },\r\n      },\r\n    });\r\n\r\n    const withSigned = list.map((tx: any) => {\r\n      const amount = Number(tx.amount);\r\n      const before = tx.balanceBefore == null ? null : Number(tx.balanceBefore);\r\n      const after = tx.balanceAfter == null ? null : Number(tx.balanceAfter);\r\n      const deltaKnown = before !== null && after !== null;\r\n      const balanceIncreased = deltaKnown ? after! > before! : undefined;\r\n      const lowerDesc = tx.description?.toLowerCase?.() || '';\r\n\r\n      let signedAmount = amount;\r\n      switch (tx.type) {\r\n        case 'DEPOSIT':\r\n        case 'PAYMENT_GATEWAY_DEPOSIT':\r\n        case 'REFUND':\r\n        case 'INVESTMENT_MATURITY':\r\n          signedAmount = amount; break;\r\n        case 'WITHDRAWAL':\r\n        case 'PAYMENT_GATEWAY_WITHDRAWAL':\r\n        case 'FEE':\r\n        case 'CARD_PAYMENT':\r\n        case 'INVESTMENT':\r\n        case 'INVESTMENT_LIQUIDATION':\r\n          signedAmount = -amount; break;\r\n        case 'TRANSFER':\r\n          if (tx.transfer) {\r\n            if (tx.transfer.receiver?.id === tx.userId) signedAmount = amount;\r\n            else if (tx.transfer.sender?.id === tx.userId) signedAmount = -amount;\r\n            else if (deltaKnown) signedAmount = balanceIncreased ? amount : -amount;\r\n            else signedAmount = amount;\r\n          } else if (deltaKnown) {\r\n            signedAmount = balanceIncreased ? amount : -amount;\r\n          }\r\n          break;\r\n        case 'ADJUSTMENT':\r\n        default:\r\n          if (deltaKnown) signedAmount = balanceIncreased ? amount : -amount;\r\n          else if (lowerDesc.includes('debit')) signedAmount = -amount;\r\n          else if (lowerDesc.includes('credit')) signedAmount = amount;\r\n          else signedAmount = amount;\r\n      }\r\n\r\n      return { ...tx, signedAmount };\r\n    });\r\n\r\n    return withSigned as any;\r\n  }\r\n\r\n  async getTransactionStats(userId: string) {\r\n    // All-time completed transactions\r\n    const transactions = await this.prisma.transaction.findMany({\r\n      where: {\r\n        userId,\r\n        status: 'COMPLETED',\r\n      },\r\n      select: {\r\n        type: true,\r\n        amount: true,\r\n        balanceBefore: true,\r\n        balanceAfter: true,\r\n        createdAt: true,\r\n        transfer: {\r\n          select: {\r\n            sender: { select: { id: true } },\r\n            receiver: { select: { id: true } },\r\n          },\r\n        },\r\n      },\r\n    }) as any[];\r\n\r\n    const startOfMonth = new Date();\r\n    startOfMonth.setUTCDate(1);\r\n    startOfMonth.setUTCHours(0, 0, 0, 0);\r\n\r\n    // Current-month completed transactions\r\n    const monthTx = transactions.filter(tx => tx.createdAt >= startOfMonth);\r\n\r\n    const computeTotals = (list: typeof transactions) => {\r\n      let income = 0;\r\n      let expenses = 0;\r\n      let deposits = 0;\r\n      let withdrawals = 0;\r\n      let transfersSent = 0;\r\n      let transfersReceived = 0;\r\n\r\n      list.forEach((tx: any) => {\r\n        const amount = Number(tx.amount);\r\n        const before = tx.balanceBefore == null ? null : Number(tx.balanceBefore);\r\n        const after = tx.balanceAfter == null ? null : Number(tx.balanceAfter);\r\n        const deltaKnown = before !== null && after !== null;\r\n        const balanceIncreased = deltaKnown ? after! > before! : undefined;\r\n        const lowerDesc = tx.description?.toLowerCase?.() || '';\r\n\r\n        switch (tx.type) {\r\n          case 'DEPOSIT':\r\n          case 'PAYMENT_GATEWAY_DEPOSIT':\r\n            deposits += amount;\r\n            income += amount;\r\n            break;\r\n          case 'WITHDRAWAL':\r\n          case 'PAYMENT_GATEWAY_WITHDRAWAL':\r\n            withdrawals += amount;\r\n            expenses += amount;\r\n            break;\r\n          case 'TRANSFER':\r\n            if (tx.transfer) {\r\n              if (tx.transfer.receiver?.id === userId) {\r\n                transfersReceived += amount;\r\n                income += amount;\r\n              } else if (tx.transfer.sender?.id === userId) {\r\n                transfersSent += amount;\r\n                expenses += amount;\r\n              } else if (deltaKnown) {\r\n                if (balanceIncreased) { transfersReceived += amount; income += amount; }\r\n                else { transfersSent += amount; expenses += amount; }\r\n              } else {\r\n                // fallback: assume credit\r\n                transfersReceived += amount; income += amount;\r\n              }\r\n            } else if (deltaKnown) {\r\n              if (balanceIncreased) { transfersReceived += amount; income += amount; }\r\n              else { transfersSent += amount; expenses += amount; }\r\n            }\r\n            break;\r\n          case 'ADJUSTMENT':\r\n            if (deltaKnown) {\r\n              if (balanceIncreased) income += amount; else expenses += amount;\r\n            } else if (lowerDesc.includes('debit')) {\r\n              expenses += amount;\r\n            } else if (lowerDesc.includes('credit')) {\r\n              income += amount;\r\n            } else {\r\n              income += amount; // default credit\r\n            }\r\n            break;\r\n        }\r\n      });\r\n\r\n      return { income, expenses, deposits, withdrawals, transfersSent, transfersReceived };\r\n    };\r\n\r\n    const all = computeTotals(transactions);\r\n    const month = computeTotals(monthTx);\r\n\r\n    return {\r\n      totalIncome: all.income,\r\n      totalExpenses: all.expenses,\r\n      totalDeposits: all.deposits,\r\n      totalWithdrawals: all.withdrawals,\r\n      totalTransfersSent: all.transfersSent,\r\n      totalTransfersReceived: all.transfersReceived,\r\n      transactionCount: transactions.length,\r\n      thisMonthIncome: month.income,\r\n      thisMonthExpenses: month.expenses,\r\n      thisMonthNet: month.income - month.expenses,\r\n      thisMonth: month.income - month.expenses,\r\n    };\r\n  }\r\n  async getAdminTransactionStats() {\r\n    const allTransactions = await this.prisma.transaction.findMany({\r\n      select: {\r\n        type: true,\r\n        amount: true,\r\n        status: true,\r\n        balanceBefore: true,\r\n        balanceAfter: true,\r\n        createdAt: true,\r\n        transfer: {\r\n          select: {\r\n            sender: { select: { id: true } },\r\n            receiver: { select: { id: true } },\r\n          },\r\n        },\r\n      },\r\n    }) as any[];\r\n\r\n    let totalVolume = 0;\r\n    let pending = 0;\r\n    let approved = 0;\r\n    let rejected = 0;\r\n\r\n    allTransactions.forEach((tx) => {\r\n      const amount = Number(tx.amount);\r\n\r\n      // Count by status\r\n      if (tx.status === 'PENDING') pending++;\r\n      else if (tx.status === 'COMPLETED') approved++;\r\n      else if (tx.status === 'FAILED') rejected++;\r\n\r\n      // Calculate volume (sum of absolute amounts of all transactions)\r\n      // We use absolute amount because volume represents total money moved\r\n      totalVolume += Math.abs(amount);\r\n    });\r\n\r\n    return {\r\n      totalVolume,\r\n      totalTransactions: allTransactions.length,\r\n      pending,\r\n      approved,\r\n      rejected,\r\n    };\r\n  }\r\n}\r\n"],"names":["TransactionsService","getUserTransactions","userId","limit","list","prisma","transaction","findMany","where","orderBy","createdAt","take","include","transfer","sender","select","id","firstName","lastName","email","receiver","withSigned","map","tx","amount","Number","before","balanceBefore","after","balanceAfter","deltaKnown","balanceIncreased","undefined","lowerDesc","description","toLowerCase","signedAmount","type","includes","getTransactionById","findFirst","card","getAllTransactions","currency","status","user","getTransactionStats","transactions","startOfMonth","Date","setUTCDate","setUTCHours","monthTx","filter","computeTotals","income","expenses","deposits","withdrawals","transfersSent","transfersReceived","forEach","all","month","totalIncome","totalExpenses","totalDeposits","totalWithdrawals","totalTransfersSent","totalTransfersReceived","transactionCount","length","thisMonthIncome","thisMonthExpenses","thisMonthNet","thisMonth","getAdminTransactionStats","allTransactions","totalVolume","pending","approved","rejected","Math","abs","totalTransactions"],"mappings":"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"}