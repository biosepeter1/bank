{"version":3,"sources":["../../../src/modules/settings/settings.service.ts"],"sourcesContent":["import { Injectable } from '@nestjs/common';\nimport { PrismaService } from '../../prisma/prisma.service';\nimport { UpdateSettingsDto } from './dto/update-settings.dto';\n\n@Injectable()\nexport class SettingsService {\n  constructor(private prisma: PrismaService) { }\n\n  async getSettings() {\n    // Fetch all settings from database\n    const settings = await this.prisma.systemSetting.findMany();\n\n    // Convert to structured format\n    const settingsMap = settings.reduce((acc, setting) => {\n      acc[setting.key] = setting.value;\n      return acc;\n    }, {} as Record<string, string>);\n\n    // Parse and return structured settings\n    return {\n      general: {\n        siteName: settingsMap['general.siteName'] || 'Banking Platform',\n        siteDescription: settingsMap['general.siteDescription'] || 'Digital Banking Solution',\n        logo: settingsMap['general.logo'] || '/logo.png',\n        favicon: settingsMap['general.favicon'] || '/favicon.ico',\n        supportEmail: settingsMap['general.supportEmail'] || 'support@bank.com',\n        supportPhone: settingsMap['general.supportPhone'] || '+234 800 000 0000',\n        bankName: settingsMap['general.bankName'] || 'United Bank of Africa',\n        bankCode: settingsMap['general.bankCode'] || '033',\n        brandPrimaryColor: settingsMap['general.brandPrimaryColor'] || '#4F46E5',\n        brandSecondaryColor: settingsMap['general.brandSecondaryColor'] || '#7C3AED',\n      },\n      email: {\n        provider: settingsMap['email.provider'] || 'SMTP',\n        smtpHost: settingsMap['email.smtpHost'] || '',\n        smtpPort: parseInt(settingsMap['email.smtpPort'] || '587'),\n        smtpUser: settingsMap['email.smtpUser'] || '',\n        smtpPass: settingsMap['email.smtpPass'] || '',\n        fromAddress: settingsMap['email.fromAddress'] || (settingsMap['general.supportEmail'] || 'noreply@bank.com'),\n        fromName: settingsMap['email.fromName'] || (settingsMap['general.siteName'] || 'Banking Platform'),\n      },\n      payment: {\n        usdtWalletAddress: settingsMap['payment.usdtWalletAddress'] || '',\n        btcWalletAddress: settingsMap['payment.btcWalletAddress'] || '',\n        bankName: settingsMap['payment.bankName'] || 'Bank',\n        accountNumber: settingsMap['payment.accountNumber'] || '',\n        accountName: settingsMap['payment.accountName'] || 'Banking Platform',\n      },\n      security: {\n        enableTransferCodes: settingsMap['security.enableTransferCodes'] === 'true',\n        enableTwoFactor: settingsMap['security.enableTwoFactor'] === 'true',\n        maxLoginAttempts: parseInt(settingsMap['security.maxLoginAttempts'] || '5'),\n        sessionTimeout: parseInt(settingsMap['security.sessionTimeout'] || '30'),\n        requireKycForTransactions: settingsMap['security.requireKycForTransactions'] === 'true',\n        requireKycForCards: settingsMap['security.requireKycForCards'] === 'true',\n      },\n      notifications: {\n        emailNotifications: settingsMap['notifications.emailNotifications'] === 'true',\n        smsNotifications: settingsMap['notifications.smsNotifications'] === 'true',\n        pushNotifications: settingsMap['notifications.pushNotifications'] === 'true',\n        transactionAlerts: settingsMap['notifications.transactionAlerts'] === 'true',\n        securityAlerts: settingsMap['notifications.securityAlerts'] === 'true',\n      },\n      limits: {\n        minDeposit: parseFloat(settingsMap['limits.minDeposit'] || '1000'),\n        maxDeposit: parseFloat(settingsMap['limits.maxDeposit'] || '10000000'),\n        minWithdrawal: parseFloat(settingsMap['limits.minWithdrawal'] || '1000'),\n        maxWithdrawal: parseFloat(settingsMap['limits.maxWithdrawal'] || '5000000'),\n        minTransfer: parseFloat(settingsMap['limits.minTransfer'] || '100'),\n        maxTransfer: parseFloat(settingsMap['limits.maxTransfer'] || '5000000'),\n        dailyTransferLimit: parseFloat(settingsMap['limits.dailyTransferLimit'] || '10000000'),\n      },\n    };\n  }\n\n  async updateSettings(updateSettingsDto: UpdateSettingsDto) {\n    const settingsToUpdate: Array<{ key: string; value: string }> = [];\n    let shouldSyncBrandColors = false;\n\n    // General settings\n    if (updateSettingsDto.general) {\n      Object.entries(updateSettingsDto.general).forEach(([key, value]) => {\n        settingsToUpdate.push({ key: `general.${key}`, value: String(value) });\n        // Check if bank code or name changed - need to sync colors\n        if (key === 'bankCode' || key === 'bankName') {\n          shouldSyncBrandColors = true;\n        }\n      });\n    }\n\n    // Payment settings\n    if (updateSettingsDto.payment) {\n      Object.entries(updateSettingsDto.payment).forEach(([key, value]) => {\n        settingsToUpdate.push({ key: `payment.${key}`, value: String(value) });\n      });\n    }\n\n    // Security settings\n    if (updateSettingsDto.security) {\n      Object.entries(updateSettingsDto.security).forEach(([key, value]) => {\n        settingsToUpdate.push({ key: `security.${key}`, value: String(value) });\n      });\n    }\n\n    // Email settings\n    if (updateSettingsDto.email) {\n      Object.entries(updateSettingsDto.email).forEach(([key, value]) => {\n        settingsToUpdate.push({ key: `email.${key}`, value: String(value) });\n      });\n    }\n\n    // Notification settings\n    if (updateSettingsDto.notifications) {\n      Object.entries(updateSettingsDto.notifications).forEach(([key, value]) => {\n        settingsToUpdate.push({ key: `notifications.${key}`, value: String(value) });\n      });\n    }\n\n    // Limit settings\n    if (updateSettingsDto.limits) {\n      Object.entries(updateSettingsDto.limits).forEach(([key, value]) => {\n        settingsToUpdate.push({ key: `limits.${key}`, value: String(value) });\n      });\n    }\n\n    // Update or create each setting\n    for (const setting of settingsToUpdate) {\n      await this.prisma.systemSetting.upsert({\n        where: { key: setting.key },\n        update: { value: setting.value },\n        create: { key: setting.key, value: setting.value },\n      });\n    }\n\n    // Auto-sync brand colors if bank changed\n    if (shouldSyncBrandColors) {\n      await this.syncBrandColors();\n    }\n\n    return { message: 'Settings updated successfully', settings: await this.getSettings() };\n  }\n\n  private async syncBrandColors() {\n    // Get current bank code\n    const bankCodeSetting = await this.prisma.systemSetting.findUnique({\n      where: { key: 'general.bankCode' },\n    });\n\n    const bankCode = bankCodeSetting?.value || '011';\n\n    // Brand color mapping\n    const brandColors: Record<string, { primary: string; secondary: string }> = {\n      '011': { primary: '#00416A', secondary: '#00B4D8' }, // First Bank\n      '058': { primary: '#D4AF37', secondary: '#C5A028' }, // GTBank\n      '033': { primary: '#8B0000', secondary: '#B30000' }, // UBA\n      '214': { primary: '#FF6B00', secondary: '#FF8533' }, // FCMB\n      '215': { primary: '#1B5E20', secondary: '#2E7D32' }, // Unity Bank\n      '057': { primary: '#004D40', secondary: '#00796B' }, // Zenith Bank\n      '044': { primary: '#1565C0', secondary: '#1976D2' }, // Access Bank\n    };\n\n    const colors = brandColors[bankCode] || { primary: '#4F46E5', secondary: '#7C3AED' };\n\n    // Update brand colors\n    await this.prisma.systemSetting.upsert({\n      where: { key: 'general.brandPrimaryColor' },\n      update: { value: colors.primary },\n      create: {\n        key: 'general.brandPrimaryColor',\n        value: colors.primary,\n        description: 'Primary brand color for emails and UI',\n      },\n    });\n\n    await this.prisma.systemSetting.upsert({\n      where: { key: 'general.brandSecondaryColor' },\n      update: { value: colors.secondary },\n      create: {\n        key: 'general.brandSecondaryColor',\n        value: colors.secondary,\n        description: 'Secondary brand color for emails and UI',\n      },\n    });\n  }\n}\n"],"names":["SettingsService","getSettings","settings","prisma","systemSetting","findMany","settingsMap","reduce","acc","setting","key","value","general","siteName","siteDescription","logo","favicon","supportEmail","supportPhone","bankName","bankCode","brandPrimaryColor","brandSecondaryColor","email","provider","smtpHost","smtpPort","parseInt","smtpUser","smtpPass","fromAddress","fromName","payment","usdtWalletAddress","btcWalletAddress","accountNumber","accountName","security","enableTransferCodes","enableTwoFactor","maxLoginAttempts","sessionTimeout","requireKycForTransactions","requireKycForCards","notifications","emailNotifications","smsNotifications","pushNotifications","transactionAlerts","securityAlerts","limits","minDeposit","parseFloat","maxDeposit","minWithdrawal","maxWithdrawal","minTransfer","maxTransfer","dailyTransferLimit","updateSettings","updateSettingsDto","settingsToUpdate","shouldSyncBrandColors","Object","entries","forEach","push","String","upsert","where","update","create","syncBrandColors","message","bankCodeSetting","findUnique","brandColors","primary","secondary","colors","description"],"mappings":"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"}