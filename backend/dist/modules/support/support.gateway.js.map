{"version":3,"sources":["../../../src/modules/support/support.gateway.ts"],"sourcesContent":["import {\r\n  WebSocketGateway,\r\n  WebSocketServer,\r\n  SubscribeMessage,\r\n  OnGatewayConnection,\r\n  OnGatewayDisconnect,\r\n  ConnectedSocket,\r\n  MessageBody,\r\n} from '@nestjs/websockets';\r\nimport { Server, Socket } from 'socket.io';\r\nimport { PrismaService } from '@/prisma/prisma.service';\r\nimport { Injectable } from '@nestjs/common';\r\n\r\n@Injectable()\r\n@WebSocketGateway({\r\n  cors: {\r\n    origin: process.env.FRONTEND_URL || 'http://localhost:3000',\r\n    credentials: true,\r\n  },\r\n})\r\nexport class SupportGateway implements OnGatewayConnection, OnGatewayDisconnect {\r\n  @WebSocketServer()\r\n  server: Server;\r\n\r\n  private userSockets = new Map<string, string>(); // userId -> socketId\r\n\r\n  constructor(private prisma: PrismaService) {}\r\n\r\n  handleConnection(client: Socket) {\r\n    console.log(`Client connected: ${client.id}`);\r\n  }\r\n\r\n  handleDisconnect(client: Socket) {\r\n    console.log(`Client disconnected: ${client.id}`);\r\n    // Remove from userSockets\r\n    for (const [userId, socketId] of this.userSockets.entries()) {\r\n      if (socketId === client.id) {\r\n        this.userSockets.delete(userId);\r\n        break;\r\n      }\r\n    }\r\n  }\r\n\r\n  @SubscribeMessage('register')\r\n  handleRegister(\r\n    @ConnectedSocket() client: Socket,\r\n    @MessageBody() data: { userId: string; role: string },\r\n  ) {\r\n    this.userSockets.set(data.userId, client.id);\r\n    console.log(`User ${data.userId} (${data.role}) registered with socket ${client.id}`);\r\n    \r\n    // Join user-specific room\r\n    client.join(`user:${data.userId}`);\r\n    \r\n    // If admin, join admin room\r\n    if (data.role === 'BANK_ADMIN' || data.role === 'SUPER_ADMIN') {\r\n      client.join('admins');\r\n    }\r\n  }\r\n\r\n  @SubscribeMessage('joinTicket')\r\n  handleJoinTicket(\r\n    @ConnectedSocket() client: Socket,\r\n    @MessageBody() ticketId: string,\r\n  ) {\r\n    client.join(`ticket:${ticketId}`);\r\n    console.log(`Client ${client.id} joined ticket ${ticketId}`);\r\n  }\r\n\r\n  @SubscribeMessage('leaveTicket')\r\n  handleLeaveTicket(\r\n    @ConnectedSocket() client: Socket,\r\n    @MessageBody() ticketId: string,\r\n  ) {\r\n    client.leave(`ticket:${ticketId}`);\r\n    console.log(`Client ${client.id} left ticket ${ticketId}`);\r\n  }\r\n\r\n  @SubscribeMessage('typing')\r\n  handleTyping(\r\n    @ConnectedSocket() client: Socket,\r\n    @MessageBody() data: { ticketId: string; senderName: string },\r\n  ) {\r\n    // Broadcast typing indicator to all users in this ticket except sender\r\n    client.to(`ticket:${data.ticketId}`).emit('userTyping', {\r\n      ticketId: data.ticketId,\r\n      senderName: data.senderName,\r\n    });\r\n  }\r\n\r\n  @SubscribeMessage('stopTyping')\r\n  handleStopTyping(\r\n    @ConnectedSocket() client: Socket,\r\n    @MessageBody() ticketId: string,\r\n  ) {\r\n    client.to(`ticket:${ticketId}`).emit('userStoppedTyping', { ticketId });\r\n  }\r\n\r\n  // Method to emit new message to all users in a ticket\r\n  emitNewMessage(ticketId: string, message: any) {\r\n    this.server.to(`ticket:${ticketId}`).emit('newMessage', message);\r\n  }\r\n\r\n  // Method to notify admins of new ticket\r\n  notifyAdminsNewTicket(ticket: any) {\r\n    this.server.to('admins').emit('newTicket', ticket);\r\n  }\r\n\r\n  // Method to notify user of ticket update\r\n  notifyUserTicketUpdate(userId: string, ticket: any) {\r\n    this.server.to(`user:${userId}`).emit('ticketUpdated', ticket);\r\n  }\r\n}\r\n"],"names":["SupportGateway","handleConnection","client","console","log","id","handleDisconnect","userId","socketId","userSockets","entries","delete","handleRegister","data","set","role","join","handleJoinTicket","ticketId","handleLeaveTicket","leave","handleTyping","to","emit","senderName","handleStopTyping","emitNewMessage","message","server","notifyAdminsNewTicket","ticket","notifyUserTicketUpdate","prisma","Map","cors","origin","process","env","FRONTEND_URL","credentials"],"mappings":"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"}