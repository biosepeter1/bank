{"version":3,"sources":["../../../src/modules/support/support.service.ts"],"sourcesContent":["import { Injectable, NotFoundException, BadRequestException, Inject, forwardRef } from '@nestjs/common';\r\nimport { PrismaService } from '@/prisma/prisma.service';\r\nimport { CreateTicketDto, UpdateTicketDto } from './dto/create-ticket.dto';\r\nimport { ContactFormDto } from './dto/contact-form.dto';\r\nimport { EmailService } from '@/common/services/email.service';\r\nimport { SupportGateway } from './support.gateway';\r\n\r\n@Injectable()\r\nexport class SupportService {\r\n  constructor(\r\n    private prisma: PrismaService,\r\n    private emailService: EmailService,\r\n    @Inject(forwardRef(() => SupportGateway))\r\n    private supportGateway: SupportGateway,\r\n  ) { }\r\n\r\n  /**\r\n   * Create a new support ticket\r\n   */\r\n  async createTicket(userId: string, data: CreateTicketDto) {\r\n    const user = await this.prisma.user.findUnique({\r\n      where: { id: userId },\r\n      select: { id: true, email: true, firstName: true, lastName: true, emailTransactions: true },\r\n    });\r\n\r\n    if (!user) {\r\n      throw new NotFoundException('User not found');\r\n    }\r\n\r\n    const ticket = await this.prisma.supportTicket.create({\r\n      data: {\r\n        userId,\r\n        subject: data.subject,\r\n        message: data.message,\r\n        category: data.category,\r\n        priority: data.priority || 'MEDIUM',\r\n        status: 'OPEN',\r\n      },\r\n    });\r\n\r\n    // Send confirmation email\r\n    try {\r\n      if (user.emailTransactions) {\r\n        await this.emailService.sendGenericNotification({\r\n          email: user.email,\r\n          title: 'ðŸŽ« Support Ticket Created',\r\n          message: `Hi ${user.firstName},<br><br>Your support ticket has been created successfully.<br><br><strong>Ticket ID:</strong> #${ticket.id.substring(0, 8).toUpperCase()}<br><strong>Subject:</strong> ${ticket.subject}<br><strong>Category:</strong> ${ticket.category}<br><strong>Priority:</strong> ${ticket.priority}<br><br>Our support team will review your request and get back to you as soon as possible. You can track the status of your ticket in your account.`,\r\n          actionLabel: 'View Ticket',\r\n          actionUrl: `${process.env.FRONTEND_URL || 'http://localhost:3000'}/user/support`,\r\n        });\r\n      }\r\n    } catch (error) {\r\n      console.error('Failed to send ticket creation email:', error);\r\n    }\r\n\r\n    // Create in-app notification\r\n    await this.prisma.notification.create({\r\n      data: {\r\n        userId,\r\n        title: 'Support Ticket Created',\r\n        message: `Your support ticket #${ticket.id.substring(0, 8).toUpperCase()} has been created. We'll respond soon.`,\r\n        type: 'INFO',\r\n      },\r\n    });\r\n\r\n    return ticket;\r\n  }\r\n\r\n  /**\r\n   * Create a guest support ticket from contact form (no auth required)\r\n   */\r\n  async createGuestTicket(data: ContactFormDto) {\r\n    // For guest tickets, prepend visitor info to the message\r\n    const guestInfoPrefix = `[GUEST CONTACT]\\nName: ${data.name}\\nEmail: ${data.email}\\n---\\n\\n`;\r\n    const fullMessage = guestInfoPrefix + data.message;\r\n\r\n    // Get or create a system \"guest\" user for contact forms\r\n    let guestUser = await this.prisma.user.findFirst({\r\n      where: { email: 'guest@contact.system' },\r\n    });\r\n\r\n    if (!guestUser) {\r\n      guestUser = await this.prisma.user.create({\r\n        data: {\r\n          email: 'guest@contact.system',\r\n          phone: '+0000000000',\r\n          password: 'not-a-real-password-hash',\r\n          firstName: 'Guest',\r\n          lastName: 'Contact',\r\n          role: 'USER',\r\n          accountStatus: 'ACTIVE',\r\n        },\r\n      });\r\n    }\r\n\r\n    // Create ticket with guest user\r\n    const ticket = await this.prisma.supportTicket.create({\r\n      data: {\r\n        userId: guestUser.id,\r\n        subject: data.subject || `Contact from ${data.name}: ${data.category || 'General Inquiry'}`,\r\n        message: fullMessage,\r\n        category: data.category || 'General',\r\n        priority: 'MEDIUM',\r\n        status: 'OPEN',\r\n      },\r\n    });\r\n\r\n    // Send confirmation email to the guest\r\n    try {\r\n      await this.emailService.sendGenericNotification({\r\n        email: data.email,\r\n        title: 'ðŸ“© We Received Your Message',\r\n        message: `Hi ${data.name},<br><br>Thank you for contacting us! We have received your message and our support team will respond within 24 hours.<br><br><strong>Reference:</strong> #${ticket.id.substring(0, 8).toUpperCase()}<br><strong>Subject:</strong> ${ticket.subject}<br><br>If you have an account with us, you can login to track your request in the Support section.`,\r\n        actionLabel: 'Visit Our Website',\r\n        actionUrl: process.env.FRONTEND_URL || 'http://localhost:3000',\r\n      });\r\n    } catch (error) {\r\n      console.error('Failed to send guest confirmation email:', error);\r\n    }\r\n\r\n    // Send notification to admin/support email\r\n    try {\r\n      const settings = await this.prisma.systemSetting.findFirst({\r\n        where: { key: 'general.supportEmail' },\r\n      });\r\n      const adminEmail = settings?.value || process.env.ADMIN_EMAIL || 'admin@example.com';\r\n\r\n      await this.emailService.sendGenericNotification({\r\n        email: adminEmail,\r\n        title: 'ðŸ”” New Contact Form Submission',\r\n        message: `A new contact form has been submitted:<br><br><strong>From:</strong> ${data.name} (${data.email})<br><strong>Category:</strong> ${data.category || 'Not specified'}<br><strong>Subject:</strong> ${data.subject || 'Not specified'}<br><strong>Reference:</strong> #${ticket.id.substring(0, 8).toUpperCase()}<br><br><strong>Message:</strong><br>${data.message}`,\r\n        actionLabel: 'View in Admin Panel',\r\n        actionUrl: `${process.env.FRONTEND_URL || 'http://localhost:3000'}/admin/support`,\r\n      });\r\n    } catch (error) {\r\n      console.error('Failed to send admin notification email:', error);\r\n    }\r\n\r\n    return {\r\n      success: true,\r\n      message: 'Your message has been received. We will respond within 24 hours.',\r\n      reference: ticket.id.substring(0, 8).toUpperCase(),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Get all tickets for a user\r\n   */\r\n  async getUserTickets(userId: string) {\r\n    return this.prisma.supportTicket.findMany({\r\n      where: { userId },\r\n      include: {\r\n        messages: {\r\n          orderBy: { createdAt: 'asc' },\r\n        },\r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Get a specific ticket\r\n   */\r\n  async getTicket(userId: string, ticketId: string) {\r\n    const ticket = await this.prisma.supportTicket.findUnique({\r\n      where: { id: ticketId },\r\n      include: {\r\n        messages: {\r\n          orderBy: { createdAt: 'asc' },\r\n        },\r\n      },\r\n    });\r\n\r\n    if (!ticket || ticket.userId !== userId) {\r\n      throw new NotFoundException('Ticket not found');\r\n    }\r\n\r\n    return ticket;\r\n  }\r\n\r\n  /**\r\n   * Admin: Get all tickets\r\n   */\r\n  async getAllTickets(status?: string) {\r\n    return this.prisma.supportTicket.findMany({\r\n      where: status ? { status } : undefined,\r\n      include: {\r\n        user: {\r\n          select: {\r\n            id: true,\r\n            email: true,\r\n            firstName: true,\r\n            lastName: true,\r\n          },\r\n        },\r\n        messages: {\r\n          orderBy: { createdAt: 'asc' },\r\n        },\r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Admin: Get a specific ticket\r\n   */\r\n  async getAdminTicket(ticketId: string) {\r\n    const ticket = await this.prisma.supportTicket.findUnique({\r\n      where: { id: ticketId },\r\n      include: {\r\n        user: {\r\n          select: {\r\n            id: true,\r\n            email: true,\r\n            firstName: true,\r\n            lastName: true,\r\n          },\r\n        },\r\n        messages: {\r\n          orderBy: { createdAt: 'asc' },\r\n        },\r\n      },\r\n    });\r\n\r\n    if (!ticket) {\r\n      throw new NotFoundException('Ticket not found');\r\n    }\r\n\r\n    return ticket;\r\n  }\r\n  /**\r\n   * Admin: Update ticket status\r\n   */\r\n  async updateTicket(ticketId: string, adminId: string, data: UpdateTicketDto) {\r\n    const ticket = await this.prisma.supportTicket.findUnique({\r\n      where: { id: ticketId },\r\n      include: { user: true },\r\n    });\r\n\r\n    if (!ticket) {\r\n      throw new NotFoundException('Ticket not found');\r\n    }\r\n\r\n    const updated = await this.prisma.supportTicket.update({\r\n      where: { id: ticketId },\r\n      data: {\r\n        ...data,\r\n        assignedTo: data.assignedTo || ticket.assignedTo,\r\n        resolvedAt: data.status === 'RESOLVED' || data.status === 'CLOSED' ? new Date() : ticket.resolvedAt,\r\n        resolution: data.resolution || ticket.resolution,\r\n      },\r\n    });\r\n\r\n    // Notify user of status change\r\n    if (data.status && data.status !== ticket.status) {\r\n      await this.prisma.notification.create({\r\n        data: {\r\n          userId: ticket.userId,\r\n          title: 'Support Ticket Updated',\r\n          message: `Your ticket #${ticket.id.substring(0, 8).toUpperCase()} status has been updated to ${data.status.replace('_', ' ')}`,\r\n          type: 'INFO',\r\n        },\r\n      });\r\n\r\n      // Send conversation summary email if resolved\r\n      if ((data.status === 'RESOLVED' || data.status === 'CLOSED') && ticket.user.emailTransactions) {\r\n        try {\r\n          // Fetch all messages for this ticket\r\n          const ticketWithMessages = await this.prisma.supportTicket.findUnique({\r\n            where: { id: ticketId },\r\n            include: {\r\n              messages: {\r\n                orderBy: { createdAt: 'asc' },\r\n              },\r\n              user: true,\r\n            },\r\n          });\r\n\r\n          if (ticketWithMessages) {\r\n            // Build conversation HTML\r\n            let conversationHtml = `<div style=\"background:#f8fafc;padding:16px;border-radius:8px;margin:16px 0\">`;\r\n\r\n            // Original message\r\n            conversationHtml += `\r\n              <div style=\"margin-bottom:16px;padding:12px;background:#fff;border-radius:8px;border-left:3px solid #3b82f6\">\r\n                <div style=\"font-size:12px;color:#64748b;margin-bottom:4px\">\r\n                  <strong>${ticketWithMessages.user.firstName} ${ticketWithMessages.user.lastName}</strong> â€¢ ${new Date(ticketWithMessages.createdAt).toLocaleString()}\r\n                </div>\r\n                <div style=\"color:#334155\">${ticketWithMessages.message}</div>\r\n              </div>`;\r\n\r\n            // All replies\r\n            ticketWithMessages.messages?.forEach((msg) => {\r\n              const isSupport = msg.senderType === 'ADMIN';\r\n              conversationHtml += `\r\n                <div style=\"margin-bottom:16px;padding:12px;background:${isSupport ? '#dcfce7' : '#fff'};border-radius:8px;border-left:3px solid ${isSupport ? '#16a34a' : '#3b82f6'}\">\r\n                  <div style=\"font-size:12px;color:#64748b;margin-bottom:4px\">\r\n                    <strong>${msg.senderName}</strong> â€¢ ${new Date(msg.createdAt).toLocaleString()}\r\n                  </div>\r\n                  <div style=\"color:#334155\">${msg.message}</div>\r\n                </div>`;\r\n            });\r\n\r\n            conversationHtml += `</div>`;\r\n\r\n            await this.emailService.sendGenericNotification({\r\n              email: ticketWithMessages.user.email,\r\n              title: 'âœ… Support Ticket Resolved - Full Conversation',\r\n              message: `Hi ${ticketWithMessages.user.firstName},<br><br>Your support ticket has been ${data.status === 'RESOLVED' ? 'resolved' : 'closed'}.<br><br><strong>Ticket ID:</strong> #${ticket.id.substring(0, 8).toUpperCase()}<br><strong>Subject:</strong> ${ticket.subject}${data.resolution ? `<br><br><strong>Resolution:</strong><br>${data.resolution}` : ''}<br><br><strong>Full Conversation:</strong>${conversationHtml}<br>If you have any further questions, feel free to create a new support ticket.`,\r\n              actionLabel: 'View Tickets',\r\n              actionUrl: `${process.env.FRONTEND_URL || 'http://localhost:3000'}/user/support`,\r\n            });\r\n          }\r\n        } catch (error) {\r\n          console.error('Failed to send ticket resolution email:', error);\r\n        }\r\n      }\r\n    }\r\n\r\n    // Audit log\r\n    await this.prisma.auditLog.create({\r\n      data: {\r\n        userId: adminId,\r\n        actorEmail: 'admin',\r\n        actorRole: 'BANK_ADMIN',\r\n        action: 'SETTINGS_CHANGED',\r\n        entity: 'SupportTicket',\r\n        entityId: ticketId,\r\n        description: `Updated support ticket #${ticket.id.substring(0, 8).toUpperCase()}`,\r\n        metadata: data as any,\r\n      },\r\n    });\r\n\r\n    return updated;\r\n  }\r\n\r\n  /**\r\n   * Admin: Delete ticket\r\n   */\r\n  async deleteTicket(ticketId: string, adminId: string) {\r\n    const ticket = await this.prisma.supportTicket.findUnique({\r\n      where: { id: ticketId },\r\n    });\r\n\r\n    if (!ticket) {\r\n      throw new NotFoundException('Ticket not found');\r\n    }\r\n\r\n    await this.prisma.supportTicket.delete({\r\n      where: { id: ticketId },\r\n    });\r\n\r\n    await this.prisma.auditLog.create({\r\n      data: {\r\n        userId: adminId,\r\n        actorEmail: 'admin',\r\n        actorRole: 'BANK_ADMIN',\r\n        action: 'USER_DELETED',\r\n        entity: 'SupportTicket',\r\n        entityId: ticketId,\r\n        description: `Deleted support ticket #${ticket.id.substring(0, 8).toUpperCase()}`,\r\n      },\r\n    });\r\n\r\n    return { message: 'Ticket deleted successfully' };\r\n  }\r\n\r\n  /**\r\n   * User: Add a reply to ticket\r\n   */\r\n  async addUserReply(userId: string, ticketId: string, message: string) {\r\n    const ticket = await this.prisma.supportTicket.findUnique({\r\n      where: { id: ticketId },\r\n      include: { user: true },\r\n    });\r\n\r\n    if (!ticket || ticket.userId !== userId) {\r\n      throw new NotFoundException('Ticket not found');\r\n    }\r\n\r\n    if (ticket.status === 'CLOSED') {\r\n      throw new BadRequestException('Cannot reply to a closed ticket');\r\n    }\r\n\r\n    const reply = await this.prisma.ticketMessage.create({\r\n      data: {\r\n        ticketId,\r\n        senderId: userId,\r\n        senderName: `${ticket.user.firstName} ${ticket.user.lastName}`,\r\n        senderType: 'USER',\r\n        message,\r\n      },\r\n    });\r\n\r\n    // Update ticket timestamp\r\n    await this.prisma.supportTicket.update({\r\n      where: { id: ticketId },\r\n      data: { updatedAt: new Date() },\r\n    });\r\n\r\n    // Emit real-time event\r\n    this.supportGateway.emitNewMessage(ticketId, reply);\r\n\r\n    return reply;\r\n  }\r\n\r\n  /**\r\n   * Admin: Add a reply to ticket\r\n   */\r\n  async addAdminReply(adminId: string, ticketId: string, message: string) {\r\n    const ticket = await this.prisma.supportTicket.findUnique({\r\n      where: { id: ticketId },\r\n      include: { user: true },\r\n    });\r\n\r\n    if (!ticket) {\r\n      throw new NotFoundException('Ticket not found');\r\n    }\r\n\r\n    const admin = await this.prisma.user.findUnique({\r\n      where: { id: adminId },\r\n    });\r\n\r\n    if (!admin) {\r\n      throw new NotFoundException('Admin not found');\r\n    }\r\n\r\n    const reply = await this.prisma.ticketMessage.create({\r\n      data: {\r\n        ticketId,\r\n        senderId: adminId,\r\n        senderName: 'Support Team',\r\n        senderType: 'ADMIN',\r\n        message,\r\n      },\r\n    });\r\n\r\n    // Update ticket timestamp and set to IN_PROGRESS if OPEN\r\n    await this.prisma.supportTicket.update({\r\n      where: { id: ticketId },\r\n      data: {\r\n        updatedAt: new Date(),\r\n        status: ticket.status === 'OPEN' ? 'IN_PROGRESS' : ticket.status,\r\n      },\r\n    });\r\n\r\n    // Notify user\r\n    await this.prisma.notification.create({\r\n      data: {\r\n        userId: ticket.userId,\r\n        title: 'New Reply on Support Ticket',\r\n        message: `Support team replied to your ticket: ${ticket.subject}`,\r\n        type: 'INFO',\r\n      },\r\n    });\r\n\r\n    // Emit real-time event\r\n    this.supportGateway.emitNewMessage(ticketId, reply);\r\n\r\n    return reply;\r\n  }\r\n\r\n  /**\r\n   * Admin: Send email reply to guest contact form submission\r\n   */\r\n  async sendGuestEmailReply(\r\n    ticketId: string,\r\n    data: { guestEmail: string; guestName: string; subject: string; message: string },\r\n    admin: { firstName: string; lastName: string },\r\n  ) {\r\n    const ticket = await this.prisma.supportTicket.findUnique({\r\n      where: { id: ticketId },\r\n    });\r\n\r\n    if (!ticket) {\r\n      throw new NotFoundException('Ticket not found');\r\n    }\r\n\r\n    // Send email to guest\r\n    try {\r\n      await this.emailService.sendGenericNotification({\r\n        email: data.guestEmail,\r\n        title: `ðŸ“§ Reply: ${data.subject}`,\r\n        message: `\r\n          <p>Hi ${data.guestName},</p>\r\n          <p>Thank you for contacting us. Here's our response to your inquiry:</p>\r\n          <div style=\"background-color: #f8f9fa; padding: 16px; border-radius: 8px; margin: 16px 0; border-left: 4px solid #007bff;\">\r\n            ${data.message.replace(/\\n/g, '<br>')}\r\n          </div>\r\n          <p><strong>Reference:</strong> #${ticket.id.substring(0, 8).toUpperCase()}</p>\r\n          <p style=\"color: #666; font-size: 14px;\">\r\n            <em>Replied by: Support Team</em>\r\n          </p>\r\n          <p>If you have any further questions, feel free to reply to this email or visit our website.</p>\r\n        `,\r\n        actionLabel: 'Visit Our Website',\r\n        actionUrl: process.env.FRONTEND_URL || 'http://localhost:3000',\r\n      });\r\n\r\n      // Also add a record in ticket messages for audit trail\r\n      await this.prisma.ticketMessage.create({\r\n        data: {\r\n          ticketId,\r\n          senderId: 'system',\r\n          senderName: `${admin.firstName} ${admin.lastName} (via Email)`,\r\n          senderType: 'ADMIN',\r\n          message: `[EMAIL SENT TO: ${data.guestEmail}]\\n\\n${data.message}`,\r\n        },\r\n      });\r\n\r\n      // Update ticket status\r\n      await this.prisma.supportTicket.update({\r\n        where: { id: ticketId },\r\n        data: {\r\n          updatedAt: new Date(),\r\n          status: 'IN_PROGRESS',\r\n        },\r\n      });\r\n\r\n      return {\r\n        success: true,\r\n        message: `Email sent successfully to ${data.guestEmail}`,\r\n      };\r\n    } catch (error) {\r\n      console.error('Failed to send guest email reply:', error);\r\n      throw new Error('Failed to send email. Please check SMTP configuration.');\r\n    }\r\n  }\r\n}\r\n"],"names":["SupportService","createTicket","userId","data","user","prisma","findUnique","where","id","select","email","firstName","lastName","emailTransactions","NotFoundException","ticket","supportTicket","create","subject","message","category","priority","status","emailService","sendGenericNotification","title","substring","toUpperCase","actionLabel","actionUrl","process","env","FRONTEND_URL","error","console","notification","type","createGuestTicket","guestInfoPrefix","name","fullMessage","guestUser","findFirst","phone","password","role","accountStatus","settings","systemSetting","key","adminEmail","value","ADMIN_EMAIL","success","reference","getUserTickets","findMany","include","messages","orderBy","createdAt","getTicket","ticketId","getAllTickets","undefined","getAdminTicket","updateTicket","adminId","updated","update","assignedTo","resolvedAt","Date","resolution","replace","ticketWithMessages","conversationHtml","toLocaleString","forEach","msg","isSupport","senderType","senderName","auditLog","actorEmail","actorRole","action","entity","entityId","description","metadata","deleteTicket","delete","addUserReply","BadRequestException","reply","ticketMessage","senderId","updatedAt","supportGateway","emitNewMessage","addAdminReply","admin","sendGuestEmailReply","guestEmail","guestName","Error","SupportGateway"],"mappings":"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"}