{"version":3,"sources":["../../../src/modules/transfers/transfers.service.ts"],"sourcesContent":["import { Injectable, BadRequestException, NotFoundException } from '@nestjs/common';\nimport { PrismaService } from '@/prisma/prisma.service';\nimport { CreateTransferDto, CreateInternationalTransferDto, CreateBeneficiaryDto } from './dto/create-transfer.dto';\nimport { Decimal } from '@prisma/client/runtime/library';\nimport { EmailService } from '@/common/services/email.service';\n\n@Injectable()\nexport class TransfersService {\n  constructor(private prisma: PrismaService, private email: EmailService) {}\n\n  /**\n   * Initiate a local transfer between platform users\n   */\n  async initiateLocalTransfer(userId: string, data: CreateTransferDto) {\n    const sender = await this.prisma.user.findUnique({\n      where: { id: userId },\n      include: { wallet: true, kyc: true },\n    });\n\n    if (!sender) throw new NotFoundException('Sender not found');\n\n    // Check KYC verification\n    if (!sender.kyc || sender.kyc.status !== 'APPROVED') {\n      throw new BadRequestException(\n        'KYC verification is required to make transfers. Please complete your KYC verification first.',\n      );\n    }\n\n    const receiver = await this.prisma.user.findUnique({\n      where: { email: data.recipientEmail },\n      include: { wallet: true },\n    });\n\n    if (!receiver) throw new BadRequestException('Recipient not found');\n\n    if (sender.id === receiver.id) {\n      throw new BadRequestException('Cannot transfer to yourself');\n    }\n\n    const amount = new Decimal(data.amount);\n\n    if (!sender.wallet) {\n      throw new BadRequestException('Sender wallet not found');\n    }\n\n    if (new Decimal(sender.wallet.balance).lessThan(amount)) {\n      throw new BadRequestException(\n        `Insufficient balance. Available: ${sender.wallet.balance.toString()} ${sender.wallet.currency}, Required: ${amount.toString()} ${sender.wallet.currency}`\n      );\n    }\n\n    // Database transaction for atomicity\n    const result = await this.prisma.$transaction(async (tx) => {\n      // Create transfer record\n      const newTransfer = await tx.transfer.create({\n        data: {\n          senderId: userId,\n          receiverId: receiver.id,\n          transferType: 'INTERNAL',\n          amount,\n          currency: sender.wallet.currency,\n          description: data.description,\n          status: 'COMPLETED',\n        },\n      });\n\n      const senderBalanceBefore = sender.wallet.balance;\n      const senderBalanceAfter = senderBalanceBefore.sub(amount);\n\n      // Debit sender\n      await tx.wallet.update({\n        where: { userId },\n        data: {\n          balance: senderBalanceAfter,\n        },\n      });\n\n      const receiverBalanceBefore = receiver.wallet.balance;\n      const receiverBalanceAfter = receiverBalanceBefore.add(amount);\n\n      // Credit receiver\n      await tx.wallet.update({\n        where: { userId: receiver.id },\n        data: {\n          balance: receiverBalanceAfter,\n        },\n      });\n\n      // Create sender transaction record\n      await tx.transaction.create({\n        data: {\n          userId,\n          type: 'TRANSFER',\n          status: 'COMPLETED',\n          amount,\n          balanceBefore: senderBalanceBefore,\n          balanceAfter: senderBalanceAfter,\n          description: `Transfer to ${receiver.firstName} ${receiver.lastName}`,\n          reference: `XFER-${Date.now()}-${Math.random().toString(36).substring(7)}`,\n          transferId: newTransfer.id,\n        },\n      });\n\n      // Create receiver transaction record\n      await tx.transaction.create({\n        data: {\n          userId: receiver.id,\n          type: 'TRANSFER',\n          status: 'COMPLETED',\n          amount,\n          balanceBefore: receiverBalanceBefore,\n          balanceAfter: receiverBalanceAfter,\n          description: `Transfer from ${sender.firstName} ${sender.lastName}`,\n          reference: `XFER-${Date.now()}-${Math.random().toString(36).substring(7)}`,\n          transferId: newTransfer.id,\n        },\n      });\n\n      return newTransfer;\n    });\n\n    // Send email notifications if enabled (non-blocking)\n    try {\n      // Notify sender\n      if (sender.emailTransactions) {\n        await this.email.sendTransactionEmail({\n          email: sender.email,\n          firstName: sender.firstName,\n          transactionType: 'TRANSFER',\n          amount: amount.toString(),\n          currency: sender.wallet.currency,\n          balance: sender.wallet.balance.sub(amount).toString(),\n          reference: `XFER-${Date.now()}`,\n          description: `Transfer to ${receiver.firstName} ${receiver.lastName}`,\n        });\n      }\n\n      // Notify receiver\n      if (receiver.emailTransactions) {\n        await this.email.sendTransactionEmail({\n          email: receiver.email,\n          firstName: receiver.firstName,\n          transactionType: 'TRANSFER',\n          amount: amount.toString(),\n          currency: receiver.wallet.currency,\n          balance: receiver.wallet.balance.add(amount).toString(),\n          reference: `XFER-${Date.now()}`,\n          description: `Transfer from ${sender.firstName} ${sender.lastName}`,\n        });\n      }\n    } catch (error) {\n      // Log error but don't fail the transaction\n      console.error('Failed to send transaction emails:', error);\n    }\n\n    return result;\n  }\n\n  /**\n   * Request a local transfer (creates a pending transfer requiring admin approval)\n   */\n  async requestLocalTransfer(userId: string, data: CreateTransferDto) {\n    const sender = await this.prisma.user.findUnique({\n      where: { id: userId },\n      include: { wallet: true, kyc: true },\n    });\n\n    if (!sender) throw new NotFoundException('Sender not found');\n\n    // Check KYC verification\n    if (!sender.kyc || sender.kyc.status !== 'APPROVED') {\n      throw new BadRequestException(\n        'KYC verification is required to request transfers. Please complete your KYC verification first.',\n      );\n    }\n\n    // Find recipient by email OR phone (used as account number) OR id\n    let receiver;\n    if (data.recipientEmail) {\n      receiver = await this.prisma.user.findUnique({\n        where: { email: data.recipientEmail },\n        include: { wallet: true },\n      });\n    } else if (data.recipientAccount) {\n      // Try to find by phone (account number) or id\n      receiver = await this.prisma.user.findFirst({\n        where: {\n          OR: [\n            { phone: data.recipientAccount },\n            { id: data.recipientAccount },\n          ],\n        },\n        include: { wallet: true },\n      });\n    }\n\n    if (!receiver) {\n      throw new BadRequestException(\n        `Recipient not found. Searched for: ${data.recipientEmail || data.recipientAccount || 'no identifier provided'}`,\n      );\n    }\n\n    if (!sender.wallet) {\n      throw new BadRequestException('Sender wallet not found');\n    }\n\n    const amount = new Decimal(data.amount);\n\n    if (new Decimal(sender.wallet.balance).lessThan(amount)) {\n      throw new BadRequestException(\n        `Insufficient balance. Available: ${sender.wallet.balance.toString()} ${sender.wallet.currency}, Required: ${amount.toString()} ${sender.wallet.currency}`\n      );\n    }\n\n    if (sender.id === receiver.id) {\n      throw new BadRequestException('Cannot transfer to yourself');\n    }\n\n    const newTransfer = await this.prisma.transfer.create({\n      data: {\n        senderId: userId,\n        receiverId: receiver.id,\n        transferType: 'INTERNAL',\n        amount,\n        currency: sender.wallet.currency,\n        description: data.description,\n        status: 'PENDING',\n      },\n    });\n\n    // Log a pending transaction for the sender so they can see the request in history\n    await this.prisma.transaction.create({\n      data: {\n        userId,\n        type: 'TRANSFER',\n        status: 'PENDING',\n        amount,\n        currency: sender.wallet.currency,\n        balanceBefore: sender.wallet.balance,\n        balanceAfter: sender.wallet.balance, // no funds moved yet\n        description: `Transfer request to ${receiver.firstName} ${receiver.lastName}`,\n        reference: `TRF-${newTransfer.id.substring(0, 8)}-P`,\n        transferId: newTransfer.id,\n      },\n    });\n\n    return newTransfer;\n  }\n\n  /**\n   * Initiate an international transfer\n   */\n  async initiateInternationalTransfer(userId: string, data: CreateInternationalTransferDto) {\n    // Check system setting to require transfer codes (COT/IMF/TAX)\n    // Robust, case-insensitive detection of any setting enabling transfer codes\n    const settings = await (this.prisma as any).systemSetting.findMany({\n      where: { key: { contains: 'transfer', mode: 'insensitive' } },\n      select: { key: true, value: true },\n    });\n    // Per-user forced override\n    const forcedSetting = await (this.prisma as any).systemSetting.findUnique({ where: { key: `transferCodes.force.${userId}` } });\n\n    const truthy = (v: any) => typeof v === 'string'\n      ? ['true', '1', 'yes', 'on', 'enabled', 'enable', 'active'].includes(v.toLowerCase())\n      : !!v;\n\n    const codesRequired = (Array.isArray(settings)\n      ? settings.some((s: any) => /codes?/i.test(s.key) && truthy(s.value))\n      : false) || !!(forcedSetting && truthy(forcedSetting.value));\n\n    // Validate transfer codes if provided or required by settings\n    if (data.transferCodes && data.transferCodes.length > 0) {\n      const validCodes = await this.validateTransferCodes(userId, data.transferCodes);\n      if (!validCodes) {\n        throw new BadRequestException('Invalid or inactive transfer codes');\n      }\n    } else if (codesRequired) {\n      // If codes not provided, allow if user already has all verified codes stored\n      const existing = await this.prisma.transferCode.findMany({\n        where: { userId, isActive: true, isVerified: true },\n        select: { type: true },\n      });\n      const types = new Set(existing.map((e: any) => e.type));\n      const hasAll = types.has('COT') && types.has('IMF') && types.has('TAX');\n      if (!hasAll) {\n        throw new BadRequestException('Transfer codes required (COT, IMF, TAX)');\n      }\n    }\n\n    const user = await this.prisma.user.findUnique({\n      where: { id: userId },\n      include: { wallet: true, kyc: true },\n    });\n\n    if (!user) throw new NotFoundException('User not found');\n\n    // Check KYC verification\n    if (!user.kyc || user.kyc.status !== 'APPROVED') {\n      throw new BadRequestException(\n        'KYC verification is required to make international transfers. Please complete your KYC verification first.',\n      );\n    }\n\n    const amount = new Decimal(data.amount);\n\n    // Check if user has sufficient balance\n    if (new Decimal(user.wallet.balance).lessThan(amount)) {\n      throw new BadRequestException(\n        `Insufficient balance. Available: ${user.wallet.balance.toString()} ${user.wallet.currency}, Required: ${amount.toString()} ${data.currency || user.wallet.currency}`\n      );\n    }\n\n    // Create international transfer (pending status for processing)\n    const transfer = await this.prisma.transfer.create({\n      data: {\n        senderId: userId,\n        transferType: 'INTERNATIONAL',\n        amount,\n        currency: data.currency || user.wallet.currency,\n        description: data.description,\n        status: 'PENDING',\n        beneficiaryName: data.beneficiaryName,\n        beneficiaryAccount: data.beneficiaryAccount,\n        bankName: data.bankName,\n        bankCode: data.bankCode,\n        swiftCode: data.swiftCode,\n        country: data.country,\n      },\n    });\n\n    // Log a pending transaction so the user sees it immediately\n    await this.prisma.transaction.create({\n      data: {\n        userId,\n        type: 'TRANSFER',\n        status: 'PENDING',\n        amount,\n        currency: data.currency || user.wallet.currency,\n        balanceBefore: user.wallet.balance,\n        balanceAfter: user.wallet.balance,\n        description: `International transfer request${data.beneficiaryName ? ` to ${data.beneficiaryName}` : ''}`,\n        reference: `TRF-${transfer.id.substring(0, 8)}-P`,\n        transferId: transfer.id,\n      },\n    });\n\n    // Send email notification to user about pending transfer\n    try {\n      if (user.emailTransactions) {\n        await this.email.sendTransactionEmail({\n          email: user.email,\n          firstName: user.firstName,\n          transactionType: 'TRANSFER',\n          amount: amount.toString(),\n          currency: data.currency || user.wallet.currency,\n          balance: user.wallet.balance.toString(),\n          reference: `TRF-${transfer.id.substring(0, 8)}-P`,\n          description: `International wire transfer to ${data.beneficiaryName} - Processing`,\n        });\n      }\n    } catch (error) {\n      console.error('Failed to send international transfer pending email:', error);\n    }\n\n    return transfer;\n  }\n\n  /**\n   * Validate transfer codes (COT, IMF, TAX)\n   */\n  async validateTransferCodes(userId: string, codes: string[]): Promise<boolean> {\n    const validCodes = await this.prisma.transferCode.findMany({\n      where: {\n        userId,\n        code: { in: codes },\n        isActive: true,\n        isVerified: true,\n      },\n    });\n\n    return validCodes.length === codes.length;\n  }\n\n  /**\n   * Get all beneficiaries for a user\n   */\n  async getBeneficiaries(userId: string) {\n    return this.prisma.beneficiary.findMany({\n      where: { userId },\n      orderBy: [{ isDefault: 'desc' }, { createdAt: 'desc' }],\n    });\n  }\n\n  /**\n   * Create a new beneficiary\n   */\n  async createBeneficiary(userId: string, data: CreateBeneficiaryDto) {\n    // Check if beneficiary already exists\n    const existing = await this.prisma.beneficiary.findUnique({\n      where: {\n        userId_accountNumber: {\n          userId,\n          accountNumber: data.accountNumber,\n        },\n      },\n    });\n\n    if (existing) {\n      throw new BadRequestException('Beneficiary already exists');\n    }\n\n    return this.prisma.beneficiary.create({\n      data: {\n        ...data,\n        userId,\n      },\n    });\n  }\n\n  /**\n   * Update a beneficiary\n   */\n  async updateBeneficiary(userId: string, beneficiaryId: string, data: Partial<CreateBeneficiaryDto>) {\n    const beneficiary = await this.prisma.beneficiary.findUnique({\n      where: { id: beneficiaryId },\n    });\n\n    if (!beneficiary || beneficiary.userId !== userId) {\n      throw new BadRequestException('Beneficiary not found or unauthorized');\n    }\n\n    return this.prisma.beneficiary.update({\n      where: { id: beneficiaryId },\n      data,\n    });\n  }\n\n  /**\n   * Delete a beneficiary\n   */\n  async deleteBeneficiary(userId: string, beneficiaryId: string) {\n    const beneficiary = await this.prisma.beneficiary.findUnique({\n      where: { id: beneficiaryId },\n    });\n\n    if (!beneficiary || beneficiary.userId !== userId) {\n      throw new BadRequestException('Beneficiary not found or unauthorized');\n    }\n\n    return this.prisma.beneficiary.delete({\n      where: { id: beneficiaryId },\n    });\n  }\n\n  /**\n   * Set a beneficiary as default\n   */\n  async setDefaultBeneficiary(userId: string, beneficiaryId: string) {\n    const beneficiary = await this.prisma.beneficiary.findUnique({\n      where: { id: beneficiaryId },\n    });\n\n    if (!beneficiary || beneficiary.userId !== userId) {\n      throw new BadRequestException('Beneficiary not found or unauthorized');\n    }\n\n    // Remove default from all other beneficiaries\n    await this.prisma.beneficiary.updateMany({\n      where: { userId, isDefault: true },\n      data: { isDefault: false },\n    });\n\n    // Set this one as default\n    return this.prisma.beneficiary.update({\n      where: { id: beneficiaryId },\n      data: { isDefault: true },\n    });\n  }\n\n  /**\n   * Get transfer history\n   */\n  async getTransferHistory(userId: string, limit: number = 10, skip: number = 0) {\n    return this.prisma.transfer.findMany({\n      where: {\n        OR: [{ senderId: userId }, { receiverId: userId }],\n      },\n      orderBy: { createdAt: 'desc' },\n      take: limit,\n      skip,\n      include: {\n        sender: {\n          select: { id: true, firstName: true, lastName: true, email: true },\n        },\n        receiver: {\n          select: { id: true, firstName: true, lastName: true, email: true },\n        },\n      },\n    });\n  }\n\n  /**\n   * Admin: Get all transfers\n   */\n  async getAllTransfers() {\n    const transfers = await this.prisma.transfer.findMany({\n      include: {\n        sender: {\n          select: {\n            id: true,\n            firstName: true,\n            lastName: true,\n            email: true,\n          },\n        },\n        receiver: {\n          select: {\n            id: true,\n            firstName: true,\n            lastName: true,\n            email: true,\n          },\n        },\n      },\n      orderBy: { createdAt: 'desc' },\n    });\n\n    return transfers.map(transfer => ({\n      id: transfer.id,\n      senderId: transfer.senderId,\n      senderName: `${transfer.sender.firstName} ${transfer.sender.lastName}`,\n      senderEmail: transfer.sender.email,\n      receiverId: transfer.receiverId,\n      receiverName: transfer.receiver ? `${transfer.receiver.firstName} ${transfer.receiver.lastName}` : 'N/A',\n      receiverEmail: transfer.receiver?.email || 'N/A',\n      amount: transfer.amount.toNumber(),\n      currency: transfer.currency,\n      transferType: transfer.transferType,\n      status: transfer.status,\n      reference: `TRF-${transfer.id.substring(0, 8)}`,\n      description: transfer.description,\n      createdAt: transfer.createdAt,\n      updatedAt: transfer.updatedAt,\n    }));\n  }\n\n  /**\n   * Admin: Approve transfer\n   */\n  async approveTransfer(transferId: string, adminId: string) {\n    const transfer = await this.prisma.transfer.findUnique({\n      where: { id: transferId },\n      include: {\n        sender: { include: { wallet: true } },\n        receiver: { include: { wallet: true } },\n      },\n    });\n\n    if (!transfer) {\n      throw new NotFoundException('Transfer not found');\n    }\n\n    if (transfer.status !== 'PENDING') {\n      throw new BadRequestException('Transfer already processed');\n    }\n\n    // Perform approval atomically and ensure unique references per transaction\n    const result = await this.prisma.$transaction(async (tx) => {\n      // Mark transfer completed\n      const updatedTransfer = await tx.transfer.update({\n        where: { id: transferId },\n        data: { status: 'COMPLETED' },\n      });\n\n      // Fetch wallets fresh within transaction\n      const senderWallet = await tx.wallet.findUnique({ where: { userId: transfer.senderId } });\n      const senderBalanceBefore = senderWallet.balance;\n      const senderWalletAfter = await tx.wallet.update({\n        where: { userId: transfer.senderId },\n        data: { balance: { decrement: transfer.amount } },\n      });\n\n      let receiverWalletAfter: any = null;\n      let receiverBalanceBefore: any = null;\n      if (transfer.receiverId && transfer.receiver) {\n        const receiverWallet = await tx.wallet.findUnique({ where: { userId: transfer.receiverId } });\n        receiverBalanceBefore = receiverWallet.balance;\n        receiverWalletAfter = await tx.wallet.update({\n          where: { userId: transfer.receiverId },\n          data: { balance: { increment: transfer.amount } },\n        });\n      }\n\n      const baseRef = `TRF-${transfer.id.substring(0, 8)}`;\n      const senderRef = `${baseRef}-S`;\n      const receiverRef = `${baseRef}-R`;\n\n      // If a pending sender transaction exists for this transfer, update it; else create new\n      const pendingTx = await tx.transaction.findFirst({\n        where: { transferId: transfer.id, userId: transfer.senderId, type: 'TRANSFER', status: 'PENDING' },\n      });\n      if (pendingTx) {\n        await tx.transaction.update({\n          where: { id: pendingTx.id },\n          data: {\n            status: 'COMPLETED',\n            balanceBefore: senderBalanceBefore,\n            balanceAfter: senderWalletAfter.balance,\n            description: `Transfer to ${transfer.receiver?.firstName || 'external'} ${transfer.receiver?.lastName || ''}`.trim(),\n            reference: senderRef,\n          },\n        });\n      } else {\n        await tx.transaction.create({\n          data: {\n            userId: transfer.senderId,\n            type: 'TRANSFER',\n            amount: transfer.amount,\n            currency: transfer.currency,\n            balanceBefore: senderBalanceBefore,\n            balanceAfter: senderWalletAfter.balance,\n            status: 'COMPLETED',\n            description: `Transfer to ${transfer.receiver?.firstName || 'external'} ${transfer.receiver?.lastName || ''}`.trim(),\n            reference: senderRef,\n            transferId: transfer.id,\n          },\n        });\n      }\n\n      if (transfer.receiverId && receiverWalletAfter) {\n        await tx.transaction.create({\n          data: {\n            userId: transfer.receiverId,\n            type: 'TRANSFER',\n            amount: transfer.amount,\n            currency: transfer.currency,\n            balanceBefore: receiverBalanceBefore,\n            balanceAfter: receiverWalletAfter.balance,\n            status: 'COMPLETED',\n            description: `Transfer from ${transfer.sender.firstName} ${transfer.sender.lastName}`,\n            reference: receiverRef,\n            transferId: transfer.id,\n          },\n        });\n      }\n\n      return updatedTransfer;\n    });\n\n    // Send email notification to sender about approved transfer\n    try {\n      if (transfer.sender.emailTransactions) {\n        const newBalance = transfer.sender.wallet.balance.sub(transfer.amount);\n        await this.email.sendTransactionEmail({\n          email: transfer.sender.email,\n          firstName: transfer.sender.firstName,\n          transactionType: 'TRANSFER',\n          amount: transfer.amount.toString(),\n          currency: transfer.currency,\n          balance: newBalance.toString(),\n          reference: `TRF-${transfer.id.substring(0, 8)}-S`,\n          description: `International wire transfer to ${transfer.beneficiaryName || 'external'} - Completed successfully`,\n        });\n      }\n    } catch (error) {\n      console.error('Failed to send transfer approval email:', error);\n    }\n\n    // Optionally emit audit log asynchronously here\n    return result;\n  }\n\n  /**\n   * Admin: Reject transfer\n   */\n  async rejectTransfer(transferId: string, adminId: string, reason?: string) {\n    const transfer = await this.prisma.transfer.findUnique({\n      where: { id: transferId },\n      include: {\n        sender: { include: { wallet: true } },\n        receiver: true,\n      },\n    });\n\n    if (!transfer) {\n      throw new NotFoundException('Transfer not found');\n    }\n\n    if (transfer.status !== 'PENDING') {\n      throw new BadRequestException('Transfer already processed');\n    }\n\n    // Mark transfer failed\n    const updatedTransfer = await this.prisma.transfer.update({\n      where: { id: transferId },\n      data: { status: 'FAILED' },\n    });\n\n    // Update existing pending transaction for the sender to FAILED, or create one if missing\n    const pendingTx = await this.prisma.transaction.findFirst({\n      where: { transferId: transferId, userId: transfer.senderId, type: 'TRANSFER', status: 'PENDING' },\n    });\n\n    if (pendingTx) {\n      await this.prisma.transaction.update({\n        where: { id: pendingTx.id },\n        data: {\n          status: 'FAILED',\n          balanceBefore: transfer.sender.wallet?.balance,\n          balanceAfter: transfer.sender.wallet?.balance, // no funds moved\n          description: `Transfer request rejected${reason ? `: ${reason}` : ''}`,\n          reference: `TRF-${transfer.id.substring(0, 8)}-RJ`,\n        },\n      });\n    } else {\n      // Log a failed transfer entry so the user sees it in history\n      await this.prisma.transaction.create({\n        data: {\n          userId: transfer.senderId,\n          type: 'TRANSFER',\n          status: 'FAILED',\n          amount: transfer.amount,\n          currency: transfer.currency,\n          balanceBefore: transfer.sender.wallet?.balance,\n          balanceAfter: transfer.sender.wallet?.balance,\n          description: `Transfer rejected by admin${reason ? `: ${reason}` : ''}`,\n          reference: `TRF-${transfer.id.substring(0, 8)}-RJ`,\n          transferId: transfer.id,\n        },\n      });\n    }\n\n    // Notify sender\n    await (this.prisma as any).notification.create({\n      data: {\n        userId: transfer.senderId,\n        title: 'Transfer Rejected',\n        message: `Your transfer of ${transfer.amount.toNumber ? transfer.amount.toNumber() : transfer.amount} ${transfer.currency} was rejected${reason ? `: ${reason}` : ''}.`,\n        type: 'ERROR',\n      },\n    }).catch(() => {});\n\n    return updatedTransfer;\n  }\n\n  /**\n   * Delete transfer (User can delete their own transfer history)\n   */\n  async deleteTransfer(userId: string, transferId: string) {\n    const transfer = await this.prisma.transfer.findUnique({\n      where: { id: transferId },\n    });\n\n    if (!transfer) {\n      throw new NotFoundException('Transfer not found');\n    }\n\n    if (transfer.senderId !== userId && transfer.receiverId !== userId) {\n      throw new BadRequestException('You can only delete your own transfers');\n    }\n\n    // Only allow deletion of failed or completed transfers\n    if (transfer.status === 'PENDING' || transfer.status === 'PROCESSING') {\n      throw new BadRequestException('Cannot delete pending or processing transfers');\n    }\n\n    await this.prisma.transfer.delete({\n      where: { id: transferId },\n    });\n\n    return { message: 'Transfer deleted successfully' };\n  }\n\n  /**\n   * Admin: Delete transfer (Admins can delete any transfer)\n   */\n  async adminDeleteTransfer(transferId: string, adminId: string) {\n    const transfer = await this.prisma.transfer.findUnique({\n      where: { id: transferId },\n      include: {\n        sender: true,\n        receiver: true,\n      },\n    });\n\n    if (!transfer) {\n      throw new NotFoundException('Transfer not found');\n    }\n\n    await this.prisma.transfer.delete({\n      where: { id: transferId },\n    });\n\n    // Create audit log\n    // await this.prisma.auditLog.create({\n    //   data: {\n    //     userId: adminId,\n    //     action: 'DELETE',\n    //     entity: 'Transfer',\n    //     entityId: transferId,\n    //     details: `Deleted transfer of ${transfer.amount} ${transfer.currency} from ${transfer.sender.email} to ${transfer.receiver?.email || 'external'}`,\n    //   },\n    // });\n\n    return { message: 'Transfer deleted successfully' };\n  }\n\n  /**\n   * User: Request a transfer code (COT/IMF/TAX)\n   */\n  async requestTransferCode(userId: string, type: 'COT' | 'IMF' | 'TAX') {\n    // Upsert placeholder record flagged as not verified\n    const codeRec = await this.prisma.transferCode.upsert({\n      where: { userId_type: { userId, type } as any },\n      update: { isActive: false, isVerified: false },\n      create: {\n        userId,\n        type: type as any,\n        code: 'PENDING',\n        amount: new Decimal(0),\n        isActive: false,\n        isVerified: false,\n      },\n    } as any);\n    // Optionally notify admins via audit or notifications (omitted here)\n    return { requested: true };\n  }\n\n  /**\n   * User: Verify a transfer code issued by admin\n   */\n  async verifyUserTransferCode(userId: string, type: 'COT' | 'IMF' | 'TAX', code: string) {\n    const rec = await this.prisma.transferCode.findUnique({\n      where: { userId_type: { userId, type } as any },\n    } as any);\n    \n    // Better error messages for debugging\n    if (!rec) {\n      throw new BadRequestException(`No ${type} code found. Please request one first.`);\n    }\n    if (!rec.isActive) {\n      throw new BadRequestException(`${type} code not activated yet. Please wait for admin approval.`);\n    }\n    \n    // Trim and uppercase both codes for comparison\n    const storedCode = rec.code.trim().toUpperCase();\n    const providedCode = code.trim().toUpperCase();\n    \n    // Normalize common confusable characters: O->0, I->1, l->1\n    const normalizeCode = (c: string) => c.replace(/O/g, '0').replace(/[Il]/g, '1');\n    const normalizedStored = normalizeCode(storedCode);\n    const normalizedProvided = normalizeCode(providedCode);\n    \n    if (normalizedStored !== normalizedProvided) {\n      throw new BadRequestException(`Invalid ${type} code. Expected: \"${storedCode}\" (length: ${storedCode.length}), Got: \"${providedCode}\" (length: ${providedCode.length}). Please check carefully - use number 0 not letter O.`);\n    }\n    \n    await this.prisma.transferCode.update({\n      where: { userId_type: { userId, type } as any },\n      data: { isVerified: true, verifiedBy: userId, verifiedAt: new Date() },\n    } as any);\n    return { verified: true, success: true };\n  }\n\n  /**\n   * Admin: Approve and issue a transfer code to user via email\n   */\n  async adminApproveAndIssueTransferCode(targetUserId: string, type: 'COT' | 'IMF' | 'TAX', adminId: string) {\n    // Generate code\n    const code = Math.random().toString(36).substring(2, 8).toUpperCase();\n\n    // Upsert record\n    const rec = await this.prisma.transferCode.upsert({\n      where: { userId_type: { userId: targetUserId, type } as any },\n      update: { code, isActive: true, isVerified: false, activatedBy: adminId, activatedAt: new Date() },\n      create: {\n        userId: targetUserId,\n        type: type as any,\n        code,\n        amount: new Decimal(0),\n        isActive: true,\n        isVerified: false,\n        activatedBy: adminId,\n        activatedAt: new Date(),\n      },\n    } as any);\n\n    // Email the code to the user\n    const user = await this.prisma.user.findUnique({ where: { id: targetUserId } });\n    try {\n      await (this as any).email?.sendTransferCodeEmail?.({\n        email: user?.email,\n        firstName: user?.firstName || 'Customer',\n        type,\n        code,\n      });\n    } catch (_) {}\n\n    return { issued: true };\n  }\n\n  /**\n   * Codes status for current user and whether codes are required\n   */\n  async getUserTransferCodeStatus(userId: string) {\n    // Same detection as initiateInternationalTransfer\n    const settings = await (this.prisma as any).systemSetting.findMany({\n      where: { key: { contains: 'transfer', mode: 'insensitive' } },\n      select: { key: true, value: true },\n    });\n    const truthy = (v: any) => typeof v === 'string'\n      ? ['true', '1', 'yes', 'on', 'enabled', 'enable', 'active'].includes(v.toLowerCase())\n      : !!v;\n    const codesRequired = Array.isArray(settings)\n      ? settings.some((s: any) => /codes?/i.test(s.key) && truthy(s.value))\n      : false;\n\n    const codes = await this.prisma.transferCode.findMany({\n      where: { userId },\n      select: { type: true, isActive: true, isVerified: true },\n    });\n\n    const byType = { COT: { isActive: false, isVerified: false }, IMF: { isActive: false, isVerified: false }, TAX: { isActive: false, isVerified: false } };\n    codes.forEach((c: any) => { byType[c.type] = { isActive: c.isActive, isVerified: c.isVerified }; });\n\n    return { transferCodesRequired: codesRequired, codes: byType };\n  }\n\n  /**\n   * Admin: List pending transfer code requests\n   */\n  async getPendingTransferCodeRequests() {\n    const rows = await this.prisma.transferCode.findMany({\n      where: { isActive: false, isVerified: false },\n      include: { user: { select: { id: true, email: true, firstName: true, lastName: true } } },\n      orderBy: { createdAt: 'desc' },\n    } as any);\n    return rows.map((r: any) => ({\n      userId: r.userId,\n      userEmail: r.user?.email,\n      userName: `${r.user?.firstName || ''} ${r.user?.lastName || ''}`.trim(),\n      type: r.type,\n      requestedAt: r.createdAt,\n    }));\n  }\n\n  /**\n   * Admin: Get a user's codes and forced flag\n   */\n  async adminGetUserCodes(userId: string) {\n    const codes = await this.prisma.transferCode.findMany({\n      where: { userId },\n      select: { type: true, code: true, isActive: true, isVerified: true, activatedAt: true, verifiedAt: true },\n    } as any);\n    const force = await (this.prisma as any).systemSetting.findUnique({ where: { key: `transferCodes.force.${userId}` } });\n    return { forced: !!(force && (force.value === 'true' || force.value === '1')), codes };\n  }\n\n  /**\n   * Admin: Set or clear per-user force-verification override\n   */\n  async adminSetUserCodesForce(userId: string, forced: boolean) {\n    await (this.prisma as any).systemSetting.upsert({\n      where: { key: `transferCodes.force.${userId}` },\n      update: { value: forced ? 'true' : 'false' },\n      create: { key: `transferCodes.force.${userId}`, value: forced ? 'true' : 'false', description: 'Per-user transfer codes force flag' },\n    });\n    return { forced };\n  }\n}\n"],"names":["TransfersService","initiateLocalTransfer","userId","data","sender","prisma","user","findUnique","where","id","include","wallet","kyc","NotFoundException","status","BadRequestException","receiver","email","recipientEmail","amount","Decimal","balance","lessThan","toString","currency","result","$transaction","tx","newTransfer","transfer","create","senderId","receiverId","transferType","description","senderBalanceBefore","senderBalanceAfter","sub","update","receiverBalanceBefore","receiverBalanceAfter","add","transaction","type","balanceBefore","balanceAfter","firstName","lastName","reference","Date","now","Math","random","substring","transferId","emailTransactions","sendTransactionEmail","transactionType","error","console","requestLocalTransfer","recipientAccount","findFirst","OR","phone","initiateInternationalTransfer","settings","systemSetting","findMany","key","contains","mode","select","value","forcedSetting","truthy","v","includes","toLowerCase","codesRequired","Array","isArray","some","s","test","transferCodes","length","validCodes","validateTransferCodes","existing","transferCode","isActive","isVerified","types","Set","map","e","hasAll","has","beneficiaryName","beneficiaryAccount","bankName","bankCode","swiftCode","country","codes","code","in","getBeneficiaries","beneficiary","orderBy","isDefault","createdAt","createBeneficiary","userId_accountNumber","accountNumber","updateBeneficiary","beneficiaryId","deleteBeneficiary","delete","setDefaultBeneficiary","updateMany","getTransferHistory","limit","skip","take","getAllTransfers","transfers","senderName","senderEmail","receiverName","receiverEmail","toNumber","updatedAt","approveTransfer","adminId","updatedTransfer","senderWallet","senderWalletAfter","decrement","receiverWalletAfter","receiverWallet","increment","baseRef","senderRef","receiverRef","pendingTx","trim","newBalance","rejectTransfer","reason","notification","title","message","catch","deleteTransfer","adminDeleteTransfer","requestTransferCode","codeRec","upsert","userId_type","requested","verifyUserTransferCode","rec","storedCode","toUpperCase","providedCode","normalizeCode","c","replace","normalizedStored","normalizedProvided","verifiedBy","verifiedAt","verified","success","adminApproveAndIssueTransferCode","targetUserId","activatedBy","activatedAt","sendTransferCodeEmail","_","issued","getUserTransferCodeStatus","byType","COT","IMF","TAX","forEach","transferCodesRequired","getPendingTransferCodeRequests","rows","r","userEmail","userName","requestedAt","adminGetUserCodes","force","forced","adminSetUserCodesForce"],"mappings":"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"}