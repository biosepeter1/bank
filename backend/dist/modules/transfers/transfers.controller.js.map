{"version":3,"sources":["../../../src/modules/transfers/transfers.controller.ts"],"sourcesContent":["import {\r\n  Controller,\r\n  Post,\r\n  Get,\r\n  Patch,\r\n  Delete,\r\n  Body,\r\n  Param,\r\n  UseGuards,\r\n  Request,\r\n  Query,\r\n} from '@nestjs/common';\r\nimport { JwtAuthGuard } from '@/common/guards/jwt-auth.guard';\r\nimport { RolesGuard } from '@/common/guards/roles.guard';\r\nimport { EmailVerifiedGuard } from '@/common/guards/email-verified.guard';\r\nimport { Roles } from '@/common/decorators/roles.decorator';\r\nimport { RequireEmailVerified } from '@/common/decorators/email-verified.decorator';\r\nimport { TransfersService } from './transfers.service';\r\nimport { CreateTransferDto, CreateInternationalTransferDto, CreateBeneficiaryDto } from './dto/create-transfer.dto';\r\nimport { RequestTransferCodeDto, VerifyTransferCodeDto } from './dto/transfer-code-request.dto';\r\nimport { TransferCodeStatusResponseDto } from './dto/transfer-code-status.dto';\r\nimport { ApiOperation, ApiTags, ApiBearerAuth, ApiResponse } from '@nestjs/swagger';\r\n\r\n@ApiTags('transfers')\r\n@ApiBearerAuth()\r\n@Controller('transfers')\r\n@UseGuards(JwtAuthGuard, EmailVerifiedGuard)\r\nexport class TransfersController {\r\n  constructor(private transfersService: TransfersService) { }\r\n\r\n  /**\r\n   * Initiate a local transfer between platform users\r\n   */\r\n  @Post('local')\r\n  @RequireEmailVerified()\r\n  @ApiOperation({ summary: 'Send money to another user' })\r\n  async initiateLocalTransfer(\r\n    @Request() req,\r\n    @Body() createTransferDto: CreateTransferDto,\r\n  ) {\r\n    return this.transfersService.initiateLocalTransfer(req.user.id, createTransferDto);\r\n  }\r\n\r\n  /**\r\n   * Request a local transfer (Pending; admin approval required)\r\n   */\r\n  @Post('request/local')\r\n  @RequireEmailVerified()\r\n  @ApiOperation({ summary: 'Request a local transfer (pending until admin approves)' })\r\n  async requestLocalTransfer(\r\n    @Request() req,\r\n    @Body() createTransferDto: CreateTransferDto,\r\n  ) {\r\n    return this.transfersService.requestLocalTransfer(req.user.id, createTransferDto);\r\n  }\r\n\r\n  /**\r\n   * Initiate an international transfer\r\n   */\r\n  @Post('international')\r\n  @RequireEmailVerified()\r\n  @ApiOperation({ summary: 'Send money internationally' })\r\n  async initiateInternationalTransfer(\r\n    @Request() req,\r\n    @Body() data: CreateInternationalTransferDto,\r\n  ) {\r\n    return this.transfersService.initiateInternationalTransfer(req.user.id, data);\r\n  }\r\n\r\n  /**\r\n   * Get all beneficiaries for the current user\r\n   */\r\n  @Get('beneficiaries')\r\n  @ApiOperation({ summary: 'Get all saved beneficiaries' })\r\n  async getBeneficiaries(@Request() req) {\r\n    return this.transfersService.getBeneficiaries(req.user.id);\r\n  }\r\n\r\n  /**\r\n   * Create a new beneficiary\r\n   */\r\n  @Post('beneficiaries')\r\n  @ApiOperation({ summary: 'Add a new beneficiary' })\r\n  async createBeneficiary(\r\n    @Request() req,\r\n    @Body() data: CreateBeneficiaryDto,\r\n  ) {\r\n    return this.transfersService.createBeneficiary(req.user.id, data);\r\n  }\r\n\r\n  /**\r\n   * Update a beneficiary\r\n   */\r\n  @Patch('beneficiaries/:id')\r\n  @ApiOperation({ summary: 'Update beneficiary details' })\r\n  async updateBeneficiary(\r\n    @Request() req,\r\n    @Param('id') beneficiaryId: string,\r\n    @Body() data: Partial<CreateBeneficiaryDto>,\r\n  ) {\r\n    return this.transfersService.updateBeneficiary(req.user.id, beneficiaryId, data);\r\n  }\r\n\r\n  /**\r\n   * Delete a beneficiary\r\n   */\r\n  @Delete('beneficiaries/:id')\r\n  @ApiOperation({ summary: 'Remove a beneficiary' })\r\n  async deleteBeneficiary(\r\n    @Request() req,\r\n    @Param('id') beneficiaryId: string,\r\n  ) {\r\n    return this.transfersService.deleteBeneficiary(req.user.id, beneficiaryId);\r\n  }\r\n\r\n  /**\r\n   * Set a beneficiary as default\r\n   */\r\n  @Patch('beneficiaries/:id/set-default')\r\n  @ApiOperation({ summary: 'Set beneficiary as default' })\r\n  async setDefaultBeneficiary(\r\n    @Request() req,\r\n    @Param('id') beneficiaryId: string,\r\n  ) {\r\n    return this.transfersService.setDefaultBeneficiary(req.user.id, beneficiaryId);\r\n  }\r\n\r\n  /**\r\n   * Validate transfer codes\r\n   */\r\n  @Post('validate-codes')\r\n  @ApiOperation({ summary: 'Validate transfer codes (COT, IMF, TAX)' })\r\n  async validateCodes(\r\n    @Request() req,\r\n    @Body() { codes }: { codes: string[] },\r\n  ) {\r\n    const valid = await this.transfersService.validateTransferCodes(req.user.id, codes);\r\n    return { valid };\r\n  }\r\n\r\n  // Stepwise transfer codes flow\r\n  @Post('codes/request')\r\n  @ApiOperation({ summary: 'Request a transfer code (COT/IMF/TAX)' })\r\n  async requestCode(\r\n    @Request() req,\r\n    @Body() body: RequestTransferCodeDto,\r\n  ) {\r\n    return this.transfersService.requestTransferCode(req.user.id, body.type);\r\n  }\r\n\r\n  @Post('codes/verify')\r\n  @ApiOperation({ summary: 'Verify a transfer code (COT/IMF/TAX)' })\r\n  async verifyCode(\r\n    @Request() req,\r\n    @Body() body: VerifyTransferCodeDto,\r\n  ) {\r\n    return this.transfersService.verifyUserTransferCode(req.user.id, body.type, body.code);\r\n  }\r\n\r\n  @Get('codes/status')\r\n  @ApiOperation({ summary: 'Get codes required flag and per-type status' })\r\n  @ApiResponse({ type: TransferCodeStatusResponseDto })\r\n  async getCodesStatus(@Request() req): Promise<TransferCodeStatusResponseDto> {\r\n    return this.transfersService.getUserTransferCodeStatus(req.user.id);\r\n  }\r\n\r\n  /**\r\n   * Get transfer history\r\n   */\r\n  @Get('history')\r\n  @ApiOperation({ summary: 'Get user transfer history' })\r\n  async getTransferHistory(\r\n    @Request() req,\r\n    @Query('limit') limit: string = '10',\r\n    @Query('skip') skip: string = '0',\r\n  ) {\r\n    return this.transfersService.getTransferHistory(\r\n      req.user.id,\r\n      parseInt(limit),\r\n      parseInt(skip),\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Delete transfer (User can delete their own transfer history)\r\n   */\r\n  @Delete(':transferId')\r\n  @ApiOperation({ summary: 'Delete transfer from history' })\r\n  async deleteTransfer(\r\n    @Request() req,\r\n    @Param('transferId') transferId: string,\r\n  ) {\r\n    return this.transfersService.deleteTransfer(req.user.id, transferId);\r\n  }\r\n\r\n  /**\r\n   * Admin: Get all transfers\r\n   */\r\n  @Get('admin/all')\r\n  @UseGuards(RolesGuard)\r\n  @Roles('BANK_ADMIN', 'SUPER_ADMIN')\r\n  @ApiOperation({ summary: 'Get all transfers (Admin only)' })\r\n  async getAllTransfers() {\r\n    return this.transfersService.getAllTransfers();\r\n  }\r\n\r\n  /**\r\n   * Admin: Approve transfer\r\n   */\r\n  @Patch('admin/:transferId/approve')\r\n  @UseGuards(RolesGuard)\r\n  @Roles('BANK_ADMIN', 'SUPER_ADMIN')\r\n  @ApiOperation({ summary: 'Approve transfer (Admin only)' })\r\n  async approveTransfer(\r\n    @Param('transferId') transferId: string,\r\n    @Request() req,\r\n  ) {\r\n    const adminId = req.user.id;\r\n    return this.transfersService.approveTransfer(transferId, adminId);\r\n  }\r\n\r\n  /**\r\n   * Admin: Reject transfer\r\n   */\r\n  @Patch('admin/:transferId/reject')\r\n  @UseGuards(RolesGuard)\r\n  @Roles('BANK_ADMIN', 'SUPER_ADMIN')\r\n  @ApiOperation({ summary: 'Reject transfer (Admin only)' })\r\n  async rejectTransfer(\r\n    @Param('transferId') transferId: string,\r\n    @Body() body: { reason?: string },\r\n    @Request() req,\r\n  ) {\r\n    const adminId = req.user.id;\r\n    return this.transfersService.rejectTransfer(transferId, adminId, body.reason);\r\n  }\r\n\r\n  /**\r\n   * Admin: Delete transfer\r\n   */\r\n  @Delete('admin/:transferId')\r\n  @UseGuards(RolesGuard)\r\n  @Roles('BANK_ADMIN', 'SUPER_ADMIN')\r\n  @ApiOperation({ summary: 'Delete transfer (Admin only)' })\r\n  async adminDeleteTransfer(\r\n    @Param('transferId') transferId: string,\r\n    @Request() req,\r\n  ) {\r\n    const adminId = req.user.id;\r\n    return this.transfersService.adminDeleteTransfer(transferId, adminId);\r\n  }\r\n\r\n  // Admin: Approve & issue transfer codes\r\n  @Patch('codes/admin/:userId/:type/approve')\r\n  @UseGuards(RolesGuard)\r\n  @Roles('BANK_ADMIN', 'SUPER_ADMIN')\r\n  @ApiOperation({ summary: 'Approve and issue a transfer code to user (Admin only)' })\r\n  async adminApproveCode(\r\n    @Param('userId') userId: string,\r\n    @Param('type') type: string,\r\n    @Request() req,\r\n  ) {\r\n    return this.transfersService.adminApproveAndIssueTransferCode(userId, type as any, req.user.id);\r\n  }\r\n\r\n  @Get('codes/admin/requests')\r\n  @UseGuards(RolesGuard)\r\n  @Roles('BANK_ADMIN', 'SUPER_ADMIN')\r\n  @ApiOperation({ summary: 'List pending transfer code requests (Admin only)' })\r\n  async adminListCodeRequests() {\r\n    return this.transfersService.getPendingTransferCodeRequests();\r\n  }\r\n\r\n  @Get('codes/admin/:userId')\r\n  @UseGuards(RolesGuard)\r\n  @Roles('BANK_ADMIN', 'SUPER_ADMIN')\r\n  @ApiOperation({ summary: 'Get a user\\'s transfer codes and force flag (Admin only)' })\r\n  async adminGetUserCodes(@Param('userId') userId: string) {\r\n    return this.transfersService.adminGetUserCodes(userId);\r\n  }\r\n\r\n  @Patch('codes/admin/:userId/force')\r\n  @UseGuards(RolesGuard)\r\n  @Roles('BANK_ADMIN', 'SUPER_ADMIN')\r\n  @ApiOperation({ summary: 'Set per-user force verification flag (Admin only)' })\r\n  async adminSetUserForce(\r\n    @Param('userId') userId: string,\r\n    @Body() body: { forced: boolean },\r\n  ) {\r\n    return this.transfersService.adminSetUserCodesForce(userId, !!body.forced);\r\n  }\r\n}\r\n"],"names":["TransfersController","initiateLocalTransfer","req","createTransferDto","transfersService","user","id","requestLocalTransfer","initiateInternationalTransfer","data","getBeneficiaries","createBeneficiary","updateBeneficiary","beneficiaryId","deleteBeneficiary","setDefaultBeneficiary","validateCodes","codes","valid","validateTransferCodes","requestCode","body","requestTransferCode","type","verifyCode","verifyUserTransferCode","code","getCodesStatus","getUserTransferCodeStatus","getTransferHistory","limit","skip","parseInt","deleteTransfer","transferId","getAllTransfers","approveTransfer","adminId","rejectTransfer","reason","adminDeleteTransfer","adminApproveCode","userId","adminApproveAndIssueTransferCode","adminListCodeRequests","getPendingTransferCodeRequests","adminGetUserCodes","adminSetUserForce","adminSetUserCodesForce","forced","summary","TransferCodeStatusResponseDto"],"mappings":"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"}