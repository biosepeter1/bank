{"version":3,"sources":["../../../src/modules/otp/otp.service.ts"],"sourcesContent":["import { BadRequestException, Injectable, Logger, NotFoundException } from '@nestjs/common';\r\nimport { PrismaService } from '../../prisma/prisma.service';\r\nimport { EmailService } from '../../common/services/email.service';\r\nimport * as bcrypt from 'bcrypt';\r\n\r\n@Injectable()\r\nexport class OtpService {\r\n  private readonly logger = new Logger(OtpService.name);\r\n  private readonly TTL_SECONDS = 5 * 60; // 5 minutes\r\n\r\n  constructor(private prisma: PrismaService, private email: EmailService) { }\r\n\r\n  private generateCode(): string {\r\n    // 6-digit numeric\r\n    return Math.floor(100000 + Math.random() * 900000).toString();\r\n  }\r\n\r\n  async start(userId: string, purpose: string, metadata?: Record<string, any>) {\r\n    const code = this.generateCode();\r\n    const codeHash = await bcrypt.hash(code, 10);\r\n    const expiresAt = new Date(Date.now() + this.TTL_SECONDS * 1000);\r\n\r\n    let otp;\r\n    try {\r\n      otp = await (this.prisma as any).otpCode.create({\r\n        data: {\r\n          userId,\r\n          purpose,\r\n          codeHash,\r\n          expiresAt,\r\n          metadata: metadata as any,\r\n        },\r\n      });\r\n    } catch (error) {\r\n      this.logger.error(`Failed to create OTP code: ${error.message}`, error.stack);\r\n      throw error;\r\n    }\r\n\r\n    // Send via email\r\n    try {\r\n      const user = await (this.prisma as any).user.findUnique({ where: { id: userId } });\r\n      await this.email.sendOtpEmail({\r\n        email: user?.email || metadata?.email || 'user@local',\r\n        firstName: user?.firstName || metadata?.firstName || 'User',\r\n        code,\r\n        purpose: purpose,\r\n      });\r\n    } catch (e) {\r\n      // We only log here; in production wire a dedicated template\r\n      this.logger.warn(`Email send failed or stubbed: ${e?.message || e}`);\r\n    }\r\n\r\n    return { otpId: otp.id, code, expiresIn: this.TTL_SECONDS };\r\n  }\r\n\r\n  async verify(userId: string, otpId: string, code: string) {\r\n    const otp = await (this.prisma as any).otpCode.findUnique({ where: { id: otpId } });\r\n    if (!otp || otp.userId !== userId) {\r\n      throw new NotFoundException('OTP not found');\r\n    }\r\n    if (otp.usedAt) {\r\n      throw new BadRequestException('OTP already used');\r\n    }\r\n    if (otp.expiresAt < new Date()) {\r\n      throw new BadRequestException('OTP expired');\r\n    }\r\n    if (otp.attempts >= 5) {\r\n      throw new BadRequestException('Too many attempts');\r\n    }\r\n\r\n    const ok = await bcrypt.compare(code, otp.codeHash);\r\n    await (this.prisma as any).otpCode.update({\r\n      where: { id: otpId },\r\n      data: { attempts: { increment: 1 }, usedAt: ok ? new Date() : null },\r\n    });\r\n\r\n    if (!ok) throw new BadRequestException('Invalid code');\r\n\r\n    return { success: true };\r\n  }\r\n}\r\n"],"names":["OtpService","generateCode","Math","floor","random","toString","start","userId","purpose","metadata","code","codeHash","bcrypt","hash","expiresAt","Date","now","TTL_SECONDS","otp","prisma","otpCode","create","data","error","logger","message","stack","user","findUnique","where","id","email","sendOtpEmail","firstName","e","warn","otpId","expiresIn","verify","NotFoundException","usedAt","BadRequestException","attempts","ok","compare","update","increment","success","Logger","name"],"mappings":"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"}