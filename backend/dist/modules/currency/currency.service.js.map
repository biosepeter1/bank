{"version":3,"sources":["../../../src/modules/currency/currency.service.ts"],"sourcesContent":["import { Injectable, NotFoundException, BadRequestException, Logger } from '@nestjs/common';\nimport { PrismaService } from '@/prisma/prisma.service';\nimport { Decimal } from '@prisma/client/runtime/library';\nimport axios from 'axios';\n\n@Injectable()\nexport class CurrencyService {\n  private readonly logger = new Logger(CurrencyService.name);\n  private exchangeRateCache: Map<string, { rate: number; timestamp: number }> = new Map();\n  private readonly CACHE_DURATION = 5 * 60 * 1000; // 5 minutes\n\n  constructor(private prisma: PrismaService) {}\n\n  /**\n   * Get current exchange rate between two currencies\n   */\n  async getExchangeRate(fromCurrency: string, toCurrency: string): Promise<number> {\n    if (fromCurrency === toCurrency) {\n      return 1;\n    }\n\n    const cacheKey = `${fromCurrency}_${toCurrency}`;\n    const cached = this.exchangeRateCache.get(cacheKey);\n\n    if (cached && Date.now() - cached.timestamp < this.CACHE_DURATION) {\n      return cached.rate;\n    }\n\n    // Try to get from database first\n    const dbRate = await this.prisma.currencyExchange.findFirst({\n      where: {\n        fromCurrency,\n        toCurrency,\n      },\n      orderBy: {\n        createdAt: 'desc',\n      },\n    });\n\n    if (dbRate && Date.now().valueOf() - new Date(dbRate.createdAt).valueOf() < this.CACHE_DURATION) {\n      const rate = dbRate.exchangeRate.toNumber();\n      this.exchangeRateCache.set(cacheKey, { rate, timestamp: Date.now() });\n      return rate;\n    }\n\n    // Fetch from external API\n    try {\n      const rate = await this.fetchExchangeRateFromAPI(fromCurrency, toCurrency);\n      \n      // Cache the rate (not storing in DB as it requires userId and amounts)\n      this.exchangeRateCache.set(cacheKey, { rate, timestamp: Date.now() });\n      return rate;\n    } catch (error) {\n      this.logger.error(`Failed to fetch exchange rate for ${fromCurrency}/${toCurrency}`, error);\n      \n      // Fallback to last known rate\n      if (dbRate) {\n        return dbRate.exchangeRate.toNumber();\n      }\n\n      throw new BadRequestException('Unable to fetch exchange rate');\n    }\n  }\n\n  /**\n   * Fetch exchange rate from external API\n   */\n  private async fetchExchangeRateFromAPI(fromCurrency: string, toCurrency: string): Promise<number> {\n    const apiKey = process.env.EXCHANGE_RATE_API_KEY;\n    if (!apiKey) {\n      throw new BadRequestException('Exchange rate API not configured');\n    }\n\n    try {\n      // Using exchangerate-api.com as example\n      const response = await axios.get(\n        `https://api.exchangerate-api.com/v4/latest/${fromCurrency}`,\n        {\n          params: {\n            apikey: apiKey,\n          },\n        }\n      );\n\n      const rate = response.data.rates[toCurrency];\n      if (!rate) {\n        throw new BadRequestException(`Exchange rate not found for ${toCurrency}`);\n      }\n\n      return rate;\n    } catch (error) {\n      this.logger.error('Exchange rate API call failed', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Convert amount from one currency to another\n   */\n  async convertCurrency(\n    amount: number,\n    fromCurrency: string,\n    toCurrency: string\n  ): Promise<{\n    originalAmount: number;\n    convertedAmount: number;\n    fromCurrency: string;\n    toCurrency: string;\n    rate: number;\n  }> {\n    const rate = await this.getExchangeRate(fromCurrency, toCurrency);\n    const convertedAmount = new Decimal(amount).mul(new Decimal(rate)).toNumber();\n\n    return {\n      originalAmount: amount,\n      convertedAmount,\n      fromCurrency,\n      toCurrency,\n      rate,\n    };\n  }\n\n  /**\n   * Get supported currencies\n   */\n  async getSupportedCurrencies(): Promise<string[]> {\n    const currencies = await this.prisma.currencyExchange.findMany({\n      select: {\n        fromCurrency: true,\n      },\n      distinct: ['fromCurrency'],\n    });\n\n    return currencies.map((c) => c.fromCurrency);\n  }\n\n  /**\n   * Get exchange rate history\n   */\n  async getExchangeRateHistory(\n    fromCurrency: string,\n    toCurrency: string,\n    days = 30\n  ): Promise<any[]> {\n    const startDate = new Date();\n    startDate.setDate(startDate.getDate() - days);\n\n    return this.prisma.currencyExchange.findMany({\n      where: {\n        fromCurrency,\n        toCurrency,\n        createdAt: {\n          gte: startDate,\n        },\n      },\n      orderBy: {\n        createdAt: 'asc',\n      },\n    });\n  }\n\n  /**\n   * Update exchange rate manually (for admin)\n   */\n  async updateExchangeRate(\n    fromCurrency: string,\n    toCurrency: string,\n    rate: number\n  ): Promise<any> {\n    // Note: This method is deprecated as CurrencyExchange requires userId and amounts\n    // Consider removing or updating to accept full exchange transaction details\n    throw new BadRequestException('This method requires userId and transaction amounts');\n  }\n}\n"],"names":["CurrencyService","getExchangeRate","fromCurrency","toCurrency","cacheKey","cached","exchangeRateCache","get","Date","now","timestamp","CACHE_DURATION","rate","dbRate","prisma","currencyExchange","findFirst","where","orderBy","createdAt","valueOf","exchangeRate","toNumber","set","fetchExchangeRateFromAPI","error","logger","BadRequestException","apiKey","process","env","EXCHANGE_RATE_API_KEY","response","axios","params","apikey","data","rates","convertCurrency","amount","convertedAmount","Decimal","mul","originalAmount","getSupportedCurrencies","currencies","findMany","select","distinct","map","c","getExchangeRateHistory","days","startDate","setDate","getDate","gte","updateExchangeRate","Logger","name","Map"],"mappings":"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"}