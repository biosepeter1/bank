{"version":3,"sources":["../../../src/modules/chat/chat.controller.ts"],"sourcesContent":["import { Controller, Post, Body } from '@nestjs/common';\r\nimport { ApiOperation, ApiTags } from '@nestjs/swagger';\r\n\r\n// Use environment variable for API key - NEVER commit API keys to git\r\nconst GEMINI_API_KEY = process.env.GEMINI_API_KEY;\r\nconst GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent';\r\n\r\n@ApiTags('chat')\r\n@Controller('chat')\r\nexport class ChatController {\r\n\r\n    @Post('ai')\r\n    @ApiOperation({ summary: 'Send message to AI chatbot' })\r\n    async sendMessage(@Body() body: { message: string; history?: any[]; siteName?: string; supportPhone?: string; supportEmail?: string }) {\r\n        const { message, history = [], siteName = 'Our Bank', supportPhone = '+234 800 900 7777', supportEmail = 'support@bank.com' } = body;\r\n\r\n        console.log('üì® Chat AI request received:', { message, siteName });\r\n\r\n        const systemPrompt = `You are a helpful and friendly customer support assistant for ${siteName}, a professional banking institution. \r\n\r\nYour role is to:\r\n- Answer questions about banking services (accounts, cards, loans, transfers)\r\n- Provide information about bank features and products\r\n- Help customers with general inquiries\r\n- Be professional, concise, and helpful\r\n- If you cannot answer something, suggest contacting human support\r\n\r\nBank Info:\r\n- Name: ${siteName}\r\n- Support Phone: ${supportPhone}\r\n- Support Email: ${supportEmail}\r\n\r\nKeep responses SHORT and conversational (2-3 sentences max). Use emojis sparingly for a friendly tone.`;\r\n\r\n        try {\r\n            console.log('üîÑ Calling Gemini API...');\r\n\r\n            const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {\r\n                method: 'POST',\r\n                headers: {\r\n                    'Content-Type': 'application/json',\r\n                },\r\n                body: JSON.stringify({\r\n                    contents: [\r\n                        { role: 'user', parts: [{ text: systemPrompt }] },\r\n                        { role: 'model', parts: [{ text: 'Understood! I\\'m ready to help customers as a professional banking assistant.' }] },\r\n                        ...history,\r\n                        { role: 'user', parts: [{ text: message }] }\r\n                    ],\r\n                    generationConfig: {\r\n                        temperature: 0.7,\r\n                        maxOutputTokens: 256,\r\n                        topP: 0.8,\r\n                        topK: 40\r\n                    },\r\n                    safetySettings: [\r\n                        { category: 'HARM_CATEGORY_HARASSMENT', threshold: 'BLOCK_MEDIUM_AND_ABOVE' },\r\n                        { category: 'HARM_CATEGORY_HATE_SPEECH', threshold: 'BLOCK_MEDIUM_AND_ABOVE' },\r\n                        { category: 'HARM_CATEGORY_SEXUALLY_EXPLICIT', threshold: 'BLOCK_MEDIUM_AND_ABOVE' },\r\n                        { category: 'HARM_CATEGORY_DANGEROUS_CONTENT', threshold: 'BLOCK_MEDIUM_AND_ABOVE' },\r\n                    ]\r\n                }),\r\n            });\r\n\r\n            const data = await response.json();\r\n            console.log('üì• Gemini API response status:', response.status);\r\n            console.log('üì• Gemini API response data:', JSON.stringify(data, null, 2));\r\n\r\n            // Check for API errors\r\n            if (data.error) {\r\n                console.error('‚ùå Gemini API error:', data.error);\r\n\r\n                // Handle quota limits gracefully\r\n                if (data.error.message?.includes('quota') || data.error.code === 429) {\r\n                    return {\r\n                        success: true, // Treat as success to show message in chat\r\n                        response: 'I am currently receiving too many requests. Please try again in a few minutes. üïí',\r\n                    };\r\n                }\r\n\r\n                return {\r\n                    success: false,\r\n                    response: 'I apologize, but I am momentarily unavailable. Please try again later.',\r\n                    debug: data.error\r\n                };\r\n            }\r\n\r\n            if (data.candidates && data.candidates[0]?.content?.parts?.[0]?.text) {\r\n                const aiResponse = data.candidates[0].content.parts[0].text;\r\n                console.log('‚úÖ AI Response:', aiResponse);\r\n                return {\r\n                    success: true,\r\n                    response: aiResponse\r\n                };\r\n            }\r\n\r\n            console.log('‚ö†Ô∏è No valid response from Gemini');\r\n            return {\r\n                success: false,\r\n                response: 'I apologize, but I couldn\\'t process your request. Please try again or contact our support team.',\r\n                debug: data\r\n            };\r\n        } catch (error) {\r\n            console.error('‚ùå Gemini AI fetch error:', error);\r\n            return {\r\n                success: false,\r\n                response: 'I\\'m having trouble connecting right now. Please try again or contact our support team directly.',\r\n                error: error.message\r\n            };\r\n        }\r\n    }\r\n}"],"names":["ChatController","GEMINI_API_KEY","process","env","GEMINI_API_URL","sendMessage","body","message","history","siteName","supportPhone","supportEmail","console","log","systemPrompt","response","fetch","method","headers","JSON","stringify","contents","role","parts","text","generationConfig","temperature","maxOutputTokens","topP","topK","safetySettings","category","threshold","data","json","status","error","includes","code","success","debug","candidates","content","aiResponse","summary"],"mappings":"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"}