{"version":3,"sources":["../../../src/modules/withdrawals/withdrawals.service.ts"],"sourcesContent":["import { Injectable, BadRequestException, NotFoundException, Logger } from '@nestjs/common';\nimport { PrismaService } from '@/prisma/prisma.service';\nimport { Decimal } from '@prisma/client/runtime/library';\nimport { CreateWithdrawalDto } from './dto/create-withdrawal.dto';\nimport { EmailService } from '@/common/services/email.service';\n\n@Injectable()\nexport class WithdrawalsService {\n  private readonly logger = new Logger(WithdrawalsService.name);\n\n  constructor(\n    private prisma: PrismaService,\n    private email: EmailService,\n  ) {}\n\n  /**\n   * Initiate a withdrawal request\n   */\n  async initiateWithdrawal(userId: string, data: CreateWithdrawalDto) {\n    const user = await this.prisma.user.findUnique({\n      where: { id: userId },\n      include: { wallet: true },\n    });\n\n    if (!user) {\n      throw new NotFoundException('User not found');\n    }\n\n    const amount = new Decimal(data.amount);\n\n    // Check balance\n    if (user.wallet.balance.lessThan(amount)) {\n      throw new BadRequestException('Insufficient balance for withdrawal');\n    }\n\n    // Calculate fees\n    const fee = this.calculateWithdrawalFee(amount, data.withdrawalMethod);\n    const totalDebit = amount.add(fee);\n\n    // Check if total debit exceeds balance\n    if (user.wallet.balance.lessThan(totalDebit)) {\n      throw new BadRequestException('Insufficient balance including withdrawal fee');\n    }\n\n    // Create withdrawal request\n    const withdrawal = await this.prisma.withdrawal.create({\n      data: {\n        userId,\n        amount,\n        fee,\n        totalAmount: totalDebit,\n        status: 'PENDING',\n        description: `${data.withdrawalMethod} - ${data.accountName} (${data.accountNumber}) - ${data.narration || ''}`,\n        reference: `WD-${Date.now()}-${userId.slice(0, 8)}`,\n      },\n    });\n\n    return withdrawal;\n  }\n\n  /**\n   * Calculate withdrawal fee based on method and amount\n   */\n  private calculateWithdrawalFee(amount: Decimal, method: string): Decimal {\n    // Example fee structure\n    const feePercentage = method === 'BANK_TRANSFER' ? 0.0075 : 0.01; // 0.75% or 1%\n    const fee = amount.mul(new Decimal(feePercentage));\n    const minFee = new Decimal(50);\n    const maxFee = new Decimal(500);\n\n    if (fee.lessThan(minFee)) return minFee;\n    if (fee.greaterThan(maxFee)) return maxFee;\n    return fee;\n  }\n\n  /**\n   * Approve a withdrawal request\n   */\n  async approveWithdrawal(withdrawalId: string) {\n    const withdrawal = await this.prisma.withdrawal.findUnique({\n      where: { id: withdrawalId },\n      include: { user: { include: { wallet: true } } },\n    });\n\n    if (!withdrawal) {\n      throw new NotFoundException('Withdrawal not found');\n    }\n\n    if (withdrawal.status !== 'PENDING') {\n      throw new BadRequestException('Withdrawal can only be approved if pending');\n    }\n\n    const result = await this.prisma.$transaction(async (tx) => {\n      // Debit wallet\n      const walletBefore = withdrawal.user.wallet;\n      const walletAfter = walletBefore.balance.sub(withdrawal.totalAmount);\n\n      await tx.wallet.update({\n        where: { userId: withdrawal.userId },\n        data: { balance: walletAfter },\n      });\n\n      // Create transaction record\n      await tx.transaction.create({\n        data: {\n          userId: withdrawal.userId,\n          type: 'WITHDRAWAL',\n          status: 'COMPLETED',\n          amount: withdrawal.amount,\n          balanceBefore: walletBefore.balance,\n          balanceAfter: walletAfter,\n          description: `Withdrawal - ${withdrawal.description}`,\n          reference: withdrawal.id,\n        },\n      });\n\n      // Update withdrawal status\n      const updatedWithdrawal = await tx.withdrawal.update({\n        where: { id: withdrawalId },\n        data: {\n          status: 'SUCCESS',\n          processedAt: new Date(),\n        },\n      });\n\n      return updatedWithdrawal;\n    });\n\n    // Send email notification if enabled (non-blocking)\n    try {\n      if (withdrawal.user.emailTransactions) {\n        const walletAfter = withdrawal.user.wallet.balance.sub(withdrawal.totalAmount);\n        await this.email.sendTransactionEmail({\n          email: withdrawal.user.email,\n          firstName: withdrawal.user.firstName,\n          transactionType: 'WITHDRAWAL',\n          amount: withdrawal.amount.toString(),\n          currency: withdrawal.user.wallet.currency,\n          balance: walletAfter.toString(),\n          reference: withdrawal.id,\n          description: `Withdrawal - ${withdrawal.description}`,\n        });\n      }\n    } catch (error) {\n      console.error('Failed to send withdrawal email:', error);\n    }\n\n    return result;\n  }\n\n  /**\n   * Reject a withdrawal request\n   */\n  async rejectWithdrawal(withdrawalId: string, reason: string) {\n    const withdrawal = await this.prisma.withdrawal.findUnique({\n      where: { id: withdrawalId },\n    });\n\n    if (!withdrawal) {\n      throw new NotFoundException('Withdrawal not found');\n    }\n\n    if (withdrawal.status !== 'PENDING') {\n      throw new BadRequestException('Only pending withdrawals can be rejected');\n    }\n\n    return this.prisma.withdrawal.update({\n      where: { id: withdrawalId },\n      data: {\n        status: 'FAILED',\n        failureReason: reason,\n        processedAt: new Date(),\n      },\n    });\n  }\n\n  /**\n   * Get withdrawal history\n   */\n  async getWithdrawalHistory(userId: string, limit = 20, skip = 0) {\n    return this.prisma.withdrawal.findMany({\n      where: { userId },\n      orderBy: { createdAt: 'desc' },\n      take: limit,\n      skip,\n    });\n  }\n\n  /**\n   * Get withdrawal details\n   */\n  async getWithdrawalById(userId: string, withdrawalId: string) {\n    const withdrawal = await this.prisma.withdrawal.findUnique({\n      where: { id: withdrawalId },\n    });\n\n    if (!withdrawal || withdrawal.userId !== userId) {\n      throw new NotFoundException('Withdrawal not found or unauthorized');\n    }\n\n    return withdrawal;\n  }\n\n  /**\n   * Cancel a withdrawal request\n   */\n  async cancelWithdrawal(userId: string, withdrawalId: string) {\n    const withdrawal = await this.prisma.withdrawal.findUnique({\n      where: { id: withdrawalId },\n    });\n\n    if (!withdrawal || withdrawal.userId !== userId) {\n      throw new NotFoundException('Withdrawal not found or unauthorized');\n    }\n\n    if (withdrawal.status !== 'PENDING') {\n      throw new BadRequestException('Only pending withdrawals can be cancelled');\n    }\n\n    return this.prisma.withdrawal.update({\n      where: { id: withdrawalId },\n      data: { status: 'CANCELLED' },\n    });\n  }\n}\n"],"names":["WithdrawalsService","initiateWithdrawal","userId","data","user","prisma","findUnique","where","id","include","wallet","NotFoundException","amount","Decimal","balance","lessThan","BadRequestException","fee","calculateWithdrawalFee","withdrawalMethod","totalDebit","add","withdrawal","create","totalAmount","status","description","accountName","accountNumber","narration","reference","Date","now","slice","method","feePercentage","mul","minFee","maxFee","greaterThan","approveWithdrawal","withdrawalId","result","$transaction","tx","walletBefore","walletAfter","sub","update","transaction","type","balanceBefore","balanceAfter","updatedWithdrawal","processedAt","emailTransactions","email","sendTransactionEmail","firstName","transactionType","toString","currency","error","console","rejectWithdrawal","reason","failureReason","getWithdrawalHistory","limit","skip","findMany","orderBy","createdAt","take","getWithdrawalById","cancelWithdrawal","logger","Logger","name"],"mappings":";;;;+BAOaA;;;eAAAA;;;wBAP8D;+BAC7C;yBACN;8BAEK;;;;;;;;;;AAGtB,IAAA,AAAMA,qBAAN,MAAMA;IAQX;;GAEC,GACD,MAAMC,mBAAmBC,MAAc,EAAEC,IAAyB,EAAE;QAClE,MAAMC,OAAO,MAAM,IAAI,CAACC,MAAM,CAACD,IAAI,CAACE,UAAU,CAAC;YAC7CC,OAAO;gBAAEC,IAAIN;YAAO;YACpBO,SAAS;gBAAEC,QAAQ;YAAK;QAC1B;QAEA,IAAI,CAACN,MAAM;YACT,MAAM,IAAIO,yBAAiB,CAAC;QAC9B;QAEA,MAAMC,SAAS,IAAIC,gBAAO,CAACV,KAAKS,MAAM;QAEtC,gBAAgB;QAChB,IAAIR,KAAKM,MAAM,CAACI,OAAO,CAACC,QAAQ,CAACH,SAAS;YACxC,MAAM,IAAII,2BAAmB,CAAC;QAChC;QAEA,iBAAiB;QACjB,MAAMC,MAAM,IAAI,CAACC,sBAAsB,CAACN,QAAQT,KAAKgB,gBAAgB;QACrE,MAAMC,aAAaR,OAAOS,GAAG,CAACJ;QAE9B,uCAAuC;QACvC,IAAIb,KAAKM,MAAM,CAACI,OAAO,CAACC,QAAQ,CAACK,aAAa;YAC5C,MAAM,IAAIJ,2BAAmB,CAAC;QAChC;QAEA,4BAA4B;QAC5B,MAAMM,aAAa,MAAM,IAAI,CAACjB,MAAM,CAACiB,UAAU,CAACC,MAAM,CAAC;YACrDpB,MAAM;gBACJD;gBACAU;gBACAK;gBACAO,aAAaJ;gBACbK,QAAQ;gBACRC,aAAa,GAAGvB,KAAKgB,gBAAgB,CAAC,GAAG,EAAEhB,KAAKwB,WAAW,CAAC,EAAE,EAAExB,KAAKyB,aAAa,CAAC,IAAI,EAAEzB,KAAK0B,SAAS,IAAI,IAAI;gBAC/GC,WAAW,CAAC,GAAG,EAAEC,KAAKC,GAAG,GAAG,CAAC,EAAE9B,OAAO+B,KAAK,CAAC,GAAG,IAAI;YACrD;QACF;QAEA,OAAOX;IACT;IAEA;;GAEC,GACD,AAAQJ,uBAAuBN,MAAe,EAAEsB,MAAc,EAAW;QACvE,wBAAwB;QACxB,MAAMC,gBAAgBD,WAAW,kBAAkB,SAAS,MAAM,cAAc;QAChF,MAAMjB,MAAML,OAAOwB,GAAG,CAAC,IAAIvB,gBAAO,CAACsB;QACnC,MAAME,SAAS,IAAIxB,gBAAO,CAAC;QAC3B,MAAMyB,SAAS,IAAIzB,gBAAO,CAAC;QAE3B,IAAII,IAAIF,QAAQ,CAACsB,SAAS,OAAOA;QACjC,IAAIpB,IAAIsB,WAAW,CAACD,SAAS,OAAOA;QACpC,OAAOrB;IACT;IAEA;;GAEC,GACD,MAAMuB,kBAAkBC,YAAoB,EAAE;QAC5C,MAAMnB,aAAa,MAAM,IAAI,CAACjB,MAAM,CAACiB,UAAU,CAAChB,UAAU,CAAC;YACzDC,OAAO;gBAAEC,IAAIiC;YAAa;YAC1BhC,SAAS;gBAAEL,MAAM;oBAAEK,SAAS;wBAAEC,QAAQ;oBAAK;gBAAE;YAAE;QACjD;QAEA,IAAI,CAACY,YAAY;YACf,MAAM,IAAIX,yBAAiB,CAAC;QAC9B;QAEA,IAAIW,WAAWG,MAAM,KAAK,WAAW;YACnC,MAAM,IAAIT,2BAAmB,CAAC;QAChC;QAEA,MAAM0B,SAAS,MAAM,IAAI,CAACrC,MAAM,CAACsC,YAAY,CAAC,OAAOC;YACnD,eAAe;YACf,MAAMC,eAAevB,WAAWlB,IAAI,CAACM,MAAM;YAC3C,MAAMoC,cAAcD,aAAa/B,OAAO,CAACiC,GAAG,CAACzB,WAAWE,WAAW;YAEnE,MAAMoB,GAAGlC,MAAM,CAACsC,MAAM,CAAC;gBACrBzC,OAAO;oBAAEL,QAAQoB,WAAWpB,MAAM;gBAAC;gBACnCC,MAAM;oBAAEW,SAASgC;gBAAY;YAC/B;YAEA,4BAA4B;YAC5B,MAAMF,GAAGK,WAAW,CAAC1B,MAAM,CAAC;gBAC1BpB,MAAM;oBACJD,QAAQoB,WAAWpB,MAAM;oBACzBgD,MAAM;oBACNzB,QAAQ;oBACRb,QAAQU,WAAWV,MAAM;oBACzBuC,eAAeN,aAAa/B,OAAO;oBACnCsC,cAAcN;oBACdpB,aAAa,CAAC,aAAa,EAAEJ,WAAWI,WAAW,EAAE;oBACrDI,WAAWR,WAAWd,EAAE;gBAC1B;YACF;YAEA,2BAA2B;YAC3B,MAAM6C,oBAAoB,MAAMT,GAAGtB,UAAU,CAAC0B,MAAM,CAAC;gBACnDzC,OAAO;oBAAEC,IAAIiC;gBAAa;gBAC1BtC,MAAM;oBACJsB,QAAQ;oBACR6B,aAAa,IAAIvB;gBACnB;YACF;YAEA,OAAOsB;QACT;QAEA,oDAAoD;QACpD,IAAI;YACF,IAAI/B,WAAWlB,IAAI,CAACmD,iBAAiB,EAAE;gBACrC,MAAMT,cAAcxB,WAAWlB,IAAI,CAACM,MAAM,CAACI,OAAO,CAACiC,GAAG,CAACzB,WAAWE,WAAW;gBAC7E,MAAM,IAAI,CAACgC,KAAK,CAACC,oBAAoB,CAAC;oBACpCD,OAAOlC,WAAWlB,IAAI,CAACoD,KAAK;oBAC5BE,WAAWpC,WAAWlB,IAAI,CAACsD,SAAS;oBACpCC,iBAAiB;oBACjB/C,QAAQU,WAAWV,MAAM,CAACgD,QAAQ;oBAClCC,UAAUvC,WAAWlB,IAAI,CAACM,MAAM,CAACmD,QAAQ;oBACzC/C,SAASgC,YAAYc,QAAQ;oBAC7B9B,WAAWR,WAAWd,EAAE;oBACxBkB,aAAa,CAAC,aAAa,EAAEJ,WAAWI,WAAW,EAAE;gBACvD;YACF;QACF,EAAE,OAAOoC,OAAO;YACdC,QAAQD,KAAK,CAAC,oCAAoCA;QACpD;QAEA,OAAOpB;IACT;IAEA;;GAEC,GACD,MAAMsB,iBAAiBvB,YAAoB,EAAEwB,MAAc,EAAE;QAC3D,MAAM3C,aAAa,MAAM,IAAI,CAACjB,MAAM,CAACiB,UAAU,CAAChB,UAAU,CAAC;YACzDC,OAAO;gBAAEC,IAAIiC;YAAa;QAC5B;QAEA,IAAI,CAACnB,YAAY;YACf,MAAM,IAAIX,yBAAiB,CAAC;QAC9B;QAEA,IAAIW,WAAWG,MAAM,KAAK,WAAW;YACnC,MAAM,IAAIT,2BAAmB,CAAC;QAChC;QAEA,OAAO,IAAI,CAACX,MAAM,CAACiB,UAAU,CAAC0B,MAAM,CAAC;YACnCzC,OAAO;gBAAEC,IAAIiC;YAAa;YAC1BtC,MAAM;gBACJsB,QAAQ;gBACRyC,eAAeD;gBACfX,aAAa,IAAIvB;YACnB;QACF;IACF;IAEA;;GAEC,GACD,MAAMoC,qBAAqBjE,MAAc,EAAEkE,QAAQ,EAAE,EAAEC,OAAO,CAAC,EAAE;QAC/D,OAAO,IAAI,CAAChE,MAAM,CAACiB,UAAU,CAACgD,QAAQ,CAAC;YACrC/D,OAAO;gBAAEL;YAAO;YAChBqE,SAAS;gBAAEC,WAAW;YAAO;YAC7BC,MAAML;YACNC;QACF;IACF;IAEA;;GAEC,GACD,MAAMK,kBAAkBxE,MAAc,EAAEuC,YAAoB,EAAE;QAC5D,MAAMnB,aAAa,MAAM,IAAI,CAACjB,MAAM,CAACiB,UAAU,CAAChB,UAAU,CAAC;YACzDC,OAAO;gBAAEC,IAAIiC;YAAa;QAC5B;QAEA,IAAI,CAACnB,cAAcA,WAAWpB,MAAM,KAAKA,QAAQ;YAC/C,MAAM,IAAIS,yBAAiB,CAAC;QAC9B;QAEA,OAAOW;IACT;IAEA;;GAEC,GACD,MAAMqD,iBAAiBzE,MAAc,EAAEuC,YAAoB,EAAE;QAC3D,MAAMnB,aAAa,MAAM,IAAI,CAACjB,MAAM,CAACiB,UAAU,CAAChB,UAAU,CAAC;YACzDC,OAAO;gBAAEC,IAAIiC;YAAa;QAC5B;QAEA,IAAI,CAACnB,cAAcA,WAAWpB,MAAM,KAAKA,QAAQ;YAC/C,MAAM,IAAIS,yBAAiB,CAAC;QAC9B;QAEA,IAAIW,WAAWG,MAAM,KAAK,WAAW;YACnC,MAAM,IAAIT,2BAAmB,CAAC;QAChC;QAEA,OAAO,IAAI,CAACX,MAAM,CAACiB,UAAU,CAAC0B,MAAM,CAAC;YACnCzC,OAAO;gBAAEC,IAAIiC;YAAa;YAC1BtC,MAAM;gBAAEsB,QAAQ;YAAY;QAC9B;IACF;IArNA,YACE,AAAQpB,MAAqB,EAC7B,AAAQmD,KAAmB,CAC3B;aAFQnD,SAAAA;aACAmD,QAAAA;aAJOoB,SAAS,IAAIC,cAAM,CAAC7E,mBAAmB8E,IAAI;IAKzD;AAmNL"}