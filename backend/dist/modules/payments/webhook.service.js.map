{"version":3,"sources":["../../../src/modules/payments/webhook.service.ts"],"sourcesContent":["import { Injectable, Logger, BadRequestException } from '@nestjs/common';\r\nimport { PrismaService } from 'src/prisma/prisma.service';\r\nimport { PaystackService } from './paystack.service';\r\nimport { PaymentStatus, TransactionStatus, Prisma } from '@prisma/client';\r\n\r\ninterface PaystackWebhookEvent {\r\n  event: string;\r\n  data: {\r\n    id: number;\r\n    domain: string;\r\n    status: string;\r\n    reference: string;\r\n    amount: number;\r\n    message: string | null;\r\n    gateway_response: string;\r\n    paid_at: string;\r\n    created_at: string;\r\n    channel: string;\r\n    currency: string;\r\n    ip_address: string;\r\n    metadata: Record<string, any>;\r\n    fees: number;\r\n    customer: {\r\n      id: number;\r\n      first_name: string | null;\r\n      last_name: string | null;\r\n      email: string;\r\n      customer_code: string;\r\n      phone: string | null;\r\n      metadata: Record<string, any>;\r\n      risk_action: string;\r\n    };\r\n    authorization?: {\r\n      authorization_code: string;\r\n      bin: string;\r\n      last4: string;\r\n      exp_month: string;\r\n      exp_year: string;\r\n      channel: string;\r\n      card_type: string;\r\n      bank: string;\r\n      country_code: string;\r\n      brand: string;\r\n      reusable: boolean;\r\n      signature: string;\r\n      account_name: string | null;\r\n    };\r\n    // Transfer specific fields\r\n    transfer_code?: string;\r\n    recipient?: {\r\n      active: boolean;\r\n      createdAt: string;\r\n      currency: string;\r\n      domain: string;\r\n      id: number;\r\n      integration: number;\r\n      name: string;\r\n      recipient_code: string;\r\n      type: string;\r\n      updatedAt: string;\r\n      is_deleted: boolean;\r\n      details: {\r\n        account_number: string;\r\n        account_name: string;\r\n        bank_code: string;\r\n        bank_name: string;\r\n      };\r\n    };\r\n    reason?: string;\r\n    source?: string;\r\n    source_details?: {\r\n      type: string;\r\n      currency: string;\r\n      available_balance: number;\r\n      ledger_balance: number;\r\n    };\r\n    failures?: any;\r\n    titan_code?: string;\r\n    transfer_code_id?: string;\r\n  };\r\n}\r\n\r\n@Injectable()\r\nexport class WebhookService {\r\n  private readonly logger = new Logger(WebhookService.name);\r\n\r\n  constructor(\r\n    private readonly prisma: PrismaService,\r\n    private readonly paystackService: PaystackService,\r\n  ) {}\r\n\r\n  /**\r\n   * Handle Paystack webhook events\r\n   */\r\n  async handlePaystackWebhook(signature: string, payload: string): Promise<{ message: string }> {\r\n    try {\r\n      // Verify webhook signature\r\n      if (!this.paystackService.verifyWebhookSignature(payload, signature)) {\r\n        this.logger.warn('Invalid webhook signature received');\r\n        throw new BadRequestException('Invalid webhook signature');\r\n      }\r\n\r\n      const event: PaystackWebhookEvent = JSON.parse(payload);\r\n      this.logger.log(`Received webhook event: ${event.event} for reference: ${event.data.reference}`);\r\n\r\n      // Route webhook event to appropriate handler\r\n      switch (event.event) {\r\n        case 'charge.success':\r\n          await this.handleChargeSuccess(event);\r\n          break;\r\n        case 'charge.failed':\r\n        case 'charge.cancelled':\r\n          await this.handleChargeFailed(event);\r\n          break;\r\n        case 'transfer.success':\r\n          await this.handleTransferSuccess(event);\r\n          break;\r\n        case 'transfer.failed':\r\n        case 'transfer.reversed':\r\n          await this.handleTransferFailed(event);\r\n          break;\r\n        default:\r\n          this.logger.log(`Unhandled webhook event: ${event.event}`);\r\n      }\r\n\r\n      return { message: 'Webhook processed successfully' };\r\n    } catch (error) {\r\n      this.logger.error('Webhook processing failed:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle successful charge (deposit)\r\n   */\r\n  private async handleChargeSuccess(event: PaystackWebhookEvent) {\r\n    try {\r\n      const { data } = event;\r\n      const reference = data.reference;\r\n\r\n      // Find payment record\r\n      const payment = await this.prisma.payment.findUnique({\r\n        where: { reference },\r\n        include: { user: { include: { wallet: true } } },\r\n      });\r\n\r\n      if (!payment) {\r\n        this.logger.warn(`Payment not found for reference: ${reference}`);\r\n        return;\r\n      }\r\n\r\n      // Skip if already processed\r\n      if (payment.status === PaymentStatus.SUCCESS) {\r\n        this.logger.log(`Payment already processed: ${reference}`);\r\n        return;\r\n      }\r\n\r\n      const paidAmount = this.paystackService.fromKobo(data.amount);\r\n      \r\n      await this.prisma.$transaction(async (tx) => {\r\n        // Update payment status\r\n        await tx.payment.update({\r\n          where: { id: payment.id },\r\n          data: {\r\n            status: PaymentStatus.SUCCESS,\r\n            completedAt: new Date(),\r\n            webhookData: data,\r\n            providerResponse: { ...payment.providerResponse as any, webhookData: data },\r\n          },\r\n        });\r\n\r\n        // Update wallet balance\r\n        const updatedWallet = await tx.wallet.update({\r\n          where: { userId: payment.userId },\r\n          data: {\r\n            balance: {\r\n              increment: new Prisma.Decimal(paidAmount),\r\n            },\r\n          },\r\n        });\r\n\r\n        // Create transaction record\r\n        await tx.transaction.create({\r\n          data: {\r\n            userId: payment.userId,\r\n            type: 'PAYMENT_GATEWAY_DEPOSIT',\r\n            status: TransactionStatus.COMPLETED,\r\n            amount: new Prisma.Decimal(paidAmount),\r\n            currency: 'NGN',\r\n            balanceBefore: payment.user.wallet?.balance || new Prisma.Decimal(0),\r\n            balanceAfter: updatedWallet.balance,\r\n            description: payment.description || 'Paystack deposit',\r\n            reference: `TXN_${payment.reference}`,\r\n            externalRef: payment.providerRef,\r\n            metadata: {\r\n              paymentId: payment.id,\r\n              provider: payment.provider,\r\n              method: payment.method,\r\n              channel: data.channel,\r\n              gatewayResponse: data.gateway_response,\r\n              fees: this.paystackService.fromKobo(data.fees),\r\n            },\r\n          },\r\n        });\r\n      });\r\n\r\n      this.logger.log(`Deposit webhook processed successfully: ${reference} - ₦${paidAmount}`);\r\n    } catch (error) {\r\n      this.logger.error('Charge success webhook processing failed:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle failed charge (deposit)\r\n   */\r\n  private async handleChargeFailed(event: PaystackWebhookEvent) {\r\n    try {\r\n      const { data } = event;\r\n      const reference = data.reference;\r\n\r\n      // Find payment record\r\n      const payment = await this.prisma.payment.findUnique({\r\n        where: { reference },\r\n      });\r\n\r\n      if (!payment) {\r\n        this.logger.warn(`Payment not found for reference: ${reference}`);\r\n        return;\r\n      }\r\n\r\n      // Skip if already processed\r\n      if (payment.status === PaymentStatus.FAILED) {\r\n        this.logger.log(`Payment failure already processed: ${reference}`);\r\n        return;\r\n      }\r\n\r\n      // Update payment status\r\n      await this.prisma.payment.update({\r\n        where: { id: payment.id },\r\n        data: {\r\n          status: PaymentStatus.FAILED,\r\n          failedAt: new Date(),\r\n          webhookData: data,\r\n          providerResponse: { ...payment.providerResponse as any, webhookData: data },\r\n        },\r\n      });\r\n\r\n      this.logger.log(`Deposit failure webhook processed: ${reference} - ${data.gateway_response}`);\r\n    } catch (error) {\r\n      this.logger.error('Charge failed webhook processing failed:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle successful transfer (withdrawal)\r\n   */\r\n  private async handleTransferSuccess(event: PaystackWebhookEvent) {\r\n    try {\r\n      const { data } = event;\r\n      const reference = data.reference;\r\n\r\n      // Find withdrawal record\r\n      const withdrawal = await this.prisma.withdrawal.findUnique({\r\n        where: { reference },\r\n      });\r\n\r\n      if (!withdrawal) {\r\n        this.logger.warn(`Withdrawal not found for reference: ${reference}`);\r\n        return;\r\n      }\r\n\r\n      // Skip if already processed\r\n      if (withdrawal.status === PaymentStatus.SUCCESS) {\r\n        this.logger.log(`Withdrawal already processed: ${reference}`);\r\n        return;\r\n      }\r\n\r\n      await this.prisma.$transaction(async (tx) => {\r\n        // Update withdrawal status\r\n        await tx.withdrawal.update({\r\n          where: { id: withdrawal.id },\r\n          data: {\r\n            status: PaymentStatus.SUCCESS,\r\n            completedAt: new Date(),\r\n            providerResponse: { ...withdrawal.providerResponse as any, webhookData: data },\r\n          },\r\n        });\r\n\r\n        // Update transaction status\r\n        await tx.transaction.updateMany({\r\n          where: {\r\n            reference: `TXN_${withdrawal.reference}`,\r\n            status: TransactionStatus.PROCESSING,\r\n          },\r\n          data: {\r\n            status: TransactionStatus.COMPLETED,\r\n            metadata: {\r\n              ...(withdrawal.providerResponse as any) || {},\r\n              transferCompletedAt: new Date().toISOString(),\r\n              gatewayResponse: data.gateway_response || 'Transfer completed',\r\n            },\r\n          },\r\n        });\r\n      });\r\n\r\n      this.logger.log(`Withdrawal webhook processed successfully: ${reference} - ₦${withdrawal.amount}`);\r\n    } catch (error) {\r\n      this.logger.error('Transfer success webhook processing failed:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle failed transfer (withdrawal)\r\n   */\r\n  private async handleTransferFailed(event: PaystackWebhookEvent) {\r\n    try {\r\n      const { data } = event;\r\n      const reference = data.reference;\r\n\r\n      // Find withdrawal record\r\n      const withdrawal = await this.prisma.withdrawal.findUnique({\r\n        where: { reference },\r\n        include: { user: { include: { wallet: true } } },\r\n      });\r\n\r\n      if (!withdrawal) {\r\n        this.logger.warn(`Withdrawal not found for reference: ${reference}`);\r\n        return;\r\n      }\r\n\r\n      // Skip if already processed\r\n      if (withdrawal.status === PaymentStatus.FAILED) {\r\n        this.logger.log(`Withdrawal failure already processed: ${reference}`);\r\n        return;\r\n      }\r\n\r\n      const failureReason = data.gateway_response || 'Transfer failed';\r\n\r\n      await this.prisma.$transaction(async (tx) => {\r\n        // Update withdrawal status\r\n        await tx.withdrawal.update({\r\n          where: { id: withdrawal.id },\r\n          data: {\r\n            status: PaymentStatus.FAILED,\r\n            failedAt: new Date(),\r\n            failureReason,\r\n            providerResponse: { ...withdrawal.providerResponse as any, webhookData: data },\r\n          },\r\n        });\r\n\r\n        // Update transaction status\r\n        await tx.transaction.updateMany({\r\n          where: {\r\n            reference: `TXN_${withdrawal.reference}`,\r\n            status: TransactionStatus.PROCESSING,\r\n          },\r\n          data: {\r\n            status: TransactionStatus.FAILED,\r\n            metadata: {\r\n              ...(withdrawal.providerResponse as any) || {},\r\n              failureReason,\r\n              failedAt: new Date().toISOString(),\r\n            },\r\n          },\r\n        });\r\n\r\n        // Refund amount to wallet (since it was already deducted)\r\n        const refundAmount = withdrawal.totalAmount.toNumber();\r\n        \r\n        const updatedWallet = await tx.wallet.update({\r\n          where: { userId: withdrawal.userId },\r\n          data: {\r\n            balance: {\r\n              increment: new Prisma.Decimal(refundAmount),\r\n            },\r\n          },\r\n        });\r\n\r\n        // Create refund transaction\r\n        await tx.transaction.create({\r\n          data: {\r\n            userId: withdrawal.userId,\r\n            type: 'REFUND',\r\n            status: TransactionStatus.COMPLETED,\r\n            amount: new Prisma.Decimal(refundAmount),\r\n            currency: 'NGN',\r\n            balanceBefore: withdrawal.user.wallet?.balance || new Prisma.Decimal(0),\r\n            balanceAfter: updatedWallet.balance,\r\n            description: `Withdrawal refund - ${failureReason}`,\r\n            reference: `REF_${withdrawal.reference}`,\r\n            externalRef: withdrawal.providerRef,\r\n            metadata: {\r\n              originalWithdrawalId: withdrawal.id,\r\n              failureReason,\r\n              refundType: 'withdrawal_failure',\r\n            },\r\n          },\r\n        });\r\n      });\r\n\r\n      this.logger.log(`Withdrawal failure webhook processed with refund: ${reference} - ₦${withdrawal.totalAmount} refunded`);\r\n    } catch (error) {\r\n      this.logger.error('Transfer failed webhook processing failed:', error);\r\n      throw error;\r\n    }\r\n  }\r\n}"],"names":["WebhookService","handlePaystackWebhook","signature","payload","paystackService","verifyWebhookSignature","logger","warn","BadRequestException","event","JSON","parse","log","data","reference","handleChargeSuccess","handleChargeFailed","handleTransferSuccess","handleTransferFailed","message","error","payment","prisma","findUnique","where","include","user","wallet","status","PaymentStatus","SUCCESS","paidAmount","fromKobo","amount","$transaction","tx","update","id","completedAt","Date","webhookData","providerResponse","updatedWallet","userId","balance","increment","Prisma","Decimal","transaction","create","type","TransactionStatus","COMPLETED","currency","balanceBefore","balanceAfter","description","externalRef","providerRef","metadata","paymentId","provider","method","channel","gatewayResponse","gateway_response","fees","FAILED","failedAt","withdrawal","updateMany","PROCESSING","transferCompletedAt","toISOString","failureReason","refundAmount","totalAmount","toNumber","originalWithdrawalId","refundType","Logger","name"],"mappings":"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"}