{"version":3,"sources":["../../../src/modules/payments/payments.service.ts"],"sourcesContent":["import {\r\n  Injectable,\r\n  Logger,\r\n  BadRequestException,\r\n  NotFoundException,\r\n  ConflictException,\r\n  InternalServerErrorException,\r\n} from '@nestjs/common';\r\nimport { PrismaService } from 'src/prisma/prisma.service';\r\nimport { PaystackService } from './paystack.service';\r\nimport { ConfigService } from '@nestjs/config';\r\nimport {\r\n  PaymentProvider,\r\n  PaymentMethod,\r\n  PaymentStatus,\r\n  TransactionType,\r\n  TransactionStatus,\r\n  Prisma,\r\n} from '@prisma/client';\r\nimport {\r\n  InitiateDepositDto,\r\n  VerifyPaymentDto,\r\n  AddBankAccountDto,\r\n  InitiateWithdrawalDto,\r\n  ResolveAccountDto,\r\n} from './dto/payment.dto';\r\n\r\n@Injectable()\r\nexport class PaymentsService {\r\n  private readonly logger = new Logger(PaymentsService.name);\r\n  private readonly withdrawalFeeRate = 0.01; // 1% fee\r\n  private readonly minWithdrawalFee = 50; // Minimum ₦50 fee\r\n  private readonly maxWithdrawalFee = 2000; // Maximum ₦2000 fee\r\n\r\n  constructor(\r\n    private readonly prisma: PrismaService,\r\n    private readonly paystackService: PaystackService,\r\n    private readonly configService: ConfigService,\r\n  ) {}\r\n\r\n  /**\r\n   * Initiate a deposit payment\r\n   */\r\n  async initiateDeposit(userId: string, dto: InitiateDepositDto) {\r\n    try {\r\n      // Get user details\r\n      const user = await this.prisma.user.findUnique({\r\n        where: { id: userId },\r\n        include: { wallet: true },\r\n      });\r\n\r\n      if (!user) {\r\n        throw new NotFoundException('User not found');\r\n      }\r\n\r\n      if (!user.wallet) {\r\n        throw new BadRequestException('User wallet not found');\r\n      }\r\n\r\n      // Generate payment reference\r\n      const reference = this.paystackService.generateReference('DEP');\r\n\r\n      // Create payment record\r\n      const payment = await this.prisma.payment.create({\r\n        data: {\r\n          userId,\r\n          amount: new Prisma.Decimal(dto.amount),\r\n          currency: 'NGN',\r\n          description: dto.description || 'Wallet deposit',\r\n          reference,\r\n          provider: PaymentProvider.PAYSTACK,\r\n          method: dto.method,\r\n          status: PaymentStatus.PENDING,\r\n          callbackUrl: dto.callbackUrl,\r\n          metadata: {\r\n            userEmail: user.email,\r\n            userName: `${user.firstName} ${user.lastName}`,\r\n          },\r\n        },\r\n      });\r\n\r\n      // Initialize payment with Paystack\r\n      const paystackResponse = await this.paystackService.initializePayment({\r\n        email: user.email,\r\n        amount: this.paystackService.toKobo(dto.amount),\r\n        reference,\r\n        callback_url: dto.callbackUrl || `${this.configService.get('FRONTEND_URL')}/deposit/callback`,\r\n        metadata: {\r\n          userId,\r\n          paymentId: payment.id,\r\n          type: 'deposit',\r\n        },\r\n        channels: this.getPaymentChannels(dto.method),\r\n      });\r\n\r\n      // Update payment with Paystack response\r\n      await this.prisma.payment.update({\r\n        where: { id: payment.id },\r\n        data: {\r\n          providerRef: paystackResponse.data.reference,\r\n          redirectUrl: paystackResponse.data.authorization_url,\r\n          providerResponse: paystackResponse as any,\r\n        },\r\n      });\r\n\r\n      return {\r\n        paymentId: payment.id,\r\n        reference,\r\n        authorizationUrl: paystackResponse.data.authorization_url,\r\n        accessCode: paystackResponse.data.access_code,\r\n        amount: dto.amount,\r\n        status: PaymentStatus.PENDING,\r\n      };\r\n    } catch (error) {\r\n      this.logger.error('Deposit initiation failed:', error);\r\n      throw new InternalServerErrorException(\r\n        error.message || 'Failed to initiate deposit',\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Verify a payment\r\n   */\r\n  async verifyPayment(dto: VerifyPaymentDto) {\r\n    try {\r\n      // Find payment record\r\n      const payment = await this.prisma.payment.findUnique({\r\n        where: { reference: dto.reference },\r\n        include: { user: { include: { wallet: true } } },\r\n      });\r\n\r\n      if (!payment) {\r\n        throw new NotFoundException('Payment not found');\r\n      }\r\n\r\n      // Verify with Paystack\r\n      const verificationResponse = await this.paystackService.verifyPayment(\r\n        dto.reference,\r\n      );\r\n\r\n      const isSuccess = verificationResponse.data.status === 'success';\r\n      const paidAmount = this.paystackService.fromKobo(\r\n        verificationResponse.data.amount,\r\n      );\r\n\r\n      // Update payment status\r\n      const updatedPayment = await this.prisma.payment.update({\r\n        where: { id: payment.id },\r\n        data: {\r\n          status: isSuccess ? PaymentStatus.SUCCESS : PaymentStatus.FAILED,\r\n          completedAt: isSuccess ? new Date() : undefined,\r\n          failedAt: !isSuccess ? new Date() : undefined,\r\n          providerResponse: verificationResponse as any,\r\n        },\r\n      });\r\n\r\n      // If payment successful, update wallet and create transaction\r\n      if (isSuccess && payment.status !== PaymentStatus.SUCCESS) {\r\n        await this.processSuccessfulDeposit(payment, paidAmount);\r\n      }\r\n\r\n      return {\r\n        paymentId: payment.id,\r\n        reference: dto.reference,\r\n        status: updatedPayment.status,\r\n        amount: paidAmount,\r\n        paidAt: verificationResponse.data.paid_at,\r\n        channel: verificationResponse.data.channel,\r\n        gatewayResponse: verificationResponse.data.gateway_response,\r\n      };\r\n    } catch (error) {\r\n      this.logger.error('Payment verification failed:', error);\r\n      throw new InternalServerErrorException(\r\n        error.message || 'Failed to verify payment',\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Process successful deposit\r\n   */\r\n  private async processSuccessfulDeposit(payment: any, amount: number) {\r\n    const user = payment.user;\r\n    const wallet = user.wallet;\r\n\r\n    await this.prisma.$transaction(async (tx) => {\r\n      // Update wallet balance\r\n      const updatedWallet = await tx.wallet.update({\r\n        where: { userId: user.id },\r\n        data: {\r\n          balance: {\r\n            increment: new Prisma.Decimal(amount),\r\n          },\r\n        },\r\n      });\r\n\r\n      // Create transaction record\r\n      await tx.transaction.create({\r\n        data: {\r\n          userId: user.id,\r\n          type: TransactionType.PAYMENT_GATEWAY_DEPOSIT,\r\n          status: TransactionStatus.COMPLETED,\r\n          amount: new Prisma.Decimal(amount),\r\n          currency: 'NGN',\r\n          balanceBefore: wallet.balance,\r\n          balanceAfter: updatedWallet.balance,\r\n          description: payment.description || 'Paystack deposit',\r\n          reference: `TXN_${payment.reference}`,\r\n          externalRef: payment.providerRef,\r\n          metadata: {\r\n            paymentId: payment.id,\r\n            provider: payment.provider,\r\n            method: payment.method,\r\n          },\r\n        },\r\n      });\r\n    });\r\n\r\n    this.logger.log(`Deposit processed successfully: ${payment.reference} - ₦${amount}`);\r\n  }\r\n\r\n  /**\r\n   * Get available banks\r\n   */\r\n  async getBanks() {\r\n    try {\r\n      const response = await this.paystackService.getBanks();\r\n      return response.data\r\n        .filter((bank) => bank.active && bank.supports_transfer)\r\n        .map((bank) => ({\r\n          name: bank.name,\r\n          code: bank.code,\r\n          slug: bank.slug,\r\n          supports_transfer: bank.supports_transfer,\r\n        }));\r\n    } catch (error) {\r\n      this.logger.error('Failed to fetch banks:', error);\r\n      throw new InternalServerErrorException('Failed to fetch bank list');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Resolve bank account details\r\n   */\r\n  async resolveAccount(dto: ResolveAccountDto) {\r\n    try {\r\n      const response = await this.paystackService.resolveAccountNumber({\r\n        account_number: dto.accountNumber,\r\n        bank_code: dto.bankCode,\r\n      });\r\n\r\n      return {\r\n        accountNumber: response.data.account_number,\r\n        accountName: response.data.account_name,\r\n        bankId: response.data.bank_id,\r\n      };\r\n    } catch (error) {\r\n      this.logger.error('Account resolution failed:', error);\r\n      throw new BadRequestException(\r\n        error.message || 'Failed to resolve account details',\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add a bank account\r\n   */\r\n  async addBankAccount(userId: string, dto: AddBankAccountDto) {\r\n    try {\r\n      // Check if account already exists\r\n      const existingAccount = await this.prisma.bankAccount.findFirst({\r\n        where: {\r\n          userId,\r\n          accountNumber: dto.accountNumber,\r\n          bankCode: dto.bankCode,\r\n        },\r\n      });\r\n\r\n      if (existingAccount) {\r\n        throw new ConflictException('Bank account already exists');\r\n      }\r\n\r\n      // Verify account with Paystack\r\n      const accountDetails = await this.resolveAccount({\r\n        accountNumber: dto.accountNumber,\r\n        bankCode: dto.bankCode,\r\n      });\r\n\r\n      // If setting as primary, unset other primary accounts\r\n      if (dto.isPrimary) {\r\n        await this.prisma.bankAccount.updateMany({\r\n          where: { userId, isPrimary: true },\r\n          data: { isPrimary: false },\r\n        });\r\n      }\r\n\r\n      // Create bank account\r\n      const bankAccount = await this.prisma.bankAccount.create({\r\n        data: {\r\n          userId,\r\n          accountName: accountDetails.accountName,\r\n          accountNumber: dto.accountNumber,\r\n          bankName: dto.bankName,\r\n          bankCode: dto.bankCode,\r\n          isVerified: true,\r\n          verifiedAt: new Date(),\r\n          isPrimary: dto.isPrimary || false,\r\n        },\r\n      });\r\n\r\n      return bankAccount;\r\n    } catch (error) {\r\n      this.logger.error('Bank account creation failed:', error);\r\n      throw new InternalServerErrorException(\r\n        error.message || 'Failed to add bank account',\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get user bank accounts\r\n   */\r\n  async getBankAccounts(userId: string) {\r\n    return this.prisma.bankAccount.findMany({\r\n      where: { userId },\r\n      orderBy: [{ isPrimary: 'desc' }, { createdAt: 'desc' }],\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Initiate withdrawal\r\n   */\r\n  async initiateWithdrawal(userId: string, dto: InitiateWithdrawalDto) {\r\n    try {\r\n      // Get user and wallet\r\n      const user = await this.prisma.user.findUnique({\r\n        where: { id: userId },\r\n        include: { wallet: true },\r\n      });\r\n\r\n      if (!user || !user.wallet) {\r\n        throw new NotFoundException('User or wallet not found');\r\n      }\r\n\r\n      // Check if user has sufficient balance\r\n      const currentBalance = user.wallet.balance.toNumber();\r\n      const withdrawalFee = this.calculateWithdrawalFee(dto.amount);\r\n      const totalAmount = dto.amount + withdrawalFee;\r\n\r\n      if (currentBalance < totalAmount) {\r\n        throw new BadRequestException(\r\n          `Insufficient balance. Available: ₦${currentBalance.toLocaleString()}, Required: ₦${totalAmount.toLocaleString()}`,\r\n        );\r\n      }\r\n\r\n      // Get bank account\r\n      const bankAccount = await this.prisma.bankAccount.findUnique({\r\n        where: { id: dto.bankAccountId, userId },\r\n      });\r\n\r\n      if (!bankAccount) {\r\n        throw new NotFoundException('Bank account not found');\r\n      }\r\n\r\n      if (!bankAccount.isVerified) {\r\n        throw new BadRequestException('Bank account is not verified');\r\n      }\r\n\r\n      // Generate withdrawal reference\r\n      const reference = this.paystackService.generateReference('WDR');\r\n\r\n      // Create transfer recipient in Paystack\r\n      const recipient = await this.paystackService.createTransferRecipient({\r\n        type: 'nuban',\r\n        name: bankAccount.accountName,\r\n        account_number: bankAccount.accountNumber,\r\n        bank_code: bankAccount.bankCode,\r\n      });\r\n\r\n      // Create withdrawal record\r\n      const withdrawal = await this.prisma.withdrawal.create({\r\n        data: {\r\n          userId,\r\n          amount: new Prisma.Decimal(dto.amount),\r\n          currency: 'NGN',\r\n          fee: new Prisma.Decimal(withdrawalFee),\r\n          totalAmount: new Prisma.Decimal(totalAmount),\r\n          bankAccountId: bankAccount.id,\r\n          recipientCode: recipient.data.recipient_code,\r\n          provider: PaymentProvider.PAYSTACK,\r\n          status: PaymentStatus.PENDING,\r\n          reference,\r\n          description: dto.description || 'Wallet withdrawal',\r\n        },\r\n      });\r\n\r\n      // Initiate transfer with Paystack\r\n      const transferResponse = await this.paystackService.initiateTransfer({\r\n        source: 'balance',\r\n        amount: this.paystackService.toKobo(dto.amount),\r\n        recipient: recipient.data.recipient_code,\r\n        reason: dto.description || 'Wallet withdrawal',\r\n        reference,\r\n      });\r\n\r\n      // Update withdrawal with transfer details\r\n      await this.prisma.withdrawal.update({\r\n        where: { id: withdrawal.id },\r\n        data: {\r\n          providerRef: transferResponse.data.transfer_code,\r\n          transferCode: transferResponse.data.transfer_code,\r\n          status: PaymentStatus.PROCESSING,\r\n          processedAt: new Date(),\r\n          providerResponse: transferResponse as any,\r\n        },\r\n      });\r\n\r\n      // Deduct amount from wallet immediately\r\n      await this.processWithdrawalDeduction(user, withdrawal, totalAmount);\r\n\r\n      return {\r\n        withdrawalId: withdrawal.id,\r\n        reference,\r\n        amount: dto.amount,\r\n        fee: withdrawalFee,\r\n        totalAmount,\r\n        status: PaymentStatus.PROCESSING,\r\n        bankAccount: {\r\n          accountName: bankAccount.accountName,\r\n          accountNumber: bankAccount.accountNumber,\r\n          bankName: bankAccount.bankName,\r\n        },\r\n      };\r\n    } catch (error) {\r\n      this.logger.error('Withdrawal initiation failed:', error);\r\n      throw new InternalServerErrorException(\r\n        error.message || 'Failed to initiate withdrawal',\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Process withdrawal wallet deduction\r\n   */\r\n  private async processWithdrawalDeduction(user: any, withdrawal: any, totalAmount: number) {\r\n    await this.prisma.$transaction(async (tx) => {\r\n      // Update wallet balance\r\n      const updatedWallet = await tx.wallet.update({\r\n        where: { userId: user.id },\r\n        data: {\r\n          balance: {\r\n            decrement: new Prisma.Decimal(totalAmount),\r\n          },\r\n        },\r\n      });\r\n\r\n      // Create transaction record\r\n      await tx.transaction.create({\r\n        data: {\r\n          userId: user.id,\r\n          type: TransactionType.PAYMENT_GATEWAY_WITHDRAWAL,\r\n          status: TransactionStatus.PROCESSING,\r\n          amount: new Prisma.Decimal(totalAmount),\r\n          currency: 'NGN',\r\n          balanceBefore: user.wallet.balance,\r\n          balanceAfter: updatedWallet.balance,\r\n          description: withdrawal.description || 'Paystack withdrawal',\r\n          reference: `TXN_${withdrawal.reference}`,\r\n          externalRef: withdrawal.providerRef,\r\n          metadata: {\r\n            withdrawalId: withdrawal.id,\r\n            provider: withdrawal.provider,\r\n            bankAccountId: withdrawal.bankAccountId,\r\n            fee: withdrawal.fee.toNumber(),\r\n            withdrawalAmount: withdrawal.amount.toNumber(),\r\n          },\r\n        },\r\n      });\r\n    });\r\n\r\n    this.logger.log(`Withdrawal deducted from wallet: ${withdrawal.reference} - ₦${totalAmount}`);\r\n  }\r\n\r\n  /**\r\n   * Get user withdrawals\r\n   */\r\n  async getWithdrawals(userId: string) {\r\n    const withdrawals = await this.prisma.withdrawal.findMany({\r\n      where: { userId },\r\n      include: { bankAccount: true },\r\n      orderBy: { createdAt: 'desc' },\r\n    });\r\n\r\n    return withdrawals.map(withdrawal => ({\r\n      id: withdrawal.id,\r\n      reference: withdrawal.reference,\r\n      amount: withdrawal.amount.toNumber(),\r\n      fee: withdrawal.fee?.toNumber() || 0,\r\n      totalAmount: withdrawal.totalAmount.toNumber(),\r\n      status: withdrawal.status,\r\n      requestedAt: withdrawal.requestedAt,\r\n      processedAt: withdrawal.processedAt,\r\n      bankAccount: withdrawal.bankAccount ? {\r\n        id: withdrawal.bankAccount.id,\r\n        accountName: withdrawal.bankAccount.accountName,\r\n        accountNumber: withdrawal.bankAccount.accountNumber,\r\n        bankName: withdrawal.bankAccount.bankName,\r\n        bankCode: withdrawal.bankAccount.bankCode,\r\n        isVerified: withdrawal.bankAccount.isVerified,\r\n        isPrimary: withdrawal.bankAccount.isPrimary,\r\n        createdAt: withdrawal.bankAccount.createdAt,\r\n      } : null,\r\n    }));\r\n  }\r\n\r\n  /**\r\n   * Get payment status\r\n   */\r\n  async getPaymentStatus(paymentId: string, userId?: string) {\r\n    const whereClause: any = { id: paymentId };\r\n    if (userId) {\r\n      whereClause.userId = userId;\r\n    }\r\n\r\n    const payment = await this.prisma.payment.findUnique({\r\n      where: whereClause,\r\n    });\r\n\r\n    if (!payment) {\r\n      throw new NotFoundException('Payment not found');\r\n    }\r\n\r\n    return {\r\n      ...payment,\r\n      amount: payment.amount.toNumber(),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Calculate withdrawal fee\r\n   */\r\n  private calculateWithdrawalFee(amount: number): number {\r\n    const feeAmount = amount * this.withdrawalFeeRate;\r\n    return Math.min(Math.max(feeAmount, this.minWithdrawalFee), this.maxWithdrawalFee);\r\n  }\r\n\r\n  /**\r\n   * Get payment channels based on method\r\n   */\r\n  private getPaymentChannels(method: PaymentMethod): string[] {\r\n    switch (method) {\r\n      case PaymentMethod.CARD:\r\n        return ['card'];\r\n      case PaymentMethod.BANK_TRANSFER:\r\n        return ['bank_transfer'];\r\n      case PaymentMethod.USSD:\r\n        return ['ussd'];\r\n      case PaymentMethod.QR:\r\n        return ['qr'];\r\n      case PaymentMethod.MOBILE_MONEY:\r\n        return ['mobile_money'];\r\n      default:\r\n        return ['card', 'bank_transfer', 'ussd'];\r\n    }\r\n  }\r\n}"],"names":["PaymentsService","initiateDeposit","userId","dto","user","prisma","findUnique","where","id","include","wallet","NotFoundException","BadRequestException","reference","paystackService","generateReference","payment","create","data","amount","Prisma","Decimal","currency","description","provider","PaymentProvider","PAYSTACK","method","status","PaymentStatus","PENDING","callbackUrl","metadata","userEmail","email","userName","firstName","lastName","paystackResponse","initializePayment","toKobo","callback_url","configService","get","paymentId","type","channels","getPaymentChannels","update","providerRef","redirectUrl","authorization_url","providerResponse","authorizationUrl","accessCode","access_code","error","logger","InternalServerErrorException","message","verifyPayment","verificationResponse","isSuccess","paidAmount","fromKobo","updatedPayment","SUCCESS","FAILED","completedAt","Date","undefined","failedAt","processSuccessfulDeposit","paidAt","paid_at","channel","gatewayResponse","gateway_response","$transaction","tx","updatedWallet","balance","increment","transaction","TransactionType","PAYMENT_GATEWAY_DEPOSIT","TransactionStatus","COMPLETED","balanceBefore","balanceAfter","externalRef","log","getBanks","response","filter","bank","active","supports_transfer","map","name","code","slug","resolveAccount","resolveAccountNumber","account_number","accountNumber","bank_code","bankCode","accountName","account_name","bankId","bank_id","addBankAccount","existingAccount","bankAccount","findFirst","ConflictException","accountDetails","isPrimary","updateMany","bankName","isVerified","verifiedAt","getBankAccounts","findMany","orderBy","createdAt","initiateWithdrawal","currentBalance","toNumber","withdrawalFee","calculateWithdrawalFee","totalAmount","toLocaleString","bankAccountId","recipient","createTransferRecipient","withdrawal","fee","recipientCode","recipient_code","transferResponse","initiateTransfer","source","reason","transfer_code","transferCode","PROCESSING","processedAt","processWithdrawalDeduction","withdrawalId","decrement","PAYMENT_GATEWAY_WITHDRAWAL","withdrawalAmount","getWithdrawals","withdrawals","requestedAt","getPaymentStatus","whereClause","feeAmount","withdrawalFeeRate","Math","min","max","minWithdrawalFee","maxWithdrawalFee","PaymentMethod","CARD","BANK_TRANSFER","USSD","QR","MOBILE_MONEY","Logger"],"mappings":"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"}