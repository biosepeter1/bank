{"version":3,"sources":["../../../src/modules/payments/paystack.webhook.controller.ts"],"sourcesContent":["import {\n  Controller,\n  Post,\n  Body,\n  Headers,\n  BadRequestException,\n  Logger,\n  HttpCode,\n  HttpStatus,\n} from '@nestjs/common';\nimport { DepositsService } from '../deposits/deposits.service';\nimport { PaystackWebhookService } from '../deposits/paystack.webhook';\nimport { ApiTags, ApiOperation } from '@nestjs/swagger';\n\n@ApiTags('Webhooks')\n@Controller('webhooks')\nexport class PaystackWebhookController {\n  private readonly logger = new Logger(PaystackWebhookController.name);\n\n  constructor(\n    private paystackWebhookService: PaystackWebhookService,\n    private depositsService: DepositsService,\n  ) {}\n\n  /**\n   * Paystack webhook endpoint for demo mode\n   * In demo mode, this accepts both signed webhooks and test requests\n   */\n  @Post('paystack')\n  @HttpCode(HttpStatus.OK)\n  @ApiOperation({ summary: 'Paystack webhook endpoint (supports demo mode)' })\n  async handlePaystackWebhook(\n    @Body() event: any,\n    @Headers('x-paystack-signature') signature: string\n  ) {\n    const isDemoMode = process.env.PAYSTACK_DEMO_MODE === 'true';\n\n    if (!isDemoMode && signature) {\n      // In production, verify the signature\n      const payload = JSON.stringify(event);\n      const isValid = this.paystackWebhookService.verifyWebhookSignature(\n        payload,\n        signature\n      );\n\n      if (!isValid) {\n        throw new BadRequestException('Invalid webhook signature');\n      }\n    }\n\n    this.logger.log(\n      `Received Paystack webhook: ${event.event} - Reference: ${event.data?.reference}`\n    );\n\n    // Handle the webhook event\n    await this.paystackWebhookService.handleWebhookEvent(event);\n\n    return { status: 'success' };\n  }\n\n  /**\n   * Demo endpoint to simulate successful payment\n   * For testing in development\n   */\n  @Post('paystack/demo/success')\n  @HttpCode(HttpStatus.OK)\n  @ApiOperation({ summary: 'Demo endpoint to simulate successful Paystack payment' })\n  async simulatePaystackSuccess(@Body() data: { reference: string }) {\n    if (process.env.PAYSTACK_DEMO_MODE !== 'true') {\n      throw new BadRequestException('Demo mode is not enabled');\n    }\n\n    this.logger.log(`[DEMO] Simulating successful payment - Reference: ${data.reference}`);\n\n    try {\n      const result = await this.depositsService.confirmPaystackDeposit(data.reference);\n      return { status: 'success', data: result };\n    } catch (error) {\n      this.logger.error(`[DEMO] Error confirming deposit: ${error.message}`);\n      throw new BadRequestException(`Failed to confirm deposit: ${error.message}`);\n    }\n  }\n\n  /**\n   * Demo endpoint to simulate failed payment\n   */\n  @Post('paystack/demo/failed')\n  @HttpCode(HttpStatus.OK)\n  @ApiOperation({ summary: 'Demo endpoint to simulate failed Paystack payment' })\n  async simulatePaystackFailed(@Body() data: { reference: string }) {\n    if (process.env.PAYSTACK_DEMO_MODE !== 'true') {\n      throw new BadRequestException('Demo mode is not enabled');\n    }\n\n    this.logger.log(`[DEMO] Simulating failed payment - Reference: ${data.reference}`);\n\n    // In a real scenario, you would update the deposit status to FAILED\n    return { status: 'success', message: 'Demo payment failure recorded' };\n  }\n\n  /**\n   * Health check endpoint\n   */\n  @Post('paystack/health')\n  @HttpCode(HttpStatus.OK)\n  @ApiOperation({ summary: 'Health check for webhook endpoint' })\n  async healthCheck() {\n    return {\n      status: 'healthy',\n      demoMode: process.env.PAYSTACK_DEMO_MODE === 'true',\n      timestamp: new Date().toISOString(),\n    };\n  }\n}\n"],"names":["PaystackWebhookController","handlePaystackWebhook","event","signature","isDemoMode","process","env","PAYSTACK_DEMO_MODE","payload","JSON","stringify","isValid","paystackWebhookService","verifyWebhookSignature","BadRequestException","logger","log","data","reference","handleWebhookEvent","status","simulatePaystackSuccess","result","depositsService","confirmPaystackDeposit","error","message","simulatePaystackFailed","healthCheck","demoMode","timestamp","Date","toISOString","Logger","name","OK","summary"],"mappings":";;;;+BAgBaA;;;eAAAA;;;wBAPN;iCACyB;iCACO;yBACD;;;;;;;;;;;;;;;AAI/B,IAAA,AAAMA,4BAAN,MAAMA;IAQX;;;GAGC,GACD,MAGMC,sBACJ,AAAQC,KAAU,EAClB,AAAiCC,SAAiB,EAClD;QACA,MAAMC,aAAaC,QAAQC,GAAG,CAACC,kBAAkB,KAAK;QAEtD,IAAI,CAACH,cAAcD,WAAW;YAC5B,sCAAsC;YACtC,MAAMK,UAAUC,KAAKC,SAAS,CAACR;YAC/B,MAAMS,UAAU,IAAI,CAACC,sBAAsB,CAACC,sBAAsB,CAChEL,SACAL;YAGF,IAAI,CAACQ,SAAS;gBACZ,MAAM,IAAIG,2BAAmB,CAAC;YAChC;QACF;QAEA,IAAI,CAACC,MAAM,CAACC,GAAG,CACb,CAAC,2BAA2B,EAAEd,MAAMA,KAAK,CAAC,cAAc,EAAEA,MAAMe,IAAI,EAAEC,WAAW;QAGnF,2BAA2B;QAC3B,MAAM,IAAI,CAACN,sBAAsB,CAACO,kBAAkB,CAACjB;QAErD,OAAO;YAAEkB,QAAQ;QAAU;IAC7B;IAEA;;;GAGC,GACD,MAGMC,wBAAwB,AAAQJ,IAA2B,EAAE;QACjE,IAAIZ,QAAQC,GAAG,CAACC,kBAAkB,KAAK,QAAQ;YAC7C,MAAM,IAAIO,2BAAmB,CAAC;QAChC;QAEA,IAAI,CAACC,MAAM,CAACC,GAAG,CAAC,CAAC,kDAAkD,EAAEC,KAAKC,SAAS,EAAE;QAErF,IAAI;YACF,MAAMI,SAAS,MAAM,IAAI,CAACC,eAAe,CAACC,sBAAsB,CAACP,KAAKC,SAAS;YAC/E,OAAO;gBAAEE,QAAQ;gBAAWH,MAAMK;YAAO;QAC3C,EAAE,OAAOG,OAAO;YACd,IAAI,CAACV,MAAM,CAACU,KAAK,CAAC,CAAC,iCAAiC,EAAEA,MAAMC,OAAO,EAAE;YACrE,MAAM,IAAIZ,2BAAmB,CAAC,CAAC,2BAA2B,EAAEW,MAAMC,OAAO,EAAE;QAC7E;IACF;IAEA;;GAEC,GACD,MAGMC,uBAAuB,AAAQV,IAA2B,EAAE;QAChE,IAAIZ,QAAQC,GAAG,CAACC,kBAAkB,KAAK,QAAQ;YAC7C,MAAM,IAAIO,2BAAmB,CAAC;QAChC;QAEA,IAAI,CAACC,MAAM,CAACC,GAAG,CAAC,CAAC,8CAA8C,EAAEC,KAAKC,SAAS,EAAE;QAEjF,oEAAoE;QACpE,OAAO;YAAEE,QAAQ;YAAWM,SAAS;QAAgC;IACvE;IAEA;;GAEC,GACD,MAGME,cAAc;QAClB,OAAO;YACLR,QAAQ;YACRS,UAAUxB,QAAQC,GAAG,CAACC,kBAAkB,KAAK;YAC7CuB,WAAW,IAAIC,OAAOC,WAAW;QACnC;IACF;IA7FA,YACE,AAAQpB,sBAA8C,EACtD,AAAQW,eAAgC,CACxC;aAFQX,yBAAAA;aACAW,kBAAAA;aAJOR,SAAS,IAAIkB,cAAM,CAACjC,0BAA0BkC,IAAI;IAKhE;AA2FL;;;6CApFuBC;;QACLC,SAAS;;;;;;;;;;;;;6CAmCJD;;QACLC,SAAS;;;;;;;;;;;6CAqBJD;;QACLC,SAAS;;;;;;;;;;;6CAgBJD;;QACLC,SAAS"}