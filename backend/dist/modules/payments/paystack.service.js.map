{"version":3,"sources":["../../../src/modules/payments/paystack.service.ts"],"sourcesContent":["import { Injectable, Logger, BadRequestException } from '@nestjs/common';\r\nimport { ConfigService } from '@nestjs/config';\r\nimport axios, { AxiosInstance, AxiosResponse } from 'axios';\r\nimport * as crypto from 'crypto';\r\n\r\nexport interface PaystackInitializePaymentDto {\r\n  email: string;\r\n  amount: number; // Amount in kobo (NGN * 100)\r\n  reference?: string;\r\n  callback_url?: string;\r\n  metadata?: Record<string, any>;\r\n  channels?: string[];\r\n}\r\n\r\nexport interface PaystackInitializeResponse {\r\n  status: boolean;\r\n  message: string;\r\n  data: {\r\n    authorization_url: string;\r\n    access_code: string;\r\n    reference: string;\r\n  };\r\n}\r\n\r\nexport interface PaystackVerifyResponse {\r\n  status: boolean;\r\n  message: string;\r\n  data: {\r\n    id: number;\r\n    domain: string;\r\n    status: string;\r\n    reference: string;\r\n    amount: number;\r\n    message: string | null;\r\n    gateway_response: string;\r\n    paid_at: string;\r\n    created_at: string;\r\n    channel: string;\r\n    currency: string;\r\n    ip_address: string;\r\n    metadata: Record<string, any>;\r\n    log: Record<string, any>;\r\n    fees: number;\r\n    fees_split: any;\r\n    authorization: {\r\n      authorization_code: string;\r\n      bin: string;\r\n      last4: string;\r\n      exp_month: string;\r\n      exp_year: string;\r\n      channel: string;\r\n      card_type: string;\r\n      bank: string;\r\n      country_code: string;\r\n      brand: string;\r\n      reusable: boolean;\r\n      signature: string;\r\n      account_name: string | null;\r\n    };\r\n    customer: {\r\n      id: number;\r\n      first_name: string | null;\r\n      last_name: string | null;\r\n      email: string;\r\n      customer_code: string;\r\n      phone: string | null;\r\n      metadata: Record<string, any>;\r\n      risk_action: string;\r\n      international_format_phone: string | null;\r\n    };\r\n    plan: any;\r\n    split: Record<string, any>;\r\n    order_id: any;\r\n    paidAt: string;\r\n    createdAt: string;\r\n    requested_amount: number;\r\n    pos_transaction_data: any;\r\n    source: any;\r\n    fees_breakdown: any;\r\n  };\r\n}\r\n\r\nexport interface PaystackBankListResponse {\r\n  status: boolean;\r\n  message: string;\r\n  data: Array<{\r\n    name: string;\r\n    slug: string;\r\n    code: string;\r\n    longcode: string;\r\n    gateway: string | null;\r\n    pay_with_bank: boolean;\r\n    supports_transfer: boolean;\r\n    active: boolean;\r\n    country: string;\r\n    currency: string;\r\n    type: string;\r\n    is_deleted: boolean;\r\n    createdAt: string;\r\n    updatedAt: string;\r\n  }>;\r\n}\r\n\r\nexport interface PaystackResolveAccountDto {\r\n  account_number: string;\r\n  bank_code: string;\r\n}\r\n\r\nexport interface PaystackResolveAccountResponse {\r\n  status: boolean;\r\n  message: string;\r\n  data: {\r\n    account_number: string;\r\n    account_name: string;\r\n    bank_id: number;\r\n  };\r\n}\r\n\r\nexport interface PaystackTransferRecipientDto {\r\n  type: string; // Usually 'nuban'\r\n  name: string;\r\n  account_number: string;\r\n  bank_code: string;\r\n  currency?: string;\r\n}\r\n\r\nexport interface PaystackTransferRecipientResponse {\r\n  status: boolean;\r\n  message: string;\r\n  data: {\r\n    active: boolean;\r\n    createdAt: string;\r\n    currency: string;\r\n    domain: string;\r\n    id: number;\r\n    integration: number;\r\n    name: string;\r\n    recipient_code: string;\r\n    type: string;\r\n    updatedAt: string;\r\n    is_deleted: boolean;\r\n    isDeleted: boolean;\r\n    details: {\r\n      authorization_code: string | null;\r\n      account_number: string;\r\n      account_name: string | null;\r\n      bank_code: string;\r\n      bank_name: string;\r\n    };\r\n  };\r\n}\r\n\r\nexport interface PaystackInitiateTransferDto {\r\n  source: string; // Usually 'balance'\r\n  amount: number; // Amount in kobo\r\n  recipient: string; // Recipient code\r\n  reason?: string;\r\n  reference?: string;\r\n}\r\n\r\nexport interface PaystackInitiateTransferResponse {\r\n  status: boolean;\r\n  message: string;\r\n  data: {\r\n    integration: number;\r\n    domain: string;\r\n    amount: number;\r\n    currency: string;\r\n    source: string;\r\n    reason: string;\r\n    recipient: number;\r\n    status: string;\r\n    transfer_code: string;\r\n    id: number;\r\n    createdAt: string;\r\n    updatedAt: string;\r\n  };\r\n}\r\n\r\n@Injectable()\r\nexport class PaystackService {\r\n  private readonly logger = new Logger(PaystackService.name);\r\n  private readonly httpClient: AxiosInstance;\r\n  private readonly secretKey: string;\r\n  private readonly baseUrl: string;\r\n\r\n  constructor(private readonly configService: ConfigService) {\r\n    const secretKey = this.configService.get<string>('PAYSTACK_SECRET_KEY');\r\n    this.baseUrl = this.configService.get<string>('PAYSTACK_BASE_URL') || 'https://api.paystack.co';\r\n\r\n    if (!secretKey) {\r\n      throw new Error('PAYSTACK_SECRET_KEY is not configured');\r\n    }\r\n    \r\n    this.secretKey = secretKey;\r\n\r\n    this.httpClient = axios.create({\r\n      baseURL: this.baseUrl,\r\n      headers: {\r\n        'Authorization': `Bearer ${this.secretKey}`,\r\n        'Content-Type': 'application/json',\r\n      },\r\n      timeout: 30000,\r\n    });\r\n\r\n    // Request interceptor for logging\r\n    this.httpClient.interceptors.request.use(\r\n      (config) => {\r\n        this.logger.debug(`Making request to: ${config.method?.toUpperCase()} ${config.url}`);\r\n        return config;\r\n      },\r\n      (error) => {\r\n        this.logger.error('Request interceptor error:', error);\r\n        return Promise.reject(error);\r\n      }\r\n    );\r\n\r\n    // Response interceptor for logging\r\n    this.httpClient.interceptors.response.use(\r\n      (response) => {\r\n        this.logger.debug(`Response from ${response.config.url}: ${response.status}`);\r\n        return response;\r\n      },\r\n      (error) => {\r\n        const message = error.response?.data?.message || error.message || 'Unknown error';\r\n        this.logger.error(`Request failed: ${error.config?.url} - ${message}`);\r\n        return Promise.reject(error);\r\n      }\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Initialize a payment transaction\r\n   */\r\n  async initializePayment(data: PaystackInitializePaymentDto): Promise<PaystackInitializeResponse> {\r\n    try {\r\n      const response: AxiosResponse<PaystackInitializeResponse> = await this.httpClient.post(\r\n        '/transaction/initialize',\r\n        data\r\n      );\r\n\r\n      if (!response.data.status) {\r\n        throw new BadRequestException(response.data.message || 'Payment initialization failed');\r\n      }\r\n\r\n      return response.data;\r\n    } catch (error) {\r\n      this.logger.error('Payment initialization failed:', error.response?.data || error.message);\r\n      throw new BadRequestException(\r\n        error.response?.data?.message || 'Failed to initialize payment'\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Verify a payment transaction\r\n   */\r\n  async verifyPayment(reference: string): Promise<PaystackVerifyResponse> {\r\n    try {\r\n      const response: AxiosResponse<PaystackVerifyResponse> = await this.httpClient.get(\r\n        `/transaction/verify/${reference}`\r\n      );\r\n\r\n      if (!response.data.status) {\r\n        throw new BadRequestException(response.data.message || 'Payment verification failed');\r\n      }\r\n\r\n      return response.data;\r\n    } catch (error) {\r\n      this.logger.error('Payment verification failed:', error.response?.data || error.message);\r\n      throw new BadRequestException(\r\n        error.response?.data?.message || 'Failed to verify payment'\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get list of banks\r\n   */\r\n  async getBanks(): Promise<PaystackBankListResponse> {\r\n    try {\r\n      const response: AxiosResponse<PaystackBankListResponse> = await this.httpClient.get(\r\n        '/bank?country=nigeria'\r\n      );\r\n\r\n      return response.data;\r\n    } catch (error) {\r\n      this.logger.error('Failed to fetch banks:', error.response?.data || error.message);\r\n      throw new BadRequestException('Failed to fetch bank list');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Resolve bank account details\r\n   */\r\n  async resolveAccountNumber(data: PaystackResolveAccountDto): Promise<PaystackResolveAccountResponse> {\r\n    try {\r\n      const response: AxiosResponse<PaystackResolveAccountResponse> = await this.httpClient.get(\r\n        `/bank/resolve?account_number=${data.account_number}&bank_code=${data.bank_code}`\r\n      );\r\n\r\n      if (!response.data.status) {\r\n        throw new BadRequestException(response.data.message || 'Account resolution failed');\r\n      }\r\n\r\n      return response.data;\r\n    } catch (error) {\r\n      this.logger.error('Account resolution failed:', error.response?.data || error.message);\r\n      throw new BadRequestException(\r\n        error.response?.data?.message || 'Failed to resolve account'\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create a transfer recipient\r\n   */\r\n  async createTransferRecipient(data: PaystackTransferRecipientDto): Promise<PaystackTransferRecipientResponse> {\r\n    try {\r\n      const response: AxiosResponse<PaystackTransferRecipientResponse> = await this.httpClient.post(\r\n        '/transferrecipient',\r\n        {\r\n          ...data,\r\n          currency: data.currency || 'NGN',\r\n        }\r\n      );\r\n\r\n      if (!response.data.status) {\r\n        throw new BadRequestException(response.data.message || 'Failed to create transfer recipient');\r\n      }\r\n\r\n      return response.data;\r\n    } catch (error) {\r\n      this.logger.error('Transfer recipient creation failed:', error.response?.data || error.message);\r\n      throw new BadRequestException(\r\n        error.response?.data?.message || 'Failed to create transfer recipient'\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Initiate a transfer\r\n   */\r\n  async initiateTransfer(data: PaystackInitiateTransferDto): Promise<PaystackInitiateTransferResponse> {\r\n    try {\r\n      const response: AxiosResponse<PaystackInitiateTransferResponse> = await this.httpClient.post(\r\n        '/transfer',\r\n        data\r\n      );\r\n\r\n      if (!response.data.status) {\r\n        throw new BadRequestException(response.data.message || 'Transfer initiation failed');\r\n      }\r\n\r\n      return response.data;\r\n    } catch (error) {\r\n      this.logger.error('Transfer initiation failed:', error.response?.data || error.message);\r\n      throw new BadRequestException(\r\n        error.response?.data?.message || 'Failed to initiate transfer'\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Verify webhook signature\r\n   */\r\n  verifyWebhookSignature(payload: string, signature: string): boolean {\r\n    try {\r\n      const hash = crypto\r\n        .createHmac('sha512', this.secretKey)\r\n        .update(payload)\r\n        .digest('hex');\r\n      \r\n      return hash === signature;\r\n    } catch (error) {\r\n      this.logger.error('Webhook signature verification failed:', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Generate payment reference\r\n   */\r\n  generateReference(prefix = 'RDN'): string {\r\n    const timestamp = Date.now();\r\n    const random = Math.random().toString(36).substring(2, 8).toUpperCase();\r\n    return `${prefix}_${timestamp}_${random}`;\r\n  }\r\n\r\n  /**\r\n   * Convert amount to kobo (for Paystack)\r\n   */\r\n  toKobo(amount: number): number {\r\n    return Math.round(amount * 100);\r\n  }\r\n\r\n  /**\r\n   * Convert kobo to naira\r\n   */\r\n  fromKobo(kobo: number): number {\r\n    return kobo / 100;\r\n  }\r\n}"],"names":["PaystackService","initializePayment","data","response","httpClient","post","status","BadRequestException","message","error","logger","verifyPayment","reference","get","getBanks","resolveAccountNumber","account_number","bank_code","createTransferRecipient","currency","initiateTransfer","verifyWebhookSignature","payload","signature","hash","crypto","createHmac","secretKey","update","digest","generateReference","prefix","timestamp","Date","now","random","Math","toString","substring","toUpperCase","toKobo","amount","round","fromKobo","kobo","configService","Logger","name","baseUrl","Error","axios","create","baseURL","headers","timeout","interceptors","request","use","config","debug","method","url","Promise","reject"],"mappings":"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"}