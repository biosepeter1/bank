{"version":3,"sources":["../../../src/modules/payments/demo.controller.ts"],"sourcesContent":["import {\r\n  Controller,\r\n  Post,\r\n  Get,\r\n  Body,\r\n  Param,\r\n  UseGuards,\r\n  HttpCode,\r\n  HttpStatus,\r\n} from '@nestjs/common';\r\nimport { ApiTags, ApiOperation, ApiResponse, ApiBearerAuth } from '@nestjs/swagger';\r\nimport { PaystackDemoService } from './paystack-demo.service';\r\nimport { WebhookService } from './webhook.service';\r\nimport { JwtAuthGuard } from 'src/common/guards/jwt-auth.guard';\r\nimport { RolesGuard } from 'src/common/guards/roles.guard';\r\nimport { Roles } from 'src/common/decorators/roles.decorator';\r\nimport { UserRole } from '@prisma/client';\r\n\r\n@ApiTags('demo')\r\n@Controller('demo')\r\nexport class DemoController {\r\n  constructor(\r\n    private readonly demoService: PaystackDemoService,\r\n    private readonly webhookService: WebhookService,\r\n  ) {}\r\n\r\n  @Get('info')\r\n  @ApiOperation({ \r\n    summary: 'Get demo mode information',\r\n    description: 'Get current demo mode status and statistics'\r\n  })\r\n  @ApiResponse({ \r\n    status: 200, \r\n    description: 'Demo info retrieved successfully',\r\n    schema: {\r\n      type: 'object',\r\n      properties: {\r\n        mode: { type: 'string', example: 'demo' },\r\n        totalPayments: { type: 'number', example: 5 },\r\n        totalTransfers: { type: 'number', example: 2 },\r\n        totalRecipients: { type: 'number', example: 3 },\r\n        warning: { type: 'string', example: 'This is demo mode. No real money transactions will occur.' },\r\n      },\r\n    },\r\n  })\r\n  getDemoInfo() {\r\n    return this.demoService.getDemoInfo();\r\n  }\r\n\r\n  @Post('webhook/charge/:reference')\r\n  @HttpCode(HttpStatus.OK)\r\n  @ApiOperation({ \r\n    summary: 'Simulate charge webhook event',\r\n    description: 'Simulate a Paystack webhook for charge success/failure (Demo only)'\r\n  })\r\n  @ApiResponse({ status: 200, description: 'Webhook event simulated successfully' })\r\n  async simulateChargeWebhook(\r\n    @Param('reference') reference: string,\r\n    @Body('success') success: boolean = true,\r\n  ) {\r\n    const eventType = success ? 'charge.success' : 'charge.failed';\r\n    const webhookEvent = await this.demoService.simulateWebhookEvent(reference, eventType);\r\n    \r\n    const payload = JSON.stringify(webhookEvent);\r\n    const signature = 'demo-signature'; // Demo signature\r\n    \r\n    return this.webhookService.handlePaystackWebhook(signature, payload);\r\n  }\r\n\r\n  @Post('webhook/transfer/:reference')\r\n  @HttpCode(HttpStatus.OK)\r\n  @ApiOperation({ \r\n    summary: 'Simulate transfer webhook event',\r\n    description: 'Simulate a Paystack webhook for transfer success/failure (Demo only)'\r\n  })\r\n  @ApiResponse({ status: 200, description: 'Webhook event simulated successfully' })\r\n  async simulateTransferWebhook(\r\n    @Param('reference') reference: string,\r\n    @Body('success') success: boolean = true,\r\n  ) {\r\n    const eventType = success ? 'transfer.success' : 'transfer.failed';\r\n    const webhookEvent = await this.demoService.simulateWebhookEvent(reference, eventType);\r\n    \r\n    const payload = JSON.stringify(webhookEvent);\r\n    const signature = 'demo-signature'; // Demo signature\r\n    \r\n    return this.webhookService.handlePaystackWebhook(signature, payload);\r\n  }\r\n\r\n  @Post('simulate-payment-flow')\r\n  @UseGuards(JwtAuthGuard)\r\n  @ApiBearerAuth()\r\n  @ApiOperation({ \r\n    summary: 'Simulate complete payment flow',\r\n    description: 'Simulate a complete payment flow from initiation to webhook confirmation (Demo only)'\r\n  })\r\n  @ApiResponse({ \r\n    status: 200, \r\n    description: 'Payment flow simulated successfully',\r\n    schema: {\r\n      type: 'object',\r\n      properties: {\r\n        step1: { type: 'object', description: 'Payment initialization' },\r\n        step2: { type: 'object', description: 'Payment verification' },\r\n        step3: { type: 'object', description: 'Webhook processing' },\r\n        message: { type: 'string', example: 'Complete demo payment flow executed successfully' },\r\n      },\r\n    },\r\n  })\r\n  async simulatePaymentFlow(\r\n    @Body() data: { \r\n      email: string; \r\n      amount: number; \r\n      success?: boolean;\r\n    }\r\n  ) {\r\n    // Step 1: Initialize payment\r\n    const initResponse = await this.demoService.initializePayment({\r\n      email: data.email,\r\n      amount: this.demoService.toKobo(data.amount),\r\n      metadata: { demo: true, simulatedFlow: true },\r\n    });\r\n\r\n    // Step 2: Verify payment\r\n    const verifyResponse = await this.demoService.verifyPayment(\r\n      initResponse.data.reference\r\n    );\r\n\r\n    // Step 3: Simulate webhook (if payment was successful)\r\n    let webhookResponse: any = null;\r\n    if (verifyResponse.data.status === 'success') {\r\n      const webhookEvent = await this.demoService.simulateWebhookEvent(\r\n        initResponse.data.reference, \r\n        'charge.success'\r\n      );\r\n      \r\n      webhookResponse = await this.webhookService.handlePaystackWebhook(\r\n        'demo-signature', \r\n        JSON.stringify(webhookEvent)\r\n      );\r\n    }\r\n\r\n    return {\r\n      step1: initResponse,\r\n      step2: verifyResponse,\r\n      step3: webhookResponse,\r\n      message: 'Complete demo payment flow executed successfully',\r\n      warning: 'This is a demo simulation. No real money was processed.',\r\n    };\r\n  }\r\n\r\n  @Get('banks')\r\n  @ApiOperation({ \r\n    summary: 'Get demo banks list',\r\n    description: 'Get list of demo Nigerian banks for testing'\r\n  })\r\n  @ApiResponse({ status: 200, description: 'Demo banks retrieved successfully' })\r\n  async getDemoBanks() {\r\n    return this.demoService.getBanks();\r\n  }\r\n\r\n  @Post('resolve-account')\r\n  @ApiOperation({ \r\n    summary: 'Resolve demo account',\r\n    description: 'Resolve a demo bank account (returns random demo names)'\r\n  })\r\n  @ApiResponse({ status: 200, description: 'Demo account resolved successfully' })\r\n  async resolveDemoAccount(\r\n    @Body() data: { accountNumber: string; bankCode: string }\r\n  ) {\r\n    return this.demoService.resolveAccountNumber({\r\n      account_number: data.accountNumber,\r\n      bank_code: data.bankCode,\r\n    });\r\n  }\r\n\r\n  // Admin endpoint to reset demo data\r\n  @Post('reset')\r\n  @UseGuards(JwtAuthGuard, RolesGuard)\r\n  @Roles(UserRole.SUPER_ADMIN)\r\n  @ApiBearerAuth()\r\n  @ApiOperation({ \r\n    summary: 'Reset demo data (Super Admin only)',\r\n    description: 'Clear all demo payment and transfer data'\r\n  })\r\n  @ApiResponse({ status: 200, description: 'Demo data reset successfully' })\r\n  async resetDemoData() {\r\n    // Clear demo data maps\r\n    (this.demoService as any).demoPayments.clear();\r\n    (this.demoService as any).demoTransfers.clear();\r\n    (this.demoService as any).demoRecipients.clear();\r\n    \r\n    return {\r\n      message: 'Demo data has been reset successfully',\r\n      timestamp: new Date().toISOString(),\r\n    };\r\n  }\r\n}"],"names":["DemoController","getDemoInfo","demoService","simulateChargeWebhook","reference","success","eventType","webhookEvent","simulateWebhookEvent","payload","JSON","stringify","signature","webhookService","handlePaystackWebhook","simulateTransferWebhook","simulatePaymentFlow","data","initResponse","initializePayment","email","amount","toKobo","metadata","demo","simulatedFlow","verifyResponse","verifyPayment","webhookResponse","status","step1","step2","step3","message","warning","getDemoBanks","getBanks","resolveDemoAccount","resolveAccountNumber","account_number","accountNumber","bank_code","bankCode","resetDemoData","demoPayments","clear","demoTransfers","demoRecipients","timestamp","Date","toISOString","summary","description","schema","type","properties","mode","example","totalPayments","totalTransfers","totalRecipients","OK","SUPER_ADMIN"],"mappings":"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"}