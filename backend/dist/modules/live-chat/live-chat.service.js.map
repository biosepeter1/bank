{"version":3,"sources":["../../../src/modules/live-chat/live-chat.service.ts"],"sourcesContent":["import { Injectable } from '@nestjs/common';\r\nimport { PrismaService } from '../../prisma/prisma.service';\r\n\r\n@Injectable()\r\nexport class LiveChatService {\r\n    constructor(private prisma: PrismaService) { }\r\n\r\n    async createSession(data: { socketId: string; userId?: string; userIp?: string }) {\r\n        return this.prisma.chatSession.create({\r\n            data: {\r\n                socketId: data.socketId,\r\n                userId: data.userId,\r\n                userIp: data.userIp,\r\n                status: 'QUEUED',\r\n            },\r\n            include: {\r\n                user: { select: { firstName: true, lastName: true, email: true } },\r\n                messages: true,\r\n            },\r\n        });\r\n    }\r\n\r\n    async getSessions(status?: 'QUEUED' | 'ACTIVE' | 'ENDED') {\r\n        return this.prisma.chatSession.findMany({\r\n            where: status ? { status } : undefined,\r\n            orderBy: { updatedAt: 'desc' },\r\n            include: {\r\n                user: { select: { firstName: true, lastName: true, email: true } },\r\n                admin: { select: { firstName: true, lastName: true } },\r\n                messages: {\r\n                    orderBy: { createdAt: 'asc' }\r\n                },\r\n            },\r\n        });\r\n    }\r\n\r\n    async getSession(id: string) {\r\n        return this.prisma.chatSession.findUnique({\r\n            where: { id },\r\n            include: {\r\n                messages: { orderBy: { createdAt: 'asc' } },\r\n                user: { select: { firstName: true, lastName: true, email: true } },\r\n                admin: { select: { firstName: true, lastName: true } },\r\n            },\r\n        });\r\n    }\r\n\r\n    async assignAdminToSession(sessionId: string, adminId: string) {\r\n        return this.prisma.chatSession.update({\r\n            where: { id: sessionId },\r\n            data: {\r\n                adminId,\r\n                status: 'ACTIVE',\r\n            },\r\n        });\r\n    }\r\n\r\n    async saveMessage(sessionId: string, message: string, sender: 'USER' | 'ADMIN' | 'SYSTEM') {\r\n        return this.prisma.chatMessage.create({\r\n            data: {\r\n                sessionId,\r\n                message,\r\n                sender,\r\n            },\r\n        });\r\n    }\r\n\r\n    async endSession(sessionId: string) {\r\n        return this.prisma.chatSession.update({\r\n            where: { id: sessionId },\r\n            data: { status: 'ENDED' },\r\n        });\r\n    }\r\n}\r\n"],"names":["LiveChatService","createSession","data","prisma","chatSession","create","socketId","userId","userIp","status","include","user","select","firstName","lastName","email","messages","getSessions","findMany","where","undefined","orderBy","updatedAt","admin","createdAt","getSession","id","findUnique","assignAdminToSession","sessionId","adminId","update","saveMessage","message","sender","chatMessage","endSession"],"mappings":";;;;+BAIaA;;;eAAAA;;;wBAJc;+BACG;;;;;;;;;;AAGvB,IAAA,AAAMA,kBAAN,MAAMA;IAGT,MAAMC,cAAcC,IAA4D,EAAE;QAC9E,OAAO,IAAI,CAACC,MAAM,CAACC,WAAW,CAACC,MAAM,CAAC;YAClCH,MAAM;gBACFI,UAAUJ,KAAKI,QAAQ;gBACvBC,QAAQL,KAAKK,MAAM;gBACnBC,QAAQN,KAAKM,MAAM;gBACnBC,QAAQ;YACZ;YACAC,SAAS;gBACLC,MAAM;oBAAEC,QAAQ;wBAAEC,WAAW;wBAAMC,UAAU;wBAAMC,OAAO;oBAAK;gBAAE;gBACjEC,UAAU;YACd;QACJ;IACJ;IAEA,MAAMC,YAAYR,MAAsC,EAAE;QACtD,OAAO,IAAI,CAACN,MAAM,CAACC,WAAW,CAACc,QAAQ,CAAC;YACpCC,OAAOV,SAAS;gBAAEA;YAAO,IAAIW;YAC7BC,SAAS;gBAAEC,WAAW;YAAO;YAC7BZ,SAAS;gBACLC,MAAM;oBAAEC,QAAQ;wBAAEC,WAAW;wBAAMC,UAAU;wBAAMC,OAAO;oBAAK;gBAAE;gBACjEQ,OAAO;oBAAEX,QAAQ;wBAAEC,WAAW;wBAAMC,UAAU;oBAAK;gBAAE;gBACrDE,UAAU;oBACNK,SAAS;wBAAEG,WAAW;oBAAM;gBAChC;YACJ;QACJ;IACJ;IAEA,MAAMC,WAAWC,EAAU,EAAE;QACzB,OAAO,IAAI,CAACvB,MAAM,CAACC,WAAW,CAACuB,UAAU,CAAC;YACtCR,OAAO;gBAAEO;YAAG;YACZhB,SAAS;gBACLM,UAAU;oBAAEK,SAAS;wBAAEG,WAAW;oBAAM;gBAAE;gBAC1Cb,MAAM;oBAAEC,QAAQ;wBAAEC,WAAW;wBAAMC,UAAU;wBAAMC,OAAO;oBAAK;gBAAE;gBACjEQ,OAAO;oBAAEX,QAAQ;wBAAEC,WAAW;wBAAMC,UAAU;oBAAK;gBAAE;YACzD;QACJ;IACJ;IAEA,MAAMc,qBAAqBC,SAAiB,EAAEC,OAAe,EAAE;QAC3D,OAAO,IAAI,CAAC3B,MAAM,CAACC,WAAW,CAAC2B,MAAM,CAAC;YAClCZ,OAAO;gBAAEO,IAAIG;YAAU;YACvB3B,MAAM;gBACF4B;gBACArB,QAAQ;YACZ;QACJ;IACJ;IAEA,MAAMuB,YAAYH,SAAiB,EAAEI,OAAe,EAAEC,MAAmC,EAAE;QACvF,OAAO,IAAI,CAAC/B,MAAM,CAACgC,WAAW,CAAC9B,MAAM,CAAC;YAClCH,MAAM;gBACF2B;gBACAI;gBACAC;YACJ;QACJ;IACJ;IAEA,MAAME,WAAWP,SAAiB,EAAE;QAChC,OAAO,IAAI,CAAC1B,MAAM,CAACC,WAAW,CAAC2B,MAAM,CAAC;YAClCZ,OAAO;gBAAEO,IAAIG;YAAU;YACvB3B,MAAM;gBAAEO,QAAQ;YAAQ;QAC5B;IACJ;IAnEA,YAAY,AAAQN,MAAqB,CAAE;aAAvBA,SAAAA;IAAyB;AAoEjD"}