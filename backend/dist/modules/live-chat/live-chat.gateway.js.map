{"version":3,"sources":["../../../src/modules/live-chat/live-chat.gateway.ts"],"sourcesContent":["import {\r\n    WebSocketGateway,\r\n    WebSocketServer,\r\n    SubscribeMessage,\r\n    OnGatewayConnection,\r\n    OnGatewayDisconnect,\r\n    ConnectedSocket,\r\n    MessageBody,\r\n} from '@nestjs/websockets';\r\nimport { Server, Socket } from 'socket.io';\r\nimport { LiveChatService } from './live-chat.service';\r\nimport { UseGuards } from '@nestjs/common';\r\nimport { WsJwtGuard } from '../../common/guards/ws-jwt.guard';\r\n\r\n@WebSocketGateway({\r\n    cors: {\r\n        origin: '*',\r\n    },\r\n    namespace: 'live-chat',\r\n})\r\nexport class LiveChatGateway implements OnGatewayConnection, OnGatewayDisconnect {\r\n    @WebSocketServer()\r\n    server: Server;\r\n\r\n    constructor(private readonly liveChatService: LiveChatService) { }\r\n\r\n    async handleConnection(client: Socket) {\r\n        // console.log(`Client connected: ${client.id}`);\r\n    }\r\n\r\n    handleDisconnect(client: Socket) {\r\n        // console.log(`Client disconnected: ${client.id}`);\r\n    }\r\n\r\n    @SubscribeMessage('startChat')\r\n    async handleStartChat(\r\n        @ConnectedSocket() client: Socket,\r\n        @MessageBody() data: { userId?: string; name?: string; email?: string; userIp?: string },\r\n    ) {\r\n        const session = await this.liveChatService.createSession({\r\n            socketId: client.id,\r\n            userId: data.userId,\r\n            userIp: data.userIp || client.handshake.address,\r\n        });\r\n\r\n        // Join room specifically for this session\r\n        client.join(session.id);\r\n\r\n        // Notify admins of new chat\r\n        this.server.to('admin-room').emit('newChatSession', session);\r\n\r\n        return { event: 'chatStarted', data: session };\r\n    }\r\n\r\n    @SubscribeMessage('joinAdminRoom')\r\n    async handleJoinAdminRoom(@ConnectedSocket() client: Socket) {\r\n        // In a real app, verify admin role via Guard/Token\r\n        client.join('admin-room');\r\n        return { status: 'joined admin room' };\r\n    }\r\n\r\n    @SubscribeMessage('adminJoinSession')\r\n    async handleAdminJoinSession(\r\n        @ConnectedSocket() client: Socket,\r\n        @MessageBody() data: { sessionId: string; adminId: string },\r\n    ) {\r\n        const session = await this.liveChatService.assignAdminToSession(data.sessionId, data.adminId);\r\n        client.join(data.sessionId); // Admin joins the chat room\r\n\r\n        // Notify user that admin joined\r\n        this.server.to(data.sessionId).emit('adminJoined', { adminId: data.adminId });\r\n\r\n        return session;\r\n    }\r\n\r\n    @SubscribeMessage('sendMessage')\r\n    async handleSendMessage(\r\n        @ConnectedSocket() client: Socket,\r\n        @MessageBody() data: { sessionId: string; message: string; sender: 'USER' | 'ADMIN' },\r\n    ) {\r\n        const savedMessage = await this.liveChatService.saveMessage(\r\n            data.sessionId,\r\n            data.message,\r\n            data.sender,\r\n        );\r\n\r\n        // Broadcast to everyone in the room (User + Admin)\r\n        this.server.to(data.sessionId).emit('newMessage', savedMessage);\r\n\r\n        return savedMessage;\r\n    }\r\n\r\n    @SubscribeMessage('typing')\r\n    async handleTyping(\r\n        @ConnectedSocket() client: Socket,\r\n        @MessageBody() data: { sessionId: string; isTyping: boolean },\r\n    ) {\r\n        client.to(data.sessionId).emit('typingStatus', data);\r\n    }\r\n\r\n    @SubscribeMessage('adminEndSession')\r\n    async handleAdminEndSession(\r\n        @ConnectedSocket() client: Socket,\r\n        @MessageBody() data: { sessionId: string; adminId: string },\r\n    ) {\r\n        // Update session status in database\r\n        await this.liveChatService.endSession(data.sessionId);\r\n\r\n        // Send a system message to the session\r\n        const systemMessage = await this.liveChatService.saveMessage(\r\n            data.sessionId,\r\n            'This chat session has been ended by the support agent. Thank you for contacting us!',\r\n            'SYSTEM',\r\n        );\r\n\r\n        // Broadcast the system message first\r\n        this.server.to(data.sessionId).emit('newMessage', systemMessage);\r\n\r\n        // Then notify everyone in the session that it has ended\r\n        this.server.to(data.sessionId).emit('sessionEnded', data.sessionId);\r\n\r\n        // Also notify admin room\r\n        this.server.to('admin-room').emit('sessionEnded', data.sessionId);\r\n\r\n        return { status: 'session ended', sessionId: data.sessionId };\r\n    }\r\n}\r\n"],"names":["LiveChatGateway","handleConnection","client","handleDisconnect","handleStartChat","data","session","liveChatService","createSession","socketId","id","userId","userIp","handshake","address","join","server","to","emit","event","handleJoinAdminRoom","status","handleAdminJoinSession","assignAdminToSession","sessionId","adminId","handleSendMessage","savedMessage","saveMessage","message","sender","handleTyping","handleAdminEndSession","endSession","systemMessage","cors","origin","namespace"],"mappings":"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"}