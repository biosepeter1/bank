{"version":3,"sources":["../../../src/modules/audit/audit.service.ts"],"sourcesContent":["import { Injectable } from '@nestjs/common';\r\nimport { PrismaService } from '../../prisma/prisma.service';\r\n\r\n@Injectable()\r\nexport class AuditService {\r\n  constructor(private prisma: PrismaService) {}\r\n\r\n  async getAllLogs(filters: {\r\n    action?: string;\r\n    entity?: string;\r\n    actorRole?: string;\r\n    limit?: number;\r\n  }) {\r\n    const where: any = {};\r\n\r\n    if (filters.action) {\r\n      where.action = filters.action;\r\n    }\r\n\r\n    if (filters.entity) {\r\n      where.entity = filters.entity;\r\n    }\r\n\r\n    if (filters.actorRole) {\r\n      where.actorRole = filters.actorRole;\r\n    }\r\n\r\n    return this.prisma.auditLog.findMany({\r\n      where,\r\n      orderBy: { createdAt: 'desc' },\r\n      take: filters.limit || 100,\r\n      include: {\r\n        user: {\r\n          select: {\r\n            id: true,\r\n            email: true,\r\n            firstName: true,\r\n            lastName: true,\r\n            role: true,\r\n          },\r\n        },\r\n      },\r\n    });\r\n  }\r\n\r\n  async getStats() {\r\n    const [\r\n      totalLogs,\r\n      todayLogs,\r\n      criticalActions,\r\n      topActors,\r\n      actionBreakdown,\r\n      entityBreakdown,\r\n    ] = await Promise.all([\r\n      // Total logs\r\n      this.prisma.auditLog.count(),\r\n\r\n      // Today's logs\r\n      this.prisma.auditLog.count({\r\n        where: {\r\n          createdAt: {\r\n            gte: new Date(new Date().setHours(0, 0, 0, 0)),\r\n          },\r\n        },\r\n      }),\r\n\r\n      // Critical actions (KYC, Account changes, Balance adjustments)\r\n      this.prisma.auditLog.count({\r\n        where: {\r\n          action: {\r\n            in: [\r\n              'KYC_APPROVED',\r\n              'KYC_REJECTED',\r\n              'ACCOUNT_FROZEN',\r\n              'ACCOUNT_UNFROZEN',\r\n              'BALANCE_ADJUSTED',\r\n            ],\r\n          },\r\n        },\r\n      }),\r\n\r\n      // Top actors by log count\r\n      this.prisma.auditLog.groupBy({\r\n        by: ['actorEmail', 'actorRole'],\r\n        _count: true,\r\n        orderBy: {\r\n          _count: {\r\n            actorEmail: 'desc',\r\n          },\r\n        },\r\n        take: 5,\r\n      }),\r\n\r\n      // Action breakdown\r\n      this.prisma.auditLog.groupBy({\r\n        by: ['action'],\r\n        _count: true,\r\n        orderBy: {\r\n          _count: {\r\n            action: 'desc',\r\n          },\r\n        },\r\n        take: 10,\r\n      }),\r\n\r\n      // Entity breakdown\r\n      this.prisma.auditLog.groupBy({\r\n        by: ['entity'],\r\n        _count: true,\r\n        orderBy: {\r\n          _count: {\r\n            entity: 'desc',\r\n          },\r\n        },\r\n      }),\r\n    ]);\r\n\r\n    return {\r\n      totalLogs,\r\n      todayLogs,\r\n      criticalActions,\r\n      topActors: topActors.map((actor) => ({\r\n        email: actor.actorEmail,\r\n        role: actor.actorRole,\r\n        count: actor._count,\r\n      })),\r\n      actionBreakdown: actionBreakdown.map((item) => ({\r\n        action: item.action,\r\n        count: item._count,\r\n      })),\r\n      entityBreakdown: entityBreakdown.map((item) => ({\r\n        entity: item.entity,\r\n        count: item._count,\r\n      })),\r\n    };\r\n  }\r\n\r\n  async deleteAuditLog(logId: string) {\r\n    return this.prisma.auditLog.delete({\r\n      where: { id: logId },\r\n    });\r\n  }\r\n\r\n  async deleteAuditLogs(logIds: string[]) {\r\n    return this.prisma.auditLog.deleteMany({\r\n      where: {\r\n        id: {\r\n          in: logIds,\r\n        },\r\n      },\r\n    });\r\n  }\r\n}\r\n"],"names":["AuditService","getAllLogs","filters","where","action","entity","actorRole","prisma","auditLog","findMany","orderBy","createdAt","take","limit","include","user","select","id","email","firstName","lastName","role","getStats","totalLogs","todayLogs","criticalActions","topActors","actionBreakdown","entityBreakdown","Promise","all","count","gte","Date","setHours","in","groupBy","by","_count","actorEmail","map","actor","item","deleteAuditLog","logId","delete","deleteAuditLogs","logIds","deleteMany"],"mappings":"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"}