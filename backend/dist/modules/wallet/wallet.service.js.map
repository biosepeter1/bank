{"version":3,"sources":["../../../src/modules/wallet/wallet.service.ts"],"sourcesContent":["import { Injectable, NotFoundException, BadRequestException } from '@nestjs/common';\r\nimport { PrismaService } from '../../prisma/prisma.service';\r\nimport { DepositDto, WithdrawDto, TransferDto } from './dto/wallet.dto';\r\nimport { ExchangeRateService } from '../../common/services/exchange-rate.service';\r\nimport { TransferLimitsService } from '../../common/services/transfer-limits.service';\r\nimport { Decimal } from '@prisma/client/runtime/library';\r\n\r\n@Injectable()\r\nexport class WalletService {\r\n  constructor(\r\n    private prisma: PrismaService,\r\n    private exchangeRateService: ExchangeRateService,\r\n    private transferLimitsService: TransferLimitsService,\r\n  ) {}\r\n\r\n  async getWallet(userId: string) {\r\n    const wallet = await this.prisma.wallet.findUnique({\r\n      where: { userId },\r\n      include: {\r\n        user: {\r\n          select: {\r\n            id: true,\r\n            email: true,\r\n            firstName: true,\r\n            lastName: true,\r\n          },\r\n        },\r\n      },\r\n    });\r\n\r\n    if (!wallet) {\r\n      throw new NotFoundException('Wallet not found');\r\n    }\r\n\r\n    return wallet;\r\n  }\r\n\r\n  async deposit(userId: string, depositDto: DepositDto) {\r\n    return this.prisma.$transaction(async (tx) => {\r\n      // Get current wallet\r\n      const wallet = await tx.wallet.findUnique({\r\n        where: { userId },\r\n      });\r\n\r\n      if (!wallet) {\r\n        throw new NotFoundException('Wallet not found');\r\n      }\r\n\r\n      const newBalance = Number(wallet.balance) + depositDto.amount;\r\n\r\n      // Update wallet balance\r\n      const updatedWallet = await tx.wallet.update({\r\n        where: { userId },\r\n        data: { balance: newBalance },\r\n      });\r\n\r\n      // Create transaction record\r\n      const transaction = await tx.transaction.create({\r\n        data: {\r\n          userId,\r\n          type: 'DEPOSIT',\r\n          status: 'COMPLETED',\r\n          amount: depositDto.amount,\r\n          balanceBefore: wallet.balance,\r\n          balanceAfter: newBalance,\r\n          description: depositDto.description || 'Deposit',\r\n          reference: `DEP-${Date.now()}-${userId.substring(0, 8)}`,\r\n        },\r\n      });\r\n\r\n      return {\r\n        wallet: updatedWallet,\r\n        transaction,\r\n      };\r\n    });\r\n  }\r\n\r\n  async withdraw(userId: string, withdrawDto: WithdrawDto) {\r\n    return this.prisma.$transaction(async (tx) => {\r\n      // Get current wallet with user and KYC info\r\n      const wallet = await tx.wallet.findUnique({\r\n        where: { userId },\r\n        include: {\r\n          user: {\r\n            include: { kyc: true },\r\n          },\r\n        },\r\n      });\r\n\r\n      if (!wallet) {\r\n        throw new NotFoundException('Wallet not found');\r\n      }\r\n\r\n      // Check KYC approval\r\n      if (!wallet.user.kyc || wallet.user.kyc.status !== 'APPROVED') {\r\n        throw new BadRequestException('KYC verification required. Please complete your KYC to withdraw funds.');\r\n      }\r\n\r\n      // Check sufficient balance\r\n      if (new Decimal(wallet.balance).lessThan(withdrawDto.amount)) {\r\n        throw new BadRequestException(\r\n          `Insufficient balance. Available: ${wallet.balance.toString()} ${wallet.currency}, Required: ${withdrawDto.amount} ${wallet.currency}`\r\n        );\r\n      }\r\n\r\n      const newBalance = Number(wallet.balance) - withdrawDto.amount;\r\n\r\n      // Update wallet balance\r\n      const updatedWallet = await tx.wallet.update({\r\n        where: { userId },\r\n        data: { balance: newBalance },\r\n      });\r\n\r\n      // Create transaction record\r\n      const transaction = await tx.transaction.create({\r\n        data: {\r\n          userId,\r\n          type: 'WITHDRAWAL',\r\n          status: 'COMPLETED',\r\n          amount: withdrawDto.amount,\r\n          balanceBefore: wallet.balance,\r\n          balanceAfter: newBalance,\r\n          description: withdrawDto.description || 'Withdrawal',\r\n          reference: `WTH-${Date.now()}-${userId.substring(0, 8)}`,\r\n        },\r\n      });\r\n\r\n      return {\r\n        wallet: updatedWallet,\r\n        transaction,\r\n      };\r\n    });\r\n  }\r\n\r\n  async transfer(senderId: string, transferDto: TransferDto) {\r\n    // Route to appropriate transfer handler based on type\r\n    switch (transferDto.transferType) {\r\n      case 'INTERNAL':\r\n        return this.internalTransfer(senderId, transferDto);\r\n      case 'DOMESTIC':\r\n        return this.domesticTransfer(senderId, transferDto);\r\n      case 'INTERNATIONAL':\r\n        return this.internationalTransfer(senderId, transferDto);\r\n      default:\r\n        throw new BadRequestException('Invalid transfer type');\r\n    }\r\n  }\r\n\r\n  private async internalTransfer(senderId: string, transferDto: TransferDto) {\r\n    return this.prisma.$transaction(async (tx) => {\r\n      // Get sender wallet with user and KYC info\r\n      const senderWallet = await tx.wallet.findUnique({\r\n        where: { userId: senderId },\r\n        include: {\r\n          user: {\r\n            include: { kyc: true },\r\n          },\r\n        },\r\n      });\r\n\r\n      if (!senderWallet) {\r\n        throw new NotFoundException('Sender wallet not found');\r\n      }\r\n\r\n      // Check KYC approval\r\n      if (!senderWallet.user.kyc || senderWallet.user.kyc.status !== 'APPROVED') {\r\n        throw new BadRequestException('KYC verification required. Please complete your KYC to transfer funds.');\r\n      }\r\n\r\n      // Check transfer limits\r\n      this.transferLimitsService.checkSingleTransferLimit(transferDto.amount);\r\n      await this.transferLimitsService.checkTransferLimits(senderId, transferDto.amount);\r\n\r\n      // Calculate fee (0 for internal transfers)\r\n      const fee = this.transferLimitsService.calculateFee(transferDto.amount, 'INTERNAL');\r\n      const totalAmount = transferDto.amount + fee;\r\n\r\n      // Check sufficient balance (amount + fee)\r\n      if (new Decimal(senderWallet.balance).lessThan(totalAmount)) {\r\n        throw new BadRequestException(\r\n          `Insufficient balance. Available: ${senderWallet.balance.toString()} ${senderWallet.currency}, Required: ${totalAmount} (Amount: ${transferDto.amount} + Fee: ${fee})`\r\n        );\r\n      }\r\n\r\n      if (!transferDto.recipientId) {\r\n        throw new BadRequestException('Recipient ID is required for internal transfers');\r\n      }\r\n\r\n      // Get recipient wallet\r\n      const recipientWallet = await tx.wallet.findUnique({\r\n        where: { userId: transferDto.recipientId },\r\n        include: { user: true },\r\n      });\r\n\r\n      if (!recipientWallet) {\r\n        throw new NotFoundException('Recipient wallet not found');\r\n      }\r\n\r\n      // Deduct from sender (amount + fee)\r\n      const senderNewBalance = Number(senderWallet.balance) - totalAmount;\r\n      await tx.wallet.update({\r\n        where: { userId: senderId },\r\n        data: { balance: senderNewBalance },\r\n      });\r\n\r\n      // Add to recipient\r\n      const recipientNewBalance = Number(recipientWallet.balance) + transferDto.amount;\r\n      await tx.wallet.update({\r\n        where: { userId: transferDto.recipientId },\r\n        data: { balance: recipientNewBalance },\r\n      });\r\n\r\n      // Create transfer record\r\n      const transfer = await tx.transfer.create({\r\n        data: {\r\n          senderId,\r\n          receiverId: transferDto.recipientId,\r\n          transferType: 'INTERNAL',\r\n          amount: transferDto.amount,\r\n          currency: senderWallet.currency,\r\n          description: transferDto.description,\r\n          status: 'COMPLETED',\r\n          providerResponse: {\r\n            fee,\r\n            totalAmount,\r\n          },\r\n        },\r\n      });\r\n\r\n      // Create transaction for sender\r\n      await tx.transaction.create({\r\n        data: {\r\n          userId: senderId,\r\n          type: 'TRANSFER',\r\n          status: 'COMPLETED',\r\n          amount: transferDto.amount,\r\n          balanceBefore: senderWallet.balance,\r\n          balanceAfter: senderNewBalance,\r\n          description: transferDto.description || `Transfer to ${recipientWallet.user.firstName} ${recipientWallet.user.lastName}`,\r\n          reference: `INT-${Date.now()}-${senderId.substring(0, 8)}`,\r\n          transferId: transfer.id,\r\n          metadata: {\r\n            fee,\r\n            totalAmount,\r\n            transferType: 'INTERNAL',\r\n          },\r\n        },\r\n      });\r\n\r\n      // Create transaction for recipient\r\n      await tx.transaction.create({\r\n        data: {\r\n          userId: transferDto.recipientId,\r\n          type: 'TRANSFER',\r\n          status: 'COMPLETED',\r\n          amount: transferDto.amount,\r\n          balanceBefore: recipientWallet.balance,\r\n          balanceAfter: recipientNewBalance,\r\n          description: transferDto.description || `Transfer from ${senderWallet.user.firstName} ${senderWallet.user.lastName}`,\r\n          reference: `INT-${Date.now()}-${transferDto.recipientId.substring(0, 8)}`,\r\n          transferId: transfer.id,\r\n        },\r\n      });\r\n\r\n      return {\r\n        transfer,\r\n        senderNewBalance,\r\n        recipientNewBalance,\r\n        fee,\r\n        totalAmount,\r\n      };\r\n    });\r\n  }\r\n\r\n  private async domesticTransfer(senderId: string, transferDto: TransferDto) {\r\n    return this.prisma.$transaction(async (tx) => {\r\n      // Validate required fields\r\n      if (!transferDto.beneficiaryName || !transferDto.beneficiaryAccount || !transferDto.bankName) {\r\n        throw new BadRequestException('Beneficiary name, account number, and bank name are required for domestic transfers');\r\n      }\r\n\r\n      // Get sender wallet\r\n      const senderWallet = await tx.wallet.findUnique({\r\n        where: { userId: senderId },\r\n        include: {\r\n          user: {\r\n            include: { kyc: true },\r\n          },\r\n        },\r\n      });\r\n\r\n      if (!senderWallet) {\r\n        throw new NotFoundException('Sender wallet not found');\r\n      }\r\n\r\n      // Check KYC approval\r\n      if (!senderWallet.user.kyc || senderWallet.user.kyc.status !== 'APPROVED') {\r\n        throw new BadRequestException('KYC verification required. Please complete your KYC to transfer funds.');\r\n      }\r\n\r\n      // Check transfer limits\r\n      this.transferLimitsService.checkSingleTransferLimit(transferDto.amount);\r\n      await this.transferLimitsService.checkTransferLimits(senderId, transferDto.amount);\r\n\r\n      // Calculate fee\r\n      const fee = this.transferLimitsService.calculateFee(transferDto.amount, 'DOMESTIC');\r\n      const totalAmount = transferDto.amount + fee;\r\n\r\n      // Check sufficient balance (amount + fee)\r\n      if (new Decimal(senderWallet.balance).lessThan(totalAmount)) {\r\n        throw new BadRequestException(\r\n          `Insufficient balance. Available: ${senderWallet.balance.toString()} ${senderWallet.currency}, Required: ${totalAmount} (Amount: ${transferDto.amount} + Fee: ${fee})`\r\n        );\r\n      }\r\n\r\n      // Deduct from sender (amount + fee)\r\n      const senderNewBalance = Number(senderWallet.balance) - totalAmount;\r\n      await tx.wallet.update({\r\n        where: { userId: senderId },\r\n        data: { balance: senderNewBalance },\r\n      });\r\n\r\n      // Create transfer record\r\n      const transfer = await tx.transfer.create({\r\n        data: {\r\n          senderId,\r\n          transferType: 'DOMESTIC',\r\n          amount: transferDto.amount,\r\n          currency: senderWallet.currency,\r\n          description: transferDto.description,\r\n          status: 'COMPLETED', // Mock: instantly completed\r\n          beneficiaryName: transferDto.beneficiaryName,\r\n          beneficiaryAccount: transferDto.beneficiaryAccount,\r\n          bankName: transferDto.bankName,\r\n          bankCode: transferDto.bankCode,\r\n          country: transferDto.country || senderWallet.user.country,\r\n          providerRef: `MOCK-DOM-${Date.now()}`,\r\n          providerResponse: {\r\n            fee,\r\n            totalAmount,\r\n          },\r\n        },\r\n      });\r\n\r\n      // Create transaction for sender\r\n      await tx.transaction.create({\r\n        data: {\r\n          userId: senderId,\r\n          type: 'TRANSFER',\r\n          status: 'COMPLETED',\r\n          amount: transferDto.amount,\r\n          balanceBefore: senderWallet.balance,\r\n          balanceAfter: senderNewBalance,\r\n          description: `Domestic transfer to ${transferDto.beneficiaryName} (${transferDto.bankName})`,\r\n          reference: `DOM-${Date.now()}-${senderId.substring(0, 8)}`,\r\n          transferId: transfer.id,\r\n          metadata: {\r\n            fee,\r\n            totalAmount,\r\n            transferType: 'DOMESTIC',\r\n          },\r\n        },\r\n      });\r\n\r\n      return {\r\n        transfer,\r\n        senderNewBalance,\r\n        fee,\r\n        totalAmount,\r\n        message: 'Domestic transfer completed successfully (Mock)',\r\n      };\r\n    });\r\n  }\r\n\r\n  private async internationalTransfer(senderId: string, transferDto: TransferDto) {\r\n    return this.prisma.$transaction(async (tx) => {\r\n      // Validate required fields\r\n      if (!transferDto.beneficiaryName || !transferDto.beneficiaryAccount || !transferDto.country) {\r\n        throw new BadRequestException('Beneficiary name, account number, and country are required for international transfers');\r\n      }\r\n\r\n      // Get sender wallet\r\n      const senderWallet = await tx.wallet.findUnique({\r\n        where: { userId: senderId },\r\n        include: {\r\n          user: {\r\n            include: { kyc: true },\r\n          },\r\n        },\r\n      });\r\n\r\n      if (!senderWallet) {\r\n        throw new NotFoundException('Sender wallet not found');\r\n      }\r\n\r\n      // Check KYC approval\r\n      if (!senderWallet.user.kyc || senderWallet.user.kyc.status !== 'APPROVED') {\r\n        throw new BadRequestException('KYC verification required. Please complete your KYC to transfer funds.');\r\n      }\r\n\r\n      // Check transfer limits\r\n      this.transferLimitsService.checkSingleTransferLimit(transferDto.amount);\r\n      await this.transferLimitsService.checkTransferLimits(senderId, transferDto.amount);\r\n\r\n      // Calculate fee\r\n      const fee = this.transferLimitsService.calculateFee(transferDto.amount, 'INTERNATIONAL');\r\n      const totalAmount = transferDto.amount + fee;\r\n\r\n      // Check sufficient balance (amount + fee)\r\n      if (new Decimal(senderWallet.balance).lessThan(totalAmount)) {\r\n        throw new BadRequestException(\r\n          `Insufficient balance. Available: ${senderWallet.balance.toString()} ${senderWallet.currency}, Required: ${totalAmount} (Amount: ${transferDto.amount} + Fee: ${fee})`\r\n        );\r\n      }\r\n\r\n      // Deduct from sender (amount + fee)\r\n      const senderNewBalance = Number(senderWallet.balance) - totalAmount;\r\n      await tx.wallet.update({\r\n        where: { userId: senderId },\r\n        data: { balance: senderNewBalance },\r\n      });\r\n\r\n      // Create transfer record\r\n      const transfer = await tx.transfer.create({\r\n        data: {\r\n          senderId,\r\n          transferType: 'INTERNATIONAL',\r\n          amount: transferDto.amount,\r\n          currency: senderWallet.currency,\r\n          description: transferDto.description,\r\n          status: 'COMPLETED', // Mock: instantly completed\r\n          beneficiaryName: transferDto.beneficiaryName,\r\n          beneficiaryAccount: transferDto.beneficiaryAccount,\r\n          bankName: transferDto.bankName,\r\n          swiftCode: transferDto.swiftCode,\r\n          iban: transferDto.iban,\r\n          country: transferDto.country,\r\n          providerRef: `MOCK-INT-${Date.now()}`,\r\n          providerResponse: {\r\n            fee,\r\n            totalAmount,\r\n          },\r\n        },\r\n      });\r\n\r\n      // Create transaction for sender\r\n      await tx.transaction.create({\r\n        data: {\r\n          userId: senderId,\r\n          type: 'TRANSFER',\r\n          status: 'COMPLETED',\r\n          amount: transferDto.amount,\r\n          balanceBefore: senderWallet.balance,\r\n          balanceAfter: senderNewBalance,\r\n          description: `International transfer to ${transferDto.beneficiaryName} (${transferDto.country})`,\r\n          reference: `INT-${Date.now()}-${senderId.substring(0, 8)}`,\r\n          transferId: transfer.id,\r\n          metadata: {\r\n            fee,\r\n            totalAmount,\r\n            transferType: 'INTERNATIONAL',\r\n          },\r\n        },\r\n      });\r\n\r\n      return {\r\n        transfer,\r\n        senderNewBalance,\r\n        fee,\r\n        totalAmount,\r\n        message: 'International transfer completed successfully (Mock)',\r\n      };\r\n    });\r\n  }\r\n\r\n  async getBalance(userId: string) {\r\n    const wallet = await this.prisma.wallet.findUnique({\r\n      where: { userId },\r\n      select: {\r\n        balance: true,\r\n        currency: true,\r\n        updatedAt: true,\r\n      },\r\n    });\r\n\r\n    if (!wallet) {\r\n      throw new NotFoundException('Wallet not found');\r\n    }\r\n\r\n    return wallet;\r\n  }\r\n\r\n  // Admin functions\r\n  async adminAdjustBalance(\r\n    userId: string,\r\n    adminId: string,\r\n    amount: number,\r\n    type: 'CREDIT' | 'DEBIT',\r\n    reason: string,\r\n  ) {\r\n    return this.prisma.$transaction(async (tx) => {\r\n      // Get user wallet\r\n      const wallet = await tx.wallet.findUnique({\r\n        where: { userId },\r\n        include: { user: true },\r\n      });\r\n\r\n      if (!wallet) {\r\n        throw new NotFoundException('User wallet not found');\r\n      }\r\n\r\n      // Check if user account is active\r\n      if (wallet.user.accountStatus === 'CLOSED') {\r\n        throw new BadRequestException('Cannot adjust balance for closed account');\r\n      }\r\n\r\n      const currentBalance = Number(wallet.balance);\r\n      let newBalance: number;\r\n      let transactionType: string;\r\n      let transactionAmount: number;\r\n      let description: string;\r\n\r\n      if (type === 'CREDIT') {\r\n        newBalance = currentBalance + amount;\r\n        transactionType = 'TRANSFER';\r\n        transactionAmount = amount; // Positive for credit\r\n        description = reason;\r\n      } else {\r\n        // DEBIT\r\n        if (currentBalance < amount) {\r\n          throw new BadRequestException(\r\n            `Insufficient balance. Current: ${currentBalance}, Requested: ${amount}`,\r\n          );\r\n        }\r\n        newBalance = currentBalance - amount;\r\n        transactionType = 'TRANSFER';\r\n        transactionAmount = -amount; // Negative for debit\r\n        description = reason;\r\n      }\r\n\r\n      // Update wallet\r\n      const updatedWallet = await tx.wallet.update({\r\n        where: { userId },\r\n        data: { balance: newBalance },\r\n      });\r\n\r\n      // Create transaction record (store reason only in metadata, not in description)\r\n      const transaction = await tx.transaction.create({\r\n        data: {\r\n          userId,\r\n          type: transactionType as any,\r\n          status: 'COMPLETED',\r\n          amount: transactionAmount,\r\n          balanceBefore: currentBalance,\r\n          balanceAfter: newBalance,\r\n          description: type === 'CREDIT' ? 'Account Credited' : 'Account Debited',\r\n          reference: `ADJ-${Date.now()}-${userId.substring(0, 8)}`,\r\n          metadata: {\r\n            adjustmentType: type,\r\n            reason,\r\n            adminId,\r\n          },\r\n        },\r\n      });\r\n\r\n      // Create audit log\r\n      const admin = await tx.user.findUnique({ where: { id: adminId } });\r\n      if (!admin) {\r\n        throw new NotFoundException('Admin user not found');\r\n      }\r\n      await tx.auditLog.create({\r\n        data: {\r\n          userId: adminId,\r\n          actorEmail: admin.email,\r\n          actorRole: admin.role,\r\n          action: 'BALANCE_ADJUSTED',\r\n          entity: 'Wallet',\r\n          entityId: wallet.id,\r\n          description: `Admin ${type.toLowerCase()}ed ${amount} ${wallet.currency} for user ${wallet.user.email}. Reason: ${reason}`,\r\n          metadata: {\r\n            userId,\r\n            amount,\r\n            type,\r\n            reason,\r\n            previousBalance: currentBalance,\r\n            newBalance,\r\n          },\r\n        },\r\n      });\r\n\r\n      // Create notification for user (without reason)\r\n      await tx.notification.create({\r\n        data: {\r\n          userId,\r\n          title: `Balance ${type === 'CREDIT' ? 'Credited' : 'Debited'}`,\r\n          message: `Your account has been ${type === 'CREDIT' ? 'credited with' : 'debited by'} ${amount} ${wallet.currency}.`,\r\n          type: type === 'CREDIT' ? 'SUCCESS' : 'WARNING',\r\n        },\r\n      });\r\n\r\n      return {\r\n        wallet: updatedWallet,\r\n        transaction,\r\n        previousBalance: currentBalance,\r\n        newBalance,\r\n      };\r\n    });\r\n  }\r\n\r\n  async adminClearAccount(\r\n    userId: string,\r\n    adminId: string,\r\n    reason: string,\r\n  ) {\r\n    return this.prisma.$transaction(async (tx) => {\r\n      // Get user wallet\r\n      const wallet = await tx.wallet.findUnique({\r\n        where: { userId },\r\n        include: { user: true },\r\n      });\r\n\r\n      if (!wallet) {\r\n        throw new NotFoundException('User wallet not found');\r\n      }\r\n\r\n      // Check if user account is active\r\n      if (wallet.user.accountStatus === 'CLOSED') {\r\n        throw new BadRequestException('Cannot clear balance for closed account');\r\n      }\r\n\r\n      const currentBalance = Number(wallet.balance);\r\n\r\n      // Count existing transactions\r\n      const transactionCount = await tx.transaction.count({\r\n        where: { userId },\r\n      });\r\n\r\n      // Delete related records first (to avoid foreign key constraints)\r\n      // Delete payments\r\n      await tx.payment.deleteMany({\r\n        where: { userId },\r\n      });\r\n\r\n      // Delete withdrawals\r\n      await tx.withdrawal.deleteMany({\r\n        where: { userId },\r\n      });\r\n\r\n      // Delete deposits\r\n      await tx.deposit.deleteMany({\r\n        where: { userId },\r\n      });\r\n\r\n      // Delete transfers where user was sender or receiver\r\n      await tx.transfer.deleteMany({\r\n        where: {\r\n          OR: [\r\n            { senderId: userId },\r\n            { receiverId: userId },\r\n          ],\r\n        },\r\n      });\r\n\r\n      // Now delete all user transactions\r\n      await tx.transaction.deleteMany({\r\n        where: { userId },\r\n      });\r\n\r\n      // Update wallet to zero\r\n      const updatedWallet = await tx.wallet.update({\r\n        where: { userId },\r\n        data: { balance: 0 },\r\n      });\r\n\r\n      // Create audit log\r\n      const admin = await tx.user.findUnique({ where: { id: adminId } });\r\n      if (!admin) {\r\n        throw new NotFoundException('Admin user not found');\r\n      }\r\n      await tx.auditLog.create({\r\n        data: {\r\n          userId: adminId,\r\n          actorEmail: admin.email,\r\n          actorRole: admin.role,\r\n          action: 'BALANCE_ADJUSTED',\r\n          entity: 'Wallet',\r\n          entityId: wallet.id,\r\n          description: `Admin cleared account for user ${wallet.user.email}. Balance: ${currentBalance} ${wallet.currency} cleared, ${transactionCount} transactions deleted. Reason: ${reason}`,\r\n          metadata: {\r\n            userId,\r\n            amount: currentBalance,\r\n            type: 'CLEAR',\r\n            reason,\r\n            previousBalance: currentBalance,\r\n            newBalance: 0,\r\n            deletedTransactions: transactionCount,\r\n          },\r\n        },\r\n      });\r\n\r\n      return {\r\n        wallet: updatedWallet,\r\n        previousBalance: currentBalance,\r\n        newBalance: 0,\r\n        clearedAmount: currentBalance,\r\n        deletedTransactions: transactionCount,\r\n      };\r\n    });\r\n  }\r\n}\r\n"],"names":["WalletService","getWallet","userId","wallet","prisma","findUnique","where","include","user","select","id","email","firstName","lastName","NotFoundException","deposit","depositDto","$transaction","tx","newBalance","Number","balance","amount","updatedWallet","update","data","transaction","create","type","status","balanceBefore","balanceAfter","description","reference","Date","now","substring","withdraw","withdrawDto","kyc","BadRequestException","Decimal","lessThan","toString","currency","transfer","senderId","transferDto","transferType","internalTransfer","domesticTransfer","internationalTransfer","senderWallet","transferLimitsService","checkSingleTransferLimit","checkTransferLimits","fee","calculateFee","totalAmount","recipientId","recipientWallet","senderNewBalance","recipientNewBalance","receiverId","providerResponse","transferId","metadata","beneficiaryName","beneficiaryAccount","bankName","bankCode","country","providerRef","message","swiftCode","iban","getBalance","updatedAt","adminAdjustBalance","adminId","reason","accountStatus","currentBalance","transactionType","transactionAmount","adjustmentType","admin","auditLog","actorEmail","actorRole","role","action","entity","entityId","toLowerCase","previousBalance","notification","title","adminClearAccount","transactionCount","count","payment","deleteMany","withdrawal","OR","deletedTransactions","clearedAmount","exchangeRateService"],"mappings":"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"}