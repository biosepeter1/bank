{"version":3,"sources":["../../../src/modules/admin/admin.service.ts"],"sourcesContent":["import { Injectable, BadRequestException, NotFoundException } from '@nestjs/common';\r\nimport { PrismaService } from '../../prisma/prisma.service';\r\nimport { TransactionStatus, KYCStatus, CardRequestStatus, AccountStatus, TransferCodeType } from '@prisma/client';\r\nimport * as bcrypt from 'bcrypt';\r\nimport { EmailService } from '../../common/services/email.service';\r\nimport { CreateUserDto, UpdateUserDto, UpdateBalanceDto, UpdateKycStatusDto, AdminUpdateTransferCodeDto } from './dto/create-user.dto';\r\n\r\n@Injectable()\r\nexport class AdminService {\r\n  constructor(\r\n    private prisma: PrismaService,\r\n    private emailService: EmailService,\r\n  ) {}\r\n\r\n  async getDashboardStats() {\r\n    // Get total users count\r\n    const totalUsers = await this.prisma.user.count({\r\n      where: { role: 'USER' }\r\n    });\r\n\r\n    // Get active users count\r\n    const activeUsers = await this.prisma.user.count({\r\n      where: { \r\n        role: 'USER',\r\n        accountStatus: AccountStatus.ACTIVE \r\n      }\r\n    });\r\n\r\n    // Get pending KYC count\r\n    const pendingKYC = await this.prisma.kYC.count({\r\n      where: { status: KYCStatus.PENDING }\r\n    });\r\n\r\n    // Get current month transactions (excluding ADJUSTMENT type which are admin-created)\r\n    const startOfMonth = new Date();\r\n    startOfMonth.setDate(1);\r\n    startOfMonth.setHours(0, 0, 0, 0);\r\n\r\n    const totalTransactions = await this.prisma.transaction.count({\r\n      where: {\r\n        createdAt: { gte: startOfMonth },\r\n        status: TransactionStatus.COMPLETED,\r\n        type: { not: 'ADJUSTMENT' } // Exclude admin adjustments and initial deposits\r\n      }\r\n    });\r\n\r\n    // Get total transaction volume for current month (excluding admin adjustments)\r\n    const volumeResult = await this.prisma.transaction.aggregate({\r\n      where: {\r\n        createdAt: { gte: startOfMonth },\r\n        status: TransactionStatus.COMPLETED,\r\n        type: { not: 'ADJUSTMENT' } // Exclude admin adjustments\r\n      },\r\n      _sum: {\r\n        amount: true\r\n      }\r\n    });\r\n\r\n    const totalVolume = volumeResult._sum.amount?.toNumber() || 0;\r\n\r\n    // Get active cards count\r\n    const activeCards = await this.prisma.card.count({\r\n      where: { status: 'ACTIVE' }\r\n    });\r\n\r\n    // Get pending transfers awaiting admin approval (treat as \"Pending Approvals\")\r\n    const pendingTransfers = await (this.prisma as any).transfer.count({\r\n      where: { status: 'PENDING' }\r\n    });\r\n\r\n    const pendingApprovals = pendingTransfers;\r\n\r\n    // Count system alerts (suspicious transactions, failed logins, old pending KYC)\r\n    const twoDaysAgo = new Date();\r\n    twoDaysAgo.setDate(twoDaysAgo.getDate() - 2);\r\n    \r\n    const oldPendingKYC = await this.prisma.kYC.count({\r\n      where: {\r\n        status: KYCStatus.PENDING,\r\n        createdAt: { lt: twoDaysAgo }\r\n      }\r\n    });\r\n\r\n    // Count large pending transactions\r\n    const largePendingTransactions = await this.prisma.transaction.count({\r\n      where: {\r\n        status: TransactionStatus.PENDING,\r\n        amount: { gte: 1000000 } // Large transactions over 1M\r\n      }\r\n    });\r\n\r\n    const systemAlerts = oldPendingKYC + largePendingTransactions;\r\n\r\n    return {\r\n      totalUsers,\r\n      activeUsers,\r\n      pendingKYC,\r\n      totalTransactions,\r\n      totalVolume,\r\n      activeCards,\r\n      pendingApprovals,\r\n      systemAlerts\r\n    };\r\n  }\r\n\r\n  async getTransactionVolume() {\r\n    const today = new Date();\r\n    const sevenDaysAgo = new Date(today);\r\n    sevenDaysAgo.setDate(today.getDate() - 6);\r\n    sevenDaysAgo.setHours(0, 0, 0, 0);\r\n\r\n    // Fetch all transactions from last 7 days in a single query\r\n    const transactions = await this.prisma.transaction.findMany({\r\n      where: {\r\n        createdAt: { gte: sevenDaysAgo },\r\n        status: TransactionStatus.COMPLETED,\r\n        type: { not: 'ADJUSTMENT' }\r\n      },\r\n      select: {\r\n        createdAt: true,\r\n        amount: true,\r\n      }\r\n    });\r\n\r\n    // Group by date in memory\r\n    const dateMap = new Map<string, { date: Date; transactions: number; volume: number }>();\r\n    \r\n    // Initialize all 7 days\r\n    for (let i = 6; i >= 0; i--) {\r\n      const date = new Date(today);\r\n      date.setDate(date.getDate() - i);\r\n      date.setHours(0, 0, 0, 0);\r\n      const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });\r\n      dateMap.set(dateStr, { date, transactions: 0, volume: 0 });\r\n    }\r\n\r\n    // Aggregate transactions by date\r\n    transactions.forEach(tx => {\r\n      const txDate = new Date(tx.createdAt);\r\n      txDate.setHours(0, 0, 0, 0);\r\n      const dateStr = txDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });\r\n      const dayData = dateMap.get(dateStr);\r\n      if (dayData) {\r\n        dayData.transactions++;\r\n        dayData.volume += tx.amount.toNumber();\r\n      }\r\n    });\r\n\r\n    // Convert to array\r\n    return Array.from(dateMap.values()).map(({ date, transactions, volume }) => ({\r\n      date: date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),\r\n      transactions,\r\n      volume\r\n    }));\r\n  }\r\n\r\n  async getTransactionTypeDistribution() {\r\n    const totalCompleted = await this.prisma.transaction.count({\r\n      where: { status: TransactionStatus.COMPLETED }\r\n    });\r\n\r\n    if (totalCompleted === 0) {\r\n      return [\r\n        { name: 'Deposits', value: 0, color: '#10b981' },\r\n        { name: 'Withdrawals', value: 0, color: '#f59e0b' },\r\n        { name: 'Transfers', value: 0, color: '#3b82f6' },\r\n        { name: 'Others', value: 0, color: '#8b5cf6' },\r\n      ];\r\n    }\r\n\r\n    const deposits = await this.prisma.transaction.count({\r\n      where: { \r\n        type: 'DEPOSIT',\r\n        status: TransactionStatus.COMPLETED \r\n      }\r\n    });\r\n\r\n    const withdrawals = await this.prisma.transaction.count({\r\n      where: { \r\n        type: 'WITHDRAWAL',\r\n        status: TransactionStatus.COMPLETED \r\n      }\r\n    });\r\n\r\n    const transfers = await this.prisma.transaction.count({\r\n      where: { \r\n        type: 'TRANSFER',\r\n        status: TransactionStatus.COMPLETED \r\n      }\r\n    });\r\n\r\n    const others = totalCompleted - deposits - withdrawals - transfers;\r\n\r\n    return [\r\n      { \r\n        name: 'Deposits', \r\n        value: Math.round((deposits / totalCompleted) * 100), \r\n        color: '#10b981' \r\n      },\r\n      { \r\n        name: 'Withdrawals', \r\n        value: Math.round((withdrawals / totalCompleted) * 100), \r\n        color: '#f59e0b' \r\n      },\r\n      { \r\n        name: 'Transfers', \r\n        value: Math.round((transfers / totalCompleted) * 100), \r\n        color: '#3b82f6' \r\n      },\r\n      { \r\n        name: 'Others', \r\n        value: Math.round((others / totalCompleted) * 100), \r\n        color: '#8b5cf6' \r\n      },\r\n    ];\r\n  }\r\n\r\n  async getRecentActivities() {\r\n    // Get recent audit logs\r\n    const recentLogs = await this.prisma.auditLog.findMany({\r\n      take: 10,\r\n      orderBy: { createdAt: 'desc' },\r\n      include: {\r\n        user: {\r\n          select: {\r\n            firstName: true,\r\n            lastName: true,\r\n            email: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    return recentLogs.map(log => ({\r\n      id: log.id,\r\n      action: log.action,\r\n      description: log.description || this.formatAuditAction(log.action),\r\n      userName: log.user ? `${log.user.firstName} ${log.user.lastName}` : 'System',\r\n      userEmail: log.user?.email,\r\n      timestamp: log.createdAt,\r\n      metadata: log.metadata\r\n    }));\r\n  }\r\n\r\n  async getSystemAlerts() {\r\n    const alerts: Array<{ id: string; type: string; title: string; message: string; timestamp: string }> = [];\r\n\r\n    // Check for large pending transactions\r\n    const largePendingTransactions = await this.prisma.transaction.findMany({\r\n      where: {\r\n        status: TransactionStatus.PENDING,\r\n        amount: { gte: 1000000 }\r\n      },\r\n      take: 5,\r\n      orderBy: { createdAt: 'desc' },\r\n      include: {\r\n        user: {\r\n          select: {\r\n            firstName: true,\r\n            lastName: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    largePendingTransactions.forEach(tx => {\r\n      alerts.push({\r\n        id: tx.id,\r\n        type: 'error',\r\n        title: 'Large Transaction Pending',\r\n        message: `Transaction of ${tx.amount.toNumber()} from ${tx.user.firstName} ${tx.user.lastName} requires review.`,\r\n        timestamp: tx.createdAt.toISOString()\r\n      });\r\n    });\r\n\r\n    // Check for old pending KYC\r\n    const twoDaysAgo = new Date();\r\n    twoDaysAgo.setDate(twoDaysAgo.getDate() - 2);\r\n    \r\n    const oldPendingKYCCount = await this.prisma.kYC.count({\r\n      where: {\r\n        status: KYCStatus.PENDING,\r\n        createdAt: { lt: twoDaysAgo }\r\n      }\r\n    });\r\n\r\n    if (oldPendingKYCCount > 0) {\r\n      alerts.push({\r\n        id: 'kyc-old-pending',\r\n        type: 'warning',\r\n        title: 'KYC Documents Pending',\r\n        message: `${oldPendingKYCCount} KYC documents are awaiting review for more than 48 hours.`,\r\n        timestamp: new Date().toISOString()\r\n      });\r\n    }\r\n\r\n    // Check for suspended accounts\r\n    const suspendedCount = await this.prisma.user.count({\r\n      where: { \r\n        accountStatus: AccountStatus.SUSPENDED,\r\n        role: 'USER'\r\n      }\r\n    });\r\n\r\n    if (suspendedCount > 0) {\r\n      alerts.push({\r\n        id: 'suspended-accounts',\r\n        type: 'warning',\r\n        title: 'Suspended Accounts',\r\n        message: `${suspendedCount} user accounts are currently suspended.`,\r\n        timestamp: new Date().toISOString()\r\n      });\r\n    }\r\n\r\n    return alerts;\r\n  }\r\n\r\n  private formatAuditAction(action: string): string {\r\n    return action\r\n      .split('_')\r\n      .map(word => word.charAt(0) + word.slice(1).toLowerCase())\r\n      .join(' ');\r\n  }\r\n\r\n  // ============================================\r\n  // USER MANAGEMENT METHODS\r\n  // ============================================\r\n\r\n  async createUser(createUserDto: CreateUserDto, adminId: string) {\r\n    // Check if user already exists\r\n    const existingUser = await this.prisma.user.findFirst({\r\n      where: {\r\n        OR: [\r\n          { email: createUserDto.email },\r\n          { phone: createUserDto.phone }\r\n        ]\r\n      }\r\n    });\r\n\r\n    if (existingUser) {\r\n      throw new BadRequestException('User with this email or phone already exists');\r\n    }\r\n\r\n    // Hash password\r\n    const hashedPassword = await bcrypt.hash(createUserDto.password, 10);\r\n\r\n    // Generate account number (10 digits)\r\n    const accountNumber = this.generateAccountNumber();\r\n\r\n    // Create user with wallet, KYC, and transfer codes in a transaction\r\n    const user = await this.prisma.$transaction(async (tx) => {\r\n      // Create user\r\n      const newUser = await tx.user.create({\r\n        data: {\r\n          firstName: createUserDto.firstName,\r\n          lastName: createUserDto.lastName,\r\n          username: createUserDto.username,\r\n          email: createUserDto.email,\r\n          phone: createUserDto.phone,\r\n          password: hashedPassword,\r\n          country: createUserDto.country || 'NG',\r\n          currency: createUserDto.currency || 'NGN',\r\n          accountType: createUserDto.accountType || 'savings',\r\n          transactionPin: createUserDto.transactionPin,\r\n          accountStatus: createUserDto.accountStatus || AccountStatus.ACTIVE,\r\n          isEmailVerified: true, // Auto-verified for admin-created accounts\r\n          createdBy: adminId,\r\n        },\r\n      });\r\n\r\n      // Create wallet\r\n      await tx.wallet.create({\r\n        data: {\r\n          userId: newUser.id,\r\n          balance: createUserDto.initialBalance || 0,\r\n          currency: createUserDto.currency || 'NGN',\r\n        },\r\n      });\r\n\r\n      // Create KYC record\r\n      await tx.kYC.create({\r\n        data: {\r\n          userId: newUser.id,\r\n          status: createUserDto.kycStatus || KYCStatus.PENDING,\r\n        },\r\n      });\r\n\r\n      // Create transfer codes (COT, IMF, TAX) - inactive by default\r\n      const transferCodeTypes: TransferCodeType[] = ['COT', 'IMF', 'TAX'];\r\n      for (const type of transferCodeTypes) {\r\n        await tx.transferCode.create({\r\n          data: {\r\n            userId: newUser.id,\r\n            type: type,\r\n            code: this.generateTransferCode(type),\r\n            amount: 0,\r\n            isActive: false,\r\n            isVerified: false,\r\n          },\r\n        });\r\n      }\r\n\r\n      // Create audit log\r\n      await tx.auditLog.create({\r\n        data: {\r\n          userId: adminId,\r\n          actorEmail: 'admin',\r\n          actorRole: 'BANK_ADMIN',\r\n          action: 'USER_CREATED',\r\n          entity: 'User',\r\n          entityId: newUser.id,\r\n          description: `Admin created user account for ${newUser.firstName} ${newUser.lastName}`,\r\n          metadata: {\r\n            accountNumber,\r\n            initialBalance: createUserDto.initialBalance || 0,\r\n          },\r\n        },\r\n      });\r\n\r\n      // If initial balance > 0, create transaction\r\n      if (createUserDto.initialBalance && createUserDto.initialBalance > 0) {\r\n        await tx.transaction.create({\r\n          data: {\r\n            userId: newUser.id,\r\n            type: 'DEPOSIT',\r\n            status: TransactionStatus.COMPLETED,\r\n            amount: createUserDto.initialBalance,\r\n            currency: createUserDto.currency || 'NGN',\r\n            balanceBefore: 0,\r\n            balanceAfter: createUserDto.initialBalance,\r\n            description: 'Initial deposit by admin',\r\n            reference: `INIT-${Date.now()}-${newUser.id.substring(0, 8)}`,\r\n          },\r\n        });\r\n      }\r\n\r\n      return newUser;\r\n    });\r\n\r\n    // Send welcome email\r\n    await this.emailService.sendWelcomeEmail({\r\n      email: user.email,\r\n      firstName: user.firstName,\r\n      lastName: user.lastName,\r\n      accountNumber: accountNumber,\r\n    });\r\n\r\n    return {\r\n      ...user,\r\n      accountNumber,\r\n      message: 'User account created successfully. Welcome email sent.',\r\n    };\r\n  }\r\n\r\n  async updateUser(userId: string, updateUserDto: UpdateUserDto, adminId: string) {\r\n    const user = await this.prisma.user.findUnique({\r\n      where: { id: userId },\r\n    });\r\n\r\n    if (!user) {\r\n      throw new NotFoundException('User not found');\r\n    }\r\n\r\n    // Check for email/phone conflicts\r\n    if (updateUserDto.email || updateUserDto.phone) {\r\n      const conflict = await this.prisma.user.findFirst({\r\n        where: {\r\n          AND: [\r\n            { id: { not: userId } },\r\n            {\r\n              OR: [\r\n                updateUserDto.email ? { email: updateUserDto.email } : {},\r\n                updateUserDto.phone ? { phone: updateUserDto.phone } : {},\r\n              ]\r\n            }\r\n          ]\r\n        }\r\n      });\r\n\r\n      if (conflict) {\r\n        throw new BadRequestException('Email or phone already in use');\r\n      }\r\n    }\r\n\r\n    const updatedUser = await this.prisma.user.update({\r\n      where: { id: userId },\r\n      data: {\r\n        ...updateUserDto,\r\n        updatedBy: adminId,\r\n      },\r\n    });\r\n\r\n    // Create audit log\r\n    await this.prisma.auditLog.create({\r\n      data: {\r\n        userId: adminId,\r\n        actorEmail: 'admin',\r\n        actorRole: 'BANK_ADMIN',\r\n        action: 'USER_UPDATED',\r\n        entity: 'User',\r\n        entityId: userId,\r\n        description: `Admin updated user account for ${user.firstName} ${user.lastName}`,\r\n        metadata: updateUserDto as any,\r\n      },\r\n    });\r\n\r\n    return updatedUser;\r\n  }\r\n\r\n  async updateUserBalance(userId: string, updateBalanceDto: UpdateBalanceDto, adminId: string) {\r\n    const user = await this.prisma.user.findUnique({\r\n      where: { id: userId },\r\n      include: { wallet: true },\r\n    });\r\n\r\n    if (!user || !user.wallet) {\r\n      throw new NotFoundException('User or wallet not found');\r\n    }\r\n\r\n    const currentBalance = user.wallet.balance.toNumber();\r\n    const newBalance = currentBalance + updateBalanceDto.amount;\r\n\r\n    if (newBalance < 0) {\r\n      throw new BadRequestException('Insufficient balance for this adjustment');\r\n    }\r\n\r\n    // Update wallet and create transaction\r\n    await this.prisma.$transaction(async (tx) => {\r\n      await tx.wallet.update({\r\n        where: { userId },\r\n        data: { balance: newBalance },\r\n      });\r\n\r\n      await tx.transaction.create({\r\n        data: {\r\n          userId,\r\n          type: updateBalanceDto.amount > 0 ? 'DEPOSIT' : 'WITHDRAWAL',\r\n          status: TransactionStatus.COMPLETED,\r\n          amount: Math.abs(updateBalanceDto.amount),\r\n          currency: user.wallet!.currency,\r\n          balanceBefore: currentBalance,\r\n          balanceAfter: newBalance,\r\n          description: updateBalanceDto.reason || (updateBalanceDto.amount > 0 ? 'Account Credited' : 'Account Debited'),\r\n          reference: `ADJ-${Date.now()}-${userId.substring(0, 8)}`,\r\n          metadata: {\r\n            adminId,\r\n            adjustmentType: updateBalanceDto.amount > 0 ? 'CREDIT' : 'DEBIT',\r\n          },\r\n        },\r\n      });\r\n\r\n      await tx.auditLog.create({\r\n        data: {\r\n          userId: adminId,\r\n          actorEmail: 'admin',\r\n          actorRole: 'BANK_ADMIN',\r\n          action: 'BALANCE_ADJUSTED',\r\n          entity: 'Wallet',\r\n          entityId: user.wallet!.id,\r\n          description: `Admin adjusted balance for ${user.firstName} ${user.lastName}`,\r\n          metadata: {\r\n            amount: updateBalanceDto.amount,\r\n            reason: updateBalanceDto.reason,\r\n            previousBalance: currentBalance,\r\n            newBalance,\r\n          },\r\n        },\r\n      });\r\n    });\r\n\r\n    return {\r\n      success: true,\r\n      previousBalance: currentBalance,\r\n      newBalance,\r\n      adjustment: updateBalanceDto.amount,\r\n    };\r\n  }\r\n\r\n  async updateKycStatus(userId: string, updateKycDto: UpdateKycStatusDto, adminId: string) {\r\n    const user = await this.prisma.user.findUnique({\r\n      where: { id: userId },\r\n      include: { kyc: true },\r\n    });\r\n\r\n    if (!user) {\r\n      throw new NotFoundException('User not found');\r\n    }\r\n\r\n    if (!user.kyc) {\r\n      throw new NotFoundException('KYC record not found');\r\n    }\r\n\r\n    const updatedKyc = await this.prisma.kYC.update({\r\n      where: { userId },\r\n      data: {\r\n        status: updateKycDto.status,\r\n        reviewedBy: adminId,\r\n        reviewedAt: new Date(),\r\n        rejectionReason: updateKycDto.reason || null,\r\n      },\r\n    });\r\n\r\n    // Create audit log\r\n    const action = updateKycDto.status === KYCStatus.APPROVED ? 'KYC_APPROVED' : 'KYC_REJECTED';\r\n    await this.prisma.auditLog.create({\r\n      data: {\r\n        userId: adminId,\r\n        actorEmail: 'admin',\r\n        actorRole: 'BANK_ADMIN',\r\n        action: action,\r\n        entity: 'KYC',\r\n        entityId: user.kyc.id,\r\n        description: `Admin ${updateKycDto.status.toLowerCase()} KYC for ${user.firstName} ${user.lastName}`,\r\n        metadata: { status: updateKycDto.status, reason: updateKycDto.reason },\r\n      },\r\n    });\r\n\r\n    // Send email notification\r\n    await this.emailService.sendKycStatusEmail({\r\n      email: user.email,\r\n      firstName: user.firstName,\r\n      status: updateKycDto.status,\r\n      reason: updateKycDto.reason,\r\n    });\r\n\r\n    return updatedKyc;\r\n  }\r\n\r\n  async updateTransferCode(\r\n    userId: string,\r\n    codeType: TransferCodeType,\r\n    updateCodeDto: AdminUpdateTransferCodeDto,\r\n    adminId: string,\r\n  ) {\r\n    const user = await this.prisma.user.findUnique({\r\n      where: { id: userId },\r\n    });\r\n\r\n    if (!user) {\r\n      throw new NotFoundException('User not found');\r\n    }\r\n\r\n    const transferCode = await this.prisma.transferCode.findFirst({\r\n      where: { userId, type: codeType },\r\n    });\r\n\r\n    if (!transferCode) {\r\n      throw new NotFoundException('Transfer code not found');\r\n    }\r\n\r\n    const updated = await this.prisma.transferCode.update({\r\n      where: { id: transferCode.id },\r\n      data: {\r\n        code: updateCodeDto.code,\r\n        amount: updateCodeDto.amount !== undefined ? updateCodeDto.amount : transferCode.amount.toNumber(),\r\n        isActive: updateCodeDto.isActive !== undefined ? updateCodeDto.isActive : transferCode.isActive,\r\n        isVerified: updateCodeDto.isVerified !== undefined ? updateCodeDto.isVerified : transferCode.isVerified,\r\n        description: updateCodeDto.description || transferCode.description,\r\n        activatedBy: updateCodeDto.isActive ? adminId : transferCode.activatedBy,\r\n        activatedAt: updateCodeDto.isActive ? new Date() : transferCode.activatedAt,\r\n        verifiedBy: updateCodeDto.isVerified ? adminId : transferCode.verifiedBy,\r\n        verifiedAt: updateCodeDto.isVerified ? new Date() : transferCode.verifiedAt,\r\n      },\r\n    });\r\n\r\n    // Create audit log\r\n    await this.prisma.auditLog.create({\r\n      data: {\r\n        userId: adminId,\r\n        actorEmail: 'admin',\r\n        actorRole: 'BANK_ADMIN',\r\n        action: 'USER_UPDATED',\r\n        entity: 'TransferCode',\r\n        entityId: transferCode.id,\r\n        description: `Admin updated ${codeType} transfer code for ${user.firstName} ${user.lastName}`,\r\n        metadata: updateCodeDto as any,\r\n      },\r\n    });\r\n\r\n    return updated;\r\n  }\r\n\r\n  async getTransferCodes(userId: string) {\r\n    const codes = await this.prisma.transferCode.findMany({\r\n      where: { userId },\r\n      orderBy: { type: 'asc' },\r\n    });\r\n\r\n    return codes;\r\n  }\r\n\r\n  private generateAccountNumber(): string {\r\n    // Generate a 10-digit account number\r\n    return Math.floor(1000000000 + Math.random() * 9000000000).toString();\r\n  }\r\n\r\n  private generateTransferCode(type: TransferCodeType): string {\r\n    // Generate a unique transfer code\r\n    const prefix = type.substring(0, 3).toUpperCase();\r\n    const random = Math.floor(100000 + Math.random() * 900000);\r\n    return `${prefix}-${random}`;\r\n  }\r\n\r\n  async getSidebarCounts() {\r\n    // Count pending loans\r\n    const pendingLoans = await this.prisma.loanApplication.count({\r\n      where: { status: 'PENDING' }\r\n    }).catch(() => 0);\r\n\r\n    // Count pending card requests\r\n    const pendingCardRequests = await this.prisma.cardRequest.count({\r\n      where: { status: CardRequestStatus.PENDING }\r\n    }).catch(() => 0);\r\n\r\n    // Count pending KYC\r\n    const pendingKyc = await this.prisma.kYC.count({\r\n      where: { status: KYCStatus.PENDING }\r\n    }).catch(() => 0);\r\n\r\n    // Count pending transfer codes (not verified)\r\n    const pendingTransferCodes = await this.prisma.transferCode.count({\r\n      where: { \r\n        isActive: true,\r\n        isVerified: false\r\n      }\r\n    }).catch(() => 0);\r\n\r\n    // Count open support tickets\r\n    const openSupportTickets = await this.prisma.supportTicket.count({\r\n      where: { \r\n        status: { in: ['OPEN', 'IN_PROGRESS'] }\r\n      }\r\n    }).catch(() => 0);\r\n\r\n    return {\r\n      pendingLoans,\r\n      pendingCardRequests,\r\n      pendingKyc,\r\n      pendingTransferCodes,\r\n      openSupportTickets,\r\n    };\r\n  }\r\n}\r\n"],"names":["AdminService","getDashboardStats","totalUsers","prisma","user","count","where","role","activeUsers","accountStatus","AccountStatus","ACTIVE","pendingKYC","kYC","status","KYCStatus","PENDING","startOfMonth","Date","setDate","setHours","totalTransactions","transaction","createdAt","gte","TransactionStatus","COMPLETED","type","not","volumeResult","aggregate","_sum","amount","totalVolume","toNumber","activeCards","card","pendingTransfers","transfer","pendingApprovals","twoDaysAgo","getDate","oldPendingKYC","lt","largePendingTransactions","systemAlerts","getTransactionVolume","today","sevenDaysAgo","transactions","findMany","select","dateMap","Map","i","date","dateStr","toLocaleDateString","month","day","set","volume","forEach","tx","txDate","dayData","get","Array","from","values","map","getTransactionTypeDistribution","totalCompleted","name","value","color","deposits","withdrawals","transfers","others","Math","round","getRecentActivities","recentLogs","auditLog","take","orderBy","include","firstName","lastName","email","log","id","action","description","formatAuditAction","userName","userEmail","timestamp","metadata","getSystemAlerts","alerts","push","title","message","toISOString","oldPendingKYCCount","suspendedCount","SUSPENDED","split","word","charAt","slice","toLowerCase","join","createUser","createUserDto","adminId","existingUser","findFirst","OR","phone","BadRequestException","hashedPassword","bcrypt","hash","password","accountNumber","generateAccountNumber","$transaction","newUser","create","data","username","country","currency","accountType","transactionPin","isEmailVerified","createdBy","wallet","userId","balance","initialBalance","kycStatus","transferCodeTypes","transferCode","code","generateTransferCode","isActive","isVerified","actorEmail","actorRole","entity","entityId","balanceBefore","balanceAfter","reference","now","substring","emailService","sendWelcomeEmail","updateUser","updateUserDto","findUnique","NotFoundException","conflict","AND","updatedUser","update","updatedBy","updateUserBalance","updateBalanceDto","currentBalance","newBalance","abs","reason","adjustmentType","previousBalance","success","adjustment","updateKycStatus","updateKycDto","kyc","updatedKyc","reviewedBy","reviewedAt","rejectionReason","APPROVED","sendKycStatusEmail","updateTransferCode","codeType","updateCodeDto","updated","undefined","activatedBy","activatedAt","verifiedBy","verifiedAt","getTransferCodes","codes","floor","random","toString","prefix","toUpperCase","getSidebarCounts","pendingLoans","loanApplication","catch","pendingCardRequests","cardRequest","CardRequestStatus","pendingKyc","pendingTransferCodes","openSupportTickets","supportTicket","in"],"mappings":"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"}