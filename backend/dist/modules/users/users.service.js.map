{"version":3,"sources":["../../../src/modules/users/users.service.ts"],"sourcesContent":["import { Injectable, NotFoundException, BadRequestException } from '@nestjs/common';\r\nimport { PrismaService } from '../../prisma/prisma.service';\r\nimport { AccountStatus } from '@prisma/client';\r\nimport { Decimal } from '@prisma/client/runtime/library';\r\n\r\n@Injectable()\r\nexport class UsersService {\r\n  constructor(private prisma: PrismaService) {}\r\n\r\n  async findAll(adminRole: string) {\r\n    // SUPER_ADMIN can see all users (including other admins)\r\n    // BANK_ADMIN can only see regular users (role: USER)\r\n    const where = adminRole === 'SUPER_ADMIN' ? {} : { role: 'USER' as const };\r\n\r\n    return this.prisma.user.findMany({\r\n      where,\r\n      select: {\r\n        id: true,\r\n        email: true,\r\n        firstName: true,\r\n        lastName: true,\r\n        username: true,\r\n        phone: true,\r\n        country: true,\r\n        currency: true,\r\n        accountType: true,\r\n        role: true,\r\n        accountStatus: true,\r\n        createdAt: true,\r\n        lastLoginAt: true,\r\n        wallet: {\r\n          select: {\r\n            balance: true,\r\n            currency: true,\r\n            updatedAt: true,\r\n          },\r\n        },\r\n        kyc: {\r\n          select: {\r\n            status: true,\r\n            dateOfBirth: true,\r\n            address: true,\r\n            city: true,\r\n            state: true,\r\n            postalCode: true,\r\n          },\r\n        },\r\n      },\r\n    });\r\n  }\r\n\r\n  async findOne(id: string) {\r\n    const user = await this.prisma.user.findUnique({\r\n      where: { id },\r\n      include: {\r\n        wallet: true,\r\n        kyc: true,\r\n      },\r\n    });\r\n\r\n    if (!user) {\r\n      throw new NotFoundException('User not found');\r\n    }\r\n\r\n    // Remove password from response\r\n    const { password, ...userWithoutPassword } = user;\r\n    return userWithoutPassword;\r\n  }\r\n\r\n  async updateProfile(userId: string, updateData: any) {\r\n    return this.prisma.user.update({\r\n      where: { id: userId },\r\n      data: updateData,\r\n      select: {\r\n        id: true,\r\n        email: true,\r\n        firstName: true,\r\n        lastName: true,\r\n        phone: true,\r\n      },\r\n    });\r\n  }\r\n\r\n  async updateUserStatus(userId: string, status: AccountStatus) {\r\n    const user = await this.prisma.user.findUnique({\r\n      where: { id: userId },\r\n    });\r\n\r\n    if (!user) {\r\n      throw new NotFoundException('User not found');\r\n    }\r\n\r\n    return this.prisma.user.update({\r\n      where: { id: userId },\r\n      data: { accountStatus: status },\r\n      select: {\r\n        id: true,\r\n        email: true,\r\n        firstName: true,\r\n        lastName: true,\r\n        accountStatus: true,\r\n      },\r\n    });\r\n  }\r\n\r\n  async deleteUser(userId: string) {\r\n    const user = await this.prisma.user.findUnique({\r\n      where: { id: userId },\r\n    });\r\n\r\n    if (!user) {\r\n      throw new NotFoundException('User not found');\r\n    }\r\n\r\n    // Delete user and all related data (cascading delete should handle related records)\r\n    await this.prisma.user.delete({\r\n      where: { id: userId },\r\n    });\r\n\r\n    return { message: 'User deleted successfully', userId };\r\n  }\r\n\r\n  async adjustBalance(\r\n    userId: string,\r\n    type: 'credit' | 'debit',\r\n    amount: number,\r\n    reason?: string,\r\n    adminId?: string,\r\n  ) {\r\n    const user = await this.prisma.user.findUnique({\r\n      where: { id: userId },\r\n      include: { wallet: true },\r\n    });\r\n\r\n    if (!user) {\r\n      throw new NotFoundException('User not found');\r\n    }\r\n\r\n    if (!user.wallet) {\r\n      throw new BadRequestException('User wallet not found');\r\n    }\r\n\r\n    const adjustmentAmount = new Decimal(amount);\r\n\r\n    if (type === 'debit' && user.wallet.balance.lessThan(adjustmentAmount)) {\r\n      throw new BadRequestException('Insufficient balance');\r\n    }\r\n\r\n    // Perform balance adjustment in a transaction\r\n    const result = await this.prisma.$transaction(async (tx) => {\r\n      const oldBalance = user.wallet.balance;\r\n      const newBalance =\r\n        type === 'credit'\r\n          ? oldBalance.add(adjustmentAmount)\r\n          : oldBalance.sub(adjustmentAmount);\r\n\r\n      // Update wallet balance\r\n      const updatedWallet = await tx.wallet.update({\r\n        where: { userId },\r\n        data: { balance: newBalance },\r\n      });\r\n\r\n      // Create transaction record\r\n      await tx.transaction.create({\r\n        data: {\r\n          userId,\r\n          type: 'ADJUSTMENT',\r\n          amount: adjustmentAmount,\r\n          currency: user.wallet.currency,\r\n          status: 'COMPLETED',\r\n          balanceBefore: oldBalance,\r\n          balanceAfter: newBalance,\r\n          description: (reason && reason.trim()) || (type === 'credit' ? 'Account Credited' : 'Account Debited'),\r\n          reference: `ADM-${Date.now()}-${Math.random().toString(36).substring(7)}`,\r\n        },\r\n      });\r\n\r\n      return updatedWallet;\r\n    });\r\n\r\n    return {\r\n      message: `Successfully ${type}ed ${amount} to user's account`,\r\n      balance: result.balance.toNumber(),\r\n    };\r\n  }\r\n}\r\n"],"names":["UsersService","findAll","adminRole","where","role","prisma","user","findMany","select","id","email","firstName","lastName","username","phone","country","currency","accountType","accountStatus","createdAt","lastLoginAt","wallet","balance","updatedAt","kyc","status","dateOfBirth","address","city","state","postalCode","findOne","findUnique","include","NotFoundException","password","userWithoutPassword","updateProfile","userId","updateData","update","data","updateUserStatus","deleteUser","delete","message","adjustBalance","type","amount","reason","adminId","BadRequestException","adjustmentAmount","Decimal","lessThan","result","$transaction","tx","oldBalance","newBalance","add","sub","updatedWallet","transaction","create","balanceBefore","balanceAfter","description","trim","reference","Date","now","Math","random","toString","substring","toNumber"],"mappings":"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"}