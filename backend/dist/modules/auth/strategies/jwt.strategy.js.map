{"version":3,"sources":["../../../../src/modules/auth/strategies/jwt.strategy.ts"],"sourcesContent":["import { Injectable, UnauthorizedException } from '@nestjs/common';\r\nimport { PassportStrategy } from '@nestjs/passport';\r\nimport { ExtractJwt, Strategy } from 'passport-jwt';\r\nimport { ConfigService } from '@nestjs/config';\r\nimport { PrismaService } from '../../../prisma/prisma.service';\r\n\r\nexport interface JwtPayload {\r\n  sub: string;\r\n  email: string;\r\n  role: string;\r\n}\r\n\r\n@Injectable()\r\nexport class JwtStrategy extends PassportStrategy(Strategy) {\r\n  constructor(\r\n    private configService: ConfigService,\r\n    private prisma: PrismaService,\r\n  ) {\r\n    super({\r\n      jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),\r\n      ignoreExpiration: false,\r\n      secretOrKey: configService.get<string>('JWT_SECRET') || 'default-secret',\r\n    });\r\n  }\r\n\r\n  async validate(payload: JwtPayload) {\r\n    const user = await this.prisma.user.findUnique({\r\n      where: { id: payload.sub },\r\n      select: {\r\n        id: true,\r\n        email: true,\r\n        firstName: true,\r\n        lastName: true,\r\n        role: true,\r\n        accountStatus: true,\r\n        isEmailVerified: true,\r\n      },\r\n    });\r\n\r\n    if (!user) {\r\n      throw new UnauthorizedException('User not found');\r\n    }\r\n\r\n    // Allow PENDING, ACTIVE, and SUSPENDED accounts\r\n    // SUSPENDED users can login but will have restricted access in the frontend\r\n    // Only block FROZEN and CLOSED accounts from logging in\r\n    if (user.accountStatus === 'FROZEN' || user.accountStatus === 'CLOSED') {\r\n      throw new UnauthorizedException(`Account is ${user.accountStatus.toLowerCase()}. Please contact support.`);\r\n    }\r\n\r\n    return user;\r\n  }\r\n}\r\n"],"names":["JwtStrategy","PassportStrategy","Strategy","validate","payload","user","prisma","findUnique","where","id","sub","select","email","firstName","lastName","role","accountStatus","isEmailVerified","UnauthorizedException","toLowerCase","configService","jwtFromRequest","ExtractJwt","fromAuthHeaderAsBearerToken","ignoreExpiration","secretOrKey","get"],"mappings":";;;;+BAaaA;;;eAAAA;;;wBAbqC;0BACjB;6BACI;wBACP;+BACA;;;;;;;;;;AASvB,IAAA,AAAMA,cAAN,MAAMA,oBAAoBC,IAAAA,0BAAgB,EAACC,qBAAQ;IAYxD,MAAMC,SAASC,OAAmB,EAAE;QAClC,MAAMC,OAAO,MAAM,IAAI,CAACC,MAAM,CAACD,IAAI,CAACE,UAAU,CAAC;YAC7CC,OAAO;gBAAEC,IAAIL,QAAQM,GAAG;YAAC;YACzBC,QAAQ;gBACNF,IAAI;gBACJG,OAAO;gBACPC,WAAW;gBACXC,UAAU;gBACVC,MAAM;gBACNC,eAAe;gBACfC,iBAAiB;YACnB;QACF;QAEA,IAAI,CAACZ,MAAM;YACT,MAAM,IAAIa,6BAAqB,CAAC;QAClC;QAEA,gDAAgD;QAChD,4EAA4E;QAC5E,wDAAwD;QACxD,IAAIb,KAAKW,aAAa,KAAK,YAAYX,KAAKW,aAAa,KAAK,UAAU;YACtE,MAAM,IAAIE,6BAAqB,CAAC,CAAC,WAAW,EAAEb,KAAKW,aAAa,CAACG,WAAW,GAAG,yBAAyB,CAAC;QAC3G;QAEA,OAAOd;IACT;IArCA,YACE,AAAQe,aAA4B,EACpC,AAAQd,MAAqB,CAC7B;QACA,KAAK,CAAC;YACJe,gBAAgBC,uBAAU,CAACC,2BAA2B;YACtDC,kBAAkB;YAClBC,aAAaL,cAAcM,GAAG,CAAS,iBAAiB;QAC1D,SAPQN,gBAAAA,oBACAd,SAAAA;IAOV;AA6BF"}