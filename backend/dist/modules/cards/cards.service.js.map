{"version":3,"sources":["../../../src/modules/cards/cards.service.ts"],"sourcesContent":["import { Injectable, NotFoundException, BadRequestException } from '@nestjs/common';\r\nimport { PrismaService } from '../../prisma/prisma.service';\r\nimport { Decimal } from '@prisma/client/runtime/library';\r\nimport * as crypto from 'crypto';\r\n\r\n@Injectable()\r\nexport class CardsService {\r\n  constructor(private prisma: PrismaService) {}\r\n\r\n  async getUserCards(userId: string) {\r\n    const cards = await this.prisma.card.findMany({\r\n      where: { userId },\r\n      orderBy: { createdAt: 'desc' },\r\n    });\r\n\r\n    if (cards.length === 0) return cards;\r\n\r\n    const cardIds = cards.map((c) => c.id);\r\n\r\n    // Sum completed topups per card\r\n    const topups = await this.prisma.transaction.groupBy({\r\n      by: ['cardId'],\r\n      where: {\r\n        cardId: { in: cardIds },\r\n        type: 'CARD_TOPUP',\r\n        status: 'COMPLETED',\r\n      } as any,\r\n      _sum: { amount: true },\r\n    });\r\n\r\n    // Sum completed withdrawals (back to wallet) per card\r\n    const withdrawals = await this.prisma.transaction.groupBy({\r\n      by: ['cardId'],\r\n      where: {\r\n        cardId: { in: cardIds },\r\n        type: 'WITHDRAWAL',\r\n        status: 'COMPLETED',\r\n      } as any,\r\n      _sum: { amount: true },\r\n    });\r\n\r\n    const topupMap = new Map<string, Decimal>();\r\n    for (const row of topups as any[]) {\r\n      topupMap.set(row.cardId, new Decimal(row._sum?.amount || 0));\r\n    }\r\n\r\n    const withdrawMap = new Map<string, Decimal>();\r\n    for (const row of withdrawals as any[]) {\r\n      withdrawMap.set(row.cardId, new Decimal(row._sum?.amount || 0));\r\n    }\r\n\r\n    return cards.map((c) => {\r\n      const t = topupMap.get(c.id) || new Decimal(0);\r\n      const w = withdrawMap.get(c.id) || new Decimal(0);\r\n      const available = t.sub(w);\r\n      return {\r\n        ...c,\r\n        availableBalance: Number(available),\r\n      } as any;\r\n    });\r\n  }\r\n\r\n  async getUserCardRequests(userId: string) {\r\n    return this.prisma.cardRequest.findMany({\r\n      where: { userId },\r\n      orderBy: { createdAt: 'desc' },\r\n      include: {\r\n        card: true,\r\n      },\r\n    });\r\n  }\r\n\r\n  async getCardById(id: string, userId: string) {\r\n    return this.prisma.card.findFirst({\r\n      where: { id, userId },\r\n    });\r\n  }\r\n\r\n  // Create card request (requires admin approval)\r\n  async createVirtualCard(userId: string, cardType: 'VIRTUAL' | 'PHYSICAL' = 'VIRTUAL', reason?: string) {\r\n    // Check if user KYC is approved\r\n    const user = await this.prisma.user.findUnique({\r\n      where: { id: userId },\r\n      include: { kyc: true },\r\n    });\r\n\r\n    if (!user) {\r\n      throw new NotFoundException('User not found');\r\n    }\r\n\r\n    if (!user.kyc) {\r\n      throw new BadRequestException('Please complete your KYC verification before requesting a card');\r\n    }\r\n\r\n    if (user.kyc.status !== 'APPROVED') {\r\n      throw new BadRequestException(\r\n        `Your KYC verification is ${user.kyc.status}. Please wait for KYC approval before requesting a card`,\r\n      );\r\n    }\r\n\r\n    // Check if user has pending request\r\n    const pendingRequest = await this.prisma.cardRequest.findFirst({\r\n      where: {\r\n        userId,\r\n        status: 'PENDING',\r\n      },\r\n    });\r\n\r\n    if (pendingRequest) {\r\n      throw new BadRequestException('You already have a pending card request');\r\n    }\r\n\r\n    const cardRequest = await this.prisma.cardRequest.create({\r\n      data: {\r\n        userId,\r\n        cardType,\r\n        reason,\r\n        status: 'PENDING',\r\n      },\r\n    });\r\n\r\n    // Create audit log\r\n    const auditUser = await this.prisma.user.findUnique({ where: { id: userId } });\r\n    if (!auditUser) {\r\n      throw new NotFoundException('Audit user not found');\r\n    }\r\n    await this.prisma.auditLog.create({\r\n      data: {\r\n        userId,\r\n        actorEmail: auditUser.email,\r\n        actorRole: auditUser.role,\r\n        action: 'CARD_REQUEST_CREATED',\r\n        entity: 'CardRequest',\r\n        entityId: cardRequest.id,\r\n        description: `User requested a ${cardType} card`,\r\n      },\r\n    });\r\n\r\n    return {\r\n      message: 'Card request submitted successfully. Awaiting admin approval.',\r\n      requestId: cardRequest.id,\r\n      status: 'PENDING',\r\n    };\r\n  }\r\n\r\n  // Admin: Get all card requests\r\n  async getAllCardRequests(status?: string) {\r\n    return this.prisma.cardRequest.findMany({\r\n      where: status ? { status: status as any } : undefined,\r\n      orderBy: { createdAt: 'desc' },\r\n      include: {\r\n        user: {\r\n          select: {\r\n            id: true,\r\n            email: true,\r\n            firstName: true,\r\n            lastName: true,\r\n            country: true,\r\n            accountStatus: true,\r\n          },\r\n        },\r\n        card: true,\r\n      },\r\n    });\r\n  }\r\n\r\n  // Admin: Approve card request\r\n  async approveCardRequest(requestId: string, adminId: string) {\r\n    const request = await this.prisma.cardRequest.findUnique({\r\n      where: { id: requestId },\r\n      include: { user: true },\r\n    });\r\n\r\n    if (!request) {\r\n      throw new NotFoundException('Card request not found');\r\n    }\r\n\r\n    if (request.status !== 'PENDING') {\r\n      throw new BadRequestException('Card request already processed');\r\n    }\r\n\r\n    // Determine preferred brand from request.reason if provided\r\n    const cardBrands = ['VISA', 'MASTERCARD', 'AMERICAN_EXPRESS', 'DISCOVER'];\r\n    let selectedBrand: any = null;\r\n    const reason = (request as any).reason || '';\r\n    const match = /(?:PREF_BRAND|BRAND)\\s*[:=]\\s*(VISA|MASTERCARD)/i.exec(reason);\r\n    if (match) selectedBrand = match[1].toUpperCase();\r\n    if (!selectedBrand) selectedBrand = cardBrands[Math.floor(Math.random() * cardBrands.length)];\r\n    \r\n    const card = await this.prisma.card.create({\r\n      data: {\r\n        userId: request.userId,\r\n        cardType: request.cardType,\r\n        cardBrand: selectedBrand as any,\r\n        status: 'ACTIVE',\r\n        cardNumber: `**** **** **** ${Math.floor(1000 + Math.random() * 9000)}`,\r\n        cardHolderName: `${request.user.firstName} ${request.user.lastName}`.toUpperCase(),\r\n        expiryMonth: new Date().getMonth() + 1,\r\n        expiryYear: new Date().getFullYear() + 3,\r\n        cvv: Math.floor(100 + Math.random() * 900).toString(),\r\n        provider: 'MOCK',\r\n        providerCardId: `mock_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\r\n      },\r\n    });\r\n\r\n    // Update request\r\n    await this.prisma.cardRequest.update({\r\n      where: { id: requestId },\r\n      data: {\r\n        status: 'APPROVED',\r\n        reviewedBy: adminId,\r\n        reviewedAt: new Date(),\r\n        cardId: card.id,\r\n      },\r\n    });\r\n\r\n    // Create audit log\r\n    const admin = await this.prisma.user.findUnique({ where: { id: adminId } });\r\n    if (!admin) {\r\n      throw new NotFoundException('Admin user not found');\r\n    }\r\n    await this.prisma.auditLog.create({\r\n      data: {\r\n        userId: adminId,\r\n        actorEmail: admin.email,\r\n        actorRole: admin.role,\r\n        action: 'CARD_REQUEST_APPROVED',\r\n        entity: 'CardRequest',\r\n        entityId: requestId,\r\n        description: `Admin approved card request for ${request.user.email}`,\r\n        metadata: { cardId: card.id },\r\n      },\r\n    });\r\n\r\n    // Create notification for user\r\n    await this.prisma.notification.create({\r\n      data: {\r\n        userId: request.userId,\r\n        title: 'Card Request Approved',\r\n        message: `Your ${request.cardType} card request has been approved and your card is now active!`,\r\n        type: 'SUCCESS',\r\n      },\r\n    });\r\n\r\n    return {\r\n      message: 'Card request approved and card created successfully',\r\n      card,\r\n    };\r\n  }\r\n\r\n  // Admin: Reject card request\r\n  async rejectCardRequest(requestId: string, adminId: string, rejectionReason: string) {\r\n    const request = await this.prisma.cardRequest.findUnique({\r\n      where: { id: requestId },\r\n      include: { user: true },\r\n    });\r\n\r\n    if (!request) {\r\n      throw new NotFoundException('Card request not found');\r\n    }\r\n\r\n    if (request.status !== 'PENDING') {\r\n      throw new BadRequestException('Card request already processed');\r\n    }\r\n\r\n    await this.prisma.cardRequest.update({\r\n      where: { id: requestId },\r\n      data: {\r\n        status: 'REJECTED',\r\n        reviewedBy: adminId,\r\n        reviewedAt: new Date(),\r\n        rejectionReason,\r\n      },\r\n    });\r\n\r\n    // Create audit log\r\n    const admin = await this.prisma.user.findUnique({ where: { id: adminId } });\r\n    if (!admin) {\r\n      throw new NotFoundException('Admin user not found');\r\n    }\r\n    await this.prisma.auditLog.create({\r\n      data: {\r\n        userId: adminId,\r\n        actorEmail: admin.email,\r\n        actorRole: admin.role,\r\n        action: 'CARD_REQUEST_REJECTED',\r\n        entity: 'CardRequest',\r\n        entityId: requestId,\r\n        description: `Admin rejected card request for ${request.user.email}`,\r\n        metadata: { reason: rejectionReason },\r\n      },\r\n    });\r\n\r\n    // Create notification for user\r\n    await this.prisma.notification.create({\r\n      data: {\r\n        userId: request.userId,\r\n        title: 'Card Request Rejected',\r\n        message: `Your card request has been rejected. Reason: ${rejectionReason}`,\r\n        type: 'ERROR',\r\n      },\r\n    });\r\n\r\n    return {\r\n      message: 'Card request rejected successfully',\r\n    };\r\n  }\r\n\r\n  async getAllCards() {\r\n    const cards = await this.prisma.card.findMany({\r\n      include: {\r\n        user: {\r\n          select: {\r\n            id: true,\r\n            firstName: true,\r\n            lastName: true,\r\n            email: true,\r\n          },\r\n        },\r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n    });\r\n\r\n    return cards.map(card => ({\r\n      id: card.id,\r\n      userId: card.userId,\r\n      userName: `${card.user.firstName} ${card.user.lastName}`,\r\n      userEmail: card.user.email,\r\n      cardNumber: `****-****-****-${card.cardNumber}`,\r\n      cardType: card.cardType,\r\n      cardBrand: card.cardBrand,\r\n      status: card.status,\r\n      expiryDate: `${card.expiryMonth.toString().padStart(2, '0')}/${card.expiryYear.toString().slice(-2)}`,\r\n      cardholderName: card.cardHolderName,\r\n      createdAt: card.createdAt,\r\n      lastUsed: card.updatedAt,\r\n      provider: card.provider,\r\n    }));\r\n  }\r\n\r\n  async blockCard(cardId: string, adminId: string) {\r\n    const card = await this.prisma.card.findUnique({\r\n      where: { id: cardId },\r\n      include: { user: true },\r\n    });\r\n\r\n    if (!card) {\r\n      throw new NotFoundException('Card not found');\r\n    }\r\n\r\n    if (card.status === 'BLOCKED') {\r\n      throw new BadRequestException('Card is already blocked');\r\n    }\r\n\r\n    await this.prisma.card.update({\r\n      where: { id: cardId },\r\n      data: {\r\n        status: 'BLOCKED',\r\n        blockedAt: new Date(),\r\n      },\r\n    });\r\n\r\n    // Create audit log\r\n    const admin = await this.prisma.user.findUnique({ where: { id: adminId } });\r\n    await this.prisma.auditLog.create({\r\n      data: {\r\n        userId: adminId,\r\n        actorEmail: admin?.email || 'admin',\r\n        actorRole: admin?.role || 'BANK_ADMIN',\r\n        action: 'CARD_BLOCKED',\r\n        entity: 'Card',\r\n        entityId: cardId,\r\n        description: `Admin blocked card for ${card.user.email}`,\r\n      },\r\n    });\r\n\r\n    // Notify user\r\n    await this.prisma.notification.create({\r\n      data: {\r\n        userId: card.userId,\r\n        title: 'Card Blocked',\r\n        message: 'Your card has been blocked by administrator.',\r\n        type: 'WARNING',\r\n      },\r\n    });\r\n\r\n    return { message: 'Card blocked successfully' };\r\n  }\r\n\r\n  async unblockCard(cardId: string, adminId: string) {\r\n    const card = await this.prisma.card.findUnique({\r\n      where: { id: cardId },\r\n      include: { user: true },\r\n    });\r\n\r\n    if (!card) {\r\n      throw new NotFoundException('Card not found');\r\n    }\r\n\r\n    if (card.status !== 'BLOCKED') {\r\n      throw new BadRequestException('Card is not blocked');\r\n    }\r\n\r\n    await this.prisma.card.update({\r\n      where: { id: cardId },\r\n      data: {\r\n        status: 'ACTIVE',\r\n        blockedAt: null,\r\n      },\r\n    });\r\n\r\n    // Create audit log\r\n    const admin = await this.prisma.user.findUnique({ where: { id: adminId } });\r\n    await this.prisma.auditLog.create({\r\n      data: {\r\n        userId: adminId,\r\n        actorEmail: admin?.email || 'admin',\r\n        actorRole: admin?.role || 'BANK_ADMIN',\r\n        action: 'CARD_BLOCKED',\r\n        entity: 'Card',\r\n        entityId: cardId,\r\n        description: `Admin unblocked card for ${card.user.email}`,\r\n      },\r\n    });\r\n\r\n    // Notify user\r\n    await this.prisma.notification.create({\r\n      data: {\r\n        userId: card.userId,\r\n        title: 'Card Unblocked',\r\n        message: 'Your card has been unblocked and is now active.',\r\n        type: 'SUCCESS',\r\n      },\r\n    });\r\n\r\n    return { message: 'Card unblocked successfully' };\r\n  }\r\n\r\n  // User actions\r\n  async userBlockCard(cardId: string, userId: string) {\r\n    const card = await this.prisma.card.findUnique({ where: { id: cardId } });\r\n    if (!card || card.userId !== userId) {\r\n      throw new NotFoundException('Card not found');\r\n    }\r\n    if (card.status === 'BLOCKED') {\r\n      throw new BadRequestException('Card is already blocked');\r\n    }\r\n    await this.prisma.card.update({\r\n      where: { id: cardId },\r\n      data: { status: 'BLOCKED', blockedAt: new Date() },\r\n    });\r\n    await this.prisma.notification.create({\r\n      data: { userId, title: 'Card Blocked', message: 'You blocked your card.', type: 'WARNING' },\r\n    });\r\n    return { message: 'Card blocked successfully' };\r\n  }\r\n\r\n  async userUnblockCard(cardId: string, userId: string) {\r\n    const card = await this.prisma.card.findUnique({ where: { id: cardId } });\r\n    if (!card || card.userId !== userId) {\r\n      throw new NotFoundException('Card not found');\r\n    }\r\n    if (card.status !== 'BLOCKED') {\r\n      throw new BadRequestException('Card is not blocked');\r\n    }\r\n    await this.prisma.card.update({\r\n      where: { id: cardId },\r\n      data: { status: 'ACTIVE', blockedAt: null },\r\n    });\r\n    await this.prisma.notification.create({\r\n      data: { userId, title: 'Card Unblocked', message: 'You unblocked your card.', type: 'SUCCESS' },\r\n    });\r\n    return { message: 'Card unblocked successfully' };\r\n  }\r\n\r\n  async deleteCard(cardId: string, adminId: string) {\r\n    const card = await this.prisma.card.findUnique({\r\n      where: { id: cardId },\r\n      include: { user: true },\r\n    });\r\n\r\n    if (!card) {\r\n      throw new NotFoundException('Card not found');\r\n    }\r\n\r\n    // Delete the card\r\n    await this.prisma.card.delete({\r\n      where: { id: cardId },\r\n    });\r\n\r\n    // Create audit log\r\n    // const admin = await this.prisma.user.findUnique({ where: { id: adminId } });\r\n    // await this.prisma.auditLog.create({\r\n    //   data: {\r\n    //     userId: adminId,\r\n    //     actorEmail: admin?.email || 'admin',\r\n    //     actorRole: admin?.role || 'BANK_ADMIN',\r\n    //     action: 'DELETE',\r\n    //     entity: 'Card',\r\n    //     entityId: cardId,\r\n    //     description: `Admin deleted card for ${card.user.email}`,\r\n    //   },\r\n    // });\r\n\r\n    // Notify user\r\n    await this.prisma.notification.create({\r\n      data: {\r\n        userId: card.userId,\r\n        title: 'Card Deleted',\r\n        message: 'Your card has been deleted by an administrator.',\r\n        type: 'INFO',\r\n      },\r\n    });\r\n\r\n    return { message: 'Card deleted successfully' };\r\n  }\r\n\r\n  // User: fund card from wallet\r\n  async userFundCard(cardId: string, userId: string, amountNum: number) {\r\n    if (!amountNum || amountNum <= 0) {\r\n      throw new BadRequestException('Invalid amount');\r\n    }\r\n\r\n    const [card, wallet] = await Promise.all([\r\n      this.prisma.card.findUnique({ where: { id: cardId } }),\r\n      this.prisma.wallet.findUnique({ where: { userId } }),\r\n    ]);\r\n\r\n    if (!card || card.userId !== userId) {\r\n      throw new NotFoundException('Card not found');\r\n    }\r\n    if (!wallet) {\r\n      throw new BadRequestException('Wallet not found');\r\n    }\r\n\r\n    const amount = new Decimal(amountNum);\r\n    if (wallet.balance.lessThan(amount)) {\r\n      throw new BadRequestException('Insufficient wallet balance');\r\n    }\r\n\r\n    const result = await this.prisma.$transaction(async (tx) => {\r\n      const walletBefore = wallet.balance;\r\n      const walletAfter = walletBefore.sub(amount);\r\n      await tx.wallet.update({ where: { userId }, data: { balance: walletAfter } });\r\n\r\n      const txRec = await tx.transaction.create({\r\n        data: {\r\n          userId,\r\n          type: 'CARD_TOPUP',\r\n          status: 'COMPLETED',\r\n          amount,\r\n          currency: wallet.currency,\r\n          balanceBefore: walletBefore,\r\n          balanceAfter: walletAfter,\r\n          description: `Top-up ${card.cardBrand} ${card.cardType} card`,\r\n          reference: `CARDTOPUP-${Date.now()}-${cardId.substring(0,8)}`,\r\n          cardId: card.id,\r\n        },\r\n      });\r\n\r\n      return { walletAfter, txId: txRec.id };\r\n    });\r\n\r\n    await this.prisma.notification.create({\r\n      data: { userId, title: 'Card Funded', message: `You funded your card with ${amountNum} ${wallet.currency}.`, type: 'SUCCESS' },\r\n    });\r\n\r\n    return { message: 'Card funded successfully', transactionId: result.txId };\r\n  }\r\n\r\n  // User: withdraw from card back to wallet\r\n  async userWithdrawFromCard(cardId: string, userId: string, amountNum: number) {\r\n    if (!amountNum || amountNum <= 0) {\r\n      throw new BadRequestException('Invalid amount');\r\n    }\r\n\r\n    const [card, wallet] = await Promise.all([\r\n      this.prisma.card.findUnique({ where: { id: cardId } }),\r\n      this.prisma.wallet.findUnique({ where: { userId } }),\r\n    ]);\r\n\r\n    if (!card || card.userId !== userId) {\r\n      throw new NotFoundException('Card not found');\r\n    }\r\n    if (!wallet) {\r\n      throw new BadRequestException('Wallet not found');\r\n    }\r\n\r\n    const amount = new Decimal(amountNum);\r\n\r\n    // Compute current available card balance for this card (topups - withdrawals)\r\n    const [topupAgg, withdrawAgg] = await Promise.all([\r\n      this.prisma.transaction.aggregate({\r\n        _sum: { amount: true },\r\n        where: { cardId: card.id, type: 'CARD_TOPUP', status: 'COMPLETED' as any },\r\n      }),\r\n      this.prisma.transaction.aggregate({\r\n        _sum: { amount: true },\r\n        where: { cardId: card.id, type: 'WITHDRAWAL', status: 'COMPLETED' as any },\r\n      }),\r\n    ]);\r\n    const current = new Decimal(topupAgg._sum.amount || 0).sub(new Decimal(withdrawAgg._sum.amount || 0));\r\n    if (current.lt(amount)) {\r\n      throw new BadRequestException('Insufficient card balance');\r\n    }\r\n\r\n    const result = await this.prisma.$transaction(async (tx) => {\r\n      const walletBefore = wallet.balance;\r\n      const walletAfter = walletBefore.add(amount);\r\n      await tx.wallet.update({ where: { userId }, data: { balance: walletAfter } });\r\n\r\n      const txRec = await tx.transaction.create({\r\n        data: {\r\n          userId,\r\n          type: 'WITHDRAWAL',\r\n          status: 'COMPLETED',\r\n          amount,\r\n          currency: wallet.currency,\r\n          balanceBefore: walletBefore,\r\n          balanceAfter: walletAfter,\r\n          description: `Withdrawal from ${card.cardBrand} ${card.cardType} card to wallet`,\r\n          reference: `CARDWDR-${Date.now()}-${cardId.substring(0,8)}`,\r\n          cardId: card.id,\r\n        },\r\n      });\r\n\r\n      return { walletAfter, txId: txRec.id };\r\n    });\r\n\r\n    await this.prisma.notification.create({\r\n      data: { userId, title: 'Card Withdrawal', message: `You withdrew ${amountNum} ${wallet.currency} from your card to wallet.`, type: 'SUCCESS' },\r\n    });\r\n\r\n    return { message: 'Withdrawal successful', transactionId: result.txId };\r\n  }\r\n\r\n  // Deterministic demo PAN generator (do NOT use in production)\r\n  private generatePan(brand: string, seed: string, last4: string): string {\r\n    const prefix = brand === 'MASTERCARD' ? '5' : '4';\r\n    const hash = crypto.createHash('sha256').update(seed).digest('hex');\r\n    const digits: number[] = [];\r\n    for (let i = 0; digits.length < 15; i += 2) {\r\n      digits.push(parseInt(hash.substring(i, i + 2), 16) % 10);\r\n    }\r\n    // Set first and last4\r\n    const pan = new Array(16).fill(0);\r\n    pan[0] = Number(prefix);\r\n    for (let i = 1; i < 12; i++) pan[i] = digits[i] % 10;\r\n    // place last 4\r\n    const l4 = (last4 || '0000').padStart(4, '0');\r\n    pan[12] = Number(l4[0]); pan[13] = Number(l4[1]); pan[14] = Number(l4[2]);\r\n    // compute Luhn check for first 15 digits, then set last digit\r\n    const check = (arr: number[]) => {\r\n      let sum = 0;\r\n      for (let i = 0; i < 15; i++) {\r\n        let d = arr[14 - i]; // right to left excluding check\r\n        if (i % 2 === 0) { d *= 2; if (d > 9) d -= 9; }\r\n        sum += d;\r\n      }\r\n      return (10 - (sum % 10)) % 10;\r\n    };\r\n    pan[15] = check(pan);\r\n    const s = pan.join('').replace(/(.{4})/g, '$1 ').trim();\r\n    return s;\r\n  }\r\n\r\n  async userGetPan(cardId: string, userId: string) {\r\n    const card = await this.prisma.card.findUnique({ where: { id: cardId } });\r\n    if (!card || card.userId !== userId) {\r\n      throw new NotFoundException('Card not found');\r\n    }\r\n    const last4 = (card.cardNumber || '').slice(-4);\r\n    const pan = this.generatePan(card.cardBrand as any, card.providerCardId || card.id, last4);\r\n    return {\r\n      brand: card.cardBrand,\r\n      pan,\r\n      cvv: card.cvv,\r\n      expiryMonth: card.expiryMonth,\r\n      expiryYear: card.expiryYear,\r\n    };\r\n  }\r\n}\r\n"],"names":["CardsService","getUserCards","userId","cards","prisma","card","findMany","where","orderBy","createdAt","length","cardIds","map","c","id","topups","transaction","groupBy","by","cardId","in","type","status","_sum","amount","withdrawals","topupMap","Map","row","set","Decimal","withdrawMap","t","get","w","available","sub","availableBalance","Number","getUserCardRequests","cardRequest","include","getCardById","findFirst","createVirtualCard","cardType","reason","user","findUnique","kyc","NotFoundException","BadRequestException","pendingRequest","create","data","auditUser","auditLog","actorEmail","email","actorRole","role","action","entity","entityId","description","message","requestId","getAllCardRequests","undefined","select","firstName","lastName","country","accountStatus","approveCardRequest","adminId","request","cardBrands","selectedBrand","match","exec","toUpperCase","Math","floor","random","cardBrand","cardNumber","cardHolderName","expiryMonth","Date","getMonth","expiryYear","getFullYear","cvv","toString","provider","providerCardId","now","substr","update","reviewedBy","reviewedAt","admin","metadata","notification","title","rejectCardRequest","rejectionReason","getAllCards","userName","userEmail","expiryDate","padStart","slice","cardholderName","lastUsed","updatedAt","blockCard","blockedAt","unblockCard","userBlockCard","userUnblockCard","deleteCard","delete","userFundCard","amountNum","wallet","Promise","all","balance","lessThan","result","$transaction","tx","walletBefore","walletAfter","txRec","currency","balanceBefore","balanceAfter","reference","substring","txId","transactionId","userWithdrawFromCard","topupAgg","withdrawAgg","aggregate","current","lt","add","generatePan","brand","seed","last4","prefix","hash","crypto","createHash","digest","digits","i","push","parseInt","pan","Array","fill","l4","check","arr","sum","d","s","join","replace","trim","userGetPan"],"mappings":"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"}