{"version":3,"sources":["../../../src/modules/deposits/paystack.webhook.ts"],"sourcesContent":["import { Injectable, Logger, BadRequestException } from '@nestjs/common';\nimport * as crypto from 'crypto';\nimport { DepositsService } from './deposits.service';\n\n@Injectable()\nexport class PaystackWebhookService {\n  private readonly logger = new Logger(PaystackWebhookService.name);\n\n  constructor(private depositsService: DepositsService) {}\n\n  /**\n   * Verify Paystack webhook signature\n   */\n  verifyWebhookSignature(payload: string, signature: string): boolean {\n    const secret = process.env.PAYSTACK_SECRET_KEY || '';\n    if (!secret) {\n      this.logger.error('Paystack secret key not configured');\n      return false;\n    }\n\n    const hash = crypto.createHmac('sha512', secret).update(payload).digest('hex');\n    return hash === signature;\n  }\n\n  /**\n   * Handle Paystack webhook events\n   */\n  async handleWebhookEvent(event: any) {\n    const { event: eventType, data } = event;\n\n    try {\n      switch (eventType) {\n        case 'charge.success':\n          await this.handleChargeSuccess(data);\n          break;\n        case 'charge.failed':\n          await this.handleChargeFailed(data);\n          break;\n        default:\n          this.logger.log(`Unhandled Paystack event: ${eventType}`);\n      }\n    } catch (error) {\n      this.logger.error(`Error handling Paystack webhook: ${error.message}`, error);\n      throw new BadRequestException('Webhook processing failed');\n    }\n  }\n\n  /**\n   * Handle successful charge\n   */\n  private async handleChargeSuccess(data: any) {\n    const reference = data.reference;\n    this.logger.log(`Processing successful charge with reference: ${reference}`);\n\n    // Confirm the deposit\n    await this.depositsService.confirmPaystackDeposit(reference);\n  }\n\n  /**\n   * Handle failed charge\n   */\n  private async handleChargeFailed(data: any) {\n    const reference = data.reference;\n    this.logger.log(`Charge failed with reference: ${reference}`);\n    // TODO: Update deposit status to FAILED\n  }\n}\n"],"names":["PaystackWebhookService","verifyWebhookSignature","payload","signature","secret","process","env","PAYSTACK_SECRET_KEY","logger","error","hash","crypto","createHmac","update","digest","handleWebhookEvent","event","eventType","data","handleChargeSuccess","handleChargeFailed","log","message","BadRequestException","reference","depositsService","confirmPaystackDeposit","Logger","name"],"mappings":";;;;+BAKaA;;;eAAAA;;;wBAL2C;gEAChC;iCACQ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAGzB,IAAA,AAAMA,yBAAN,MAAMA;IAKX;;GAEC,GACDC,uBAAuBC,OAAe,EAAEC,SAAiB,EAAW;QAClE,MAAMC,SAASC,QAAQC,GAAG,CAACC,mBAAmB,IAAI;QAClD,IAAI,CAACH,QAAQ;YACX,IAAI,CAACI,MAAM,CAACC,KAAK,CAAC;YAClB,OAAO;QACT;QAEA,MAAMC,OAAOC,QAAOC,UAAU,CAAC,UAAUR,QAAQS,MAAM,CAACX,SAASY,MAAM,CAAC;QACxE,OAAOJ,SAASP;IAClB;IAEA;;GAEC,GACD,MAAMY,mBAAmBC,KAAU,EAAE;QACnC,MAAM,EAAEA,OAAOC,SAAS,EAAEC,IAAI,EAAE,GAAGF;QAEnC,IAAI;YACF,OAAQC;gBACN,KAAK;oBACH,MAAM,IAAI,CAACE,mBAAmB,CAACD;oBAC/B;gBACF,KAAK;oBACH,MAAM,IAAI,CAACE,kBAAkB,CAACF;oBAC9B;gBACF;oBACE,IAAI,CAACV,MAAM,CAACa,GAAG,CAAC,CAAC,0BAA0B,EAAEJ,WAAW;YAC5D;QACF,EAAE,OAAOR,OAAO;YACd,IAAI,CAACD,MAAM,CAACC,KAAK,CAAC,CAAC,iCAAiC,EAAEA,MAAMa,OAAO,EAAE,EAAEb;YACvE,MAAM,IAAIc,2BAAmB,CAAC;QAChC;IACF;IAEA;;GAEC,GACD,MAAcJ,oBAAoBD,IAAS,EAAE;QAC3C,MAAMM,YAAYN,KAAKM,SAAS;QAChC,IAAI,CAAChB,MAAM,CAACa,GAAG,CAAC,CAAC,6CAA6C,EAAEG,WAAW;QAE3E,sBAAsB;QACtB,MAAM,IAAI,CAACC,eAAe,CAACC,sBAAsB,CAACF;IACpD;IAEA;;GAEC,GACD,MAAcJ,mBAAmBF,IAAS,EAAE;QAC1C,MAAMM,YAAYN,KAAKM,SAAS;QAChC,IAAI,CAAChB,MAAM,CAACa,GAAG,CAAC,CAAC,8BAA8B,EAAEG,WAAW;IAC5D,wCAAwC;IAC1C;IAzDA,YAAY,AAAQC,eAAgC,CAAE;aAAlCA,kBAAAA;aAFHjB,SAAS,IAAImB,cAAM,CAAC3B,uBAAuB4B,IAAI;IAET;AA0DzD"}