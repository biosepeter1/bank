{"version":3,"sources":["../../../src/modules/deposits/deposits.service.ts"],"sourcesContent":["import { Injectable, BadRequestException, NotFoundException } from '@nestjs/common';\nimport { PrismaService } from '@/prisma/prisma.service';\nimport { Decimal } from '@prisma/client/runtime/library';\nimport { CreateDepositDto } from './dto/create-deposit.dto';\nimport { EmailService } from '@/common/services/email.service';\n\n@Injectable()\nexport class DepositsService {\n  constructor(\n    private prisma: PrismaService,\n    private email: EmailService,\n  ) {}\n\n  /**\n   * Initiate a deposit\n   */\n  async initiateDeposit(userId: string, data: CreateDepositDto) {\n    const user = await this.prisma.user.findUnique({\n      where: { id: userId },\n      include: { wallet: true },\n    });\n\n    if (!user) {\n      throw new NotFoundException('User not found');\n    }\n\n    const amount = new Decimal(data.amount);\n    const currency = data.currency || user.currency || 'NGN';\n\n    // Create deposit record\n    const deposit = await this.prisma.deposit.create({\n      data: {\n        userId,\n        amount,\n        currency,\n        depositMethod: data.method,\n        paymentProvider: data.method === 'PAYSTACK' ? 'PAYSTACK' : 'MANUAL',\n        status: 'PENDING',\n      },\n    });\n\n    // For manual deposits, create a PENDING transaction so user sees it in history\n    if (deposit.paymentProvider !== 'PAYSTACK') {\n      const tx = await this.prisma.transaction.create({\n        data: {\n          userId,\n          type: 'DEPOSIT',\n          status: 'PENDING',\n          amount,\n          currency,\n          balanceBefore: user!.wallet!.balance,\n          balanceAfter: user!.wallet!.balance,\n          description: `Deposit initiated via ${deposit.depositMethod}`,\n          reference: `DEP-${deposit.id.substring(0, 8)}-P`,\n        },\n      });\n      await this.prisma.deposit.update({\n        where: { id: deposit.id },\n        data: { transactionId: tx.id },\n      });\n    }\n\n    return deposit;\n  }\n\n  /**\n   * Confirm Paystack deposit\n   */\n  async confirmPaystackDeposit(reference: string) {\n    const payment = await this.prisma.payment.findUnique({\n      where: { reference },\n      include: { user: { include: { wallet: true } } },\n    });\n\n    if (!payment) {\n      throw new NotFoundException('Payment not found');\n    }\n\n    if (payment.status !== 'PENDING') {\n      throw new BadRequestException('Payment already processed');\n    }\n\n    // Update payment and wallet in transaction\n    const result = await this.prisma.$transaction(async (tx) => {\n      // Update payment status\n      const updatedPayment = await tx.payment.update({\n        where: { reference },\n        data: {\n          status: 'SUCCESS',\n          completedAt: new Date(),\n        },\n      });\n\n      // Update wallet balance\n      const walletBefore = payment.user.wallet;\n      const walletAfter = walletBefore.balance.add(payment.amount);\n\n      await tx.wallet.update({\n        where: { userId: payment.userId },\n        data: { balance: walletAfter },\n      });\n\n      // Create transaction record\n      await tx.transaction.create({\n        data: {\n          userId: payment.userId,\n          type: 'PAYMENT_GATEWAY_DEPOSIT',\n          status: 'COMPLETED',\n          amount: payment.amount,\n          currency: payment.currency,\n          balanceBefore: walletBefore.balance,\n          balanceAfter: walletAfter,\n          description: `Deposit via ${payment.provider}`,\n          reference: `DEP-${reference}`,\n        },\n      });\n\n      return updatedPayment;\n    });\n\n    // Send email notification if enabled (non-blocking)\n    try {\n      if (payment.user.emailTransactions) {\n        const walletAfter = payment.user.wallet.balance.add(payment.amount);\n        await this.email.sendTransactionEmail({\n          email: payment.user.email,\n          firstName: payment.user.firstName,\n          transactionType: 'DEPOSIT',\n          amount: payment.amount.toString(),\n          currency: payment.currency,\n          balance: walletAfter.toString(),\n          reference: `DEP-${reference}`,\n          description: `Deposit via ${payment.provider}`,\n        });\n      }\n    } catch (error) {\n      console.error('Failed to send deposit email:', error);\n    }\n\n    return result;\n  }\n\n  /**\n   * Get deposit history\n   */\n  async getDepositHistory(userId: string, limit = 50, skip = 0) {\n    return this.prisma.deposit.findMany({\n      where: { userId },\n      orderBy: { createdAt: 'desc' },\n      take: limit,\n      skip,\n    });\n  }\n\n  /**\n   * Get deposit by ID\n   */\n  async getDepositById(userId: string, depositId: string) {\n    const deposit = await this.prisma.deposit.findUnique({\n      where: { id: depositId },\n    });\n\n    if (!deposit || deposit.userId !== userId) {\n      throw new NotFoundException('Deposit not found or unauthorized');\n    }\n\n    return deposit;\n  }\n\n  /**\n   * Upload deposit proof\n   */\n  async uploadDepositProof(userId: string, depositId: string, file: any) {\n    const deposit = await this.prisma.deposit.findUnique({\n      where: { id: depositId },\n    });\n\n    if (!deposit || deposit.userId !== userId) {\n      throw new NotFoundException('Deposit not found or unauthorized');\n    }\n\n    if (deposit.status !== 'PENDING') {\n      throw new BadRequestException('Deposit already processed');\n    }\n\n    // In a real app, upload file to cloud storage (S3, Cloudinary, etc.)\n    const proofUrl = `/uploads/deposits/${file.filename}`;\n\n    return this.prisma.deposit.update({\n      where: { id: depositId },\n      data: {\n        proofUrl,\n        status: 'PROCESSING',\n      },\n    });\n  }\n\n  /**\n   * Admin: Get all deposits\n   */\n  async getAllDeposits() {\n    const deposits = await this.prisma.deposit.findMany({\n      include: {\n        user: {\n          select: {\n            id: true,\n            firstName: true,\n            lastName: true,\n            email: true,\n          },\n        },\n      },\n      orderBy: { createdAt: 'desc' },\n    });\n\n    return deposits.map(deposit => ({\n      id: deposit.id,\n      userId: deposit.userId,\n      userName: `${deposit.user.firstName} ${deposit.user.lastName}`,\n      userEmail: deposit.user.email,\n      amount: deposit.amount.toNumber(),\n      currency: deposit.currency,\n      method: deposit.depositMethod,\n      status: deposit.status,\n      proofUrl: deposit.proofUrl,\n      createdAt: deposit.createdAt,\n      updatedAt: deposit.updatedAt,\n    }));\n  }\n\n  /**\n   * Admin: Approve deposit\n   */\n  async approveDeposit(depositId: string, adminId: string) {\n    const deposit = await this.prisma.deposit.findUnique({\n      where: { id: depositId },\n      include: { user: { include: { wallet: true } } },\n    });\n\n    if (!deposit) {\n      throw new NotFoundException('Deposit not found');\n    }\n\n    if (deposit.status !== 'PENDING' && deposit.status !== 'PROCESSING') {\n      throw new BadRequestException('Deposit already processed');\n    }\n\n    // Compute balances\n    const balanceBefore = deposit.user.wallet?.balance ?? new Decimal(0);\n    const balanceAfter = balanceBefore.add(deposit.amount);\n\n    // Update deposit status\n    const updatedDeposit = await this.prisma.deposit.update({\n      where: { id: depositId },\n      data: { status: 'COMPLETED' },\n    });\n\n    // Credit user wallet\n    await this.prisma.wallet.update({\n      where: { userId: deposit.userId },\n      data: {\n        balance: balanceAfter,\n      },\n    });\n\n    // Update existing pending tx to COMPLETED or create one\n    if (deposit.transactionId) {\n      await this.prisma.transaction.update({\n        where: { id: deposit.transactionId },\n        data: {\n          status: 'COMPLETED',\n          balanceBefore,\n          balanceAfter,\n          description: `Deposit via ${deposit.depositMethod}`,\n          reference: `DEP-${deposit.id.substring(0, 8)}`,\n        },\n      });\n    } else {\n      const tx = await this.prisma.transaction.create({\n        data: {\n          userId: deposit.userId,\n          type: 'DEPOSIT',\n          status: 'COMPLETED',\n          amount: deposit.amount,\n          currency: deposit.currency,\n          balanceBefore,\n          balanceAfter,\n          description: `Deposit via ${deposit.depositMethod}`,\n          reference: `DEP-${deposit.id.substring(0, 8)}`,\n        },\n      });\n      await this.prisma.deposit.update({ where: { id: deposit.id }, data: { transactionId: tx.id } });\n    }\n\n    // Create audit log\n    // await this.prisma.auditLog.create({\n    //   data: {\n    //     userId: adminId,\n    //     action: 'UPDATE',\n    //     entity: 'Deposit',\n    //     entityId: depositId,\n    //     details: `Approved deposit of ${deposit.amount} ${deposit.currency} for user ${deposit.user.email}`,\n    //   },\n    // });\n\n    return updatedDeposit;\n  }\n\n  /**\n   * Admin: Reject deposit\n   */\n  async rejectDeposit(depositId: string, adminId: string, reason?: string) {\n    const deposit = await this.prisma.deposit.findUnique({\n      where: { id: depositId },\n      include: { user: true },\n    });\n\n    if (!deposit) {\n      throw new NotFoundException('Deposit not found');\n    }\n\n    if (deposit.status !== 'PENDING' && deposit.status !== 'PROCESSING') {\n      throw new BadRequestException('Deposit already processed');\n    }\n\n    // Update deposit status\n    const updatedDeposit = await this.prisma.deposit.update({\n      where: { id: depositId },\n      data: {\n        status: 'FAILED',\n        // Store rejection reason in a custom field if needed\n      },\n    });\n\n    // Update any pending transaction to FAILED or create one so it shows in history\n    if (deposit.transactionId) {\n      await this.prisma.transaction.update({\n        where: { id: deposit.transactionId },\n        data: {\n          status: 'FAILED',\n          description: `Deposit rejected${reason ? `: ${reason}` : ''}`,\n          reference: `DEP-${deposit.id.substring(0, 8)}-RJ`,\n        },\n      });\n    } else {\n      await this.prisma.transaction.create({\n        data: {\n          userId: deposit.userId,\n          type: 'DEPOSIT',\n          status: 'FAILED',\n          amount: deposit.amount,\n          currency: deposit.currency,\n          balanceBefore: new Decimal(0), // unknown; will not affect balances\n          balanceAfter: new Decimal(0),\n          description: `Deposit rejected${reason ? `: ${reason}` : ''}`,\n          reference: `DEP-${deposit.id.substring(0, 8)}-RJ`,\n        },\n      });\n    }\n\n    // Create audit log\n    // await this.prisma.auditLog.create({\n    //   data: {\n    //     userId: adminId,\n    //     action: 'UPDATE',\n    //     entity: 'Deposit',\n    //     entityId: depositId,\n    //     details: `Rejected deposit of ${deposit.amount} ${deposit.currency} for user ${deposit.user.email}. Reason: ${reason || 'No reason provided'}`,\n    //   },\n    // });\n\n    return updatedDeposit;\n  }\n\n  /**\n   * Delete deposit (User can delete their own deposit history)\n   */\n  async deleteDeposit(userId: string, depositId: string) {\n    const deposit = await this.prisma.deposit.findUnique({\n      where: { id: depositId },\n    });\n\n    if (!deposit) {\n      throw new NotFoundException('Deposit not found');\n    }\n\n    if (deposit.userId !== userId) {\n      throw new BadRequestException('You can only delete your own deposits');\n    }\n\n    // Only allow deletion of failed or completed deposits\n    if (deposit.status === 'PENDING' || deposit.status === 'PROCESSING') {\n      throw new BadRequestException('Cannot delete pending or processing deposits');\n    }\n\n    await this.prisma.deposit.delete({\n      where: { id: depositId },\n    });\n\n    return { message: 'Deposit deleted successfully' };\n  }\n\n  /**\n   * Admin: Delete deposit (Admins can delete any deposit)\n   */\n  async adminDeleteDeposit(depositId: string, adminId: string) {\n    const deposit = await this.prisma.deposit.findUnique({\n      where: { id: depositId },\n      include: { user: true },\n    });\n\n    if (!deposit) {\n      throw new NotFoundException('Deposit not found');\n    }\n\n    await this.prisma.deposit.delete({\n      where: { id: depositId },\n    });\n\n    // Create audit log\n    // await this.prisma.auditLog.create({\n    //   data: {\n    //     userId: adminId,\n    //     action: 'DELETE',\n    //     entity: 'Deposit',\n    //     entityId: depositId,\n    //     details: `Deleted deposit of ${deposit.amount} ${deposit.currency} for user ${deposit.user.email}`,\n    //   },\n    // });\n\n    return { message: 'Deposit deleted successfully' };\n  }\n}\n"],"names":["DepositsService","initiateDeposit","userId","data","user","prisma","findUnique","where","id","include","wallet","NotFoundException","amount","Decimal","currency","deposit","create","depositMethod","method","paymentProvider","status","tx","transaction","type","balanceBefore","balance","balanceAfter","description","reference","substring","update","transactionId","confirmPaystackDeposit","payment","BadRequestException","result","$transaction","updatedPayment","completedAt","Date","walletBefore","walletAfter","add","provider","emailTransactions","email","sendTransactionEmail","firstName","transactionType","toString","error","console","getDepositHistory","limit","skip","findMany","orderBy","createdAt","take","getDepositById","depositId","uploadDepositProof","file","proofUrl","filename","getAllDeposits","deposits","select","lastName","map","userName","userEmail","toNumber","updatedAt","approveDeposit","adminId","updatedDeposit","rejectDeposit","reason","deleteDeposit","delete","message","adminDeleteDeposit"],"mappings":"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"}