{"version":3,"sources":["../../../src/common/guards/account-status.guard.ts"],"sourcesContent":["import {\r\n  Injectable,\r\n  CanActivate,\r\n  ExecutionContext,\r\n  ForbiddenException,\r\n} from '@nestjs/common';\r\nimport { Reflector } from '@nestjs/core';\r\nimport { PrismaService } from '../../prisma/prisma.service';\r\n\r\n/**\r\n * Guard that checks if user's account status allows them to perform certain actions\r\n * Suspended accounts have very limited access - they can only:\r\n * - View their profile\r\n * - View account status\r\n * - Contact support\r\n * - Update profile (limited)\r\n */\r\n@Injectable()\r\nexport class AccountStatusGuard implements CanActivate {\r\n  constructor(\r\n    private reflector: Reflector,\r\n    private prisma: PrismaService,\r\n  ) {}\r\n\r\n  async canActivate(context: ExecutionContext): Promise<boolean> {\r\n    // Check if this endpoint allows suspended accounts\r\n    const allowSuspended = this.reflector.get<boolean>(\r\n      'allowSuspended',\r\n      context.getHandler(),\r\n    );\r\n\r\n    // If explicitly allowed, skip check\r\n    if (allowSuspended) {\r\n      return true;\r\n    }\r\n\r\n    const request = context.switchToHttp().getRequest();\r\n    const user = request.user;\r\n\r\n    if (!user || !user.id) {\r\n      return true; // Let JWT guard handle authentication\r\n    }\r\n\r\n    // Fetch current user status from database\r\n    const dbUser = await this.prisma.user.findUnique({\r\n      where: { id: user.id },\r\n      select: { accountStatus: true },\r\n    });\r\n\r\n    if (!dbUser) {\r\n      throw new ForbiddenException('User not found');\r\n    }\r\n\r\n    // Block suspended accounts from most actions\r\n    if (dbUser.accountStatus === 'SUSPENDED') {\r\n      throw new ForbiddenException(\r\n        'Your account is suspended. You have limited access. Please contact support or check your account status.',\r\n      );\r\n    }\r\n\r\n    // Block frozen accounts entirely\r\n    if (dbUser.accountStatus === 'FROZEN') {\r\n      throw new ForbiddenException(\r\n        'Your account is frozen. Please contact support immediately.',\r\n      );\r\n    }\r\n\r\n    // Block closed accounts\r\n    if (dbUser.accountStatus === 'CLOSED') {\r\n      throw new ForbiddenException(\r\n        'Your account has been closed. Please contact support if you believe this is an error.',\r\n      );\r\n    }\r\n\r\n    return true;\r\n  }\r\n}\r\n"],"names":["AccountStatusGuard","canActivate","context","allowSuspended","reflector","get","getHandler","request","switchToHttp","getRequest","user","id","dbUser","prisma","findUnique","where","select","accountStatus","ForbiddenException"],"mappings":";;;;+BAkBaA;;;eAAAA;;;wBAbN;sBACmB;+BACI;;;;;;;;;;AAWvB,IAAA,AAAMA,qBAAN,MAAMA;IAMX,MAAMC,YAAYC,OAAyB,EAAoB;QAC7D,mDAAmD;QACnD,MAAMC,iBAAiB,IAAI,CAACC,SAAS,CAACC,GAAG,CACvC,kBACAH,QAAQI,UAAU;QAGpB,oCAAoC;QACpC,IAAIH,gBAAgB;YAClB,OAAO;QACT;QAEA,MAAMI,UAAUL,QAAQM,YAAY,GAAGC,UAAU;QACjD,MAAMC,OAAOH,QAAQG,IAAI;QAEzB,IAAI,CAACA,QAAQ,CAACA,KAAKC,EAAE,EAAE;YACrB,OAAO,MAAM,sCAAsC;QACrD;QAEA,0CAA0C;QAC1C,MAAMC,SAAS,MAAM,IAAI,CAACC,MAAM,CAACH,IAAI,CAACI,UAAU,CAAC;YAC/CC,OAAO;gBAAEJ,IAAID,KAAKC,EAAE;YAAC;YACrBK,QAAQ;gBAAEC,eAAe;YAAK;QAChC;QAEA,IAAI,CAACL,QAAQ;YACX,MAAM,IAAIM,0BAAkB,CAAC;QAC/B;QAEA,6CAA6C;QAC7C,IAAIN,OAAOK,aAAa,KAAK,aAAa;YACxC,MAAM,IAAIC,0BAAkB,CAC1B;QAEJ;QAEA,iCAAiC;QACjC,IAAIN,OAAOK,aAAa,KAAK,UAAU;YACrC,MAAM,IAAIC,0BAAkB,CAC1B;QAEJ;QAEA,wBAAwB;QACxB,IAAIN,OAAOK,aAAa,KAAK,UAAU;YACrC,MAAM,IAAIC,0BAAkB,CAC1B;QAEJ;QAEA,OAAO;IACT;IAxDA,YACE,AAAQd,SAAoB,EAC5B,AAAQS,MAAqB,CAC7B;aAFQT,YAAAA;aACAS,SAAAA;IACP;AAsDL"}