{"version":3,"sources":["../../../src/common/guards/ws-jwt.guard.ts"],"sourcesContent":["import { CanActivate, ExecutionContext, Injectable } from '@nestjs/common';\r\nimport { JwtService } from '@nestjs/jwt';\r\nimport { WsException } from '@nestjs/websockets';\r\nimport { Socket } from 'socket.io';\r\n\r\n@Injectable()\r\nexport class WsJwtGuard implements CanActivate {\r\n    constructor(private readonly jwtService: JwtService) { }\r\n\r\n    async canActivate(context: ExecutionContext): Promise<boolean> {\r\n        try {\r\n            const client: Socket = context.switchToWs().getClient<Socket>();\r\n            const token = this.extractTokenFromHandshake(client);\r\n\r\n            if (!token) {\r\n                throw new WsException('Unauthorized: No token provided');\r\n            }\r\n\r\n            const payload = await this.jwtService.verifyAsync(token, {\r\n                secret: process.env.JWT_SECRET,\r\n            });\r\n\r\n            // Attach user info to the socket for later use\r\n            client.data.user = payload;\r\n            return true;\r\n        } catch (error) {\r\n            throw new WsException('Unauthorized: Invalid token');\r\n        }\r\n    }\r\n\r\n    private extractTokenFromHandshake(client: Socket): string | undefined {\r\n        // Try to get token from handshake auth\r\n        const authToken = client.handshake.auth?.token;\r\n        if (authToken) {\r\n            return authToken;\r\n        }\r\n\r\n        // Try to get token from handshake headers (Authorization: Bearer <token>)\r\n        const authHeader = client.handshake.headers?.authorization;\r\n        if (authHeader && authHeader.startsWith('Bearer ')) {\r\n            return authHeader.substring(7);\r\n        }\r\n\r\n        // Try to get token from query params\r\n        const queryToken = client.handshake.query?.token;\r\n        if (queryToken && typeof queryToken === 'string') {\r\n            return queryToken;\r\n        }\r\n\r\n        return undefined;\r\n    }\r\n}\r\n"],"names":["WsJwtGuard","canActivate","context","client","switchToWs","getClient","token","extractTokenFromHandshake","WsException","payload","jwtService","verifyAsync","secret","process","env","JWT_SECRET","data","user","error","authToken","handshake","auth","authHeader","headers","authorization","startsWith","substring","queryToken","query","undefined"],"mappings":";;;;+BAMaA;;;eAAAA;;;wBAN6C;qBAC/B;4BACC;;;;;;;;;;AAIrB,IAAA,AAAMA,aAAN,MAAMA;IAGT,MAAMC,YAAYC,OAAyB,EAAoB;QAC3D,IAAI;YACA,MAAMC,SAAiBD,QAAQE,UAAU,GAAGC,SAAS;YACrD,MAAMC,QAAQ,IAAI,CAACC,yBAAyB,CAACJ;YAE7C,IAAI,CAACG,OAAO;gBACR,MAAM,IAAIE,uBAAW,CAAC;YAC1B;YAEA,MAAMC,UAAU,MAAM,IAAI,CAACC,UAAU,CAACC,WAAW,CAACL,OAAO;gBACrDM,QAAQC,QAAQC,GAAG,CAACC,UAAU;YAClC;YAEA,+CAA+C;YAC/CZ,OAAOa,IAAI,CAACC,IAAI,GAAGR;YACnB,OAAO;QACX,EAAE,OAAOS,OAAO;YACZ,MAAM,IAAIV,uBAAW,CAAC;QAC1B;IACJ;IAEQD,0BAA0BJ,MAAc,EAAsB;QAClE,uCAAuC;QACvC,MAAMgB,YAAYhB,OAAOiB,SAAS,CAACC,IAAI,EAAEf;QACzC,IAAIa,WAAW;YACX,OAAOA;QACX;QAEA,0EAA0E;QAC1E,MAAMG,aAAanB,OAAOiB,SAAS,CAACG,OAAO,EAAEC;QAC7C,IAAIF,cAAcA,WAAWG,UAAU,CAAC,YAAY;YAChD,OAAOH,WAAWI,SAAS,CAAC;QAChC;QAEA,qCAAqC;QACrC,MAAMC,aAAaxB,OAAOiB,SAAS,CAACQ,KAAK,EAAEtB;QAC3C,IAAIqB,cAAc,OAAOA,eAAe,UAAU;YAC9C,OAAOA;QACX;QAEA,OAAOE;IACX;IA3CA,YAAY,AAAiBnB,UAAsB,CAAE;aAAxBA,aAAAA;IAA0B;AA4C3D"}