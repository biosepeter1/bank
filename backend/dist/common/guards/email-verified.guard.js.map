{"version":3,"sources":["../../../src/common/guards/email-verified.guard.ts"],"sourcesContent":["import { Injectable, CanActivate, ExecutionContext, ForbiddenException } from '@nestjs/common';\r\nimport { Reflector } from '@nestjs/core';\r\nimport { PrismaService } from '@/prisma/prisma.service';\r\nimport { REQUIRE_EMAIL_VERIFIED_KEY } from '../decorators/email-verified.decorator';\r\n\r\n@Injectable()\r\nexport class EmailVerifiedGuard implements CanActivate {\r\n  constructor(\r\n    private reflector: Reflector,\r\n    private prisma: PrismaService,\r\n  ) {}\r\n\r\n  async canActivate(context: ExecutionContext): Promise<boolean> {\r\n    const requireEmailVerified = this.reflector.getAllAndOverride<boolean>(REQUIRE_EMAIL_VERIFIED_KEY, [\r\n      context.getHandler(),\r\n      context.getClass(),\r\n    ]);\r\n\r\n    if (!requireEmailVerified) {\r\n      return true;\r\n    }\r\n\r\n    const request = context.switchToHttp().getRequest();\r\n    const user = request.user;\r\n\r\n    if (!user) {\r\n      throw new ForbiddenException('User not authenticated');\r\n    }\r\n\r\n    // Fetch fresh user data to check email verification status\r\n    const dbUser = await this.prisma.user.findUnique({\r\n      where: { id: user.id },\r\n      select: { isEmailVerified: true },\r\n    });\r\n\r\n    if (!dbUser || !dbUser.isEmailVerified) {\r\n      throw new ForbiddenException('Please verify your email address before performing this action');\r\n    }\r\n\r\n    return true;\r\n  }\r\n}\r\n"],"names":["EmailVerifiedGuard","canActivate","context","requireEmailVerified","reflector","getAllAndOverride","REQUIRE_EMAIL_VERIFIED_KEY","getHandler","getClass","request","switchToHttp","getRequest","user","ForbiddenException","dbUser","prisma","findUnique","where","id","select","isEmailVerified"],"mappings":";;;;+BAMaA;;;eAAAA;;;wBANiE;sBACpD;+BACI;wCACa;;;;;;;;;;AAGpC,IAAA,AAAMA,qBAAN,MAAMA;IAMX,MAAMC,YAAYC,OAAyB,EAAoB;QAC7D,MAAMC,uBAAuB,IAAI,CAACC,SAAS,CAACC,iBAAiB,CAAUC,kDAA0B,EAAE;YACjGJ,QAAQK,UAAU;YAClBL,QAAQM,QAAQ;SACjB;QAED,IAAI,CAACL,sBAAsB;YACzB,OAAO;QACT;QAEA,MAAMM,UAAUP,QAAQQ,YAAY,GAAGC,UAAU;QACjD,MAAMC,OAAOH,QAAQG,IAAI;QAEzB,IAAI,CAACA,MAAM;YACT,MAAM,IAAIC,0BAAkB,CAAC;QAC/B;QAEA,2DAA2D;QAC3D,MAAMC,SAAS,MAAM,IAAI,CAACC,MAAM,CAACH,IAAI,CAACI,UAAU,CAAC;YAC/CC,OAAO;gBAAEC,IAAIN,KAAKM,EAAE;YAAC;YACrBC,QAAQ;gBAAEC,iBAAiB;YAAK;QAClC;QAEA,IAAI,CAACN,UAAU,CAACA,OAAOM,eAAe,EAAE;YACtC,MAAM,IAAIP,0BAAkB,CAAC;QAC/B;QAEA,OAAO;IACT;IAjCA,YACE,AAAQT,SAAoB,EAC5B,AAAQW,MAAqB,CAC7B;aAFQX,YAAAA;aACAW,SAAAA;IACP;AA+BL"}