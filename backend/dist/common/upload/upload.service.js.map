{"version":3,"sources":["../../../src/common/upload/upload.service.ts"],"sourcesContent":["import { Injectable, BadRequestException } from '@nestjs/common';\r\nimport { diskStorage } from 'multer';\r\nimport { extname } from 'path';\r\nimport * as fs from 'fs';\r\nimport * as path from 'path';\r\n\r\n@Injectable()\r\nexport class UploadService {\r\n  private uploadDir = path.join(process.cwd(), 'uploads');\r\n\r\n  constructor() {\r\n    // Ensure upload directory exists\r\n    this.ensureUploadDir();\r\n  }\r\n\r\n  private ensureUploadDir() {\r\n    if (!fs.existsSync(this.uploadDir)) {\r\n      fs.mkdirSync(this.uploadDir, { recursive: true });\r\n    }\r\n\r\n    // Create subdirectories for different document types\r\n    const subdirs = ['kyc', 'kyc/id-documents', 'kyc/proof-of-address', 'kyc/selfies'];\r\n    subdirs.forEach((subdir) => {\r\n      const fullPath = path.join(this.uploadDir, subdir);\r\n      if (!fs.existsSync(fullPath)) {\r\n        fs.mkdirSync(fullPath, { recursive: true });\r\n      }\r\n    });\r\n  }\r\n\r\n  getMulterOptions(folder: string) {\r\n    return {\r\n      storage: diskStorage({\r\n        destination: (req, file, cb) => {\r\n          const uploadPath = path.join(this.uploadDir, folder);\r\n          cb(null, uploadPath);\r\n        },\r\n        filename: (req, file, cb) => {\r\n          const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1e9);\r\n          const ext = extname(file.originalname);\r\n          cb(null, `${file.fieldname}-${uniqueSuffix}${ext}`);\r\n        },\r\n      }),\r\n      fileFilter: (req, file, cb) => {\r\n        // Allow images and PDFs only\r\n        const allowedMimeTypes = [\r\n          'image/jpeg',\r\n          'image/jpg',\r\n          'image/png',\r\n          'image/webp',\r\n          'application/pdf',\r\n        ];\r\n\r\n        if (allowedMimeTypes.includes(file.mimetype)) {\r\n          cb(null, true);\r\n        } else {\r\n          cb(\r\n            new BadRequestException(\r\n              'Invalid file type. Only JPEG, PNG, WEBP, and PDF files are allowed.',\r\n            ),\r\n            false,\r\n          );\r\n        }\r\n      },\r\n      limits: {\r\n        fileSize: 5 * 1024 * 1024, // 5MB max file size\r\n      },\r\n    };\r\n  }\r\n\r\n  deleteFile(filePath: string): void {\r\n    try {\r\n      const fullPath = path.join(this.uploadDir, filePath);\r\n      if (fs.existsSync(fullPath)) {\r\n        fs.unlinkSync(fullPath);\r\n      }\r\n    } catch (error) {\r\n      console.error('Error deleting file:', error);\r\n    }\r\n  }\r\n\r\n  getFileUrl(filePath: string): string {\r\n    // Return relative path that can be served by the backend\r\n    return `/uploads/${filePath}`;\r\n  }\r\n}\r\n"],"names":["UploadService","ensureUploadDir","fs","existsSync","uploadDir","mkdirSync","recursive","subdirs","forEach","subdir","fullPath","path","join","getMulterOptions","folder","storage","diskStorage","destination","req","file","cb","uploadPath","filename","uniqueSuffix","Date","now","Math","round","random","ext","extname","originalname","fieldname","fileFilter","allowedMimeTypes","includes","mimetype","BadRequestException","limits","fileSize","deleteFile","filePath","unlinkSync","error","console","getFileUrl","process","cwd"],"mappings":";;;;+BAOaA;;;eAAAA;;;wBAPmC;wBACpB;8DACJ;4DACJ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAIb,IAAA,AAAMA,gBAAN,MAAMA;IAQHC,kBAAkB;QACxB,IAAI,CAACC,IAAGC,UAAU,CAAC,IAAI,CAACC,SAAS,GAAG;YAClCF,IAAGG,SAAS,CAAC,IAAI,CAACD,SAAS,EAAE;gBAAEE,WAAW;YAAK;QACjD;QAEA,qDAAqD;QACrD,MAAMC,UAAU;YAAC;YAAO;YAAoB;YAAwB;SAAc;QAClFA,QAAQC,OAAO,CAAC,CAACC;YACf,MAAMC,WAAWC,MAAKC,IAAI,CAAC,IAAI,CAACR,SAAS,EAAEK;YAC3C,IAAI,CAACP,IAAGC,UAAU,CAACO,WAAW;gBAC5BR,IAAGG,SAAS,CAACK,UAAU;oBAAEJ,WAAW;gBAAK;YAC3C;QACF;IACF;IAEAO,iBAAiBC,MAAc,EAAE;QAC/B,OAAO;YACLC,SAASC,IAAAA,mBAAW,EAAC;gBACnBC,aAAa,CAACC,KAAKC,MAAMC;oBACvB,MAAMC,aAAaV,MAAKC,IAAI,CAAC,IAAI,CAACR,SAAS,EAAEU;oBAC7CM,GAAG,MAAMC;gBACX;gBACAC,UAAU,CAACJ,KAAKC,MAAMC;oBACpB,MAAMG,eAAeC,KAAKC,GAAG,KAAK,MAAMC,KAAKC,KAAK,CAACD,KAAKE,MAAM,KAAK;oBACnE,MAAMC,MAAMC,IAAAA,aAAO,EAACX,KAAKY,YAAY;oBACrCX,GAAG,MAAM,GAAGD,KAAKa,SAAS,CAAC,CAAC,EAAET,eAAeM,KAAK;gBACpD;YACF;YACAI,YAAY,CAACf,KAAKC,MAAMC;gBACtB,6BAA6B;gBAC7B,MAAMc,mBAAmB;oBACvB;oBACA;oBACA;oBACA;oBACA;iBACD;gBAED,IAAIA,iBAAiBC,QAAQ,CAAChB,KAAKiB,QAAQ,GAAG;oBAC5ChB,GAAG,MAAM;gBACX,OAAO;oBACLA,GACE,IAAIiB,2BAAmB,CACrB,wEAEF;gBAEJ;YACF;YACAC,QAAQ;gBACNC,UAAU,IAAI,OAAO;YACvB;QACF;IACF;IAEAC,WAAWC,QAAgB,EAAQ;QACjC,IAAI;YACF,MAAM/B,WAAWC,MAAKC,IAAI,CAAC,IAAI,CAACR,SAAS,EAAEqC;YAC3C,IAAIvC,IAAGC,UAAU,CAACO,WAAW;gBAC3BR,IAAGwC,UAAU,CAAChC;YAChB;QACF,EAAE,OAAOiC,OAAO;YACdC,QAAQD,KAAK,CAAC,wBAAwBA;QACxC;IACF;IAEAE,WAAWJ,QAAgB,EAAU;QACnC,yDAAyD;QACzD,OAAO,CAAC,SAAS,EAAEA,UAAU;IAC/B;IA1EA,aAAc;aAFNrC,YAAYO,MAAKC,IAAI,CAACkC,QAAQC,GAAG,IAAI;QAG3C,iCAAiC;QACjC,IAAI,CAAC9C,eAAe;IACtB;AAwEF"}