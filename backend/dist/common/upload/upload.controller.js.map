{"version":3,"sources":["../../../src/common/upload/upload.controller.ts"],"sourcesContent":["import {\r\n  Controller,\r\n  Post,\r\n  UseInterceptors,\r\n  UploadedFile,\r\n  BadRequestException,\r\n} from '@nestjs/common';\r\nimport { FileInterceptor } from '@nestjs/platform-express';\r\nimport { UploadService } from './upload.service';\r\n\r\n@Controller('upload')\r\nexport class UploadController {\r\n  constructor(private readonly uploadService: UploadService) {}\r\n\r\n  @Post()\r\n  @UseInterceptors(FileInterceptor('file', {\r\n    storage: require('multer').diskStorage({\r\n      destination: (req, file, cb) => {\r\n        const path = require('path');\r\n        const fs = require('fs');\r\n        const uploadPath = path.join(process.cwd(), 'uploads', 'loan-proofs');\r\n        \r\n        // Ensure directory exists\r\n        if (!fs.existsSync(uploadPath)) {\r\n          fs.mkdirSync(uploadPath, { recursive: true });\r\n        }\r\n        \r\n        cb(null, uploadPath);\r\n      },\r\n      filename: (req, file, cb) => {\r\n        const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1e9);\r\n        const ext = require('path').extname(file.originalname);\r\n        cb(null, `proof-${uniqueSuffix}${ext}`);\r\n      },\r\n    }),\r\n    fileFilter: (req, file, cb) => {\r\n      const allowedMimeTypes = [\r\n        'image/jpeg',\r\n        'image/jpg',\r\n        'image/png',\r\n        'image/webp',\r\n        'application/pdf',\r\n      ];\r\n\r\n      if (allowedMimeTypes.includes(file.mimetype)) {\r\n        cb(null, true);\r\n      } else {\r\n        cb(\r\n          new BadRequestException(\r\n            'Invalid file type. Only JPEG, PNG, WEBP, and PDF files are allowed.',\r\n          ),\r\n          false,\r\n        );\r\n      }\r\n    },\r\n    limits: {\r\n      fileSize: 5 * 1024 * 1024, // 5MB\r\n    },\r\n  }))\r\n  async uploadFile(@UploadedFile() file: Express.Multer.File) {\r\n    if (!file) {\r\n      throw new BadRequestException('No file uploaded');\r\n    }\r\n\r\n    // Return the relative path for database storage\r\n    const relativePath = `loan-proofs/${file.filename}`;\r\n    const url = this.uploadService.getFileUrl(relativePath);\r\n\r\n    return {\r\n      url,\r\n      filename: file.filename,\r\n      originalName: file.originalname,\r\n      size: file.size,\r\n      mimetype: file.mimetype,\r\n    };\r\n  }\r\n}\r\n"],"names":["UploadController","uploadFile","file","BadRequestException","relativePath","filename","url","uploadService","getFileUrl","originalName","originalname","size","mimetype","storage","require","diskStorage","destination","req","cb","path","fs","uploadPath","join","process","cwd","existsSync","mkdirSync","recursive","uniqueSuffix","Date","now","Math","round","random","ext","extname","fileFilter","allowedMimeTypes","includes","limits","fileSize"],"mappings":";;;;+BAWaA;;;eAAAA;;;wBALN;iCACyB;+BACF;;;;;;;;;;;;;;;AAGvB,IAAA,AAAMA,mBAAN,MAAMA;IAGX,MA6CMC,WAAW,AAAgBC,IAAyB,EAAE;QAC1D,IAAI,CAACA,MAAM;YACT,MAAM,IAAIC,2BAAmB,CAAC;QAChC;QAEA,gDAAgD;QAChD,MAAMC,eAAe,CAAC,YAAY,EAAEF,KAAKG,QAAQ,EAAE;QACnD,MAAMC,MAAM,IAAI,CAACC,aAAa,CAACC,UAAU,CAACJ;QAE1C,OAAO;YACLE;YACAD,UAAUH,KAAKG,QAAQ;YACvBI,cAAcP,KAAKQ,YAAY;YAC/BC,MAAMT,KAAKS,IAAI;YACfC,UAAUV,KAAKU,QAAQ;QACzB;IACF;IA/DA,YAAY,AAAiBL,aAA4B,CAAE;aAA9BA,gBAAAA;IAA+B;AAgE9D;;;;QA5DIM,SAASC,QAAQ,UAAUC,WAAW,CAAC;YACrCC,aAAa,CAACC,KAAKf,MAAMgB;gBACvB,MAAMC,OAAOL,QAAQ;gBACrB,MAAMM,KAAKN,QAAQ;gBACnB,MAAMO,aAAaF,KAAKG,IAAI,CAACC,QAAQC,GAAG,IAAI,WAAW;gBAEvD,0BAA0B;gBAC1B,IAAI,CAACJ,GAAGK,UAAU,CAACJ,aAAa;oBAC9BD,GAAGM,SAAS,CAACL,YAAY;wBAAEM,WAAW;oBAAK;gBAC7C;gBAEAT,GAAG,MAAMG;YACX;YACAhB,UAAU,CAACY,KAAKf,MAAMgB;gBACpB,MAAMU,eAAeC,KAAKC,GAAG,KAAK,MAAMC,KAAKC,KAAK,CAACD,KAAKE,MAAM,KAAK;gBACnE,MAAMC,MAAMpB,QAAQ,QAAQqB,OAAO,CAACjC,KAAKQ,YAAY;gBACrDQ,GAAG,MAAM,CAAC,MAAM,EAAEU,eAAeM,KAAK;YACxC;QACF;QACAE,YAAY,CAACnB,KAAKf,MAAMgB;YACtB,MAAMmB,mBAAmB;gBACvB;gBACA;gBACA;gBACA;gBACA;aACD;YAED,IAAIA,iBAAiBC,QAAQ,CAACpC,KAAKU,QAAQ,GAAG;gBAC5CM,GAAG,MAAM;YACX,OAAO;gBACLA,GACE,IAAIf,2BAAmB,CACrB,wEAEF;YAEJ;QACF;QACAoC,QAAQ;YACNC,UAAU,IAAI,OAAO;QACvB;;;;;yDAE6C,yCAAA,OAAO,wCAAP,OAAO"}