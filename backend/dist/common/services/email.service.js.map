{"version":3,"sources":["../../../src/common/services/email.service.ts"],"sourcesContent":["import { Injectable, Logger } from '@nestjs/common';\r\nimport { SettingsService } from '../../modules/settings/settings.service';\r\n\r\ninterface Brand {\r\n  name: string;\r\n  logo: string;\r\n  primary: string;\r\n  secondary: string;\r\n  supportEmail?: string;\r\n  websiteUrl?: string;\r\n}\r\n\r\n@Injectable()\r\nexport class EmailService {\r\n  private readonly logger = new Logger(EmailService.name);\r\n  private cachedBrand: Brand | null = null;\r\n\r\n  constructor(private readonly settingsService: SettingsService) { }\r\n\r\n  private async getBrand(): Promise<Brand> {\r\n    // Always fetch fresh to get latest brand colors\r\n    try {\r\n      const settings = await this.settingsService.getSettings();\r\n      this.cachedBrand = {\r\n        name: settings?.general?.siteName || 'Banking Platform',\r\n        logo: settings?.general?.logo || 'https://dummyimage.com/120x120/4f46e5/ffffff&text=B',\r\n        primary: settings?.general?.brandPrimaryColor || '#4F46E5',\r\n        secondary: settings?.general?.brandSecondaryColor || '#7C3AED',\r\n        supportEmail: settings?.general?.supportEmail || 'support@example.com',\r\n        websiteUrl: process.env.FRONTEND_URL || 'http://localhost:3000',\r\n      };\r\n    } catch (_) {\r\n      this.cachedBrand = { name: 'Banking Platform', logo: '', primary: '#4F46E5', secondary: '#7C3AED', supportEmail: 'support@example.com', websiteUrl: 'http://localhost:3000' };\r\n    }\r\n    return this.cachedBrand!;\r\n  }\r\n\r\n  async sendWelcomeEmail(params: {\r\n    email: string;\r\n    firstName: string;\r\n    lastName: string;\r\n    accountNumber: string;\r\n  }): Promise<void> {\r\n    const { email, firstName, lastName, accountNumber } = params;\r\n    const brand = await this.getBrand();\r\n\r\n    const subject = `Welcome to ${brand.name}`;\r\n    const html = this.renderTemplate(brand, {\r\n      title: 'Welcome!',\r\n      intro: `Hi ${firstName} ${lastName}, your ${brand.name} account is ready.`,\r\n      lines: [\r\n        `Account Holder: ${firstName} ${lastName}`,\r\n        `Account Number: ${accountNumber}`,\r\n        `Login: ${(process.env.FRONTEND_URL || 'http://localhost:3000') + '/login'}`,\r\n      ],\r\n      cta: { label: 'Go to Dashboard', url: (process.env.FRONTEND_URL || 'http://localhost:3000') + '/dashboard' },\r\n    });\r\n\r\n    this.logSend(email, subject, html);\r\n  }\r\n\r\n  async sendAccountStatusEmail(params: {\r\n    email: string;\r\n    firstName: string;\r\n    status: string;\r\n    reason?: string;\r\n  }): Promise<void> {\r\n    const { email, firstName, status, reason } = params;\r\n    const brand = await this.getBrand();\r\n    const subject = `${brand.name} ¬∑ Account ${status}`;\r\n    const html = this.renderTemplate(brand, {\r\n      title: `Account ${status}`,\r\n      intro: `Hello ${firstName}, your account status is now ${status}.`,\r\n      lines: reason ? [`Reason: ${reason}`] : [],\r\n    });\r\n    this.logSend(email, subject, html);\r\n  }\r\n\r\n  async sendKycStatusEmail(params: {\r\n    email: string;\r\n    firstName: string;\r\n    status: string;\r\n    reason?: string;\r\n  }): Promise<void> {\r\n    const { email, firstName, status, reason } = params;\r\n    const brand = await this.getBrand();\r\n    const subject = `${brand.name} ¬∑ KYC ${status}`;\r\n    const html = this.renderTemplate(brand, {\r\n      title: `KYC ${status}`,\r\n      intro: `Hi ${firstName}, your KYC is ${status}.`,\r\n      lines: [status === 'APPROVED' ? 'You now have full access to all features.' : '', reason ? `Reason: ${reason}` : ''].filter(Boolean) as string[],\r\n    });\r\n    this.logSend(email, subject, html);\r\n  }\r\n\r\n  async sendOtpEmail(params: { email: string; firstName: string; code: string; purpose?: string }): Promise<void> {\r\n    const { email, firstName, code, purpose } = params;\r\n    const brand = await this.getBrand();\r\n    const subject = `${brand.name} ¬∑ ${purpose || 'Verification'} Code`;\r\n\r\n    const otpBox = `\r\n      <div style=\"background:linear-gradient(135deg, ${brand.primary}08 0%, ${brand.secondary}08 100%);border:3px solid ${brand.primary}30;border-radius:16px;padding:32px 24px;margin:24px 0;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,0.08)\">\r\n        <div style=\"color:#64748b;font-size:13px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;margin-bottom:12px\">Your Verification Code</div>\r\n        <div style=\"font-size:40px;font-weight:800;letter-spacing:12px;margin:16px 0;background:linear-gradient(135deg, ${brand.primary} 0%, ${brand.secondary} 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;text-shadow:0 4px 12px rgba(0,0,0,0.1)\">${code}</div>\r\n        <div style=\"width:60px;height:3px;background:linear-gradient(90deg, ${brand.primary} 0%, ${brand.secondary} 100%);margin:16px auto 12px;border-radius:2px\"></div>\r\n        <div style=\"color:#94a3b8;font-size:13px;font-weight:500\">‚è∞ Expires in 5 minutes</div>\r\n      </div>\r\n    `;\r\n\r\n    const html = this.renderTemplate(brand, {\r\n      title: `üîê ${purpose || 'Verification'} Code`,\r\n      intro: `Hi ${firstName}, please use the verification code below to continue:`,\r\n      lines: [\r\n        otpBox,\r\n        '<div style=\"background:#fef3c7;border-left:4px solid #f59e0b;padding:12px 16px;margin:16px 0;border-radius:8px\"><strong style=\"color:#92400e\">‚ö†Ô∏è Security Note:</strong><br/><span style=\"color:#78350f;font-size:14px\">Never share this code with anyone. Our team will never ask for your verification code.</span></div>',\r\n      ],\r\n    });\r\n    this.logSend(email, subject, html);\r\n  }\r\n\r\n  async sendEmailVerificationCode(params: { email: string; firstName: string; code: string }): Promise<void> {\r\n    const { email, firstName, code } = params;\r\n    const brand = await this.getBrand();\r\n    const subject = `${brand.name} ¬∑ Verify Your Email Address`;\r\n\r\n    const verificationBox = `\r\n      <div style=\"background:linear-gradient(135deg, ${brand.primary}10 0%, ${brand.secondary}10 100%);border:3px dashed ${brand.primary}50;border-radius:20px;padding:40px 32px;margin:24px 0;text-align:center;position:relative;overflow:hidden\">\r\n        <div style=\"position:absolute;top:-30px;right:-30px;width:100px;height:100px;background:${brand.primary}15;border-radius:50%;filter:blur(30px)\"></div>\r\n        <div style=\"position:absolute;bottom:-30px;left:-30px;width:100px;height:100px;background:${brand.secondary}15;border-radius:50%;filter:blur(30px)\"></div>\r\n        <div style=\"font-size:48px;margin-bottom:12px\">üìß</div>\r\n        <div style=\"color:#64748b;font-size:14px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;margin-bottom:16px\">Email Verification Code</div>\r\n        <div style=\"font-size:44px;font-weight:900;letter-spacing:14px;margin:20px 0;background:linear-gradient(135deg, ${brand.primary} 0%, ${brand.secondary} 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;position:relative;z-index:1\">${code}</div>\r\n        <div style=\"width:80px;height:4px;background:linear-gradient(90deg, ${brand.primary} 0%, ${brand.secondary} 100%);margin:20px auto 16px;border-radius:2px\"></div>\r\n        <div style=\"color:#94a3b8;font-size:14px;font-weight:600;display:flex;align-items:center;justify-content:center;gap:8px\"><span>‚è±Ô∏è</span> Valid for 5 minutes</div>\r\n      </div>\r\n    `;\r\n\r\n    const html = this.renderTemplate(brand, {\r\n      title: '‚ú® Verify Your Email',\r\n      intro: `Hi ${firstName}! Welcome to ${brand.name}. Please verify your email address to activate your account.`,\r\n      lines: [\r\n        verificationBox,\r\n        '<div style=\"text-align:center;margin:20px 0;padding:16px;background:#f8fafc;border-radius:12px\"><strong style=\"color:#0f172a\">Why verify?</strong><br/><span style=\"color:#64748b;font-size:14px\">Email verification helps secure your account and enables important notifications.</span></div>',\r\n        '<div style=\"background:#dcfce7;border:2px solid #16a34a;border-radius:12px;padding:12px 16px;margin:16px 0;text-align:center\"><span style=\"color:#166534;font-size:13px;font-weight:600\">‚úÖ Complete verification to unlock all features</span></div>',\r\n      ],\r\n      cta: { label: 'Verify Email', url: `${process.env.FRONTEND_URL || 'http://localhost:3000'}/user/profile` },\r\n    });\r\n    this.logSend(email, subject, html);\r\n  }\r\n\r\n  async sendPasswordResetEmail(params: { email: string; firstName: string; resetUrl: string }): Promise<void> {\r\n    const { email, firstName, resetUrl } = params;\r\n    const brand = await this.getBrand();\r\n    const subject = `${brand.name} ¬∑ Reset your password`;\r\n    const html = this.renderTemplate(brand, {\r\n      title: 'Reset your password',\r\n      intro: `Hi ${firstName}, click the button below to reset your password.`,\r\n      cta: { label: 'Reset Password', url: resetUrl },\r\n      lines: ['If you did not request this, please ignore this email.'],\r\n    });\r\n    this.logSend(email, subject, html);\r\n  }\r\n\r\n  async sendGenericNotification(params: { email: string; title: string; message: string; actionUrl?: string; actionLabel?: string }): Promise<void> {\r\n    const { email, title, message, actionUrl, actionLabel } = params;\r\n    const brand = await this.getBrand();\r\n    const subject = `${brand.name} ¬∑ ${title}`;\r\n    const html = this.renderTemplate(brand, {\r\n      title,\r\n      intro: message,\r\n      cta: actionUrl ? { label: actionLabel || 'Open', url: actionUrl } : undefined,\r\n    });\r\n    this.logSend(email, subject, html);\r\n  }\r\n\r\n  async sendTransferCodeEmail(params: { email: string; firstName: string; type: 'COT' | 'IMF' | 'TAX'; code: string }): Promise<void> {\r\n    const { email, firstName, type, code } = params;\r\n    const brand = await this.getBrand();\r\n    const subject = `${brand.name} ¬∑ ${type} Code Issued`;\r\n    const html = this.renderTemplate(brand, {\r\n      title: `${type} Verification Code`,\r\n      intro: `Hi ${firstName}, your ${type} code has been approved and issued. Use this code for international transfers and keep it safe.`,\r\n      lines: [\r\n        `<div style=\\\"font-size:28px;font-weight:700;letter-spacing:6px;margin:12px 0\\\">${code}</div>`,\r\n        'This code is linked to your account. Do not share it with anyone.',\r\n      ],\r\n    });\r\n    this.logSend(email, subject, html);\r\n  }\r\n\r\n  async sendSupportTicketEmail(params: { email: string; firstName: string; ticketId: string; subject: string; message: string }): Promise<void> {\r\n    const { email, firstName, ticketId, subject: ticketSubject, message } = params;\r\n    const brand = await this.getBrand();\r\n    const subject = `${brand.name} ¬∑ Support Ticket #${ticketId}`;\r\n\r\n    const ticketBox = `\r\n      <div style=\"background:linear-gradient(135deg, ${brand.primary}08 0%, ${brand.secondary}08 100%);border:2px solid ${brand.primary}30;border-radius:16px;padding:24px;margin:24px 0;box-shadow:0 8px 32px rgba(0,0,0,0.08)\">\r\n        <div style=\"display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:12px\">\r\n          <div style=\"display:flex;align-items:center;gap:12px\">\r\n            <div style=\"width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg, ${brand.primary} 0%, ${brand.secondary} 100%);display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px ${brand.primary}30\">\r\n              <span style=\"font-size:24px\">üé´</span>\r\n            </div>\r\n            <div>\r\n              <div style=\"color:#64748b;font-size:12px;font-weight:600;letter-spacing:0.05em;text-transform:uppercase\">Support Ticket</div>\r\n              <div style=\"color:#0f172a;font-size:18px;font-weight:700;margin-top:2px\">#${ticketId}</div>\r\n            </div>\r\n          </div>\r\n          <div style=\"padding:8px 16px;background:#dcfce7;border-radius:8px;border:2px solid #16a34a\">\r\n            <span style=\"color:#166534;font-size:13px;font-weight:700\">‚úÖ Received</span>\r\n          </div>\r\n        </div>\r\n        <div style=\"background:#ffffff;border:1px solid #e2e8f0;border-radius:12px;padding:16px;margin-top:16px\">\r\n          <div style=\"color:#64748b;font-size:12px;font-weight:600;margin-bottom:8px\">SUBJECT</div>\r\n          <div style=\"color:#0f172a;font-weight:600;font-size:15px;margin-bottom:16px\">${ticketSubject}</div>\r\n          <div style=\"color:#64748b;font-size:12px;font-weight:600;margin-bottom:8px\">YOUR MESSAGE</div>\r\n          <div style=\"color:#475569;font-size:14px;line-height:1.6\">${message}</div>\r\n        </div>\r\n      </div>\r\n    `;\r\n\r\n    const html = this.renderTemplate(brand, {\r\n      title: 'üéØ Support Request Received',\r\n      intro: `Hi ${firstName}, thank you for contacting us! We've received your support request and our team will respond shortly.`,\r\n      lines: [\r\n        ticketBox,\r\n        '<div style=\"background:#f8fafc;border-radius:12px;padding:20px;margin:20px 0;text-align:center\"><div style=\"color:#0f172a;font-weight:700;font-size:16px;margin-bottom:8px\">‚ö° Quick Response Time</div><div style=\"color:#64748b;font-size:14px\">Our support team typically responds within 24 hours. You\\'ll receive an email notification when we reply.</div></div>',\r\n        `<div style=\"background:linear-gradient(135deg, ${brand.primary}08 0%, ${brand.secondary}08 100%);border-left:4px solid ${brand.primary};padding:16px 20px;border-radius:8px;margin:16px 0\"><strong style=\"color:${brand.primary}\">üí° Need urgent help?</strong><br/><span style=\"color:#64748b;font-size:14px\">For urgent matters, please call us at ${brand.supportEmail || 'our support number'}.</span></div>`,\r\n      ],\r\n      cta: { label: 'View Ticket Status', url: `${process.env.FRONTEND_URL || 'http://localhost:3000'}/user/support` },\r\n    });\r\n    this.logSend(email, subject, html);\r\n  }\r\n\r\n  async sendLoanFeeRequestEmail(params: {\r\n    email: string;\r\n    firstName: string;\r\n    loanAmount: string;\r\n    currency: string;\r\n    processingFee: string;\r\n    cryptoWalletAddress: string;\r\n    cryptoType: string;\r\n    feeDescription: string;\r\n  }): Promise<void> {\r\n    const { email, firstName, loanAmount, currency, processingFee, cryptoWalletAddress, cryptoType, feeDescription } = params;\r\n    const brand = await this.getBrand();\r\n\r\n    const subject = `${brand.name} ¬∑ Loan Processing Fee Required`;\r\n    const html = this.renderTemplate(brand, {\r\n      title: 'üí≥ Loan Processing Fee Required',\r\n      intro: `Hi ${firstName}, your loan application for ${currency} ${loanAmount} has been reviewed.`,\r\n      lines: [\r\n        `<div style=\"background:#fef3c7;border:2px solid #f59e0b;border-radius:12px;padding:16px;margin:16px 0\">\r\n          <div style=\"color:#92400e;font-weight:700;font-size:16px;margin-bottom:8px\">‚ö†Ô∏è Action Required</div>\r\n          <div style=\"color:#78350f\">${feeDescription}</div>\r\n        </div>`,\r\n        `<div style=\"background:#f8fafc;border:1px solid #e2e8f0;border-radius:12px;padding:16px;margin:16px 0\">\r\n          <div style=\"margin-bottom:12px\"><strong>Processing Fee:</strong> <span style=\"color:#dc2626;font-size:18px;font-weight:700\">${processingFee} ${cryptoType}</span></div>\r\n          <div style=\"margin-bottom:8px\"><strong>Crypto Type:</strong> ${cryptoType}</div>\r\n          <div style=\"margin-bottom:8px\"><strong>Wallet Address:</strong></div>\r\n          <div style=\"background:#ffffff;border:1px solid #cbd5e1;padding:12px;border-radius:8px;font-family:monospace;word-break:break-all;font-size:13px\">${cryptoWalletAddress}</div>\r\n        </div>`,\r\n        '<strong>Payment Instructions:</strong>',\r\n        '1. Send the exact fee amount to the wallet address above',\r\n        '2. Take a screenshot or save transaction ID as proof',\r\n        '3. Return to your loan application and upload the payment proof',\r\n        '4. Wait for admin verification and loan approval',\r\n        '<em style=\"color:#64748b;font-size:13px\">Note: Your loan will only be processed after fee payment verification.</em>',\r\n      ],\r\n      cta: { label: 'Upload Payment Proof', url: `${process.env.FRONTEND_URL || 'http://localhost:3000'}/user/loans` },\r\n    });\r\n    this.logSend(email, subject, html);\r\n  }\r\n\r\n  async sendLoanApprovedEmail(params: {\r\n    email: string;\r\n    firstName: string;\r\n    loanAmount: string;\r\n    currency: string;\r\n    monthlyPayment: string;\r\n    duration: number;\r\n    interestRate: string;\r\n  }): Promise<void> {\r\n    const { email, firstName, loanAmount, currency, monthlyPayment, duration, interestRate } = params;\r\n    const brand = await this.getBrand();\r\n\r\n    const subject = `${brand.name} ¬∑ Loan Approved!`;\r\n    const html = this.renderTemplate(brand, {\r\n      title: '‚úÖ Loan Approved',\r\n      intro: `Great news ${firstName}! Your loan application has been approved.`,\r\n      lines: [\r\n        `<div style=\"background:#dcfce7;border:2px solid #16a34a;border-radius:12px;padding:16px;margin:16px 0\">\r\n          <div style=\"text-align:center\">\r\n            <div style=\"font-size:32px;margin-bottom:8px\">‚úÖ</div>\r\n            <div style=\"color:#166534;font-weight:700;font-size:18px\">Loan Approved</div>\r\n            <div style=\"color:#15803d;font-size:24px;font-weight:800;margin-top:8px\">${currency} ${loanAmount}</div>\r\n          </div>\r\n        </div>`,\r\n        '<strong>Loan Details:</strong>',\r\n        `<strong>Amount:</strong> ${currency} ${loanAmount}`,\r\n        `<strong>Duration:</strong> ${duration} months`,\r\n        `<strong>Interest Rate:</strong> ${interestRate}% per annum`,\r\n        `<strong>Monthly Payment:</strong> ${currency} ${monthlyPayment}`,\r\n        '<div style=\"background:#fef3c7;border-left:4px solid #f59e0b;padding:12px;margin:16px 0;border-radius:4px\">\\n          <strong style=\"color:#92400e\">Next Steps:</strong><br/>\\n          <span style=\"color:#78350f\">Your loan will be disbursed to your wallet shortly. You will receive a notification once funds are available.</span>\\n        </div>',\r\n      ],\r\n      cta: { label: 'View Loan Details', url: `${process.env.FRONTEND_URL || 'http://localhost:3000'}/user/loans` },\r\n    });\r\n    this.logSend(email, subject, html);\r\n  }\r\n\r\n  async sendLoanDisbursementEmail(params: {\r\n    email: string;\r\n    firstName: string;\r\n    loanAmount: string;\r\n    currency: string;\r\n    monthlyPayment: string;\r\n    duration: number;\r\n  }): Promise<void> {\r\n    const { email, firstName, loanAmount, currency, monthlyPayment, duration } = params;\r\n    const brand = await this.getBrand();\r\n\r\n    const subject = `${brand.name} ¬∑ Loan Disbursed!`;\r\n    const html = this.renderTemplate(brand, {\r\n      title: 'üí∞ Loan Disbursed',\r\n      intro: `Hi ${firstName}, your loan has been successfully disbursed to your wallet!`,\r\n      lines: [\r\n        `<div style=\"background:#dcfce7;border:2px solid #16a34a;border-radius:12px;padding:20px;margin:16px 0;text-align:center\">\r\n          <div style=\"font-size:40px;margin-bottom:8px\">üí∞</div>\r\n          <div style=\"color:#166534;font-weight:700;font-size:16px;margin-bottom:8px\">Funds Disbursed</div>\r\n          <div style=\"color:#15803d;font-size:28px;font-weight:800\">${currency} ${loanAmount}</div>\r\n        </div>`,\r\n        `<strong>Repayment Schedule:</strong>`,\r\n        `<strong>Monthly Payment:</strong> ${currency} ${monthlyPayment}`,\r\n        `<strong>Duration:</strong> ${duration} months`,\r\n        `<strong>First Payment Due:</strong> 30 days from today`,\r\n        '<div style=\"background:#fee2e2;border-left:4px solid #dc2626;padding:12px;margin:16px 0;border-radius:4px\">\\n          <strong style=\"color:#991b1b\">Important:</strong><br/>\\n          <span style=\"color:#7f1d1d\">Please ensure timely monthly payments to maintain your credit standing. Late payments may incur penalties.</span>\\n        </div>',\r\n      ],\r\n      cta: { label: 'View Wallet', url: `${process.env.FRONTEND_URL || 'http://localhost:3000'}/user/dashboard` },\r\n    });\r\n    this.logSend(email, subject, html);\r\n  }\r\n\r\n  async sendTransactionEmail(params: {\r\n    email: string;\r\n    firstName: string;\r\n    transactionType: string;\r\n    amount: string;\r\n    currency: string;\r\n    balance: string;\r\n    reference: string;\r\n    description?: string;\r\n  }): Promise<void> {\r\n    const { email, firstName, transactionType, amount, currency, balance, reference, description } = params;\r\n    const brand = await this.getBrand();\r\n\r\n    const isCredit = ['DEPOSIT', 'PAYMENT_GATEWAY_DEPOSIT'].includes(transactionType) || (description || '').toLowerCase().includes('from');\r\n    const title = isCredit ? 'Money Received' : 'Transaction Alert';\r\n    const emoji = isCredit ? 'üí∞' : 'üì§';\r\n    const badgeBg = isCredit ? '#dcfce7' : '#fee2e2';\r\n    const badgeText = isCredit ? '#166534' : '#991b1b';\r\n    const badgeLabel = isCredit ? 'CREDIT' : 'DEBIT';\r\n\r\n    const detailsCard = `\r\n      <div style=\"margin-top:24px;border:2px solid #e2e8f0;border-radius:16px;padding:24px;background:#ffffff;box-shadow:0 2px 8px rgba(0,0,0,0.04)\">\r\n        <div style=\"display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px\">\r\n          <div style=\"display:inline-flex;gap:10px;align-items:center\">\r\n            <span style=\"display:inline-block;padding:8px 14px;border-radius:999px;background:${badgeBg};color:${badgeText};font-size:13px;font-weight:700;letter-spacing:0.05em\">${badgeLabel}</span>\r\n            <span style=\"color:#334155;font-weight:600;font-size:15px\">${transactionType.replace('_', ' ')}</span>\r\n          </div>\r\n          <div style=\"color:${isCredit ? '#16a34a' : '#dc2626'};font-weight:800;font-size:22px\">${isCredit ? '+' : '-'} ${currency} ${amount}</div>\r\n        </div>\r\n        <div style=\"display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:20px\">\r\n          <div style=\"background:#f8fafc;border:1px solid #e2e8f0;padding:16px;border-radius:12px\">\r\n            <div style=\"color:#64748b;font-size:13px;margin-bottom:8px;font-weight:600\">Reference</div>\r\n            <div style=\"color:#0f172a;font-weight:600;font-size:14px;word-break:break-all;line-height:1.5\">${reference}</div>\r\n          </div>\r\n          <div style=\"background:#f8fafc;border:1px solid #e2e8f0;padding:16px;border-radius:12px\">\r\n            <div style=\"color:#64748b;font-size:13px;margin-bottom:8px;font-weight:600\">New Balance</div>\r\n            <div style=\"color:#0f172a;font-weight:700;font-size:16px\">${currency} ${balance}</div>\r\n          </div>\r\n          ${description ? `<div style=\\\"grid-column:1 / -1;background:#f8fafc;border:1px solid #e2e8f0;padding:16px;border-radius:12px\\\"><div style=\\\"color:#64748b;font-size:13px;margin-bottom:8px;font-weight:600\\\">Description</div><div style=\\\"color:#0f172a;font-size:14px;line-height:1.6\\\">${description}</div></div>` : ''}\r\n        </div>\r\n      </div>\r\n    `.trim();\r\n\r\n    const subject = `${brand.name} ¬∑ ${title}`;\r\n    const html = this.renderTemplate(brand, {\r\n      title: `${emoji} ${title}`,\r\n      intro: `Hi ${firstName}, ${isCredit ? 'you have received a credit on' : 'a transaction was made on'} your account. See details below:`,\r\n      lines: [detailsCard],\r\n      cta: { label: 'View Transaction', url: `${process.env.FRONTEND_URL || 'http://localhost:3000'}/user/transactions` },\r\n    });\r\n    this.logSend(email, subject, html);\r\n  }\r\n\r\n  private async logSend(to: string, subject: string, html: string) {\r\n    // Attempt real send via SMTP if configured; otherwise log\r\n    try {\r\n      const brandSettings = await this.settingsService.getSettings();\r\n      const emailCfg = brandSettings.email || {} as any;\r\n\r\n      // Check if SMTP is configured (support both service-based and host-based config)\r\n      const hasServiceConfig = emailCfg.smtpService && emailCfg.smtpUser && emailCfg.smtpPass;\r\n      const hasHostConfig = emailCfg.smtpHost && emailCfg.smtpUser && emailCfg.smtpPass;\r\n\r\n      if (hasServiceConfig || hasHostConfig) {\r\n        // Lazy import to avoid hard dependency if not installed\r\n        // eslint-disable-next-line @typescript-eslint/no-var-requires\r\n        const nodemailer = require('nodemailer');\r\n\r\n        // Build transport config based on what's available\r\n        let transportConfig: any;\r\n        if (hasServiceConfig) {\r\n          // Use service shorthand (e.g., 'gmail', 'outlook', 'yahoo')\r\n          transportConfig = {\r\n            service: emailCfg.smtpService,\r\n            auth: { user: emailCfg.smtpUser, pass: emailCfg.smtpPass },\r\n          };\r\n        } else {\r\n          // Use explicit host/port configuration\r\n          transportConfig = {\r\n            host: emailCfg.smtpHost,\r\n            port: Number(emailCfg.smtpPort) || 587,\r\n            secure: Number(emailCfg.smtpPort) === 465,\r\n            auth: { user: emailCfg.smtpUser, pass: emailCfg.smtpPass },\r\n          };\r\n        }\r\n\r\n        const transporter = nodemailer.createTransport(transportConfig);\r\n        await transporter.sendMail({\r\n          from: `${emailCfg.fromName || brandSettings.general.siteName} <${emailCfg.fromAddress || brandSettings.general.supportEmail}>`,\r\n          to,\r\n          subject,\r\n          html,\r\n        });\r\n        this.logger.log(`Email sent via SMTP to ${to}`);\r\n        return;\r\n      }\r\n    } catch (e) {\r\n      this.logger.warn(`SMTP send failed or not configured: ${e?.message || e}`);\r\n    }\r\n\r\n    // Fallback: log only\r\n    this.logger.log(`Email (LOG) ‚Üí ${to} | ${subject}`);\r\n    this.logger.debug(html);\r\n  }\r\n\r\n  private renderTemplate(brand: Brand, opts: { title: string; intro: string; lines?: string[]; cta?: { label: string; url: string } }): string {\r\n    const { title, intro, lines = [], cta } = opts;\r\n    const primary = brand.primary;\r\n    const secondary = brand.secondary;\r\n    const textLines = lines.map((line) => (line.startsWith('<') ? line : `<p style=\\\"margin:0 0 14px;color:#475569;line-height:1.65;font-size:15px\\\">${line}</p>`)).join('');\r\n\r\n    // Render intro - if it contains <br> tags, it's already formatted HTML\r\n    const introHtml = intro.includes('<br>') || intro.includes('<strong>')\r\n      ? `<div style=\\\"margin:0 0 20px;color:#475569;line-height:1.7;font-size:15px\\\" class=\\\"dark-text-secondary\\\">${intro}</div>`\r\n      : `<p style=\\\"margin:0 0 20px;color:#475569;line-height:1.6;font-size:15px\\\" class=\\\"dark-text-secondary\\\">${intro}</p>`;\r\n\r\n    const button = cta\r\n      ? `<table role=\\\"presentation\\\" cellspacing=\\\"0\\\" cellpadding=\\\"0\\\" border=\\\"0\\\" style=\\\"margin:28px auto 0\\\"><tr><td align=\\\"center\\\" style=\\\"border-radius:12px;background:linear-gradient(135deg, ${primary} 0%, ${secondary} 100%);box-shadow:0 10px 25px -5px ${primary}40, 0 8px 10px -6px ${primary}30;transition:all 0.3s ease\\\"><a href=\\\"${cta.url}\\\" target=\\\"_blank\\\" style=\\\"display:inline-block;padding:16px 40px;color:#ffffff;text-decoration:none;font-weight:700;font-size:15px;line-height:1;border-radius:12px;letter-spacing:0.02em\\\">${cta.label}</a></td></tr></table>`\r\n      : '';\r\n\r\n    const support = brand.supportEmail\r\n      ? `<p style=\\\"margin:0 0 8px;color:#64748b;font-size:13px;line-height:1.5\\\">Questions? Contact us at <a href=\\\"mailto:${brand.supportEmail}\\\" style=\\\"color:${primary};text-decoration:none;font-weight:500\\\">${brand.supportEmail}</a></p>`\r\n      : '';\r\n\r\n    const logoBlock = brand.logo\r\n      ? `<img src=\\\"${brand.logo}\\\" alt=\\\"${brand.name}\\\" width=\\\"56\\\" height=\\\"56\\\" style=\\\"display:inline-block;vertical-align:middle;border-radius:12px;filter:brightness(0) invert(1);opacity:0.95\\\"/>`\r\n      : `<div style=\\\"width:56px;height:56px;border-radius:12px;background:rgba(255,255,255,0.2);display:inline-block;vertical-align:middle\\\"></div>`;\r\n\r\n    const preheader = `${brand.name} - ${title}`;\r\n\r\n    return `\r\n<!DOCTYPE html>\r\n<html lang=\\\"en\\\" xmlns=\\\"http://www.w3.org/1999/xhtml\\\" xmlns:o=\\\"urn:schemas-microsoft-com:office:office\\\">\r\n<head>\r\n  <meta charset=\\\"UTF-8\\\">\r\n  <meta name=\\\"viewport\\\" content=\\\"width=device-width,initial-scale=1\\\">\r\n  <meta name=\\\"x-apple-disable-message-reformatting\\\">\r\n  <meta http-equiv=\\\"X-UA-Compatible\\\" content=\\\"IE=edge\\\">\r\n  <title>${title}</title>\r\n  <!--[if mso]>\r\n  <style type=\\\"text/css\\\">\r\n    table {border-collapse:collapse;border-spacing:0;margin:0;}\r\n    div, td {padding:0;}\r\n  </style>\r\n  <![endif]-->\r\n  <style type=\\\"text/css\\\">\r\n    @media only screen and (max-width: 600px) {\r\n      .content-block { padding: 20px 16px !important; }\r\n      .header-block { padding: 16px 16px 14px !important; }\r\n      .footer-block { padding: 16px !important; }\r\n      h1 { font-size: 20px !important; }\r\n      .button-cell { padding: 14px 24px !important; font-size: 14px !important; }\r\n      .brand-name { font-size: 16px !important; }\r\n      .blur-circle { display: none !important; }\r\n    }\r\n    @media (prefers-color-scheme: dark) {\r\n      .dark-bg { background: #0f172a !important; }\r\n      .dark-card { background: #1e293b !important; border-color: #334155 !important; }\r\n      .dark-text { color: #e2e8f0 !important; }\r\n      .dark-text-secondary { color: #94a3b8 !important; }\r\n    }\r\n  </style>\r\n</head>\r\n<body style=\\\"margin:0;padding:0;background-color:#f1f5f9;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale\\\" class=\\\"dark-bg\\\">\r\n  <!-- Preheader -->\r\n  <div style=\\\"display:none;font-size:1px;line-height:1px;max-height:0;max-width:0;opacity:0;overflow:hidden;mso-hide:all\\\">${preheader}</div>\r\n  \r\n  <!-- Main Container -->\r\n  <table role=\\\"presentation\\\" cellpadding=\\\"0\\\" cellspacing=\\\"0\\\" border=\\\"0\\\" width=\\\"100%\\\" style=\\\"background-color:#f1f5f9;padding:20px 0\\\" class=\\\"dark-bg\\\">\r\n    <tr>\r\n      <td align=\\\"center\\\" style=\\\"padding:0 16px\\\">\r\n        <!-- Card Container -->\r\n        <table role=\\\"presentation\\\" cellpadding=\\\"0\\\" cellspacing=\\\"0\\\" border=\\\"0\\\" width=\\\"600\\\" style=\\\"max-width:600px;width:100%;background-color:#ffffff;border-radius:16px;box-shadow:0 4px 6px -1px rgba(0,0,0,0.1),0 2px 4px -1px rgba(0,0,0,0.06);border:1px solid #e2e8f0;overflow:hidden\\\" class=\\\"dark-card\\\">\r\n          \r\n          <!-- Header with Logo and Brand - Gradient Background -->\r\n          <tr>\r\n            <td style=\\\"background:linear-gradient(135deg,${primary} 0%,${secondary} 100%);padding:20px 24px 18px;position:relative\\\" class=\\\"header-block\\\">\r\n              <!-- Logo at far left -->\r\n              <div style=\\\"position:absolute;left:20px;top:50%;transform:translateY(-50%)\\\">\r\n                ${logoBlock}\r\n              </div>\r\n              <!-- Text centered -->\r\n              <div style=\\\"text-align:center\\\">\r\n                <div class=\\\"brand-name\\\" style=\\\"color:#ffffff;font-size:20px;font-weight:700;letter-spacing:-0.01em;text-shadow:0 1px 4px rgba(0,0,0,0.12)\\\">${brand.name}</div>\r\n              </div>\r\n            </td>\r\n          </tr>\r\n          \r\n          <!-- Main Content -->\r\n          <tr>\r\n            <td style=\\\"padding:32px 28px\\\" class=\\\"content-block dark-text\\\">\r\n              <h1 style=\\\"margin:0 0 18px;font-size:26px;font-weight:800;background:linear-gradient(135deg,${primary} 0%,${secondary} 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;line-height:1.3;letter-spacing:-0.03em\\\" class=\\\"dark-text\\\">${title}</h1>\r\n              ${introHtml}\r\n              <div style=\\\"margin:20px 0\\\">\r\n                ${textLines}\r\n              </div>\r\n              ${button}\r\n              ${cta ? `<p style=\\\"margin:20px 0 0;font-size:12px;color:#94a3b8;line-height:1.5;text-align:center\\\" class=\\\"dark-text-secondary\\\">If the button doesn't work, copy and paste this link:<br/><span style=\\\"word-break:break-all;color:#64748b\\\">${cta.url}</span></p>` : ''}\r\n            </td>\r\n          </tr>\r\n          \r\n          <!-- Divider -->\r\n          <tr>\r\n            <td style=\\\"padding:0 28px\\\">\r\n              <div style=\\\"height:1px;background-color:#e2e8f0\\\"></div>\r\n            </td>\r\n          </tr>\r\n          \r\n          <!-- Footer -->\r\n          <tr>\r\n            <td align=\\\"center\\\" style=\\\"padding:24px 28px;background-color:#f8fafc\\\" class=\\\"footer-block\\\">\r\n              ${support}\r\n              <p style=\\\"margin:0;color:#94a3b8;font-size:12px;line-height:1.5\\\" class=\\\"dark-text-secondary\\\">¬© ${new Date().getFullYear()} ${brand.name}. All rights reserved.<br/>This is an automated message, please do not reply.</p>\r\n            </td>\r\n          </tr>\r\n          \r\n        </table>\r\n        \r\n        <!-- Spacer -->\r\n        <div style=\\\"height:20px\\\"></div>\r\n        \r\n      </td>\r\n    </tr>\r\n  </table>\r\n</body>\r\n</html>\r\n    `.trim();\r\n  }\r\n}\r\n"],"names":["EmailService","getBrand","settings","settingsService","getSettings","cachedBrand","name","general","siteName","logo","primary","brandPrimaryColor","secondary","brandSecondaryColor","supportEmail","websiteUrl","process","env","FRONTEND_URL","_","sendWelcomeEmail","params","email","firstName","lastName","accountNumber","brand","subject","html","renderTemplate","title","intro","lines","cta","label","url","logSend","sendAccountStatusEmail","status","reason","sendKycStatusEmail","filter","Boolean","sendOtpEmail","code","purpose","otpBox","sendEmailVerificationCode","verificationBox","sendPasswordResetEmail","resetUrl","sendGenericNotification","message","actionUrl","actionLabel","undefined","sendTransferCodeEmail","type","sendSupportTicketEmail","ticketId","ticketSubject","ticketBox","sendLoanFeeRequestEmail","loanAmount","currency","processingFee","cryptoWalletAddress","cryptoType","feeDescription","sendLoanApprovedEmail","monthlyPayment","duration","interestRate","sendLoanDisbursementEmail","sendTransactionEmail","transactionType","amount","balance","reference","description","isCredit","includes","toLowerCase","emoji","badgeBg","badgeText","badgeLabel","detailsCard","replace","trim","to","brandSettings","emailCfg","hasServiceConfig","smtpService","smtpUser","smtpPass","hasHostConfig","smtpHost","nodemailer","require","transportConfig","service","auth","user","pass","host","port","Number","smtpPort","secure","transporter","createTransport","sendMail","from","fromName","fromAddress","logger","log","e","warn","debug","opts","textLines","map","line","startsWith","join","introHtml","button","support","logoBlock","preheader","Date","getFullYear","Logger"],"mappings":"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"}