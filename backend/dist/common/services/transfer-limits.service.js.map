{"version":3,"sources":["../../../src/common/services/transfer-limits.service.ts"],"sourcesContent":["import { Injectable, BadRequestException } from '@nestjs/common';\r\nimport { PrismaService } from '../../prisma/prisma.service';\r\n\r\ninterface TransferLimits {\r\n  dailyLimit: number;\r\n  monthlyLimit: number;\r\n  singleTransferLimit: number;\r\n  internalFeePercent: number;\r\n  domesticFeePercent: number;\r\n  internationalFeePercent: number;\r\n  minFee: number;\r\n}\r\n\r\n@Injectable()\r\nexport class TransferLimitsService {\r\n  constructor(private prisma: PrismaService) {}\r\n\r\n  // Default limits (can be overridden per user or from database)\r\n  private defaultLimits: TransferLimits = {\r\n    dailyLimit: 1000000, // 1M NGN per day\r\n    monthlyLimit: 10000000, // 10M NGN per month\r\n    singleTransferLimit: 500000, // 500K NGN per transaction\r\n    internalFeePercent: 0, // No fee for internal transfers\r\n    domesticFeePercent: 0.5, // 0.5% for domestic\r\n    internationalFeePercent: 2, // 2% for international\r\n    minFee: 10, // Minimum fee of 10 NGN/USD\r\n  };\r\n\r\n  /**\r\n   * Calculate transfer fee based on type and amount\r\n   */\r\n  calculateFee(amount: number, transferType: 'INTERNAL' | 'DOMESTIC' | 'INTERNATIONAL'): number {\r\n    let feePercent = 0;\r\n\r\n    switch (transferType) {\r\n      case 'INTERNAL':\r\n        feePercent = this.defaultLimits.internalFeePercent;\r\n        break;\r\n      case 'DOMESTIC':\r\n        feePercent = this.defaultLimits.domesticFeePercent;\r\n        break;\r\n      case 'INTERNATIONAL':\r\n        feePercent = this.defaultLimits.internationalFeePercent;\r\n        break;\r\n    }\r\n\r\n    const calculatedFee = (amount * feePercent) / 100;\r\n    \r\n    // Apply minimum fee for non-internal transfers\r\n    if (transferType !== 'INTERNAL') {\r\n      return Math.max(calculatedFee, this.defaultLimits.minFee);\r\n    }\r\n\r\n    return calculatedFee;\r\n  }\r\n\r\n  /**\r\n   * Check if transfer amount exceeds single transaction limit\r\n   */\r\n  checkSingleTransferLimit(amount: number): void {\r\n    if (amount > this.defaultLimits.singleTransferLimit) {\r\n      throw new BadRequestException(\r\n        `Transfer amount exceeds single transaction limit of ${this.defaultLimits.singleTransferLimit.toLocaleString()}`\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check daily and monthly transfer limits\r\n   */\r\n  async checkTransferLimits(userId: string, amount: number): Promise<void> {\r\n    const now = new Date();\r\n    const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());\r\n    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);\r\n\r\n    // Get today's transfers\r\n    const dailyTransfers = await this.prisma.transaction.aggregate({\r\n      where: {\r\n        userId,\r\n        type: 'TRANSFER',\r\n        status: 'COMPLETED',\r\n        createdAt: { gte: startOfDay },\r\n      },\r\n      _sum: { amount: true },\r\n    });\r\n\r\n    const dailyTotal = Number(dailyTransfers._sum.amount || 0);\r\n\r\n    if (dailyTotal + amount > this.defaultLimits.dailyLimit) {\r\n      throw new BadRequestException(\r\n        `Daily transfer limit exceeded. Limit: ${this.defaultLimits.dailyLimit.toLocaleString()}, ` +\r\n        `Used: ${dailyTotal.toLocaleString()}, Remaining: ${(this.defaultLimits.dailyLimit - dailyTotal).toLocaleString()}`\r\n      );\r\n    }\r\n\r\n    // Get this month's transfers\r\n    const monthlyTransfers = await this.prisma.transaction.aggregate({\r\n      where: {\r\n        userId,\r\n        type: 'TRANSFER',\r\n        status: 'COMPLETED',\r\n        createdAt: { gte: startOfMonth },\r\n      },\r\n      _sum: { amount: true },\r\n    });\r\n\r\n    const monthlyTotal = Number(monthlyTransfers._sum.amount || 0);\r\n\r\n    if (monthlyTotal + amount > this.defaultLimits.monthlyLimit) {\r\n      throw new BadRequestException(\r\n        `Monthly transfer limit exceeded. Limit: ${this.defaultLimits.monthlyLimit.toLocaleString()}, ` +\r\n        `Used: ${monthlyTotal.toLocaleString()}, Remaining: ${(this.defaultLimits.monthlyLimit - monthlyTotal).toLocaleString()}`\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get user's remaining limits\r\n   */\r\n  async getRemainingLimits(userId: string): Promise<{\r\n    daily: { limit: number; used: number; remaining: number };\r\n    monthly: { limit: number; used: number; remaining: number };\r\n    singleTransaction: number;\r\n  }> {\r\n    const now = new Date();\r\n    const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());\r\n    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);\r\n\r\n    const [dailyTransfers, monthlyTransfers] = await Promise.all([\r\n      this.prisma.transaction.aggregate({\r\n        where: {\r\n          userId,\r\n          type: 'TRANSFER',\r\n          status: 'COMPLETED',\r\n          createdAt: { gte: startOfDay },\r\n        },\r\n        _sum: { amount: true },\r\n      }),\r\n      this.prisma.transaction.aggregate({\r\n        where: {\r\n          userId,\r\n          type: 'TRANSFER',\r\n          status: 'COMPLETED',\r\n          createdAt: { gte: startOfMonth },\r\n        },\r\n        _sum: { amount: true },\r\n      }),\r\n    ]);\r\n\r\n    const dailyUsed = Number(dailyTransfers._sum.amount || 0);\r\n    const monthlyUsed = Number(monthlyTransfers._sum.amount || 0);\r\n\r\n    return {\r\n      daily: {\r\n        limit: this.defaultLimits.dailyLimit,\r\n        used: dailyUsed,\r\n        remaining: this.defaultLimits.dailyLimit - dailyUsed,\r\n      },\r\n      monthly: {\r\n        limit: this.defaultLimits.monthlyLimit,\r\n        used: monthlyUsed,\r\n        remaining: this.defaultLimits.monthlyLimit - monthlyUsed,\r\n      },\r\n      singleTransaction: this.defaultLimits.singleTransferLimit,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Get fee information for display\r\n   */\r\n  getFeeInfo() {\r\n    return {\r\n      internal: { percent: this.defaultLimits.internalFeePercent, min: 0 },\r\n      domestic: { percent: this.defaultLimits.domesticFeePercent, min: this.defaultLimits.minFee },\r\n      international: { percent: this.defaultLimits.internationalFeePercent, min: this.defaultLimits.minFee },\r\n    };\r\n  }\r\n}\r\n"],"names":["TransferLimitsService","calculateFee","amount","transferType","feePercent","defaultLimits","internalFeePercent","domesticFeePercent","internationalFeePercent","calculatedFee","Math","max","minFee","checkSingleTransferLimit","singleTransferLimit","BadRequestException","toLocaleString","checkTransferLimits","userId","now","Date","startOfDay","getFullYear","getMonth","getDate","startOfMonth","dailyTransfers","prisma","transaction","aggregate","where","type","status","createdAt","gte","_sum","dailyTotal","Number","dailyLimit","monthlyTransfers","monthlyTotal","monthlyLimit","getRemainingLimits","Promise","all","dailyUsed","monthlyUsed","daily","limit","used","remaining","monthly","singleTransaction","getFeeInfo","internal","percent","min","domestic","international"],"mappings":"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"}